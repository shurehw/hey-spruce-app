<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplier Portal - Hey Spruce</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            /* Layout Variables */
            --sidebar-width: 260px;
            --header-height: 60px;
            
            /* Portal Theme Colors - Supplier (Purple) */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #e0e7ff;
            --secondary: #8b5cf6;
            --secondary-dark: #7c3aed;
            --secondary-light: #ede9fe;
            
            /* Status Colors */
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fed7aa;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --info: #3b82f6;
            --info-light: #dbeafe;
            
            /* Gray Scale */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --dark: #1f2937; /* Keep for backward compatibility */
            
            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            
            /* Spacing */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 12px;
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: white;
            color: var(--gray-900);
            line-height: 1.6;
        }
        
        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: white;
            border-bottom: 1px solid var(--gray-200);
            z-index: 100;
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .portal-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-left: 1rem;
        }
        
        .back-to-main {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-600);
            text-decoration: none;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .back-to-main:hover {
            background: var(--gray-100);
            color: var(--gray-900);
        }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            top: var(--header-height);
            left: 0;
            width: var(--sidebar-width);
            height: calc(100vh - var(--header-height));
            background: white;
            border-right: 1px solid var(--gray-200);
            overflow-y: auto;
            z-index: 50;
        }
        
        .sidebar-section {
            margin-bottom: 2rem;
        }
        
        .sidebar-title {
            padding: 0 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--gray-500);
            letter-spacing: 0.05em;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 1.5rem;
            color: var(--gray-700);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .nav-item:hover {
            background: var(--gray-50);
            color: var(--primary);
        }
        
        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary);
            font-weight: 500;
            position: relative;
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary);
        }
        
        .nav-item .icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-item .badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            font-size: 0.75rem;
        }
        
        .nav-item.active .badge {
            background: white;
            color: var(--primary);
        }
        
        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            padding: 2.5rem;
            min-height: calc(100vh - var(--header-height));
            background: var(--gray-50);
        }
        
        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .stat-card:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08), 0 3px 10px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
            border-color: var(--gray-300);
        }
        
        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .stat-icon.blue { background: rgba(99, 102, 241, 0.1); color: var(--primary); }
        .stat-icon.green { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .stat-icon.yellow { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .stat-icon.red { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-600);
        }
        
        .stat-change {
            font-size: 0.75rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }
        
        /* Tables */
        .table-container {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--gray-200);
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .table-container:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .table-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--gray-900);
            letter-spacing: -0.025em;
        }
        
        .table-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 0.75rem 1.5rem;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-700);
        }
        
        td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.875rem;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-badge.requested { background: #f3e8ff; color: #6b21a8; }
        .status-badge.open { background: #dbeafe; color: #1e40af; }
        .status-badge.progress { background: #fef3c7; color: #92400e; }
        .status-badge.hold { background: #fee2e2; color: #991b1b; }
        .status-badge.completed { background: #d1fae5; color: #065f46; }
        
        .inbox-message:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .status-badge.cancelled { background: #f3f4f6; color: #4b5563; }
        
        /* Sub-Status Modal Styles */
        .substatus-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .substatus-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.15s;
            font-size: 0.875rem;
        }
        
        .substatus-item:hover {
            background-color: var(--gray-50);
        }
        
        .substatus-item input[type="checkbox"] {
            margin-right: 0.75rem;
            cursor: pointer;
        }
        
        .substatus-item .count {
            color: var(--gray-500);
            font-size: 0.8125rem;
            margin-left: auto;
        }
        
        .active-filter-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 500;
        }
        
        .active-filter-pill button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: -0.025em;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .btn-secondary:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            box-shadow: none;
        }

        .btn-outline:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15);
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.875rem;
            transition: all 0.15s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .required-field {
            color: var(--danger);
        }
        
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        
        .modal-footer .btn {
            padding: 0.625rem 1.25rem;
        }
    </style>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Google Maps API -->
    <script>
        // Initialize Supabase
        const SUPABASE_URL = 'https://uokmehjqcxmcoavnszid.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVva21laGpxY3htY29hdm5zemlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxODI1MDUsImV4cCI6MjA3MTc1ODUwNX0.K19tHO1YrS-HRBleEAWgOANCPglR9rerBCmE5abY1Rg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>
    <script>
        function loadGoogleMaps() {
            const script = document.createElement('script');
            // Note: Replace YOUR_API_KEY with an actual Google Maps API key
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyDUSvpBXJAOsQfndpiOgWRqGV-O2y7IGtM&callback=initMap';
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
        
        // Load Google Maps when page loads
        window.addEventListener('load', () => {
            // Only load if we're on a work order detail page
            if (window.location.hash.includes('work-order-detail')) {
                loadGoogleMaps();
            }
        });
        
        // Toast Notification System
        function showPreventativeMaintenanceModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3>Schedule Preventative Maintenance</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <form id="preventativeMaintenanceForm" onsubmit="submitPreventativeMaintenance(event)">
                            <!-- Service Type Selection -->
                            <div class="form-group">
                                <label style="font-weight: 600;">Service Type</label>
                                <select required style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="">Select service type...</option>
                                    <option value="hvac">HVAC System Maintenance</option>
                                    <option value="kitchen">Kitchen Equipment Check</option>
                                    <option value="plumbing">Plumbing Inspection</option>
                                    <option value="electrical">Electrical Systems Review</option>
                                    <option value="refrigeration">Refrigeration Maintenance</option>
                                    <option value="exhaust">Exhaust System Cleaning</option>
                                    <option value="grease">Grease Trap Service</option>
                                    <option value="pest">Pest Control Treatment</option>
                                    <option value="fire">Fire Safety Equipment Check</option>
                                    <option value="custom">Custom Service</option>
                                </select>
                            </div>
                            
                            <!-- Frequency Selection -->
                            <div class="form-group">
                                <label style="font-weight: 600;">Frequency</label>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                        <input type="radio" name="frequency" value="weekly" style="margin-right: 0.5rem;">
                                        <span>Weekly</span>
                                    </label>
                                    <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                        <input type="radio" name="frequency" value="biweekly" style="margin-right: 0.5rem;">
                                        <span>Bi-weekly</span>
                                    </label>
                                    <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid var(--primary); border-radius: 8px; cursor: pointer; background: var(--primary-light); transition: all 0.2s;">
                                        <input type="radio" name="frequency" value="monthly" checked style="margin-right: 0.5rem;">
                                        <span>Monthly</span>
                                    </label>
                                    <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                        <input type="radio" name="frequency" value="quarterly" style="margin-right: 0.5rem;">
                                        <span>Quarterly</span>
                                    </label>
                                    <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                        <input type="radio" name="frequency" value="biannual" style="margin-right: 0.5rem;">
                                        <span>Bi-annual</span>
                                    </label>
                                    <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                        <input type="radio" name="frequency" value="annual" style="margin-right: 0.5rem;">
                                        <span>Annual</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Location and Asset Selection -->
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label style="font-weight: 600;">Location</label>
                                    <select required style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <option value="">Select location...</option>
                                        <option value="all">All Locations</option>
                                        <option value="downtown">Downtown Store</option>
                                        <option value="melrose">Melrose Location</option>
                                        <option value="venice">Venice Beach</option>
                                        <option value="hollywood">Hollywood Blvd</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label style="font-weight: 600;">Asset/Equipment</label>
                                    <select style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <option value="">Select asset (optional)...</option>
                                        <option value="hvac-01">HVAC Unit #01</option>
                                        <option value="cooler-01">Walk-in Cooler #01</option>
                                        <option value="fryer-01">Deep Fryer #01</option>
                                        <option value="grill-01">Grill Station #01</option>
                                        <option value="dishwasher-01">Dishwasher #01</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Assignment Method Selection -->
                            <div class="form-group" style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;">Assignment Method</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <label style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--primary); border-radius: 8px; cursor: pointer; background: var(--primary-light);">
                                        <input type="radio" name="assignmentMethod" value="direct" checked style="margin-right: 0.75rem;" onchange="toggleAssignmentMethod('direct')">
                                        <div>
                                            <div style="font-weight: 600;">Direct Assignment</div>
                                            <div style="font-size: 0.875rem; color: var(--gray-600);">Assign to specific technician or vendor</div>
                                        </div>
                                    </label>
                                    <label style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--gray-200); border-radius: 8px; cursor: pointer; background: white;">
                                        <input type="radio" name="assignmentMethod" value="bid" style="margin-right: 0.75rem;" onchange="toggleAssignmentMethod('bid')">
                                        <div>
                                            <div style="font-weight: 600;">Request Bids</div>
                                            <div style="font-size: 0.875rem; color: var(--gray-600);">Get competitive bids for ongoing service</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Direct Assignment Section -->
                            <div id="directAssignmentSection">
                                <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div class="form-group">
                                        <label style="font-weight: 600;">Assign To</label>
                                        <select id="techAssignment" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;" onchange="updatePricingDisplay()">
                                            <option value="">Select technician or vendor...</option>
                                            <optgroup label="Internal Technicians">
                                                <option value="tech-john" data-rate="85">John Smith - $85/hr</option>
                                                <option value="tech-mike" data-rate="75">Mike Johnson - $75/hr</option>
                                                <option value="tech-sarah" data-rate="90">Sarah Williams - $90/hr</option>
                                            </optgroup>
                                            <optgroup label="Preferred Vendors">
                                                <option value="vendor-hvac" data-rate="450">Seattle HVAC Pro - $450/service</option>
                                                <option value="vendor-clean" data-rate="280">Sparkle Clean Co - $280/service</option>
                                                <option value="vendor-electric" data-rate="350">Elite Electrical - $350/service</option>
                                            </optgroup>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label style="font-weight: 600;">Service Price</label>
                                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                                            <span>$</span>
                                            <input type="number" id="servicePrice" placeholder="0.00" style="flex: 1; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;" onchange="updatePricingDisplay()">
                                            <select id="priceType" style="padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;" onchange="updatePricingDisplay()">
                                                <option value="per-service">Per Service</option>
                                                <option value="hourly">Hourly</option>
                                                <option value="monthly">Monthly</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Pricing Breakdown -->
                                <div style="background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                    <h4 style="margin-bottom: 0.75rem; font-size: 0.875rem; color: var(--gray-700);">Pricing Breakdown</h4>
                                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <span>Service Cost:</span>
                                            <span id="serviceCostDisplay">$0.00</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>Platform Fee:</span>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="number" id="platformFeePercent" value="15" min="0" max="100" step="0.5" style="width: 60px; padding: 0.25rem; border: 1px solid var(--gray-300); border-radius: 4px;" onchange="updatePricingDisplay()">
                                                <span>% = $<span id="platformFeeDisplay">0.00</span></span>
                                            </div>
                                        </div>
                                        <div style="border-top: 1px solid var(--gray-200); padding-top: 0.5rem; display: flex; justify-content: space-between; font-weight: 600;">
                                            <span>Total per Service:</span>
                                            <span id="totalCostDisplay">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Bid Request Section -->
                            <div id="bidRequestSection" style="display: none;">
                                <div class="form-group">
                                    <label style="font-weight: 600;">Bid Requirements</label>
                                    <textarea rows="4" placeholder="Describe your requirements for bidders..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;"></textarea>
                                </div>
                                
                                <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label style="font-weight: 600;">Maximum Budget per Service</label>
                                        <input type="number" placeholder="Enter maximum amount..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label style="font-weight: 600;">Bid Deadline</label>
                                        <input type="date" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label style="font-weight: 600;">Vendor Requirements</label>
                                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                        <label style="display: block; cursor: pointer; padding: 0.25rem 0;">
                                            <input type="checkbox" checked style="margin-right: 8px; vertical-align: middle;">
                                            <span style="vertical-align: middle;">Licensed and insured</span>
                                        </label>
                                        <label style="display: block; cursor: pointer; padding: 0.25rem 0;">
                                            <input type="checkbox" checked style="margin-right: 8px; vertical-align: middle;">
                                            <span style="vertical-align: middle;">Minimum 3 years experience</span>
                                        </label>
                                        <label style="display: block; cursor: pointer; padding: 0.25rem 0;">
                                            <input type="checkbox" style="margin-right: 8px; vertical-align: middle;">
                                            <span style="vertical-align: middle;">24/7 emergency availability</span>
                                        </label>
                                        <label style="display: block; cursor: pointer; padding: 0.25rem 0;">
                                            <input type="checkbox" style="margin-right: 8px; vertical-align: middle;">
                                            <span style="vertical-align: middle;">Green/eco-friendly practices</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div style="background: var(--warning-light); padding: 1rem; border-radius: 8px; border: 1px solid var(--warning);">
                                    <div style="display: flex; gap: 0.5rem; align-items: start;">
                                        <span style="color: var(--warning);">!</span>
                                        <div>
                                            <div style="font-weight: 600; color: var(--warning); margin-bottom: 0.25rem;">Bid Process</div>
                                            <div style="font-size: 0.875rem; color: var(--gray-700);">
                                                Vendors will receive notifications to bid on this recurring maintenance contract. 
                                                You'll be able to review all bids and select the best option for your needs.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Schedule Details -->
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label style="font-weight: 600;">Start Date</label>
                                    <input type="date" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                </div>
                                
                                <div class="form-group">
                                    <label style="font-weight: 600;">Preferred Time</label>
                                    <select style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <option value="morning">Morning (6am-12pm)</option>
                                        <option value="afternoon">Afternoon (12pm-6pm)</option>
                                        <option value="evening">Evening (6pm-10pm)</option>
                                        <option value="overnight">Overnight (10pm-6am)</option>
                                        <option value="anytime">Anytime</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Service Details -->
                            <div class="form-group">
                                <label style="font-weight: 600;">Service Description</label>
                                <textarea rows="3" placeholder="Describe the maintenance tasks to be performed..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;"></textarea>
                            </div>
                            
                            <!-- Checklist Items -->
                            <div class="form-group">
                                <label style="font-weight: 600;">Maintenance Checklist</label>
                                <div id="checklistItems" style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="text" placeholder="Add checklist item..." style="flex: 1; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                        <button type="button" class="btn btn-secondary" style="padding: 0.5rem 1rem;" onclick="addChecklistItem()">Add</button>
                                    </div>
                                    <div id="checklistItemsList" style="margin-top: 0.5rem;">
                                        <!-- Checklist items will be added here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Budget & Duration -->
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label style="font-weight: 600;">Estimated Duration</label>
                                    <select style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <option value="30min">30 minutes</option>
                                        <option value="1hr" selected>1 hour</option>
                                        <option value="2hr">2 hours</option>
                                        <option value="3hr">3 hours</option>
                                        <option value="4hr">4 hours</option>
                                        <option value="halfday">Half day</option>
                                        <option value="fullday">Full day</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label style="font-weight: 600;">Budget per Service</label>
                                    <input type="number" placeholder="Enter amount..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                </div>
                            </div>
                            
                            <!-- Auto-approval -->
                            <div class="form-group">
                                <label style="display: block; cursor: pointer;">
                                    <input type="checkbox" checked style="margin-right: 8px; vertical-align: middle;">
                                    <span style="vertical-align: middle;">Auto-approve work orders for this maintenance schedule</span>
                                </label>
                            </div>
                            
                            <!-- Summary -->
                            <div style="background: var(--primary-light); padding: 1rem; border-radius: 8px; margin-top: 1.5rem;">
                                <h4 style="margin-bottom: 0.5rem; color: var(--primary);">Schedule Summary</h4>
                                <p style="color: var(--gray-700); margin: 0;">This will create recurring work orders based on your selected frequency. You can modify or cancel this schedule at any time.</p>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="document.getElementById('preventativeMaintenanceForm').dispatchEvent(new Event('submit'))">Schedule Maintenance</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listener for frequency selection
            modal.querySelectorAll('input[name="frequency"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    // Update the visual selection
                    modal.querySelectorAll('label').forEach(label => {
                        if (label.querySelector('input[name="frequency"]')) {
                            label.style.borderColor = 'var(--gray-200)';
                            label.style.background = 'white';
                        }
                    });
                    this.parentElement.style.borderColor = 'var(--primary)';
                    this.parentElement.style.background = 'var(--primary-light)';
                });
            });
            
            // Set initial selection styling
            const checkedRadio = modal.querySelector('input[name="frequency"]:checked');
            if (checkedRadio) {
                checkedRadio.parentElement.style.borderColor = 'var(--primary)';
                checkedRadio.parentElement.style.background = 'var(--primary-light)';
            }
        }
        window.showPreventativeMaintenanceModal = showPreventativeMaintenanceModal;
        
        function submitPreventativeMaintenance(event) {
            event.preventDefault();
            showToast('Preventative maintenance schedule created successfully!', 'success');
            document.querySelector('.modal.active').remove();
            
            // In a real app, this would save to the database and create the recurring work orders
        }
        window.submitPreventativeMaintenance = submitPreventativeMaintenance;
        
        function showCreateWorkOrderModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>Create Work Order</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <form id="createWorkOrderForm" onsubmit="submitWorkOrder(event)">
                            <!-- Basic Information -->
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label style="font-weight: 600;">Client/Location</label>
                                    <select required style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <option value="">Select client/location...</option>
                                        <option value="lodge-downtown">Lodge Bread - Downtown</option>
                                        <option value="lodge-melrose">Lodge Bread - Melrose</option>
                                        <option value="tasty-hollywood">Tasty Burgers - Hollywood</option>
                                        <option value="tasty-venice">Tasty Burgers - Venice</option>
                                        <option value="delilah-main">Delilah LA - Main</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label style="font-weight: 600;">Priority</label>
                                    <select required style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <option value="low">Low Priority</option>
                                        <option value="standard" selected>Standard</option>
                                        <option value="urgent">Urgent</option>
                                        <option value="emergency">Emergency</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Service Category -->
                            <div class="form-group">
                                <label style="font-weight: 600;">Service Category</label>
                                <select required style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;" onchange="updateServiceTypes(this.value)">
                                    <option value="">Select category...</option>
                                    <option value="hvac">HVAC</option>
                                    <option value="plumbing">Plumbing</option>
                                    <option value="electrical">Electrical</option>
                                    <option value="appliance">Appliance Repair</option>
                                    <option value="cleaning">Cleaning</option>
                                    <option value="pest">Pest Control</option>
                                    <option value="maintenance">General Maintenance</option>
                                    <option value="emergency">Emergency Service</option>
                                </select>
                            </div>
                            
                            <!-- Service Type -->
                            <div class="form-group">
                                <label style="font-weight: 600;">Service Type</label>
                                <select id="serviceTypeSelect" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="">Select service category first...</option>
                                </select>
                            </div>
                            
                            <!-- Description -->
                            <div class="form-group">
                                <label style="font-weight: 600;">Description</label>
                                <textarea required rows="4" placeholder="Describe the issue or service needed..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;"></textarea>
                            </div>
                            
                            <!-- Asset/Equipment -->
                            <div class="form-group">
                                <label style="font-weight: 600;">Asset/Equipment (if applicable)</label>
                                <select style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="">Select asset...</option>
                                    <option value="hvac-01">HVAC Unit #01 - Rooftop</option>
                                    <option value="cooler-01">Walk-in Cooler #01</option>
                                    <option value="freezer-01">Walk-in Freezer #01</option>
                                    <option value="fryer-01">Deep Fryer #01</option>
                                    <option value="grill-01">Grill Station #01</option>
                                    <option value="dishwasher-01">Dishwasher #01</option>
                                    <option value="oven-01">Convection Oven #01</option>
                                </select>
                            </div>
                            
                            <!-- Schedule -->
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label style="font-weight: 600;">Requested Date</label>
                                    <input type="date" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                </div>
                                
                                <div class="form-group">
                                    <label style="font-weight: 600;">Preferred Time</label>
                                    <select style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <option value="morning">Morning (6am-12pm)</option>
                                        <option value="afternoon">Afternoon (12pm-6pm)</option>
                                        <option value="evening">Evening (6pm-10pm)</option>
                                        <option value="overnight">Overnight (10pm-6am)</option>
                                        <option value="anytime" selected>Any time</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Assignment Method -->
                            <div class="form-group" style="background: var(--gray-50); padding: 1rem; border-radius: 8px;">
                                <label style="font-weight: 600; margin-bottom: 0.75rem; display: block;">Assignment Method</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                    <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; cursor: pointer;">
                                        <input type="radio" name="assignMethod" value="auto" style="margin-right: 0.5rem;">
                                        <div>
                                            <div style="font-weight: 600; font-size: 0.875rem;">Auto-Assign</div>
                                            <div style="font-size: 0.75rem; color: var(--gray-600);">Best available</div>
                                        </div>
                                    </label>
                                    <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid var(--primary); border-radius: 8px; cursor: pointer; background: var(--primary-light);">
                                        <input type="radio" name="assignMethod" value="specific" checked style="margin-right: 0.5rem;">
                                        <div>
                                            <div style="font-weight: 600; font-size: 0.875rem;">Specific Vendor</div>
                                            <div style="font-size: 0.75rem; color: var(--gray-600);">Choose vendor</div>
                                        </div>
                                    </label>
                                    <label style="display: flex; align-items: center; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; cursor: pointer;">
                                        <input type="radio" name="assignMethod" value="bid" style="margin-right: 0.5rem;">
                                        <div>
                                            <div style="font-weight: 600; font-size: 0.875rem;">Request Bids</div>
                                            <div style="font-size: 0.75rem; color: var(--gray-600);">Multiple quotes</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Vendor Selection (shown by default) -->
                            <div class="form-group" id="vendorSelection">
                                <label style="font-weight: 600;">Select Vendor</label>
                                <select style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="">Choose vendor...</option>
                                    <optgroup label="Preferred Vendors">
                                        <option value="seattle-hvac">Seattle HVAC Pro (4.8★)</option>
                                        <option value="cooltech">CoolTech Services (4.5★)</option>
                                        <option value="sparkle">Sparkle Clean Co (4.9★)</option>
                                        <option value="elite">Elite Electrical (4.7★)</option>
                                    </optgroup>
                                    <optgroup label="Other Vendors">
                                        <option value="quickfix">QuickFix HVAC (4.2★)</option>
                                        <option value="reliable">Reliable Plumbing (4.3★)</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <!-- Budget -->
                            <div class="form-group">
                                <label style="font-weight: 600;">Estimated Budget (Optional)</label>
                                <input type="number" placeholder="Enter amount..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            
                            <!-- Attachments -->
                            <div class="form-group">
                                <label style="font-weight: 600;">Attachments</label>
                                <div style="border: 2px dashed var(--gray-300); border-radius: 8px; padding: 2rem; text-align: center; background: var(--gray-50);">
                                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
                                        Add Photos/Documents
                                    </button>
                                    <input type="file" id="fileInput" multiple style="display: none;" accept="image/*,.pdf,.doc,.docx">
                                    <p style="margin-top: 0.5rem; color: var(--gray-600); font-size: 0.875rem;">
                                        Drop files here or click to upload
                                    </p>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="document.getElementById('createWorkOrderForm').dispatchEvent(new Event('submit'))">Create Work Order</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Handle assignment method changes
            modal.querySelectorAll('input[name="assignMethod"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const vendorSelection = document.getElementById('vendorSelection');
                    modal.querySelectorAll('input[name="assignMethod"]').forEach(r => {
                        r.parentElement.style.borderColor = 'var(--gray-200)';
                        r.parentElement.style.background = 'white';
                    });
                    this.parentElement.style.borderColor = 'var(--primary)';
                    this.parentElement.style.background = 'var(--primary-light)';
                    
                    if (this.value === 'specific') {
                        vendorSelection.style.display = 'block';
                    } else {
                        vendorSelection.style.display = 'none';
                    }
                });
            });
        }
        window.showCreateWorkOrderModal = showCreateWorkOrderModal;
        
        function updateServiceTypes(category) {
            const serviceTypeSelect = document.getElementById('serviceTypeSelect');
            const serviceTypes = {
                hvac: ['AC Repair', 'Heating Repair', 'Filter Replacement', 'System Inspection', 'Emergency Repair'],
                plumbing: ['Leak Repair', 'Drain Cleaning', 'Pipe Repair', 'Water Heater', 'Emergency Service'],
                electrical: ['Outlet Repair', 'Lighting Issue', 'Circuit Breaker', 'Wiring Repair', 'Emergency Service'],
                appliance: ['Refrigerator', 'Freezer', 'Dishwasher', 'Oven/Stove', 'Other Appliance'],
                cleaning: ['Deep Clean', 'Regular Service', 'Grease Trap', 'Hood Cleaning', 'Carpet Cleaning'],
                pest: ['Inspection', 'Treatment', 'Prevention', 'Emergency Service'],
                maintenance: ['General Repair', 'Painting', 'Carpentry', 'Other Maintenance'],
                emergency: ['Immediate Response Required']
            };
            
            serviceTypeSelect.innerHTML = '<option value="">Select service type...</option>';
            if (serviceTypes[category]) {
                serviceTypes[category].forEach(type => {
                    serviceTypeSelect.innerHTML += `<option value="${type.toLowerCase().replace(/\s+/g, '-')}">${type}</option>`;
                });
            }
        }
        window.updateServiceTypes = updateServiceTypes;
        
        async function submitWorkOrder(event) {
            event.preventDefault();
            
            // Get form data
            const form = event.target;
            const formData = new FormData(form);
            
            // Generate order number
            const orderNumber = 'WO-' + new Date().getFullYear() + '-' + String(Math.floor(Math.random() * 100000)).padStart(5, '0');
            
            // Prepare work order data - using common column names
            const workOrderData = {
                title: `Work Order ${orderNumber}`,
                description: form.querySelector('[name="description"]')?.value || form.querySelector('textarea')?.value || '',
                status: 'pending',
                priority: form.querySelector('[name="priority"]')?.value || form.querySelectorAll('select')[1]?.value || 'standard',
                location: form.querySelector('[name="client_location"]')?.value || form.querySelector('select')?.value,
                category: form.querySelector('[name="service_category"]')?.value || form.querySelectorAll('select')[2]?.value || 'hvac',
                notes: form.querySelector('[name="notes"]')?.value || '',
                created_at: new Date().toISOString()
            };
            
            try {
                // Insert into Supabase
                const { data, error } = await supabase
                    .from('work_orders')
                    .insert([workOrderData])
                    .select();
                
                if (error) {
                    console.error('Error creating work order:', error);
                    showToast('Error creating work order. Please try again.', 'error');
                } else {
                    showToast('Work order created successfully!', 'success');
                    document.querySelector('.modal.active').remove();
                    // Reload the work orders section to show the new order
                    if (window.loadSection) {
                        window.loadSection('work-orders');
                    }
                }
            } catch (err) {
                console.error('Unexpected error:', err);
                showToast('Error creating work order. Please try again.', 'error');
            }
        }
        window.submitWorkOrder = submitWorkOrder;
        
        function addChecklistItem() {
            const input = document.querySelector('#checklistItems input[type="text"]');
            const itemText = input.value.trim();
            
            if (itemText) {
                const itemsList = document.getElementById('checklistItemsList');
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; margin-bottom: 0.25rem;';
                itemDiv.innerHTML = `
                    <input type="checkbox" checked>
                    <span style="flex: 1;">${itemText}</span>
                    <button type="button" onclick="this.parentElement.remove()" style="background: none; border: none; color: var(--gray-500); cursor: pointer;">✕</button>
                `;
                itemsList.appendChild(itemDiv);
                input.value = '';
            }
        }
        window.addChecklistItem = addChecklistItem;
        
        function toggleAssignmentMethod(method) {
            const directSection = document.getElementById('directAssignmentSection');
            const bidSection = document.getElementById('bidRequestSection');
            const labels = document.querySelectorAll('input[name="assignmentMethod"]').forEach(radio => {
                const label = radio.parentElement;
                if (radio.value === method) {
                    label.style.borderColor = 'var(--primary)';
                    label.style.background = 'var(--primary-light)';
                } else {
                    label.style.borderColor = 'var(--gray-200)';
                    label.style.background = 'white';
                }
            });
            
            if (method === 'direct') {
                directSection.style.display = 'block';
                bidSection.style.display = 'none';
            } else {
                directSection.style.display = 'none';
                bidSection.style.display = 'block';
            }
        }
        window.toggleAssignmentMethod = toggleAssignmentMethod;
        
        function updatePricingDisplay() {
            const techSelect = document.getElementById('techAssignment');
            const priceInput = document.getElementById('servicePrice');
            const platformFeePercent = document.getElementById('platformFeePercent');
            
            // Auto-fill price if tech is selected
            if (techSelect && techSelect.selectedOptions[0] && techSelect.selectedOptions[0].dataset.rate) {
                const rate = parseFloat(techSelect.selectedOptions[0].dataset.rate);
                if (!priceInput.value) {
                    priceInput.value = rate;
                }
            }
            
            const servicePrice = parseFloat(priceInput?.value || 0);
            const platformFee = servicePrice * (parseFloat(platformFeePercent?.value || 15) / 100);
            const total = servicePrice + platformFee;
            
            // Update displays
            const serviceCostDisplay = document.getElementById('serviceCostDisplay');
            const platformFeeDisplay = document.getElementById('platformFeeDisplay');
            const totalCostDisplay = document.getElementById('totalCostDisplay');
            
            if (serviceCostDisplay) serviceCostDisplay.textContent = `$${servicePrice.toFixed(2)}`;
            if (platformFeeDisplay) platformFeeDisplay.textContent = platformFee.toFixed(2);
            if (totalCostDisplay) totalCostDisplay.textContent = `$${total.toFixed(2)}`;
        }
        window.updatePricingDisplay = updatePricingDisplay;
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            
            toast.style.cssText = `
                background: white;
                border-left: 4px solid ${colors[type]};
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                padding: 1rem 1.5rem;
                margin-bottom: 1rem;
                border-radius: 6px;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                min-width: 300px;
                animation: slideIn 0.3s ease-out;
            `;
            
            const icon = {
                success: 'Success',
                error: '✕',
                warning: 'Warning',
                info: 'Info'
            };
            
            toast.innerHTML = `
                <span style="color: ${colors[type]}; font-size: 1.25rem;">${icon[type]}</span>
                <span style="color: var(--gray-700);">${message}</span>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Work Orders Filter Function
        function filterWorkOrders() {
            const searchTerm = document.getElementById('workOrderSearch')?.value.toLowerCase() || '';
            const dateRange = document.getElementById('dateRangeFilter')?.value || '';
            const status = document.getElementById('statusFilter')?.value || '';
            const priority = document.getElementById('priorityFilter')?.value || '';
            
            const rows = document.querySelectorAll('#workOrdersTable tbody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const woNumber = row.cells[1]?.textContent.toLowerCase() || '';
                const location = row.cells[2]?.textContent.toLowerCase() || '';
                const type = row.cells[3]?.textContent.toLowerCase() || '';
                const rowStatus = row.cells[5]?.textContent.toLowerCase() || '';
                const rowPriority = row.cells[4]?.textContent.toLowerCase() || '';
                
                const matchesSearch = !searchTerm || 
                    woNumber.includes(searchTerm) || 
                    location.includes(searchTerm) || 
                    type.includes(searchTerm);
                
                const matchesStatus = !status || rowStatus.includes(status);
                const matchesPriority = !priority || 
                    (priority === 'emergency' && rowPriority.includes('emer')) ||
                    (priority === 'urgent' && rowPriority.includes('urg')) ||
                    (priority === 'standard' && rowPriority.includes('std'));
                
                // For date range, you'd need actual date data
                const matchesDate = true; // Simplified for demo
                
                if (matchesSearch && matchesStatus && matchesPriority && matchesDate) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update results count
            if (document.getElementById('workOrderSearch')?.value) {
                showToast(`Found ${visibleCount} matching work orders`, 'info');
            }
        }
        
        // Bulk Selection Functions
        function toggleAllWorkOrders() {
            const selectAll = document.getElementById('selectAllWO');
            const checkboxes = document.querySelectorAll('.wo-checkbox');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
            
            updateBulkSelection();
        }
        
        function updateBulkSelection() {
            const checked = document.querySelectorAll('.wo-checkbox:checked');
            const bulkBar = document.getElementById('bulkActionsBar');
            const selectedCount = document.getElementById('selectedCount');
            
            if (checked.length > 0) {
                bulkBar.style.display = 'block';
                selectedCount.textContent = checked.length;
            } else {
                bulkBar.style.display = 'none';
            }
        }
        
        function clearSelection() {
            document.querySelectorAll('.wo-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAllWO').checked = false;
            updateBulkSelection();
        }
        
        function bulkAssign() {
            const selected = document.querySelectorAll('.wo-checkbox:checked');
            const woNumbers = Array.from(selected).map(cb => cb.dataset.wo);
            
            const tech = prompt('Enter technician name to assign to ' + woNumbers.length + ' work orders:');
            if (tech) {
                showToast(`Assigned ${woNumbers.length} work orders to ${tech}`, 'success');
                clearSelection();
            }
        }
        
        function bulkSchedule() {
            const selected = document.querySelectorAll('.wo-checkbox:checked');
            const woNumbers = Array.from(selected).map(cb => cb.dataset.wo);
            
            const date = prompt('Enter schedule date for ' + woNumbers.length + ' work orders (YYYY-MM-DD):');
            if (date) {
                showToast(`Scheduled ${woNumbers.length} work orders for ${date}`, 'success');
                clearSelection();
            }
        }
        
        function bulkUpdateStatus() {
            const selected = document.querySelectorAll('.wo-checkbox:checked');
            const woNumbers = Array.from(selected).map(cb => cb.dataset.wo);
            
            const status = prompt('Enter new status (open/progress/hold/completed):');
            if (status) {
                showToast(`Updated status to "${status}" for ${woNumbers.length} work orders`, 'success');
                clearSelection();
            }
        }
        
        // Export to CSV Function
        function exportToCSV(type) {
            let data = [];
            let filename = '';
            
            if (type === 'workorders') {
                const table = document.getElementById('workOrdersTable');
                const rows = table.querySelectorAll('tr');
                
                rows.forEach((row, index) => {
                    const rowData = [];
                    const cells = index === 0 ? row.querySelectorAll('th') : row.querySelectorAll('td');
                    
                    cells.forEach((cell, cellIndex) => {
                        // Skip checkbox column
                        if (cellIndex > 0) {
                            rowData.push(cell.textContent.trim());
                        }
                    });
                    
                    if (rowData.length > 0) {
                        data.push(rowData.join(','));
                    }
                });
                
                filename = 'work_orders_' + new Date().toISOString().split('T')[0] + '.csv';
            } else if (type === 'invoices') {
                // Similar logic for invoices
                filename = 'invoices_' + new Date().toISOString().split('T')[0] + '.csv';
            }
            
            const csvContent = data.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            
            showToast(`Exported ${data.length - 1} records to ${filename}`, 'success');
        }
        
        // Keyboard shortcuts removed per user request
        
        // RFP Functions
        function filterRFPs() {
            const searchTerm = document.getElementById('rfpSearch')?.value.toLowerCase() || '';
            const status = document.getElementById('rfpStatusFilter')?.value || '';
            
            const rows = document.querySelectorAll('#rfpTable tbody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const rfpNumber = row.cells[0]?.textContent.toLowerCase() || '';
                const title = row.cells[1]?.textContent.toLowerCase() || '';
                const client = row.cells[2]?.textContent.toLowerCase() || '';
                const type = row.cells[3]?.textContent.toLowerCase() || '';
                const rowStatus = row.cells[6]?.textContent.toLowerCase() || '';
                
                const matchesSearch = !searchTerm || 
                    rfpNumber.includes(searchTerm) || 
                    title.includes(searchTerm) || 
                    client.includes(searchTerm) ||
                    type.includes(searchTerm);
                
                const matchesStatus = !status || rowStatus.includes(status);
                
                if (matchesSearch && matchesStatus) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            if (searchTerm) {
                showToast(`Found ${visibleCount} matching RFPs`, 'info');
            }
        }
        
        function filterRFPsByStatus(status) {
            document.getElementById('rfpStatusFilter').value = status;
            filterRFPs();
        }
        
        function switchRFPTab(tab) {
            // Update tab styles
            const tabs = document.querySelectorAll('.rfp-tab');
            tabs.forEach(t => {
                t.classList.remove('active');
                t.style.borderBottomColor = 'transparent';
                t.style.color = 'var(--gray-600)';
            });
            
            // Set active tab
            const activeTab = event.target.closest('.rfp-tab');
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.borderBottomColor = 'var(--primary)';
                activeTab.style.color = 'var(--gray-900)';
            }
            
            // Filter RFPs based on tab
            if (tab === 'all') {
                document.getElementById('rfpStatusFilter').value = '';
            } else {
                document.getElementById('rfpStatusFilter').value = tab;
            }
            filterRFPs();
        }
        
        function viewRFPDetail(rfpId) {
            // Create and show RFP detail modal
            const modalHtml = `
                <div id="rfpDetailModal" class="modal active">
                    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2>RFP Details - ${rfpId}</h2>
                            <button class="modal-close" onclick="closeRFPDetailModal()">×</button>
                        </div>
                        <div class="modal-body" style="padding: 2rem;">
                            <!-- RFP Overview -->
                            <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                                <h3 style="color: var(--primary); margin-bottom: 1rem;">Kitchen Equipment Replacement</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label style="font-weight: 600; color: #666;">RFP Number:</label>
                                        <p style="margin: 0.25rem 0;">${rfpId}</p>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; color: #666;">Status:</label>
                                        <p style="margin: 0.25rem 0;"><span class="badge badge-warning">Open</span></p>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; color: #666;">Due Date:</label>
                                        <p style="margin: 0.25rem 0;">Feb 15, 2025</p>
                                    </div>
                                    <div>
                                        <label style="font-weight: 600; color: #666;">Location:</label>
                                        <p style="margin: 0.25rem 0;">123 Main St, Los Angeles, CA</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Scope of Work -->
                            <div style="margin-bottom: 2rem;">
                                <h4 style="color: var(--primary); margin-bottom: 1rem;">Scope of Work</h4>
                                <div style="background: white; border: 1px solid #e0e0e0; padding: 1rem; border-radius: 8px;">
                                    <ul style="margin: 0; padding-left: 1.5rem;">
                                        <li>Remove and dispose of existing commercial kitchen equipment</li>
                                        <li>Install new commercial grade refrigerator (48" wide)</li>
                                        <li>Install new 6-burner gas range with convection oven</li>
                                        <li>Install new stainless steel prep tables (3 units)</li>
                                        <li>Connect all equipment to existing utilities</li>
                                        <li>Ensure all installations meet health code requirements</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Requirements -->
                            <div style="margin-bottom: 2rem;">
                                <h4 style="color: var(--primary); margin-bottom: 1rem;">Requirements</h4>
                                <div style="background: white; border: 1px solid #e0e0e0; padding: 1rem; border-radius: 8px;">
                                    <ul style="margin: 0; padding-left: 1.5rem;">
                                        <li>Must be licensed and insured</li>
                                        <li>Experience with commercial kitchen equipment required</li>
                                        <li>Work must be completed within 5 business days</li>
                                        <li>Warranty required on all installations</li>
                                        <li>Must provide references from similar projects</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Documents -->
                            <div style="margin-bottom: 2rem;">
                                <h4 style="color: var(--primary); margin-bottom: 1rem;">Attachments</h4>
                                <div style="background: white; border: 1px solid #e0e0e0; padding: 1rem; border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                        <span style="color: #666;">📄</span>
                                        <a href="#" style="color: var(--primary);">Kitchen_Layout.pdf</a>
                                        <span style="color: #999; font-size: 0.875rem;">(245 KB)</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <span style="color: #666;">📄</span>
                                        <a href="#" style="color: var(--primary);">Equipment_Specifications.pdf</a>
                                        <span style="color: #999; font-size: 0.875rem;">(512 KB)</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button class="btn btn-secondary" onclick="closeRFPDetailModal()">Close</button>
                                <button class="btn btn-primary" onclick="openProposalForm('${rfpId}')">Submit Proposal</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove any existing modal
            const existingModal = document.getElementById('rfpDetailModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeRFPDetailModal() {
            const modal = document.getElementById('rfpDetailModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function openProposalForm(rfpId) {
            closeRFPDetailModal();
            submitProposal(rfpId);
        }
        
        function submitProposal(rfpId) {
            // Create proposal submission modal
            const modalHtml = `
                <div id="proposalModal" class="modal active">
                    <div class="modal-content" style="max-width: 700px;">
                        <div class="modal-header">
                            <h2>Submit Proposal - ${rfpId}</h2>
                            <button class="modal-close" onclick="closeProposalModal()">×</button>
                        </div>
                        <div class="modal-body">
                            <form id="proposalForm" onsubmit="sendProposal(event, '${rfpId}')">
                                <div class="form-group">
                                    <label>Proposal Title</label>
                                    <input type="text" class="form-control" placeholder="Kitchen Equipment Replacement Proposal" required>
                                </div>
                                
                                <div class="form-group">
                                    <label>Executive Summary</label>
                                    <textarea class="form-control" rows="4" placeholder="Brief overview of your proposal..." required></textarea>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label>Proposed Amount</label>
                                        <input type="number" class="form-control" placeholder="25000" min="0" step="0.01" required>
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label>Completion Time</label>
                                        <input type="text" class="form-control" placeholder="5 business days" required>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Detailed Scope</label>
                                    <textarea class="form-control" rows="6" placeholder="Detailed description of work to be performed..." required></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label>Attachments</label>
                                    <input type="file" class="form-control" multiple accept=".pdf,.doc,.docx,.xls,.xlsx">
                                    <small class="text-muted">Upload supporting documents (PDF, DOC, XLS)</small>
                                </div>
                                
                                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                                    <button type="button" class="btn btn-secondary" onclick="closeProposalModal()">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Submit Proposal</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove any existing modal
            const existingModal = document.getElementById('proposalModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeProposalModal() {
            const modal = document.getElementById('proposalModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function sendProposal(event, rfpId) {
            event.preventDefault();
            showToast(`Proposal submitted for ${rfpId}`, 'success');
            closeProposalModal();
        }
        
        function markInterested(rfpId) {
            showToast(`Marked as interested in ${rfpId}`, 'success');
            // Update the button and status
            event.target.textContent = 'Submit';
            event.target.classList.remove('btn-secondary');
            event.target.classList.add('btn-primary');
            event.target.onclick = () => submitProposal(rfpId);
        }
        
        function viewSubmission(rfpId) {
            showToast(`Opening your submission for ${rfpId}...`, 'info');
        }
        
        function viewContract(rfpId) {
            showToast(`Opening contract for ${rfpId}...`, 'info');
        }
        
        // Quote Editor Functions
        function createNewQuote() {
            loadSection('quote-editor', 'new');
        }
        
        function formatText(command) {
            const editor = document.getElementById('scopeEditor');
            if (!editor) return;
            
            switch(command) {
                case 'bold':
                    document.execCommand('bold', false, null);
                    break;
                case 'italic':
                    document.execCommand('italic', false, null);
                    break;
                case 'underline':
                    document.execCommand('underline', false, null);
                    break;
                case 'list':
                    document.execCommand('insertUnorderedList', false, null);
                    break;
                case 'number':
                    document.execCommand('insertOrderedList', false, null);
                    break;
            }
            editor.focus();
        }
        
        let costItems = [];
        let totalBeforeTax = 0;
        let categoryTotals = {
            incurred: 0,
            labor: 0,
            parts: 0,
            equipment: 0,
            travel: 0
        };
        
        function addCostLine(type, description, amount) {
            const item = { type, description, amount: parseFloat(amount) || 0 };
            costItems.push(item);
            updateCostDisplay();
            showToast(`Added ${type}: $${amount}`, 'success');
        }
        
        function updateCategoryTotal(category) {
            const amount = parseFloat(document.getElementById(category + 'CostAmount').value) || 0;
            const totalElement = document.getElementById(category + 'Total');
            if (totalElement) {
                totalElement.textContent = '$' + amount.toFixed(2);
            }
            calculateTotalBeforeTax();
        }

        function calculateTotalBeforeTax() {
            let total = 0;
            Object.keys(categoryTotals).forEach(category => {
                const amount = parseFloat(document.getElementById(category + 'CostAmount').value) || 0;
                categoryTotals[category] = amount;
                total += amount;
            });
            totalBeforeTax = total;
            updateTotals();
        }

        function addIncurredCost() {
            const description = document.getElementById('incurredCostDescription').value || 'Incurred Cost';
            const amount = document.getElementById('incurredCostAmount').value;
            if (amount && parseFloat(amount) > 0) {
                addCostLine('Incurred Cost', description, amount);
                // Reset the inputs after adding
                document.getElementById('incurredCostDescription').value = '';
                document.getElementById('incurredCostAmount').value = '';
                updateCategoryTotal('incurred');
                showToast(`Added incurred cost: $${amount}`, 'success');
            }
        }
        
        // Auto-calculate labor cost when fields change
        function calculateLaborCost() {
            const tasks = parseFloat(document.getElementById('laborTasks').value) || 0;
            const days = parseFloat(document.getElementById('laborDays').value) || 0;
            const rate = parseFloat(document.getElementById('laborRate').value) || 0;
            const total = tasks * days * rate;
            document.getElementById('laborCostAmount').value = total.toFixed(2);
            updateCategoryTotal('labor');
        }

        function addLaborCost() {
            const taskType = document.getElementById('laborTaskType').value || 'Labor';
            const tasks = document.getElementById('laborTasks').value || '1';
            const days = document.getElementById('laborDays').value || '1';
            const rate = document.getElementById('laborRate').value || '0';
            const amount = document.getElementById('laborCostAmount').value;
            
            if (amount && parseFloat(amount) > 0) {
                const description = `${taskType} (${tasks} tasks × ${days} days × $${rate}/day)`;
                addCostLine('Labor', description, amount);
                // Reset the inputs after adding
                document.getElementById('laborTaskType').value = '';
                document.getElementById('laborTasks').value = '1';
                document.getElementById('laborDays').value = '1';
                document.getElementById('laborRate').value = '';
                document.getElementById('laborCostAmount').value = '';
                updateCategoryTotal('labor');
                showToast(`Added labor cost: $${amount}`, 'success');
            }
        }
        
        // Auto-calculate parts cost when fields change
        function calculatePartsCost() {
            const quantity = parseFloat(document.getElementById('partsQuantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('partsUnitPrice').value) || 0;
            const total = quantity * unitPrice;
            document.getElementById('partsCostAmount').value = total.toFixed(2);
            updateCategoryTotal('parts');
        }

        function addPartsCost() {
            const description = document.getElementById('partsDescription').value || 'Part';
            const partNumber = document.getElementById('partsNumber').value || '';
            const unitType = document.getElementById('partsUnitType').value || 'each';
            const quantity = document.getElementById('partsQuantity').value || '1';
            const unitPrice = document.getElementById('partsUnitPrice').value || '0';
            const amount = document.getElementById('partsCostAmount').value;
            
            if (amount && parseFloat(amount) > 0) {
                const partDesc = partNumber ? `${description} (${partNumber})` : description;
                const fullDescription = `${partDesc} - ${quantity} ${unitType} × $${unitPrice}`;
                addCostLine('Parts', fullDescription, amount);
                // Reset the inputs after adding
                document.getElementById('partsDescription').value = '';
                document.getElementById('partsNumber').value = '';
                document.getElementById('partsUnitType').value = 'each';
                document.getElementById('partsQuantity').value = '1';
                document.getElementById('partsUnitPrice').value = '';
                document.getElementById('partsCostAmount').value = '';
                updateCategoryTotal('parts');
                showToast(`Added parts cost: $${amount}`, 'success');
            }
        }
        
        function addEquipmentCost() {
            const description = document.getElementById('equipmentDescription').value || 'Equipment';
            const equipmentNumber = document.getElementById('equipmentNumber').value || '';
            const serialNumber = document.getElementById('equipmentSerial').value || '';
            const amount = document.getElementById('equipmentCostAmount').value;
            
            if (amount && parseFloat(amount) > 0) {
                let fullDescription = description;
                if (equipmentNumber) fullDescription += ` (${equipmentNumber})`;
                if (serialNumber) fullDescription += ` [${serialNumber}]`;
                
                addCostLine('Equipment', fullDescription, amount);
                // Reset the inputs after adding
                document.getElementById('equipmentDescription').value = '';
                document.getElementById('equipmentNumber').value = '';
                document.getElementById('equipmentSerial').value = '';
                document.getElementById('equipmentCostAmount').value = '';
                updateCategoryTotal('equipment');
                showToast(`Added equipment cost: $${amount}`, 'success');
            }
        }
        
        function addTravelCost() {
            const description = document.getElementById('travelDescription').value || 'Travel';
            const amount = document.getElementById('travelCostAmount').value;
            if (amount && parseFloat(amount) > 0) {
                addCostLine('Travel', description, amount);
                // Reset the inputs after adding
                document.getElementById('travelDescription').value = '';
                document.getElementById('travelCostAmount').value = '';
                updateCategoryTotal('travel');
                showToast(`Added travel cost: $${amount}`, 'success');
            }
        }

        // Proposal Builder Functions
        let proposalServiceCount = 1;
        let proposalEquipment = [];

        function initializeProposalBuilder() {
            // Set today's date
            const dateField = document.getElementById('proposalDate');
            if (dateField) {
                dateField.valueAsDate = new Date();
            }
            updateProposalPreview();
        }

        function initializeRecurringCalendar() {
            // Initialize the monthly calendar grid
            const monthGrid = document.getElementById('monthGrid');
            if (!monthGrid) return;

            const months = [
                'JAN', 'FEB', 'MAR', 'APR',
                'MAY', 'JUN', 'JUL', 'AUG', 
                'SEP', 'OCT', 'NOV', 'DEC'
            ];

            monthGrid.innerHTML = months.map((month, index) => `
                <div style="text-align: center; padding: 1rem; border: 2px solid var(--gray-300); border-radius: 8px; cursor: pointer; transition: all 0.3s ease; background: white;" 
                     onclick="toggleMonth(${index})" id="month-${index}">
                    <div style="font-weight: 600; font-size: 0.875rem; color: var(--gray-700);">${month}</div>
                </div>
            `).join('');

            // Set today's date as default next work order date
            const nextWorkOrderDate = document.getElementById('nextWorkOrderDate');
            if (nextWorkOrderDate) {
                const today = new Date();
                const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                nextWorkOrderDate.valueAsDate = nextWeek;
            }

            // Load existing recurring services
            loadRecurringServices();

            // Add event listeners for service frequency change
            const frequencyRadios = document.querySelectorAll('input[name="serviceFrequency"]');
            frequencyRadios.forEach(radio => {
                radio.addEventListener('change', toggleCalendarView);
            });
        }

        function toggleMonth(monthIndex) {
            const monthElement = document.getElementById(`month-${monthIndex}`);
            const isSelected = monthElement.style.background === 'var(--primary)';
            
            if (isSelected) {
                monthElement.style.background = 'white';
                monthElement.style.borderColor = 'var(--gray-300)';
                monthElement.style.color = 'var(--gray-700)';
            } else {
                monthElement.style.background = 'var(--primary)';
                monthElement.style.borderColor = 'var(--primary)';
                monthElement.style.color = 'white';
            }
        }

        function toggleCalendarView() {
            const monthlyCalendar = document.getElementById('monthlyCalendar');
            const selectedFrequency = document.querySelector('input[name="serviceFrequency"]:checked').value;
            
            if (selectedFrequency === 'monthly') {
                monthlyCalendar.style.display = 'block';
            } else {
                monthlyCalendar.style.display = 'none';
            }
        }

        function loadRecurringServices() {
            // This would typically fetch from the API endpoint that creates recurring work orders
            // For now, we'll show some example data
            const servicesList = document.getElementById('recurringServicesList');
            if (!servicesList) return;

            // Example recurring services data
            const exampleServices = [
                {
                    client: 'ABC Restaurant',
                    service: 'Monthly Cleaning Service',
                    nextDate: '2025-09-15',
                    frequency: 'Monthly',
                    status: 'Active'
                },
                {
                    client: 'XYZ Hotel',
                    service: 'HVAC Maintenance',
                    nextDate: '2025-09-22',
                    frequency: 'Quarterly',
                    status: 'Active'
                }
            ];

            if (exampleServices.length === 0) {
                servicesList.innerHTML = `
                    <div style="text-align: center; color: var(--gray-500); padding: 2rem;">
                        <p>No recurring services scheduled yet.</p>
                        <p>Approve a proposal to create automatic recurring work orders!</p>
                    </div>
                `;
                return;
            }

            servicesList.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--gray-200);">
                                <th style="text-align: left; padding: 0.75rem 0.5rem; font-weight: 600;">Client</th>
                                <th style="text-align: left; padding: 0.75rem 0.5rem; font-weight: 600;">Service</th>
                                <th style="text-align: left; padding: 0.75rem 0.5rem; font-weight: 600;">Next Date</th>
                                <th style="text-align: left; padding: 0.75rem 0.5rem; font-weight: 600;">Frequency</th>
                                <th style="text-align: left; padding: 0.75rem 0.5rem; font-weight: 600;">Status</th>
                                <th style="text-align: left; padding: 0.75rem 0.5rem; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${exampleServices.map(service => `
                                <tr style="border-bottom: 1px solid var(--gray-100);">
                                    <td style="padding: 0.75rem 0.5rem;">${service.client}</td>
                                    <td style="padding: 0.75rem 0.5rem;">${service.service}</td>
                                    <td style="padding: 0.75rem 0.5rem;">${new Date(service.nextDate).toLocaleDateString()}</td>
                                    <td style="padding: 0.75rem 0.5rem;">${service.frequency}</td>
                                    <td style="padding: 0.75rem 0.5rem;">
                                        <span style="background: var(--success); color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                                            ${service.status}
                                        </span>
                                    </td>
                                    <td style="padding: 0.75rem 0.5rem;">
                                        <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;" onclick="viewRecurringService('${service.client}')">
                                            View
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function addNewRecurringService() {
            alert('This feature connects to the Proposal Builder. Create and approve a proposal to automatically generate recurring work orders!');
            loadSection('proposal-builder');
        }

        function viewRecurringService(clientName) {
            alert(`Viewing recurring services for ${clientName}. This would show detailed service schedule and history.`);
        }

        // Work Orders Calendar Functions
        let currentDate = new Date();
        let currentView = 'month';

        function initializeWorkOrdersCalendar() {
            // Set initial view and render calendar
            currentDate = new Date();
            currentView = document.getElementById('calendarView').value || 'month';
            renderCalendar();
        }

        function changeCalendarView() {
            currentView = document.getElementById('calendarView').value;
            renderCalendar();
        }

        function previousPeriod() {
            switch(currentView) {
                case 'month':
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    break;
                case 'week':
                    currentDate.setDate(currentDate.getDate() - 7);
                    break;
                case 'day':
                    currentDate.setDate(currentDate.getDate() - 1);
                    break;
            }
            renderCalendar();
        }

        function nextPeriod() {
            switch(currentView) {
                case 'month':
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    break;
                case 'week':
                    currentDate.setDate(currentDate.getDate() + 7);
                    break;
                case 'day':
                    currentDate.setDate(currentDate.getDate() + 1);
                    break;
            }
            renderCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            renderCalendar();
        }

        function renderCalendar() {
            const periodElement = document.getElementById('currentPeriod');
            const calendarGrid = document.getElementById('calendarGrid');
            
            if (!periodElement || !calendarGrid) return;

            switch(currentView) {
                case 'month':
                    renderMonthView(periodElement, calendarGrid);
                    break;
                case 'week':
                    renderWeekView(periodElement, calendarGrid);
                    break;
                case 'day':
                    renderDayView(periodElement, calendarGrid);
                    break;
            }
        }

        function renderMonthView(periodElement, calendarGrid) {
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            
            periodElement.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const workOrders = getWorkOrdersForMonth(currentDate);
            
            let calendarHTML = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--gray-200);">
                    ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => 
                        `<div style="background: var(--gray-50); padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.875rem;">${day}</div>`
                    ).join('')}
            `;

            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const isCurrentMonth = date.getMonth() === currentDate.getMonth();
                const isToday = date.toDateString() === new Date().toDateString();
                const dayWorkOrders = workOrders.filter(wo => wo.date.toDateString() === date.toDateString());
                
                calendarHTML += `
                    <div style="background: white; min-height: 100px; padding: 0.5rem; ${!isCurrentMonth ? 'opacity: 0.3;' : ''} ${isToday ? 'border: 2px solid var(--primary);' : 'border: 1px solid var(--gray-200);'}" onclick="openDayDetail('${date.toISOString()}')">
                        <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem; ${isToday ? 'color: var(--primary);' : ''}">${date.getDate()}</div>
                        ${dayWorkOrders.map(wo => `
                            <div style="background: ${getStatusColor(wo.status)}; color: white; padding: 0.125rem 0.25rem; margin-bottom: 0.125rem; border-radius: 3px; font-size: 0.75rem; cursor: pointer;" onclick="event.stopPropagation(); viewWorkOrder('${wo.id}')">
                                ${wo.title}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            calendarHTML += '</div>';
            calendarGrid.innerHTML = calendarHTML;
        }

        function renderWeekView(periodElement, calendarGrid) {
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            periodElement.textContent = `${startOfWeek.toLocaleDateString()} - ${endOfWeek.toLocaleDateString()}`;
            
            const workOrders = getWorkOrdersForWeek(startOfWeek);
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            let calendarHTML = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1rem;">';
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const isToday = date.toDateString() === new Date().toDateString();
                const dayWorkOrders = workOrders.filter(wo => wo.date.toDateString() === date.toDateString());
                
                calendarHTML += `
                    <div style="border: 1px solid var(--gray-200); border-radius: 8px; padding: 1rem; background: white; ${isToday ? 'border-color: var(--primary); box-shadow: 0 0 10px rgba(30, 58, 138, 0.1);' : ''}">
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-weight: 600; color: var(--gray-600);">${days[i]}</div>
                            <div style="font-size: 1.25rem; font-weight: 700; ${isToday ? 'color: var(--primary);' : ''}">${date.getDate()}</div>
                        </div>
                        <div>
                            ${dayWorkOrders.map(wo => `
                                <div style="background: ${getStatusColor(wo.status)}; color: white; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 6px; font-size: 0.875rem; cursor: pointer;" onclick="viewWorkOrder('${wo.id}')">
                                    <div style="font-weight: 600;">${wo.title}</div>
                                    <div style="opacity: 0.9; font-size: 0.75rem;">${wo.client}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            calendarHTML += '</div>';
            calendarGrid.innerHTML = calendarHTML;
        }

        function renderDayView(periodElement, calendarGrid) {
            periodElement.textContent = currentDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const workOrders = getWorkOrdersForDay(currentDate);
            
            let calendarHTML = `
                <div style="background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 2rem;">
                    <h3 style="margin-bottom: 1.5rem; color: var(--primary);">Work Orders for ${currentDate.toLocaleDateString()}</h3>
            `;
            
            if (workOrders.length === 0) {
                calendarHTML += '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">No work orders scheduled for this day.</p>';
            } else {
                workOrders.forEach(wo => {
                    calendarHTML += `
                        <div style="border: 1px solid var(--gray-200); border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; cursor: pointer; transition: all 0.3s ease;" onclick="viewWorkOrder('${wo.id}')" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h4 style="color: var(--gray-900); margin: 0;">${wo.title}</h4>
                                <span style="background: ${getStatusColor(wo.status)}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${wo.status}</span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; font-size: 0.875rem; color: var(--gray-600);">
                                <div><strong>Client:</strong> ${wo.client}</div>
                                <div><strong>Time:</strong> ${wo.time || 'TBD'}</div>
                                <div><strong>Priority:</strong> ${wo.priority}</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            calendarHTML += '</div>';
            calendarGrid.innerHTML = calendarHTML;
        }

        function getStatusColor(status) {
            switch(status.toLowerCase()) {
                case 'scheduled': return '#22c55e';
                case 'in progress': return '#3b82f6';
                case 'pending': return '#f59e0b';
                case 'overdue': return '#ef4444';
                case 'recurring': return '#8b5cf6';
                default: return '#6b7280';
            }
        }

        function getWorkOrdersForMonth(date) {
            // Sample work orders - in real app, this would fetch from API
            return [
                { id: 'WO-001', title: 'HVAC Maintenance', client: 'ABC Restaurant', date: new Date(2025, 7, 28), status: 'Scheduled', priority: 'High', time: '09:00 AM' },
                { id: 'WO-002', title: 'Kitchen Cleaning', client: 'XYZ Hotel', date: new Date(2025, 7, 30), status: 'In Progress', priority: 'Medium', time: '02:00 PM' },
                { id: 'WO-003', title: 'Floor Maintenance', client: 'DEF Office', date: new Date(2025, 8, 2), status: 'Pending', priority: 'Low', time: '10:00 AM' },
                { id: 'WO-004', title: 'Window Cleaning', client: 'GHI Store', date: new Date(2025, 8, 5), status: 'Scheduled', priority: 'Medium', time: '08:00 AM' },
                { id: 'WO-005', title: 'Monthly Cleaning', client: 'ABC Restaurant', date: new Date(2025, 8, 15), status: 'Recurring', priority: 'Normal', time: '11:00 PM' },
                { id: 'WO-006', title: 'Equipment Check', client: 'JKL Factory', date: new Date(2025, 8, 18), status: 'Overdue', priority: 'High', time: '07:00 AM' }
            ];
        }

        function getWorkOrdersForWeek(startDate) {
            const allOrders = getWorkOrdersForMonth(startDate);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            
            return allOrders.filter(wo => wo.date >= startDate && wo.date <= endDate);
        }

        function getWorkOrdersForDay(date) {
            const allOrders = getWorkOrdersForMonth(date);
            return allOrders.filter(wo => wo.date.toDateString() === date.toDateString());
        }

        function openDayDetail(dateString) {
            const date = new Date(dateString);
            currentDate = date;
            currentView = 'day';
            document.getElementById('calendarView').value = 'day';
            renderCalendar();
        }

        function viewWorkOrder(workOrderId) {
            // Navigate to work order detail
            loadSection('work-order-detail', workOrderId);
        }

        function addProposalService() {
            const servicesList = document.getElementById('servicesList');
            const serviceItem = document.createElement('div');
            serviceItem.style.cssText = 'background: var(--gray-50); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;';
            serviceItem.innerHTML = `
                <div class="form-grid" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: center; margin-bottom: 0.5rem;">
                    <input type="text" placeholder="Service Name" id="service-${proposalServiceCount}-name" onchange="updateProposalPreview()" 
                        style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                    <select id="service-${proposalServiceCount}-frequency" onchange="updateProposalPreview()" 
                        style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                        <option value="Monthly">Monthly</option>
                        <option value="Quarterly">Quarterly</option>
                        <option value="Bi-Annual">Bi-Annual</option>
                        <option value="Annual">Annual</option>
                    </select>
                    <input type="number" placeholder="Price" id="service-${proposalServiceCount}-price" onchange="updateProposalPreview()" 
                        style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; text-align: right;">
                    <button class="btn btn-danger" onclick="removeProposalService(${proposalServiceCount})" style="padding: 0.5rem 0.75rem; font-size: 0.875rem;">Remove</button>
                </div>
                <input type="text" placeholder="Notes/Equipment" id="service-${proposalServiceCount}-notes" onchange="updateProposalPreview()" 
                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
            `;
            servicesList.appendChild(serviceItem);
            proposalServiceCount++;
        }

        function removeProposalService(id) {
            const service = document.querySelector(`#service-${id}-name`)?.closest('div[style*="background: var(--gray-50)"]');
            if (service) {
                service.remove();
                updateProposalPreview();
            }
        }

        let currentProposalType = 'maintenance';
        let cleaningAreas = [];
        let cleaningPricingModel = 'detailed';
        let simpleCleaningData = null;
        
        function switchProposalType(type) {
            currentProposalType = type;
            const maintenanceSection = document.getElementById('maintenanceSection');
            const cleaningSection = document.getElementById('cleaningSection');
            const coverageTitle = document.getElementById('coverageTitle');
            
            if (type === 'cleaning') {
                maintenanceSection.style.display = 'none';
                cleaningSection.style.display = 'block';
                coverageTitle.textContent = 'Cleaning Services';
            } else if (type === 'maintenance') {
                maintenanceSection.style.display = 'block';
                cleaningSection.style.display = 'none';
                coverageTitle.textContent = 'Equipment Coverage';
            } else if (type === 'combined') {
                maintenanceSection.style.display = 'block';
                cleaningSection.style.display = 'block';
                coverageTitle.textContent = 'Service Coverage';
            }
            updateProposalPreview();
        }
        window.switchProposalType = switchProposalType;
        
        function toggleCleaningPricingModel(model) {
            cleaningPricingModel = model;
            const detailedSection = document.getElementById('detailedCleaningSection');
            const simpleSection = document.getElementById('simpleCleaningSection');
            const priceLabel = document.getElementById('simplePriceLabel');
            
            if (model === 'detailed') {
                detailedSection.style.display = 'block';
                simpleSection.style.display = 'none';
            } else {
                detailedSection.style.display = 'none';
                simpleSection.style.display = 'block';
                
                // Update label based on model
                if (model === 'monthly') {
                    priceLabel.textContent = 'Monthly Cost';
                } else if (model === 'nightly') {
                    priceLabel.textContent = 'Nightly Rate';
                }
            }
            updateCoverageList();
            updateProposalPreview();
        }
        window.toggleCleaningPricingModel = toggleCleaningPricingModel;
        
        function addEquipmentItem() {
            const category = document.getElementById('equipmentCategory').value;
            const details = document.getElementById('equipmentDetails').value;
            
            if (category && details) {
                proposalEquipment.push({ category, details });
                updateCoverageList();
                document.getElementById('equipmentDetails').value = '';
                updateProposalPreview();
            }
        }
        
        function addCleaningArea() {
            const areaType = document.getElementById('areaType').value;
            const areaSize = document.getElementById('areaSize').value;
            const frequency = document.getElementById('cleaningFrequency').value;
            
            if (areaType && areaSize) {
                cleaningAreas.push({ area: areaType, size: areaSize, frequency });
                updateCoverageList();
                document.getElementById('areaType').value = '';
                document.getElementById('areaSize').value = '';
                updateProposalPreview();
            }
        }
        window.addCleaningArea = addCleaningArea;

        function updateCoverageList() {
            const list = document.getElementById('coverageList');
            let html = '';
            
            // Add equipment items if in maintenance or combined mode
            if (currentProposalType === 'maintenance' || currentProposalType === 'combined') {
                html += proposalEquipment.map((eq, index) => `
                    <span class="badge" style="background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 0.25rem;">
                        ${eq.category}: ${eq.details}
                        <span style="cursor: pointer; font-weight: bold; margin-left: 0.25rem;" onclick="removeEquipmentItem(${index})">×</span>
                    </span>
                `).join('');
            }
            
            // Add cleaning info based on pricing model
            if (currentProposalType === 'cleaning' || currentProposalType === 'combined') {
                if (cleaningPricingModel === 'detailed') {
                    // Show detailed areas
                    html += cleaningAreas.map((area, index) => `
                        <span class="badge" style="background: var(--success); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 0.25rem;">
                            🧹 ${area.area} (${area.size}) - ${area.frequency}
                            <span style="cursor: pointer; font-weight: bold; margin-left: 0.25rem;" onclick="removeCleaningArea(${index})">×</span>
                        </span>
                    `).join('');
                } else {
                    // Show simple pricing summary
                    const cost = document.getElementById('simpleCleaningCost')?.value;
                    const frequency = document.getElementById('simpleFrequency')?.value;
                    const times = document.getElementById('serviceTimes')?.value;
                    
                    if (cost || frequency || times) {
                        const priceType = cleaningPricingModel === 'monthly' ? 'Monthly' : 'Nightly';
                        html += `
                            <span class="badge" style="background: var(--success); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 0.25rem;">
                                🧹 ${priceType}: $${cost || '0'} - ${frequency || 'TBD'} ${times ? `(${times})` : ''}
                            </span>
                        `;
                    }
                }
            }
            
            list.innerHTML = html;
        }
        
        // For backward compatibility
        function updateEquipmentItemsList() {
            updateCoverageList();
        }

        function removeEquipmentItem(index) {
            proposalEquipment.splice(index, 1);
            updateCoverageList();
            updateProposalPreview();
        }
        
        function removeCleaningArea(index) {
            cleaningAreas.splice(index, 1);
            updateCoverageList();
            updateProposalPreview();
        }
        window.removeCleaningArea = removeCleaningArea;

        function updateProposalPreview() {
            // Update client info
            const clientName = document.getElementById('clientName')?.value || 'Client Name';
            const previewElements = ['previewClientName', 'previewClientName2', 'previewClient', 'previewClientSig'];
            previewElements.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = clientName;
            });
            
            // Update contact
            const contact = document.getElementById('clientContact')?.value || 'Contact Info';
            const contactEl = document.getElementById('previewContact');
            if (contactEl) contactEl.textContent = contact;
            
            // Update date
            const dateField = document.getElementById('proposalDate');
            const dateEl = document.getElementById('previewDate');
            if (dateField && dateEl && dateField.value) {
                const formatted = new Date(dateField.value).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                dateEl.textContent = formatted;
            }
            
            // Update locations
            const locations = document.getElementById('locations')?.value;
            const locationsEl = document.getElementById('previewLocations');
            if (locations && locationsEl) {
                locationsEl.textContent = `We will include all equipment at ${clientName} locations: ${locations}`;
            }
            
            // Update equipment
            const equipmentEl = document.getElementById('previewEquipment');
            if (equipmentEl && proposalEquipment.length > 0) {
                const grouped = {};
                proposalEquipment.forEach(eq => {
                    if (!grouped[eq.category]) grouped[eq.category] = [];
                    grouped[eq.category].push(eq.details);
                });
                
                const equipmentHtml = Object.entries(grouped).map(([cat, items]) => `
                    <p><strong>${cat}:</strong> ${items.join(', ')}</p>
                `).join('');
                equipmentEl.innerHTML = equipmentHtml;
            }
            
            // Update services table
            const services = [];
            let monthlyTotal = 0;
            
            for (let i = 0; i < proposalServiceCount; i++) {
                const nameEl = document.getElementById(`service-${i}-name`);
                if (nameEl && nameEl.value) {
                    const name = nameEl.value;
                    const frequency = document.getElementById(`service-${i}-frequency`).value;
                    const price = parseFloat(document.getElementById(`service-${i}-price`).value) || 0;
                    const notes = document.getElementById(`service-${i}-notes`).value;
                    
                    if (name && price > 0) {
                        services.push({ name, frequency, price, notes });
                        
                        // Calculate monthly equivalent
                        switch(frequency) {
                            case 'Monthly': monthlyTotal += price; break;
                            case 'Quarterly': monthlyTotal += price / 3; break;
                            case 'Bi-Annual': monthlyTotal += price / 6; break;
                            case 'Annual': monthlyTotal += price / 12; break;
                        }
                    }
                }
            }
            
            const servicesEl = document.getElementById('previewServices');
            const monthlyTotalEl = document.getElementById('monthlyTotal');
            
            if (servicesEl && services.length > 0) {
                const servicesHtml = services.map(s => `
                    <tr>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0;">${s.name}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0;">${s.frequency}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0;">${s.notes || '-'}</td>
                        <td style="padding: 0.75rem; border-bottom: 1px solid #e2e8f0;">$${s.price.toFixed(2)}</td>
                    </tr>
                `).join('');
                servicesEl.innerHTML = servicesHtml;
            }
            
            if (monthlyTotalEl) {
                monthlyTotalEl.textContent = monthlyTotal.toFixed(2);
            }
        }

        function exportProposalPDF() {
            showToast('PDF export will be available soon. For now, use Print to PDF (Ctrl+P)', 'info');
            window.print();
        }

        function sendProposalEmail() {
            const modal = document.getElementById('proposalEmailModal');
            if (modal) {
                modal.style.display = 'flex';
                const contact = document.getElementById('clientContact')?.value;
                const emailField = document.getElementById('proposalSendEmail');
                if (contact && contact.includes('@') && emailField) {
                    emailField.value = contact;
                }
            }
        }

        function closeProposalModal() {
            const modal = document.getElementById('proposalEmailModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function confirmProposalSend() {
            console.log('confirmProposalSend called');
            const email = document.getElementById('proposalSendEmail')?.value;
            const message = document.getElementById('proposalSendMessage')?.value;
            
            console.log('Email:', email, 'Message:', message);
            
            if (!email) {
                showToast('Please enter an email address', 'error');
                return;
            }
            
            // Get proposal data (similar structure to original)
            const proposalData = {
                clientName: document.getElementById('clientName')?.value,
                clientContact: document.getElementById('clientContact')?.value,
                clientEmail: email,
                locations: document.getElementById('locations')?.value,
                equipment: proposalEquipment,
                services: [],
                notes: message
            };
            
            // Collect services
            for (let i = 0; i < proposalServiceCount; i++) {
                const nameEl = document.getElementById(`service-${i}-name`);
                if (nameEl && nameEl.value) {
                    const name = nameEl.value;
                    const frequency = document.getElementById(`service-${i}-frequency`).value;
                    const price = parseFloat(document.getElementById(`service-${i}-price`).value) || 0;
                    const notes = document.getElementById(`service-${i}-notes`).value;
                    
                    if (name && frequency && price > 0) {
                        proposalData.services.push({ name, frequency, price, notes });
                    }
                }
            }
            
            if (proposalData.services.length === 0) {
                showToast('Please add at least one service before sending', 'error');
                return;
            }
            
            // Send proposal via Gmail SMTP
            try {
                showToast('Sending proposal...', 'info');
                
                // Collect simple cleaning data if applicable
                let simpleCleaningData = null;
                if (currentProposalType === 'cleaning' && cleaningPricingModel !== 'detailed') {
                    const cost = document.getElementById('simpleCleaningCost')?.value;
                    const frequency = document.getElementById('simpleFrequency')?.value;
                    const times = document.getElementById('serviceTimes')?.value;
                    const services = document.getElementById('servicesIncluded')?.value;
                    
                    if (cost) {
                        simpleCleaningData = {
                            type: cleaningPricingModel,
                            cost: parseFloat(cost),
                            frequency,
                            times,
                            services
                        };
                    }
                }
                
                // Enhanced proposal data
                const enhancedProposalData = {
                    ...proposalData,
                    facilityType: document.getElementById('facilityType')?.value,
                    squareFootage: document.getElementById('squareFootage')?.value
                };
                
                console.log('Sending proposal data:', {
                    clientName: proposalData.clientName,
                    clientEmail: email,
                    proposalData: enhancedProposalData,
                    message: message,
                    services: proposalData.services,
                    equipment: proposalEquipment,
                    cleaningAreas: cleaningAreas,
                    simpleCleaningData: simpleCleaningData,
                    proposalType: currentProposalType
                });
                
                const response = await fetch('/api/send-proposal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        clientName: proposalData.clientName,
                        clientEmail: email,
                        proposalData: enhancedProposalData,
                        message: message,
                        services: proposalData.services,
                        equipment: proposalEquipment,
                        cleaningAreas: cleaningAreas,
                        simpleCleaningData: simpleCleaningData,
                        proposalType: currentProposalType
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showToast(`${result.message}`, 'success');
                    closeProposalModal();
                    
                    // Reset modal fields
                    const emailField = document.getElementById('proposalSendEmail');
                    const messageField = document.getElementById('proposalSendMessage');
                    if (emailField) emailField.value = '';
                    if (messageField) messageField.value = '';
                } else {
                    throw new Error(result.error || 'Failed to send proposal');
                }
            } catch (error) {
                console.error('Error sending proposal:', error);
                showToast(`Error sending proposal: ${error.message}`, 'error');
            }
        }

        function showAddCategoryModal() {
            const name = prompt('Enter new equipment category name:');
            if (!name) return;
            
            const description = prompt('Enter category description (optional):') || '';
            
            // Add to dropdown
            const select = document.getElementById('equipmentCategory');
            if (select) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
                select.value = name;
                showToast('Category added successfully!', 'success');
            }
        }

        // Work Order Scheduled Email Template
        function generateWorkOrderScheduledEmail(workOrderData) {
            const { orderNumber, clientName, location, service, date, timeWindow, estimatedCost, clientEmail } = workOrderData;
            
            return {
                to: clientEmail,
                subject: `Service Scheduled - Work Order ${orderNumber}`,
                html: `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>Service Scheduled</title>
                        <style>
                            body { margin: 0; padding: 0; font-family: 'Helvetica', Arial, sans-serif; background-color: #f7fafc; }
                            .email-container { max-width: 600px; margin: 0 auto; background-color: #ffffff; }
                            .email-header { background-color: #1a365d; padding: 40px 30px; text-align: left; }
                            .logo { color: #ffffff; font-size: 32px; font-weight: bold; margin: 0; display: flex; align-items: center; }
                            .logo-icon { width: 40px; height: 40px; margin-right: 15px; }
                            .email-body { background-color: #2d3748; color: #ffffff; padding: 40px 30px; line-height: 1.6; }
                            .main-message { font-size: 24px; font-weight: 300; margin-bottom: 30px; line-height: 1.4; }
                            .details { margin: 30px 0; }
                            .detail-item { margin: 12px 0; font-size: 16px; }
                            .detail-label { font-weight: 600; }
                            .separator { border-top: 1px solid #4a5568; margin: 30px 0; }
                            .reschedule-section { margin: 30px 0 20px; }
                            .reschedule-text { font-size: 16px; margin-bottom: 15px; }
                            .cancel-text { font-size: 16px; margin-bottom: 20px; }
                            .cta-button { display: inline-block; background-color: #4299e1; color: #ffffff; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px; text-align: center; margin: 10px 0; }
                            .cta-button:hover { background-color: #3182ce; }
                            .footer { background-color: #1a202c; padding: 20px 30px; text-align: center; color: #a0aec0; font-size: 14px; }
                        </style>
                    </head>
                    <body>
                        <div class="email-container">
                            <div class="email-header">
                                <h1 class="logo">
                                    <img src="/public/hey-spruce-logo.png" alt="Spruce Logo" class="logo-icon" style="width: 40px; height: 40px; margin-right: 15px;">
                                    Spruce
                                </h1>
                            </div>
                            
                            <div class="email-body">
                                <div class="main-message">
                                    An appointment has been scheduled for ${service} at ${clientName} (${location})
                                </div>
                                
                                <div class="details">
                                    <div class="detail-item">
                                        <span class="detail-label">Location:</span> ${clientName} (${location})
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Service:</span> ${service}
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Date:</span> ${date} between ${timeWindow}
                                    </div>
                                    ${estimatedCost ? `<div class="detail-item">
                                        <span class="detail-label">Estimated cost:</span> The cost for that service is estimated at ${estimatedCost}
                                    </div>` : ''}
                                </div>
                                
                                <div class="separator"></div>
                                
                                <div class="reschedule-section">
                                    <div class="reschedule-text">
                                        Not available* during this time slot anymore? Reschedule using the Spruce mobile app.
                                    </div>
                                    
                                    <div class="cancel-text">
                                        You don't need this service anymore? Cancel* this appointment using the Spruce mobile app.
                                    </div>
                                </div>
                                
                                <div style="text-align: center; margin: 30px 0;">
                                    <a href="#" class="cta-button">See work order</a>
                                </div>
                            </div>
                            
                            <div class="footer">
                                <p style="margin: 0;">Spruce - Professional Service Management</p>
                                <p style="margin: 5px 0 0;">*Terms and conditions may apply</p>
                            </div>
                        </div>
                    </body>
                    </html>
                `,
                text: `
Service Scheduled - Work Order ${orderNumber}

An appointment has been scheduled for ${service} at ${clientName} (${location})

Details:
- Location: ${clientName} (${location})
- Service: ${service}  
- Date: ${date} between ${timeWindow}
${estimatedCost ? `- Estimated cost: ${estimatedCost}` : ''}

Not available during this time slot anymore? Reschedule using the Spruce mobile app.
You don't need this service anymore? Cancel this appointment using the Spruce mobile app.

Spruce - Professional Service Management
                `
            };
        }

        // Send Work Order Scheduled Email
        async function sendWorkOrderScheduledEmail(workOrderData) {
            try {
                const emailData = generateWorkOrderScheduledEmail(workOrderData);
                
                const response = await fetch('/api/email-service', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'work_order_scheduled',
                        ...emailData
                    })
                });

                if (response.ok) {
                    showToast('Appointment confirmation email sent to client', 'success');
                    return true;
                } else {
                    throw new Error('Failed to send email');
                }
            } catch (error) {
                console.error('Error sending work order scheduled email:', error);
                showToast('Failed to send confirmation email', 'error');
                return false;
            }
        }
        
        function addFreightCost() {
            const amount = document.getElementById('freightCost').value;
            if (amount) {
                addCostLine('Freight', 'Freight Cost', amount);
                document.getElementById('freightCost').value = '';
            }
        }
        
        function addMiscCost() {
            const description = document.getElementById('miscLabel').value || 'Miscellaneous';
            const amount = document.getElementById('miscCost').value;
            if (amount) {
                addCostLine('Miscellaneous', description, amount);
                document.getElementById('miscLabel').value = '';
                document.getElementById('miscCost').value = '';
            }
        }
        
        function removeCostItem(index) {
            costItems.splice(index, 1);
            updateCostDisplay();
        }
        
        function updateCostDisplay() {
            const listContainer = document.getElementById('costItemsList');
            if (!listContainer) return;
            
            let html = '';
            totalBeforeTax = 0;
            
            costItems.forEach((item, index) => {
                totalBeforeTax += item.amount;
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--gray-50); border-radius: 6px; margin-bottom: 0.5rem;">
                        <div>
                            <span style="font-weight: 500;">${item.type}</span>
                            <span style="color: var(--gray-600); margin-left: 0.5rem;">${item.description}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span style="font-weight: 600;">$${item.amount.toFixed(2)}</span>
                            <button onclick="removeCostItem(${index})" style="background: none; border: none; color: var(--danger); cursor: pointer;">✕</button>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html || '<p style="color: var(--gray-500); text-align: center; padding: 1rem;">No cost items added yet</p>';
            
            // Update totals
            const totalBeforeTaxEl = document.getElementById('totalBeforeTax');
            if (totalBeforeTaxEl) {
                totalBeforeTaxEl.textContent = `$${totalBeforeTax.toFixed(2)}`;
            }
            
            updateTotals();
        }
        
        function updateTotals() {
            const tax = parseFloat(document.getElementById('taxAmount')?.value) || 0;
            const totalWithTax = totalBeforeTax + tax;
            
            // Update Total Before Tax display
            const totalBeforeTaxEl = document.getElementById('totalBeforeTax');
            if (totalBeforeTaxEl) {
                totalBeforeTaxEl.textContent = `$${totalBeforeTax.toFixed(2)} USD`;
            }
            
            // Update Total With Tax display
            const totalWithTaxEl = document.getElementById('totalWithTax');
            if (totalWithTaxEl) {
                totalWithTaxEl.textContent = `$${totalWithTax.toFixed(2)} USD`;
            }
        }
        
        function handleFileUpload(event) {
            const files = event.target.files;
            const attachmentsList = document.getElementById('attachmentsList');
            
            for (let file of files) {
                const fileItem = document.createElement('div');
                fileItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: var(--gray-50); border-radius: 4px; margin-bottom: 0.5rem;';
                fileItem.innerHTML = `
                    <span>${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                    <button onclick="this.parentElement.remove()" style="background: none; border: none; color: var(--danger); cursor: pointer;">Remove</button>
                `;
                attachmentsList.appendChild(fileItem);
            }
            
            showToast(`Added ${files.length} file(s)`, 'success');
        }
        
        function saveQuoteDraft() {
            showToast('Quote draft saved', 'success');
        }
        
        function submitQuote() {
            const client = document.getElementById('quoteClient')?.value;
            const title = document.getElementById('quoteTitle')?.value;
            
            if (!client || !title) {
                showToast('Please fill in required fields', 'warning');
                return;
            }
            
            showToast('Quote submitted successfully', 'success');
            loadSection('quotes');
        }
        
        function updateProposal() {
            showToast('Proposal updated successfully', 'success');
        }
        
        // Quotes Navigation Toggle Function
        function toggleQuotesExpansion(event) {
            event.preventDefault();
            const subitems = document.getElementById('quotes-subitems');
            const expandIcon = event.currentTarget.querySelector('.expand-icon');
            
            if (subitems.style.display === 'none') {
                subitems.style.display = 'block';
                expandIcon.style.transform = 'rotate(0deg)';
            } else {
                subitems.style.display = 'none';
                expandIcon.style.transform = 'rotate(-90deg)';
            }
        }
        
        // Client Quote Tab Functions
        function switchClientQuoteTab(tab) {
            // Update tab styles
            const tabs = document.querySelectorAll('.client-quote-tab');
            tabs.forEach(t => {
                t.classList.remove('active');
                t.style.borderBottomColor = 'transparent';
                t.style.color = 'var(--gray-600)';
            });
            
            // Set active tab
            const activeTab = event.target.closest('.client-quote-tab');
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.borderBottomColor = 'var(--primary)';
                activeTab.style.color = 'var(--gray-900)';
            }
            
            // Here you could filter content based on the tab
            console.log('Switching to client tab:', tab);
        }
        
        // Subcontractor Quote Tab Functions
        function switchSubQuoteTab(tab) {
            // Update tab styles
            const tabs = document.querySelectorAll('.sub-quote-tab');
            tabs.forEach(t => {
                t.classList.remove('active');
                t.style.borderBottomColor = 'transparent';
                t.style.color = 'var(--gray-600)';
            });
            
            // Set active tab
            const activeTab = event.target.closest('.sub-quote-tab');
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.borderBottomColor = 'var(--primary)';
                activeTab.style.color = 'var(--gray-900)';
            }
            
            // Filter quotes based on tab (would filter actual data)
            showToast(`Filtering subcontractor quotes by: ${tab}`, 'info');
        }

        // Bid Portal Functions
        function switchBidTab(tab) {
            // Update tab styles
            const tabs = document.querySelectorAll('.sub-quote-tab');
            tabs.forEach(t => {
                t.classList.remove('active');
                t.style.borderBottomColor = 'transparent';
                t.style.color = 'var(--gray-600)';
            });
            
            // Set active tab
            const activeTab = event.target.closest('.sub-quote-tab');
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.borderBottomColor = 'var(--primary)';
                activeTab.style.color = 'var(--gray-900)';
            }

            // Show/hide content based on tab
            const contentDivs = ['openBidsContent', 'awardedBidsContent', 'completedBidsContent'];
            contentDivs.forEach(id => {
                const div = document.getElementById(id);
                if (div) div.style.display = 'none';
            });

            const activeContent = document.getElementById(`${tab}BidsContent`);
            if (activeContent) activeContent.style.display = 'block';

            showToast(`Viewing ${tab} bids`, 'info');
        }

        function sendWorkOrderToBid() {
            // Create modal for sending work order to bid
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>Send Work Order to Bid</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Select Work Order</label>
                            <select style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                <option value="">Choose a work order...</option>
                                <option value="wo-101">WO-101: HVAC Repair - Pizza Palace</option>
                                <option value="wo-102">WO-102: Kitchen Deep Clean - Burger King</option>
                                <option value="wo-103">WO-103: Equipment Maintenance - Subway</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Bid Deadline</label>
                            <input type="datetime-local" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                        </div>
                        <div class="form-group">
                            <label>Budget Range</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <input type="number" placeholder="Min ($)" style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                <input type="number" placeholder="Max ($)" style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Special Requirements</label>
                            <textarea rows="3" placeholder="Any special requirements or notes for bidders..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="submitWorkOrderToBid()">Send to Bid</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function submitWorkOrderToBid() {
            showToast('Work order sent to bid marketplace successfully!', 'success');
            document.querySelector('.modal.active').remove();
        }

        function viewBidDetails(workOrderId) {
            // Sample bid data with expanded details
            const bids = {
                'wo-001': [
                    { 
                        company: 'Seattle HVAC Pro', 
                        rating: 4.8, 
                        price: 450, 
                        time: '2 hours', 
                        submitted: '2 hours ago', 
                        verified: true,
                        license: 'HVAC-2024-8912',
                        insurance: 'Full Coverage - $2M',
                        experience: '12 years',
                        completedJobs: 245,
                        responseTime: 'Within 1 hour',
                        specialties: ['Commercial HVAC', 'Emergency Repairs', 'Preventive Maintenance'],
                        message: 'We can handle this repair immediately. Our team has extensive experience with walk-in coolers and can diagnose the issue quickly.',
                        availability: 'Available immediately',
                        breakdown: {
                            labor: {
                                total: 280,
                                items: [
                                    { description: 'Senior HVAC Technician', hours: 2, rate: 95, total: 190 },
                                    { description: 'Assistant Technician', hours: 2, rate: 45, total: 90 }
                                ]
                            },
                            materials: {
                                total: 120,
                                items: [
                                    { description: 'Refrigerant (R-410A)', quantity: '2 lbs', unitPrice: 35, total: 70 },
                                    { description: 'Compressor Capacitor', quantity: '1', unitPrice: 25, total: 25 },
                                    { description: 'Copper Tubing', quantity: '10 ft', unitPrice: 2.50, total: 25 }
                                ]
                            },
                            other: {
                                total: 50,
                                items: [
                                    { description: 'Diagnostic Testing', total: 30 },
                                    { description: 'Disposal Fees', total: 20 }
                                ]
                            }
                        }
                    },
                    { 
                        company: 'CoolTech Services', 
                        rating: 4.5, 
                        price: 525, 
                        time: '3 hours', 
                        submitted: '5 hours ago', 
                        verified: true,
                        license: 'HVAC-2023-4567',
                        insurance: 'Full Coverage - $1M',
                        experience: '8 years',
                        completedJobs: 156,
                        responseTime: 'Within 2 hours',
                        specialties: ['Refrigeration', 'HVAC Systems', 'Energy Efficiency'],
                        message: 'Our certified technicians specialize in commercial refrigeration. We guarantee our work with a 90-day warranty.',
                        availability: 'Next day service',
                        breakdown: {
                            labor: {
                                total: 360,
                                items: [
                                    { description: 'Lead Refrigeration Tech', hours: 3, rate: 85, total: 255 },
                                    { description: 'Support Technician', hours: 3, rate: 35, total: 105 }
                                ]
                            },
                            materials: {
                                total: 115,
                                items: [
                                    { description: 'Refrigerant (R-410A)', quantity: '3 lbs', unitPrice: 35, total: 105 },
                                    { description: 'Gaskets & Seals', quantity: '1 set', unitPrice: 10, total: 10 }
                                ]
                            },
                            other: {
                                total: 50,
                                items: [
                                    { description: 'System Analysis', total: 35 },
                                    { description: 'Warranty Coverage', total: 15 }
                                ]
                            }
                        }
                    },
                    { 
                        company: 'QuickFix HVAC', 
                        rating: 4.2, 
                        price: 399, 
                        time: '4 hours', 
                        submitted: '1 day ago', 
                        verified: false,
                        license: 'HVAC-2024-1234',
                        insurance: 'Basic Coverage - $500K',
                        experience: '3 years',
                        completedJobs: 67,
                        responseTime: 'Within 4 hours',
                        specialties: ['Residential HVAC', 'Basic Repairs'],
                        message: 'We offer competitive pricing and reliable service. Can complete the job this week.',
                        availability: 'Within 48 hours',
                        breakdown: {
                            labor: {
                                total: 280,
                                items: [
                                    { description: 'HVAC Technician', hours: 4, rate: 70, total: 280 }
                                ]
                            },
                            materials: {
                                total: 89,
                                items: [
                                    { description: 'Refrigerant (R-410A)', quantity: '2 lbs', unitPrice: 32, total: 64 },
                                    { description: 'Basic Parts', quantity: '1', unitPrice: 25, total: 25 }
                                ]
                            },
                            other: {
                                total: 30,
                                items: [
                                    { description: 'Service Call', total: 30 }
                                ]
                            }
                        }
                    }
                ],
                'wo-002': [
                    { 
                        company: 'Sparkle Clean Co', 
                        rating: 4.9, 
                        price: 280, 
                        time: '3 hours', 
                        submitted: '1 hour ago', 
                        verified: true,
                        license: 'CLEAN-2024-5678',
                        insurance: 'Full Coverage - $1M',
                        experience: '15 years',
                        completedJobs: 512,
                        responseTime: 'Same day',
                        specialties: ['Commercial Kitchens', 'Deep Cleaning', 'Sanitization'],
                        message: 'We use eco-friendly products and follow all health department guidelines. Our team is certified in food safety.',
                        availability: 'Flexible scheduling available'
                    }
                ]
            };

            const workOrderBids = bids[workOrderId] || [];
            
            // Create bid details modal
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3>Bid Details - ${workOrderId === 'wo-001' ? 'HVAC Repair - Lodge Bread Downtown' : 'Kitchen Deep Clean - Tasty Burgers'}</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--gray-50); border-radius: 8px;">
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--gray-600);">Total Bids Received</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${workOrderBids.length}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--gray-600);">Average Bid</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900);">$${Math.round(workOrderBids.reduce((a,b) => a + b.price, 0) / workOrderBids.length)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--gray-600);">Lowest Bid</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">$${Math.min(...workOrderBids.map(b => b.price))}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--gray-600);">Time Remaining</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">2 days</div>
                                </div>
                            </div>
                        </div>

                        <h4 style="margin-bottom: 1rem; color: var(--gray-900);">Submitted Bids</h4>
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            ${workOrderBids.map((bid, index) => `
                                <div style="border: 1px solid var(--gray-200); border-radius: 8px; overflow: hidden; transition: all 0.3s;">
                                    <!-- Collapsed View -->
                                    <div style="padding: 1.5rem; cursor: pointer;" onclick="toggleBidExpansion('bid-${workOrderId}-${index}')">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div style="flex: 1;">
                                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                    <h5 style="font-weight: 600; color: var(--gray-900); margin: 0;">${bid.company}</h5>
                                                    ${bid.verified ? '<span style="background: var(--success-light); color: var(--success); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Verified</span>' : ''}
                                                    <span id="expand-icon-${workOrderId}-${index}" style="margin-left: auto; color: var(--gray-500); transition: transform 0.3s;">▼</span>
                                                </div>
                                                <div style="display: flex; align-items: center; gap: 0.25rem; margin-bottom: 0.5rem;">
                                                    <span style="color: var(--warning);">★</span>
                                                    <span style="font-weight: 600;">${bid.rating}</span>
                                                    <span style="color: var(--gray-500); font-size: 0.875rem;">(${Math.floor(Math.random() * 50) + 20} reviews)</span>
                                                </div>
                                                <div style="color: var(--gray-600); font-size: 0.875rem;">
                                                    Estimated time: ${bid.time} • Submitted ${bid.submitted}
                                                </div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-bottom: 0.5rem;">
                                                    $${bid.price}
                                                </div>
                                                <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" onclick="event.stopPropagation(); selectBidWithPrice('${workOrderId}', ${index}, ${bid.price})">
                                                    Select Bid
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Expanded Details -->
                                    <div id="bid-${workOrderId}-${index}" style="display: none; background: var(--gray-50); padding: 1.5rem; border-top: 1px solid var(--gray-200);">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                            <div>
                                                <h6 style="color: var(--gray-700); margin-bottom: 1rem; font-weight: 600;">Company Information</h6>
                                                <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
                                                    <div><strong>License:</strong> ${bid.license}</div>
                                                    <div><strong>Insurance:</strong> ${bid.insurance}</div>
                                                    <div><strong>Experience:</strong> ${bid.experience}</div>
                                                    <div><strong>Completed Jobs:</strong> ${bid.completedJobs}</div>
                                                    <div><strong>Response Time:</strong> ${bid.responseTime}</div>
                                                    <div><strong>Availability:</strong> ${bid.availability}</div>
                                                </div>
                                            </div>
                                            <div>
                                                <h6 style="color: var(--gray-700); margin-bottom: 1rem; font-weight: 600;">Specialties</h6>
                                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                                                    ${bid.specialties.map(spec => `
                                                        <span style="background: var(--primary-light); color: var(--primary); padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem;">
                                                            ${spec}
                                                        </span>
                                                    `).join('')}
                                                </div>
                                                
                                                <h6 style="color: var(--gray-700); margin-bottom: 0.5rem; font-weight: 600;">Contractor Message</h6>
                                                <p style="color: var(--gray-600); font-size: 0.875rem; line-height: 1.5; background: white; padding: 0.75rem; border-radius: 6px;">
                                                    "${bid.message}"
                                                </p>
                                            </div>
                                        </div>
                                        
                                        <!-- Full Bid Breakdown -->
                                        ${bid.breakdown ? `
                                        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid var(--gray-200);">
                                            <h6 style="color: var(--gray-900); margin-bottom: 1.5rem; font-weight: 700; font-size: 1rem;">Complete Bid Breakdown</h6>
                                            
                                            <!-- Labor Costs -->
                                            <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border: 1px solid var(--gray-200);">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                                    <h6 style="color: var(--gray-700); font-weight: 600; margin: 0;">Labor Costs</h6>
                                                    <span style="font-weight: 700; color: var(--gray-900); font-size: 1.125rem;">$${bid.breakdown.labor.total.toFixed(2)}</span>
                                                </div>
                                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                    ${bid.breakdown.labor.items.map(item => `
                                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-100); font-size: 0.875rem;">
                                                            <div style="color: var(--gray-600);">
                                                                <span>${item.description}</span>
                                                                ${item.hours ? `<span style="margin-left: 0.5rem; color: var(--gray-500);">(${item.hours} hrs @ $${item.rate}/hr)</span>` : ''}
                                                            </div>
                                                            <span style="font-weight: 600; color: var(--gray-800);">$${item.total.toFixed(2)}</span>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                            
                                            <!-- Materials -->
                                            <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border: 1px solid var(--gray-200);">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                                    <h6 style="color: var(--gray-700); font-weight: 600; margin: 0;">Materials & Parts</h6>
                                                    <span style="font-weight: 700; color: var(--gray-900); font-size: 1.125rem;">$${bid.breakdown.materials.total.toFixed(2)}</span>
                                                </div>
                                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                    ${bid.breakdown.materials.items.map(item => `
                                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-100); font-size: 0.875rem;">
                                                            <div style="color: var(--gray-600);">
                                                                <span>${item.description}</span>
                                                                ${item.quantity ? `<span style="margin-left: 0.5rem; color: var(--gray-500);">(${item.quantity}${item.unitPrice ? ` @ $${item.unitPrice.toFixed(2)}` : ''})</span>` : ''}
                                                            </div>
                                                            <span style="font-weight: 600; color: var(--gray-800);">$${item.total.toFixed(2)}</span>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                            
                                            <!-- Other Costs -->
                                            <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border: 1px solid var(--gray-200);">
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                                    <h6 style="color: var(--gray-700); font-weight: 600; margin: 0;">Additional Costs</h6>
                                                    <span style="font-weight: 700; color: var(--gray-900); font-size: 1.125rem;">$${bid.breakdown.other.total.toFixed(2)}</span>
                                                </div>
                                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                    ${bid.breakdown.other.items.map(item => `
                                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-100); font-size: 0.875rem;">
                                                            <div style="color: var(--gray-600);">${item.description}</div>
                                                            <span style="font-weight: 600; color: var(--gray-800);">$${item.total.toFixed(2)}</span>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                            
                                            <!-- Total Summary -->
                                            <div style="background: var(--primary-light); border-radius: 8px; padding: 1rem; border: 2px solid var(--primary);">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <div>
                                                        <h6 style="color: var(--primary); font-weight: 700; margin: 0; font-size: 1.125rem;">TOTAL BID AMOUNT</h6>
                                                        <div style="color: var(--gray-600); font-size: 0.75rem; margin-top: 0.25rem;">
                                                            Labor: $${bid.breakdown.labor.total.toFixed(2)} + Materials: $${bid.breakdown.materials.total.toFixed(2)} + Other: $${bid.breakdown.other.total.toFixed(2)}
                                                        </div>
                                                    </div>
                                                    <span style="font-weight: 700; color: var(--primary); font-size: 1.5rem;">$${bid.price.toFixed(2)}</span>
                                                </div>
                                            </div>
                                        </div>
                                        ` : ''}
                                        
                                        <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                                            <button class="btn btn-secondary" style="font-size: 0.875rem;" onclick="viewContractorProfile('${bid.company}')">
                                                View Full Profile
                                            </button>
                                            <button class="btn btn-secondary" style="font-size: 0.875rem;" onclick="contactContractor('${bid.company}')">
                                                Contact Directly
                                            </button>
                                            <button class="btn btn-secondary" style="font-size: 0.875rem;" onclick="viewPastWork('${bid.company}')">
                                                View Past Work
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                        <button class="btn btn-outline" onclick="extendBidDeadline('${workOrderId}')">Extend Deadline</button>
                        <button class="btn btn-outline" onclick="inviteMoreBidders('${workOrderId}')">Invite More Bidders</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function toggleBidExpansion(bidId) {
            const expandedSection = document.getElementById(bidId);
            const iconId = bidId.replace('bid-', 'expand-icon-');
            const icon = document.getElementById(iconId);
            
            if (expandedSection) {
                if (expandedSection.style.display === 'none') {
                    expandedSection.style.display = 'block';
                    if (icon) icon.style.transform = 'rotate(180deg)';
                } else {
                    expandedSection.style.display = 'none';
                    if (icon) icon.style.transform = 'rotate(0deg)';
                }
            }
        }

        function selectBidWithPrice(workOrderId, bidIndex, bidPrice) {
            selectBid(workOrderId, bidIndex, bidPrice);
        }

        function selectBid(workOrderId, bidIndex, bidPrice = 450) {
            // Close the bid details modal
            document.querySelector('.modal.active').remove();
            
            // Create confirmation modal with adjustable platform fee
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Confirm Bid Selection</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>You are about to award this work order to the selected bidder.</p>
                        
                        <div style="background: var(--gray-50); padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
                            <h4 style="margin-bottom: 1rem;">Platform Fee Calculation</h4>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span>Bid Amount:</span>
                                <span style="font-weight: 600; font-size: 1.125rem;">$${bidPrice.toFixed(2)}</span>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span>Platform Fee:</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="number" 
                                           id="platformFeePercent" 
                                           value="15" 
                                           min="0" 
                                           max="100" 
                                           step="0.5"
                                           style="width: 60px; padding: 0.25rem 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; text-align: right;"
                                           oninput="updatePlatformFeeCalculation(${bidPrice})">
                                    <span>%</span>
                                    <span style="margin-left: 1rem; font-weight: 600;">$<span id="platformFeeAmount">${(bidPrice * 0.15).toFixed(2)}</span></span>
                                </div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span>Processing Fee (Optional):</span>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span>$</span>
                                    <input type="number" 
                                           id="processingFee" 
                                           value="0" 
                                           min="0" 
                                           step="0.01"
                                           style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; text-align: right;"
                                           oninput="updatePlatformFeeCalculation(${bidPrice})">
                                </div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 1.125rem; padding-top: 1rem; border-top: 2px solid var(--gray-300);">
                                <span>Client Quote Total:</span>
                                <span style="color: var(--primary);">$<span id="clientQuoteTotal">${(bidPrice * 1.15).toFixed(2)}</span></span>
                            </div>
                            
                            <div style="margin-top: 1rem; padding: 0.75rem; background: var(--info-light); border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: var(--gray-700);">
                                    <span>Your Profit:</span>
                                    <span style="font-weight: 600; color: var(--success);">$<span id="profitAmount">${(bidPrice * 0.15).toFixed(2)}</span></span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--gray-700);">Add Note for Client (Optional)</label>
                            <textarea id="clientNote" rows="2" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;" placeholder="Any special notes about this quote..."></textarea>
                        </div>
                        
                        <p style="color: var(--gray-600); font-size: 0.875rem;">
                            The client will receive a professional quote for approval. Once approved, the work order will be assigned to the selected contractor.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="confirmBidSelection('${workOrderId}', ${bidPrice})">Confirm & Send Quote</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function updatePlatformFeeCalculation(bidPrice) {
            const feePercent = parseFloat(document.getElementById('platformFeePercent').value) || 0;
            const processingFee = parseFloat(document.getElementById('processingFee').value) || 0;
            
            const platformFee = bidPrice * (feePercent / 100);
            const total = bidPrice + platformFee + processingFee;
            const profit = platformFee + processingFee;
            
            document.getElementById('platformFeeAmount').textContent = platformFee.toFixed(2);
            document.getElementById('clientQuoteTotal').textContent = total.toFixed(2);
            document.getElementById('profitAmount').textContent = profit.toFixed(2);
        }

        function confirmBidSelection(workOrderId) {
            // Get bid details from the form
            const bidAmount = parseFloat(document.getElementById('bidAmount')?.textContent.replace('$', '') || 450);
            const platformFeePercent = parseFloat(document.getElementById('platformFeePercent')?.value || 15);
            const processingFee = parseFloat(document.getElementById('processingFee')?.value || 0);
            const totalFees = (bidAmount * platformFeePercent / 100) + processingFee;
            const totalAmount = bidAmount + totalFees;
            
            // Create quote object
            const quote = {
                id: `Q-2025-${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`,
                workOrderId: workOrderId,
                clientName: workOrderId === 'wo-001' ? 'Lodge Bread Downtown' : 'Tasty Burgers',
                service: workOrderId === 'wo-001' ? 'HVAC Repair - Walk-in Cooler' : 'Kitchen Deep Clean',
                bidAmount: bidAmount,
                platformFee: bidAmount * platformFeePercent / 100,
                processingFee: processingFee,
                totalAmount: totalAmount,
                status: 'pending',
                createdAt: new Date().toISOString(),
                expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString() // 7 days from now
            };
            
            // Store quote in localStorage (in production, this would be an API call)
            let quotes = JSON.parse(localStorage.getItem('clientQuotes') || '[]');
            quotes.push(quote);
            localStorage.setItem('clientQuotes', JSON.stringify(quotes));
            
            showToast('Bid selected! Quote has been created and sent to client for approval.', 'success');
            document.querySelector('.modal.active').remove();
            
            // Update the bid status in the UI
            const openBidsContent = document.getElementById('openBidsContent');
            const awardedBidsContent = document.getElementById('awardedBidsContent');
            
            // Move the work order to awarded section
            if (openBidsContent && awardedBidsContent) {
                showToast(`Quote ${quote.id} is now available in the client portal`, 'info');
            }
        }

        function extendBidDeadline(workOrderId) {
            showToast(`Bid deadline extended by 48 hours for ${workOrderId}`, 'info');
        }

        function inviteMoreBidders(workOrderId) {
            showToast('Opening bidder invitation modal...', 'info');
        }

        function viewContractorProfile(company) {
            showToast(`Opening full profile for ${company}...`, 'info');
        }

        function contactContractor(company) {
            showToast(`Opening message dialog with ${company}...`, 'info');
        }

        function viewPastWork(company) {
            showToast(`Loading past work portfolio for ${company}...`, 'info');
        }

        function sendClientQuote(workOrderId) {
            // Create quote preview modal
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>Send Client Quote</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <h4 style="margin-bottom: 1rem;">Quote Preview</h4>
                        <div style="border: 1px solid var(--gray-200); border-radius: 8px; padding: 1.5rem; background: var(--gray-50);">
                            <div style="text-align: center; margin-bottom: 1.5rem;">
                                <h2 style="color: var(--primary); margin-bottom: 0.5rem;">Service Quote</h2>
                                <p style="color: var(--gray-600);">Quote #Q-2025-001</p>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <strong>Client:</strong> Pizza Palace<br>
                                <strong>Service:</strong> Dishwasher Repair<br>
                                <strong>Location:</strong> 123 Main St, Seattle WA
                            </div>
                            
                            <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Service Cost:</span>
                                    <span>$450.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>Platform & Processing:</span>
                                    <span>$67.50</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 1.125rem; padding-top: 0.5rem; border-top: 1px solid var(--gray-200);">
                                    <span>Total:</span>
                                    <span style="color: var(--primary);">$517.50</span>
                                </div>
                            </div>
                            
                            <div style="text-align: center; margin-top: 1.5rem;">
                                <p style="color: var(--gray-600); font-size: 0.875rem;">Valid for 7 days</p>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label>Additional Message (Optional)</label>
                            <textarea rows="3" placeholder="Add a personal message to the client..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="sendQuoteToClient()">Send Quote</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function sendQuoteToClient() {
            showToast('Quote sent to client successfully! You will be notified when they respond.', 'success');
            document.querySelector('.modal.active').remove();
        }

        // Work Order Stage Filter Functions
        function filterByStage(stage) {
            showToast(`Filtering work orders by: ${stage.replace('-', ' ')}`, 'info');
        }

        // Work Order View Toggle Functions
        function switchWorkOrderView(view) {
            const listBtn = document.getElementById('listViewBtn');
            const calendarBtn = document.getElementById('calendarViewBtn');
            const listContainer = document.getElementById('listViewContainer');
            const calendarContainer = document.getElementById('calendarViewContainer');

            // Update button styles
            if (view === 'list') {
                listBtn.style.background = 'white';
                listBtn.style.color = 'var(--gray-900)';
                calendarBtn.style.background = 'transparent';
                calendarBtn.style.color = 'var(--gray-600)';
                
                if (listContainer) listContainer.style.display = 'block';
                if (calendarContainer) calendarContainer.style.display = 'none';
                
                showToast('Switched to list view', 'info');
            } else {
                calendarBtn.style.background = 'white';
                calendarBtn.style.color = 'var(--gray-900)';
                listBtn.style.background = 'transparent';
                listBtn.style.color = 'var(--gray-600)';
                
                if (listContainer) listContainer.style.display = 'none';
                if (calendarContainer) calendarContainer.style.display = 'block';
                
                showToast('Switched to calendar view', 'info');
            }
        }

        // Calendar View Functions
        function switchCalendarView(view) {
            // Update calendar view button styles
            const buttons = document.querySelectorAll('.calendar-view-btn');
            buttons.forEach(btn => {
                btn.style.background = 'transparent';
                btn.style.color = 'var(--gray-600)';
            });

            // Set active button
            event.target.style.background = 'white';
            event.target.style.color = 'var(--gray-900)';

            // Hide all calendar views
            const monthView = document.getElementById('monthView');
            const weekView = document.getElementById('weekView');
            const dayView = document.getElementById('dayView');

            if (monthView) monthView.style.display = 'none';
            if (weekView) weekView.style.display = 'none';
            if (dayView) dayView.style.display = 'none';

            // Show selected view
            const activeView = document.getElementById(view + 'View');
            if (activeView) {
                if (view === 'month') {
                    activeView.style.display = 'grid';
                } else {
                    activeView.style.display = 'block';
                }
            }

            showToast(`Switched to ${view} view`, 'info');
        }

        // Calendar Navigation Functions
        let currentCalendarDate = new Date();

        function navigateCalendar(direction) {
            const dateDisplay = document.getElementById('currentCalendarDate');
            
            if (direction === 'prev') {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                showToast('Previous month', 'info');
            } else if (direction === 'next') {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                showToast('Next month', 'info');
            } else if (direction === 'today') {
                currentCalendarDate = new Date();
                showToast('Navigated to today', 'info');
            }

            // Update date display
            if (dateDisplay) {
                const options = { year: 'numeric', month: 'long' };
                dateDisplay.textContent = currentCalendarDate.toLocaleDateString('en-US', options);
            }
        }

        function viewDayDetail(date) {
            showToast(`Viewing details for ${date}`, 'info');
        }

        function viewWorkOrderDetail(workOrderId) {
            showToast(`Opening work order details for ${workOrderId}`, 'info');
            // In a real app, this would open a detailed work order modal or navigate to work order page
        }

        // User Menu Functions
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdownMenu');
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
                
                // Close dropdown when clicking outside
                if (dropdown.style.display === 'block') {
                    document.addEventListener('click', function closeDropdown(e) {
                        const userDropdown = document.getElementById('userDropdown');
                        if (!userDropdown.contains(e.target)) {
                            dropdown.style.display = 'none';
                            document.removeEventListener('click', closeDropdown);
                        }
                    });
                    // Prevent the document click from immediately closing
                    event.stopPropagation();
                }
            }
        }
        
        function closeUserDropdown() {
            const dropdown = document.getElementById('userDropdownMenu');
            if (dropdown) dropdown.style.display = 'none';
        }
        
        // Keep old function for compatibility
        function toggleUserMenu() {
            toggleUserDropdown();
        }

        function loadUserSettings(section) {
            closeUserDropdown();
            showToast(`Loading ${section} settings...`, 'info');
        }

        function logout() {
            showToast('Signing out...', 'info');
            // In real app, this would clear session and redirect
        }

        // Location Filter Functions
        function filterByLocation(location) {
            if (location === 'all') {
                showToast('Showing all locations', 'info');
            } else {
                const locationName = document.getElementById('headerLocationFilter').selectedOptions[0].text;
                showToast(`Filtering by location: ${locationName}`, 'info');
            }
        }

        // Close user dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userButton = event.target.closest('button[onclick="toggleUserMenu()"]');
            const dropdown = document.getElementById('userDropdown');
            
            if (!userButton && dropdown && dropdown.style.display === 'block') {
                dropdown.style.display = 'none';
            }
        });

        // Invoice Management Functions
        function switchInvoiceTab(tab) {
            // Update tab styles
            const tabs = document.querySelectorAll('.invoice-tab');
            tabs.forEach(t => {
                t.classList.remove('active');
                t.style.borderBottomColor = 'transparent';
                t.style.color = 'var(--gray-600)';
            });

            const activeTab = document.querySelector(`button[onclick="switchInvoiceTab('${tab}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.borderBottomColor = 'var(--primary)';
                activeTab.style.color = 'var(--gray-900)';
            }

            // Filter invoices based on selected tab
            filterInvoicesByStatus(tab);
            
            // Update table title
            const tableTitle = document.querySelector('#invoice-table-container .table-title');
            if (tableTitle) {
                const tabNames = {
                    'all': 'All Invoices',
                    'draft': 'Draft Invoices',
                    'sent': 'Sent Invoices',
                    'paid': 'Paid Invoices',
                    'overdue': 'Overdue Invoices'
                };
                tableTitle.textContent = tabNames[tab] || 'All Invoices';
            }
        }

        function filterInvoicesByStatus(status) {
            const tbody = document.getElementById('invoice-table-body');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const statusBadge = row.querySelector('.status-badge');
                if (!statusBadge) return;
                
                const invoiceStatus = statusBadge.textContent.toLowerCase();
                
                if (status === 'all') {
                    row.style.display = '';
                } else if (status === 'draft' && invoiceStatus.includes('draft')) {
                    row.style.display = '';
                } else if (status === 'sent' && invoiceStatus.includes('sent')) {
                    row.style.display = '';
                } else if (status === 'paid' && invoiceStatus.includes('paid')) {
                    row.style.display = '';
                } else if (status === 'overdue' && invoiceStatus.includes('overdue')) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function createNewInvoice() {
            loadSection('invoice-editor', 'new');
        }

        function createInvoiceFromQuote() {
            showApprovedQuotesModal();
        }

        function showApprovedQuotesModal() {
            // Create modal for selecting approved quotes
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>Create Invoice from Approved Quote</h3>
                        <button class="close-btn" onclick="closeQuoteSelectionModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 1.5rem; color: var(--gray-600);">Select an approved quote to convert into an invoice:</p>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Quote #</th>
                                        <th>Client</th>
                                        <th>Amount</th>
                                        <th>Approved Date</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Q-2024-007</strong></td>
                                        <td>Burger King</td>
                                        <td>$4,200.00</td>
                                        <td>Feb 18, 2024</td>
                                        <td><button class="btn btn-primary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="convertQuoteToInvoice('Q-2024-007')">Create Invoice</button></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Q-2024-008</strong></td>
                                        <td>KFC</td>
                                        <td>$2,800.00</td>
                                        <td>Feb 20, 2024</td>
                                        <td><button class="btn btn-primary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="convertQuoteToInvoice('Q-2024-008')">Create Invoice</button></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Q-2024-009</strong></td>
                                        <td>Subway</td>
                                        <td>$1,650.00</td>
                                        <td>Feb 22, 2024</td>
                                        <td><button class="btn btn-primary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="convertQuoteToInvoice('Q-2024-009')">Create Invoice</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeQuoteSelectionModal()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeQuoteSelectionModal() {
            const modal = document.querySelector('.modal.active');
            if (modal) {
                modal.remove();
            }
        }

        function convertQuoteToInvoice(quoteId) {
            showToast(`Converting quote ${quoteId} to invoice...`, 'info');
            closeQuoteSelectionModal();
            loadSection('invoice-editor', quoteId);
        }

        function viewInvoice(invoiceId) {
            showToast(`Opening invoice ${invoiceId}...`, 'info');
            loadSection('invoice-editor', invoiceId);
        }

        function downloadInvoice(invoiceId) {
            showToast(`Downloading invoice ${invoiceId}...`, 'info');
        }

        function sendReminder(invoiceId) {
            showToast(`Sending payment reminder for invoice ${invoiceId}...`, 'success');
        }

        function sendFinalNotice(invoiceId) {
            showToast(`Sending final notice for invoice ${invoiceId}...`, 'warning');
        }

        function exportInvoices() {
            showToast('Exporting invoices to CSV...', 'info');
        }

        // Invoice Editor Functions
        function saveInvoiceDraft() {
            const invoiceNumber = document.getElementById('invoiceNumber')?.value;
            showToast(`Invoice ${invoiceNumber} saved as draft`, 'success');
        }

        function sendInvoice() {
            const client = document.getElementById('invoiceClient')?.value;
            const invoiceNumber = document.getElementById('invoiceNumber')?.value;
            const issueDate = document.getElementById('invoiceIssueDate')?.value;
            const dueDate = document.getElementById('invoiceDueDate')?.value;
            
            if (!client || !issueDate || !dueDate) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            // Create payment link with invoice
            const totalElement = document.getElementById('invoiceTotal');
            const invoiceTotal = totalElement?.textContent.replace('$', '').replace(',', '') || '0.00';
            
            createInvoicePaymentLink(invoiceNumber, invoiceTotal, client);
            
            showToast(`Invoice ${invoiceNumber} sent successfully with payment link`, 'success');
            setTimeout(() => {
                loadSection('invoices');
            }, 1500);
        }

        async function createInvoicePaymentLink(invoiceNumber, amount, client) {
            try {
                const response = await fetch('/api/payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'invoice',
                        invoiceNumber: invoiceNumber,
                        amount: parseFloat(amount) * 100, // Convert to cents
                        client: client,
                        description: `Invoice ${invoiceNumber} payment`,
                        metadata: {
                            invoice_id: invoiceNumber,
                            client: client,
                            type: 'invoice_payment'
                        }
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    console.log('Payment link created:', data.paymentUrl);
                    // In a real app, this would be emailed to the client
                    return data.paymentUrl;
                } else {
                    console.error('Failed to create payment link:', data.error);
                    showToast('Failed to create payment link', 'error');
                }
            } catch (error) {
                console.error('Error creating payment link:', error);
                showToast('Error creating payment link', 'error');
            }
        }

        function addInvoiceLineItem() {
            const tbody = document.getElementById('invoice-line-items');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200);">
                    <input type="text" placeholder="Service description..." 
                        style="width: 100%; border: none; background: transparent; outline: none;">
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200); text-align: center;">
                    <input type="number" value="1" min="1" onchange="calculateInvoiceLineTotal(this)"
                        style="width: 60px; text-align: center; border: 1px solid var(--gray-300); border-radius: 4px; padding: 0.25rem;">
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200); text-align: right;">
                    <input type="number" placeholder="0.00" step="0.01" onchange="calculateInvoiceLineTotal(this)"
                        style="width: 80px; text-align: right; border: 1px solid var(--gray-300); border-radius: 4px; padding: 0.25rem;">
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200); text-align: right; font-weight: 600;">
                    $0.00
                </td>
                <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200); text-align: center;">
                    <button onclick="removeInvoiceLineItem(this)" style="color: var(--danger); background: none; border: none; cursor: pointer; font-size: 1.1rem;">×</button>
                </td>
            `;
            tbody.appendChild(newRow);
            updateInvoiceTotals();
        }

        function removeInvoiceLineItem(button) {
            const row = button.closest('tr');
            row.remove();
            updateInvoiceTotals();
        }

        function calculateInvoiceLineTotal(input) {
            const row = input.closest('tr');
            const quantityInput = row.querySelector('input[type="number"]');
            const priceInput = row.querySelectorAll('input[type="number"]')[1];
            const totalCell = row.querySelector('td:nth-child(4)');
            
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const total = quantity * price;
            
            totalCell.textContent = `$${total.toFixed(2)}`;
            updateInvoiceTotals();
        }

        function updateInvoiceTotals() {
            const tbody = document.getElementById('invoice-line-items');
            const rows = tbody.querySelectorAll('tr');
            let subtotal = 0;
            
            rows.forEach(row => {
                const totalCell = row.querySelector('td:nth-child(4)');
                const totalText = totalCell.textContent.replace('$', '').replace(',', '');
                const total = parseFloat(totalText) || 0;
                subtotal += total;
            });
            
            const taxRate = 0.0825; // 8.25%
            const tax = subtotal * taxRate;
            const total = subtotal + tax;
            
            // Update display
            const subtotalElement = document.getElementById('invoiceSubtotal');
            const taxElement = document.getElementById('invoiceTax');
            const totalElement = document.getElementById('invoiceTotal');
            
            if (subtotalElement) subtotalElement.textContent = `$${subtotal.toFixed(2)}`;
            if (taxElement) taxElement.textContent = `$${tax.toFixed(2)}`;
            if (totalElement) totalElement.textContent = `$${total.toFixed(2)}`;
        }

        // Location Management Functions
        function switchLocationTab(tab) {
            // Update tab styles
            const tabs = document.querySelectorAll('.location-tab');
            tabs.forEach(t => {
                t.classList.remove('active');
                t.style.borderBottomColor = 'transparent';
                t.style.color = 'var(--gray-600)';
            });

            const activeTab = document.querySelector(`button[onclick="switchLocationTab('${tab}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.borderBottomColor = 'var(--primary)';
                activeTab.style.color = 'var(--gray-900)';
            }

            // Show/hide tab content
            const contentDivs = ['locations-tab-content', 'contacts-tab-content', 'hierarchy-tab-content'];
            contentDivs.forEach(divId => {
                const div = document.getElementById(divId);
                if (div) {
                    div.style.display = divId === `${tab}-tab-content` ? 'block' : 'none';
                }
            });
        }

        function addLocation() {
            showAddLocationModal();
        }

        function addContact() {
            showAddContactModal();
        }

        function showAddLocationModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>Add New Location</h3>
                        <button class="close-btn" onclick="closeLocationModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="location-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Location Name <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="text" id="locationName" required 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Type of Business <span style="color: var(--danger);">*</span>
                                </label>
                                <select id="businessType" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="">Select business type...</option>
                                    <option value="Restaurant">Restaurant</option>
                                    <option value="Quick Service">Quick Service</option>
                                    <option value="Nightclub">Nightclub</option>
                                    <option value="Bar">Bar</option>
                                    <option value="Corporate">Corporate</option>
                                    <option value="Retail">Retail</option>
                                    <option value="Hotel">Hotel</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Parent Company (Optional)
                                </label>
                                <select id="parentCompany" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="">Standalone Location</option>
                                    <option value="hwood">The h.wood Group</option>
                                    <option value="other">Other (specify)</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Currency
                                </label>
                                <select id="currency" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="USD">USD - US Dollar</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="GBP">GBP - British Pound</option>
                                    <option value="CAD">CAD - Canadian Dollar</option>
                                </select>
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Address <span style="color: var(--danger);">*</span>
                                </label>
                                <textarea id="locationAddress" required rows="3" 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; resize: vertical;"></textarea>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Phone Number
                                </label>
                                <input type="tel" id="locationPhone" 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Website
                                </label>
                                <input type="url" id="locationWebsite" 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Default Work Order Subscribers
                                </label>
                                <input type="email" id="defaultSubscribers" placeholder="Enter email addresses separated by commas" 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeLocationModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveLocation()">Save Location</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showAddContactModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>Add New Contact</h3>
                        <button class="close-btn" onclick="closeContactModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="contact-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    First Name <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="text" id="contactFirstName" required 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Last Name <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="text" id="contactLastName" required 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Title/Position
                                </label>
                                <input type="text" id="contactTitle" 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Primary Location <span style="color: var(--danger);">*</span>
                                </label>
                                <select id="contactLocation" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="">Select location...</option>
                                    <option value="hwood-main">The h.wood Group - Main</option>
                                    <option value="delilah-la">Delilah LA</option>
                                    <option value="bootsy-bellows">Bootsy Bellows</option>
                                    <option value="nice-guy">Nice Guy</option>
                                    <option value="mcdonalds-sunset">McDonald's - Sunset Strip</option>
                                    <option value="burger-king-melrose">Burger King - Melrose</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Email Address <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="email" id="contactEmail" required 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Phone Number
                                </label>
                                <input type="tel" id="contactPhone" 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Contact Role
                                </label>
                                <select id="contactRole" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="Primary">Primary Contact</option>
                                    <option value="Secondary">Secondary Contact</option>
                                    <option value="Emergency">Emergency Contact</option>
                                    <option value="Billing">Billing Contact</option>
                                    <option value="Technical">Technical Contact</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 500; color: var(--gray-700);">
                                    <input type="checkbox" id="workOrderNotifications" checked>
                                    Work Order Notifications
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeContactModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveContact()">Save Contact</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeLocationModal() {
            const modal = document.querySelector('.modal.active');
            if (modal) {
                modal.remove();
            }
        }

        function closeContactModal() {
            const modal = document.querySelector('.modal.active');
            if (modal) {
                modal.remove();
            }
        }

        function saveLocation() {
            const name = document.getElementById('locationName')?.value;
            const businessType = document.getElementById('businessType')?.value;
            const address = document.getElementById('locationAddress')?.value;
            const phone = document.getElementById('locationPhone')?.value;
            const parentCompany = document.getElementById('parentCompany')?.value;
            
            if (!name || !businessType || !address) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            // Add new row to locations table
            const tbody = document.querySelector('#locations-tab-content tbody');
            if (tbody) {
                const newRow = document.createElement('tr');
                const locationId = name.toLowerCase().replace(/\s+/g, '-');
                const isChildLocation = parentCompany === 'hwood';
                
                newRow.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: ${isChildLocation ? 'var(--gray-400)' : 'var(--primary)'}; font-size: 0.75rem; ${isChildLocation ? 'margin-left: 1rem;' : ''}">
                                ${isChildLocation ? '└' : '●'}
                            </span>
                            <a href="#" onclick="viewLocation('${locationId}'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">${name}</a>
                        </div>
                    </td>
                    <td>${parentCompany === 'hwood' ? 'The h.wood Group' : '<span style="font-size: 0.875rem; color: var(--gray-600);">Standalone</span>'}</td>
                    <td><span class="status-badge completed">${businessType}</span></td>
                    <td>${address}</td>
                    <td>-</td>
                    <td>${phone || '-'}</td>
                    <td>0</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="viewLocation('${locationId}')">View</button>
                            <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editLocation('${locationId}')">Edit</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(newRow);
            }
            
            showToast(`Location "${name}" saved successfully`, 'success');
            closeLocationModal();
        }

        function saveContact() {
            const firstName = document.getElementById('contactFirstName')?.value;
            const lastName = document.getElementById('contactLastName')?.value;
            const email = document.getElementById('contactEmail')?.value;
            const location = document.getElementById('contactLocation')?.value;
            const title = document.getElementById('contactTitle')?.value;
            const phone = document.getElementById('contactPhone')?.value;
            const role = document.getElementById('contactRole')?.value;
            const notifications = document.getElementById('workOrderNotifications')?.checked;
            
            if (!firstName || !lastName || !email || !location) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            // Add new row to contacts table
            const tbody = document.querySelector('#contacts-tab-content tbody');
            if (tbody) {
                const newRow = document.createElement('tr');
                const contactId = `${firstName}-${lastName}`.toLowerCase().replace(/\s+/g, '-');
                const locationText = document.querySelector(`#contactLocation option[value="${location}"]`)?.textContent || location;
                
                newRow.innerHTML = `
                    <td><strong>${firstName} ${lastName}</strong></td>
                    <td>${title || '-'}</td>
                    <td>${locationText}</td>
                    <td>${email}</td>
                    <td>${phone || '-'}</td>
                    <td><span class="status-badge completed">${role || 'Primary'}</span></td>
                    <td>${notifications ? 'Enabled' : 'Disabled'}</td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editContact('${contactId}')">Edit</button>
                            <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="assignContact('${contactId}')">Assign</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(newRow);
            }
            
            showToast(`Contact "${firstName} ${lastName}" saved successfully`, 'success');
            closeContactModal();
        }

        function viewLocation(locationId) {
            loadSection('location-detail', locationId);
        }

        function editLocation(locationId) {
            showEditLocationModal(locationId);
        }

        function showEditLocationModal(locationId) {
            // Sample data - in real app would fetch from database
            const locationData = {
                'hwood-main': {
                    name: 'The h.wood Group - Main',
                    businessType: 'Corporate',
                    parentCompany: '',
                    currency: 'USD',
                    address: '9040 W Sunset Blvd, West Hollywood, CA',
                    phone: '(310) 555-0199',
                    website: 'https://hwoodgroup.com',
                    subscribers: 'operations@hwoodgroup.com, facilities@hwoodgroup.com'
                },
                'delilah-la': {
                    name: 'Delilah LA',
                    businessType: 'Restaurant',
                    parentCompany: 'hwood',
                    currency: 'USD',
                    address: '7969 Santa Monica Blvd, West Hollywood, CA',
                    phone: '(323) 555-0147',
                    website: 'https://delilahla.com',
                    subscribers: 'sarah@delilahla.com, manager@delilahla.com'
                },
                'bootsy-bellows': {
                    name: 'Bootsy Bellows',
                    businessType: 'Nightclub',
                    parentCompany: 'hwood',
                    currency: 'USD',
                    address: '9081 Santa Monica Blvd, West Hollywood, CA',
                    phone: '(310) 555-0892',
                    website: 'https://bootsybellows.com',
                    subscribers: 'marcus@bootsybellows.com, events@bootsybellows.com'
                },
                'mcdonalds-sunset': {
                    name: 'McDonald\'s - Sunset Strip',
                    businessType: 'Quick Service',
                    parentCompany: '',
                    currency: 'USD',
                    address: '8966 Sunset Blvd, West Hollywood, CA',
                    phone: '(323) 555-0234',
                    website: 'https://mcdonalds.com',
                    subscribers: 'jennifer.kim@mcdonalds.com'
                },
                'burger-king-melrose': {
                    name: 'Burger King - Melrose',
                    businessType: 'Quick Service',
                    parentCompany: '',
                    currency: 'USD',
                    address: '7511 Melrose Ave, Los Angeles, CA',
                    phone: '(323) 555-0567',
                    website: 'https://bk.com',
                    subscribers: 'robert.johnson@bk.com'
                }
            };

            const data = locationData[locationId] || {};

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>Edit Location: ${data.name || 'Unknown'}</h3>
                        <button class="close-btn" onclick="closeLocationModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="edit-location-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Location Name <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="text" id="locationName" required value="${data.name || ''}"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Type of Business <span style="color: var(--danger);">*</span>
                                </label>
                                <select id="businessType" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="">Select business type...</option>
                                    <option value="Restaurant" ${data.businessType === 'Restaurant' ? 'selected' : ''}>Restaurant</option>
                                    <option value="Quick Service" ${data.businessType === 'Quick Service' ? 'selected' : ''}>Quick Service</option>
                                    <option value="Nightclub" ${data.businessType === 'Nightclub' ? 'selected' : ''}>Nightclub</option>
                                    <option value="Bar" ${data.businessType === 'Bar' ? 'selected' : ''}>Bar</option>
                                    <option value="Corporate" ${data.businessType === 'Corporate' ? 'selected' : ''}>Corporate</option>
                                    <option value="Retail" ${data.businessType === 'Retail' ? 'selected' : ''}>Retail</option>
                                    <option value="Hotel" ${data.businessType === 'Hotel' ? 'selected' : ''}>Hotel</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Parent Company (Optional)
                                </label>
                                <select id="parentCompany" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="" ${!data.parentCompany ? 'selected' : ''}>Standalone Location</option>
                                    <option value="hwood" ${data.parentCompany === 'hwood' ? 'selected' : ''}>The h.wood Group</option>
                                    <option value="other">Other (specify)</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Currency
                                </label>
                                <select id="currency" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="USD" ${data.currency === 'USD' ? 'selected' : ''}>USD - US Dollar</option>
                                    <option value="EUR" ${data.currency === 'EUR' ? 'selected' : ''}>EUR - Euro</option>
                                    <option value="GBP" ${data.currency === 'GBP' ? 'selected' : ''}>GBP - British Pound</option>
                                    <option value="CAD" ${data.currency === 'CAD' ? 'selected' : ''}>CAD - Canadian Dollar</option>
                                </select>
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Address <span style="color: var(--danger);">*</span>
                                </label>
                                <textarea id="locationAddress" required rows="3" 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; resize: vertical;">${data.address || ''}</textarea>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Phone Number
                                </label>
                                <input type="tel" id="locationPhone" value="${data.phone || ''}"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Website
                                </label>
                                <input type="url" id="locationWebsite" value="${data.website || ''}"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Default Work Order Subscribers
                                </label>
                                <input type="email" id="defaultSubscribers" placeholder="Enter email addresses separated by commas" value="${data.subscribers || ''}"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-danger" onclick="deleteLocation('${locationId}')" style="margin-right: auto;">Delete Location</button>
                        <button class="btn btn-secondary" onclick="closeLocationModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="updateLocation('${locationId}')">Save Changes</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function updateLocation(locationId) {
            const name = document.getElementById('locationName')?.value;
            const businessType = document.getElementById('businessType')?.value;
            const address = document.getElementById('locationAddress')?.value;
            
            if (!name || !businessType || !address) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            showToast(`Location "${name}" updated successfully`, 'success');
            closeLocationModal();
            
            // Refresh the locations table
            if (document.getElementById('locations-tab-content')) {
                loadSection('locations');
            }
        }

        function deleteLocation(locationId) {
            if (confirm('Are you sure you want to delete this location? This action cannot be undone.')) {
                showToast(`Location deleted successfully`, 'success');
                closeLocationModal();
                loadSection('locations');
            }
        }

        function editContact(contactId) {
            showEditContactModal(contactId);
        }

        function showEditContactModal(contactId) {
            // Sample data - in real app would fetch from database
            const contactData = {
                'david-chang': {
                    firstName: 'David',
                    lastName: 'Chang',
                    title: 'Operations Director',
                    location: 'hwood-main',
                    email: 'david@hwoodgroup.com',
                    phone: '(310) 555-0199',
                    role: 'Primary',
                    notifications: true
                },
                'sarah-martinez': {
                    firstName: 'Sarah',
                    lastName: 'Martinez',
                    title: 'General Manager',
                    location: 'delilah-la',
                    email: 'sarah@delilahla.com',
                    phone: '(323) 555-0147',
                    role: 'Primary',
                    notifications: true
                },
                'marcus-rodriguez': {
                    firstName: 'Marcus',
                    lastName: 'Rodriguez',
                    title: 'Venue Manager',
                    location: 'bootsy-bellows',
                    email: 'marcus@bootsybellows.com',
                    phone: '(310) 555-0892',
                    role: 'Primary',
                    notifications: true
                },
                'jennifer-kim': {
                    firstName: 'Jennifer',
                    lastName: 'Kim',
                    title: 'Store Manager',
                    location: 'mcdonalds-sunset',
                    email: 'jennifer.kim@mcdonalds.com',
                    phone: '(323) 555-0234',
                    role: 'Primary',
                    notifications: true
                }
            };

            const data = contactData[contactId] || {};

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>Edit Contact: ${data.firstName} ${data.lastName}</h3>
                        <button class="close-btn" onclick="closeContactModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="edit-contact-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    First Name <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="text" id="contactFirstName" required value="${data.firstName || ''}"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Last Name <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="text" id="contactLastName" required value="${data.lastName || ''}"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Title/Position
                                </label>
                                <input type="text" id="contactTitle" value="${data.title || ''}"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Primary Location <span style="color: var(--danger);">*</span>
                                </label>
                                <select id="contactLocation" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="">Select location...</option>
                                    <option value="hwood-main" ${data.location === 'hwood-main' ? 'selected' : ''}>The h.wood Group - Main</option>
                                    <option value="delilah-la" ${data.location === 'delilah-la' ? 'selected' : ''}>Delilah LA</option>
                                    <option value="bootsy-bellows" ${data.location === 'bootsy-bellows' ? 'selected' : ''}>Bootsy Bellows</option>
                                    <option value="nice-guy" ${data.location === 'nice-guy' ? 'selected' : ''}>Nice Guy</option>
                                    <option value="mcdonalds-sunset" ${data.location === 'mcdonalds-sunset' ? 'selected' : ''}>McDonald's - Sunset Strip</option>
                                    <option value="burger-king-melrose" ${data.location === 'burger-king-melrose' ? 'selected' : ''}>Burger King - Melrose</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Email Address <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="email" id="contactEmail" required value="${data.email || ''}"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Phone Number
                                </label>
                                <input type="tel" id="contactPhone" value="${data.phone || ''}"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Contact Role
                                </label>
                                <select id="contactRole" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="Primary" ${data.role === 'Primary' ? 'selected' : ''}>Primary Contact</option>
                                    <option value="Secondary" ${data.role === 'Secondary' ? 'selected' : ''}>Secondary Contact</option>
                                    <option value="Emergency" ${data.role === 'Emergency' ? 'selected' : ''}>Emergency Contact</option>
                                    <option value="Billing" ${data.role === 'Billing' ? 'selected' : ''}>Billing Contact</option>
                                    <option value="Technical" ${data.role === 'Technical' ? 'selected' : ''}>Technical Contact</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 500; color: var(--gray-700);">
                                    <input type="checkbox" id="workOrderNotifications" ${data.notifications ? 'checked' : ''}>
                                    Work Order Notifications
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-danger" onclick="deleteContact('${contactId}')" style="margin-right: auto;">Delete Contact</button>
                        <button class="btn btn-secondary" onclick="closeContactModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="updateContact('${contactId}')">Save Changes</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function updateContact(contactId) {
            const firstName = document.getElementById('contactFirstName')?.value;
            const lastName = document.getElementById('contactLastName')?.value;
            const email = document.getElementById('contactEmail')?.value;
            const location = document.getElementById('contactLocation')?.value;
            
            if (!firstName || !lastName || !email || !location) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            showToast(`Contact "${firstName} ${lastName}" updated successfully`, 'success');
            closeContactModal();
            
            // Refresh the contacts table if visible
            if (document.getElementById('contacts-tab-content')?.style.display !== 'none') {
                switchLocationTab('contacts');
            }
        }

        function deleteContact(contactId) {
            if (confirm('Are you sure you want to delete this contact? This action cannot be undone.')) {
                showToast(`Contact deleted successfully`, 'success');
                closeContactModal();
                switchLocationTab('contacts');
            }
        }

        function assignContact(contactId) {
            showContactAssignmentModal(contactId);
        }

        function showContactAssignmentModal(contactId) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>Assign Contact to Additional Locations</h3>
                        <button class="close-btn" onclick="closeAssignmentModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 1.5rem; color: var(--gray-600);">Select additional locations where this contact should receive notifications:</p>
                        <div style="display: grid; gap: 0.75rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; cursor: pointer;">
                                <input type="checkbox" value="hwood-main">
                                <span>The h.wood Group - Main</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; cursor: pointer;">
                                <input type="checkbox" value="delilah-la" checked>
                                <span>Delilah LA</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; cursor: pointer;">
                                <input type="checkbox" value="bootsy-bellows">
                                <span>Bootsy Bellows</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; cursor: pointer;">
                                <input type="checkbox" value="nice-guy">
                                <span>Nice Guy</span>
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeAssignmentModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveContactAssignment('${contactId}')">Save Assignment</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeAssignmentModal() {
            const modal = document.querySelector('.modal.active');
            if (modal) {
                modal.remove();
            }
        }

        function saveContactAssignment(contactId) {
            showToast(`Contact assignments updated for ${contactId}`, 'success');
            closeAssignmentModal();
        }

        function filterLocationsByClient(clientValue) {
            showToast(`Filtering locations by: ${clientValue || 'All Clients'}`, 'info');
        }

        function filterContactsByLocation(locationValue) {
            showToast(`Filtering contacts by: ${locationValue || 'All Locations'}`, 'info');
        }

        function exportLocations() {
            showToast('Exporting locations to CSV...', 'info');
        }

        function exportContacts() {
            showToast('Exporting contacts to CSV...', 'info');
        }
        
        // Replace alerts with toast notifications
        const originalAlert = window.alert;
        window.alert = function(message) {
            if (message.includes('successfully')) {
                showToast(message, 'success');
            } else if (message.includes('error') || message.includes('fail')) {
                showToast(message, 'error');
            } else if (message.includes('Please')) {
                showToast(message, 'warning');
            } else {
                showToast(message, 'info');
            }
        };
        
        // Add CSS animation for toast
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
            
            .wo-checkbox {
                cursor: pointer;
                width: 16px;
                height: 16px;
            }
            
            #selectAllWO {
                cursor: pointer;
                width: 16px;
                height: 16px;
            }
        `;
        document.head.appendChild(style);
        
        // Navigation and Core Functions will be assigned to window after loadSection is defined
        window.showToast = showToast;
        window.loadGoogleMaps = loadGoogleMaps;
        if (typeof initMap !== 'undefined') window.initMap = initMap;
        
        // Work Order Functions
        window.filterWorkOrders = filterWorkOrders;
        window.toggleAllWorkOrders = toggleAllWorkOrders;
        window.updateBulkSelection = updateBulkSelection;
        window.clearSelection = clearSelection;
        window.bulkAssign = bulkAssign;
        window.bulkSchedule = bulkSchedule;
        window.bulkUpdateStatus = bulkUpdateStatus;
        window.exportToCSV = exportToCSV;
        if (typeof handleWorkOrderAction !== 'undefined') window.handleWorkOrderAction = handleWorkOrderAction;
        if (typeof loadWorkOrderDetail !== 'undefined') window.loadWorkOrderDetail = loadWorkOrderDetail;
        if (typeof openSubStatusModal !== 'undefined') window.openSubStatusModal = openSubStatusModal;
        if (typeof closeSubStatusModal !== 'undefined') window.closeSubStatusModal = closeSubStatusModal;
        if (typeof clearAllSubStatusFilters !== 'undefined') window.clearAllSubStatusFilters = clearAllSubStatusFilters;
        if (typeof applySubStatusFilters !== 'undefined') window.applySubStatusFilters = applySubStatusFilters;
        if (typeof removeSubStatusFilter !== 'undefined') window.removeSubStatusFilter = removeSubStatusFilter;
        if (typeof openCheckinModal !== 'undefined') window.openCheckinModal = openCheckinModal;
        if (typeof closeCheckinModal !== 'undefined') window.closeCheckinModal = closeCheckinModal;
        if (typeof submitCheckin !== 'undefined') window.submitCheckin = submitCheckin;
        if (typeof openScheduleModal !== 'undefined') window.openScheduleModal = openScheduleModal;
        if (typeof closeScheduleModal !== 'undefined') window.closeScheduleModal = closeScheduleModal;
        if (typeof submitSchedule !== 'undefined') window.submitSchedule = submitSchedule;
        if (typeof openCheckoutModal !== 'undefined') window.openCheckoutModal = openCheckoutModal;
        if (typeof closeCheckoutModal !== 'undefined') window.closeCheckoutModal = closeCheckoutModal;
        if (typeof submitCheckout !== 'undefined') window.submitCheckout = submitCheckout;
        if (typeof submitSubcontract !== 'undefined') window.submitSubcontract = submitSubcontract;
        
        // RFP Functions
        window.filterRFPs = filterRFPs;
        window.filterRFPsByStatus = filterRFPsByStatus;
        window.switchRFPTab = switchRFPTab;
        window.viewRFPDetail = viewRFPDetail;
        window.submitProposal = submitProposal;
        window.markInterested = markInterested;
        window.viewSubmission = viewSubmission;
        window.viewContract = viewContract;
        
        // Quote Functions
        window.createNewQuote = createNewQuote;
        if (typeof switchClientQuoteTab !== 'undefined') window.switchClientQuoteTab = switchClientQuoteTab;
        if (typeof toggleQuotesExpansion !== 'undefined') window.toggleQuotesExpansion = toggleQuotesExpansion;
        window.saveQuoteDraft = saveQuoteDraft;
        window.submitQuote = submitQuote;
        window.formatText = formatText;
        window.addCostLine = addCostLine;
        window.updateCategoryTotal = updateCategoryTotal;
        window.calculateTotalBeforeTax = calculateTotalBeforeTax;
        window.addIncurredCost = addIncurredCost;
        window.calculateLaborCost = calculateLaborCost;
        window.addLaborCost = addLaborCost;
        window.calculatePartsCost = calculatePartsCost;
        window.addPartsCost = addPartsCost;
        window.addEquipmentCost = addEquipmentCost;
        window.addTravelCost = addTravelCost;
        window.addFreightCost = addFreightCost;
        window.addMiscCost = addMiscCost;
        window.removeCostItem = removeCostItem;
        window.updateCostDisplay = updateCostDisplay;
        window.updateTotals = updateTotals;
        window.handleFileUpload = handleFileUpload;
        
        // Invoice Functions
        window.switchInvoiceTab = switchInvoiceTab;
        window.createInvoiceFromQuote = createInvoiceFromQuote;
        window.createNewInvoice = createNewInvoice;
        window.convertQuoteToInvoice = convertQuoteToInvoice;
        window.closeQuoteSelectionModal = closeQuoteSelectionModal;
        if (typeof exportInvoices !== 'undefined') window.exportInvoices = exportInvoices;
        window.saveInvoiceDraft = saveInvoiceDraft;
        window.sendInvoice = sendInvoice;
        window.addInvoiceLineItem = addInvoiceLineItem;
        window.removeInvoiceLineItem = removeInvoiceLineItem;
        
        // Proposal Builder Functions
        window.initializeProposalBuilder = initializeProposalBuilder;
        window.addProposalService = addProposalService;
        window.removeProposalService = removeProposalService;
        window.addEquipmentItem = addEquipmentItem;
        window.updateEquipmentItemsList = updateEquipmentItemsList;
        window.removeEquipmentItem = removeEquipmentItem;
        window.updateProposalPreview = updateProposalPreview;
        window.exportProposalPDF = exportProposalPDF;
        window.sendProposalEmail = sendProposalEmail;
        window.closeProposalModal = closeProposalModal;
        if (typeof confirmProposalSend !== 'undefined') window.confirmProposalSend = confirmProposalSend;
        window.showAddCategoryModal = showAddCategoryModal;
        
        // Location Functions
        window.addLocation = addLocation;
        window.closeLocationModal = closeLocationModal;
        window.saveLocation = saveLocation;
        window.viewLocation = viewLocation;
        window.editLocation = editLocation;
        if (typeof deleteLocation !== 'undefined') window.deleteLocation = deleteLocation;
        if (typeof updateLocation !== 'undefined') window.updateLocation = updateLocation;
        if (typeof exportLocations !== 'undefined') window.exportLocations = exportLocations;
        window.switchLocationTab = switchLocationTab;
        
        // Contact Functions
        window.addContact = addContact;
        window.closeContactModal = closeContactModal;
        window.saveContact = saveContact;
        window.editContact = editContact;
        if (typeof assignContact !== 'undefined') window.assignContact = assignContact;
        if (typeof deleteContact !== 'undefined') window.deleteContact = deleteContact;
        if (typeof updateContact !== 'undefined') window.updateContact = updateContact;
        if (typeof exportContacts !== 'undefined') window.exportContacts = exportContacts;
        if (typeof closeAssignmentModal !== 'undefined') window.closeAssignmentModal = closeAssignmentModal;
        if (typeof saveContactAssignment !== 'undefined') window.saveContactAssignment = saveContactAssignment;
        
        // Inbox Functions
        if (typeof markAllAsRead !== 'undefined') window.markAllAsRead = markAllAsRead;
        if (typeof markAsRead !== 'undefined') window.markAsRead = markAsRead;
        if (typeof openInboxSettings !== 'undefined') window.openInboxSettings = openInboxSettings;
        if (typeof closeInboxSettings !== 'undefined') window.closeInboxSettings = closeInboxSettings;
        if (typeof saveInboxSettings !== 'undefined') window.saveInboxSettings = saveInboxSettings;
        
        // Parts and Equipment Functions
        if (typeof openAddPartsModal !== 'undefined') window.openAddPartsModal = openAddPartsModal;
        if (typeof closeAddPartsModal !== 'undefined') window.closeAddPartsModal = closeAddPartsModal;
        if (typeof addPart !== 'undefined') window.addPart = addPart;
        if (typeof openAddEquipmentModal !== 'undefined') window.openAddEquipmentModal = openAddEquipmentModal;
        if (typeof closeAddEquipmentModal !== 'undefined') window.closeAddEquipmentModal = closeAddEquipmentModal;
        if (typeof addEquipment !== 'undefined') window.addEquipment = addEquipment;
        
        // Email Generation Functions
        window.generateWorkOrderScheduledEmail = generateWorkOrderScheduledEmail;
        
        // Initialize Supabase database on first load
        async function initializeDatabase() {
            try {
                const response = await fetch('/api/init-db', { method: 'POST' });
                if (response.ok) {
                    const result = await response.json();
                    console.log('Database initialized:', result.message);
                }
            } catch (error) {
                console.log('Database initialization skipped (local server):', error.message);
            }
        }
        
        // Content generation functions - define these FIRST
        function getDashboardContent() {
            return `<div>
                <h1>Dashboard</h1>
                <p>Welcome to the Supplier Portal Dashboard</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-top: 2rem;">
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                        <h3>Active Work Orders</h3>
                        <p style="font-size: 2rem; font-weight: 700; color: var(--primary);">12</p>
                    </div>
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                        <h3>Pending RFPs</h3>
                        <p style="font-size: 2rem; font-weight: 700; color: var(--primary);">5</p>
                    </div>
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                        <h3>Recent Invoices</h3>
                        <p style="font-size: 2rem; font-weight: 700; color: var(--primary);">8</p>
                    </div>
                </div>
            </div>`;
        }

        function getInboxContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Inbox</h2>
                        <button class="btn btn-primary">+ Compose Message</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Unread Messages</h4>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">8</p>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Priority Messages</h4>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--danger);">3</p>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Recent Messages</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>From</th>
                                        <th>Subject</th>
                                        <th>Date</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="font-weight: 600;">
                                        <td>Project Manager</td>
                                        <td>Work Order WO-2024-001 Update Required</td>
                                        <td>Jan 10, 2024</td>
                                        <td><span class="status-badge danger">High</span></td>
                                        <td><span class="status-badge pending">Unread</span></td>
                                        <td><button class="btn btn-secondary btn-sm">Open</button></td>
                                    </tr>
                                    <tr>
                                        <td>Facility Manager</td>
                                        <td>RFP Response Due Tomorrow</td>
                                        <td>Jan 9, 2024</td>
                                        <td><span class="status-badge warning">Medium</span></td>
                                        <td><span class="status-badge success">Read</span></td>
                                        <td><button class="btn btn-secondary btn-sm">Open</button></td>
                                    </tr>
                                    <tr style="font-weight: 600;">
                                        <td>Admin</td>
                                        <td>Invoice Payment Processed</td>
                                        <td>Jan 8, 2024</td>
                                        <td><span class="status-badge success">Low</span></td>
                                        <td><span class="status-badge pending">Unread</span></td>
                                        <td><button class="btn btn-secondary btn-sm">Open</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        async function getWorkOrdersContent() {
            // Show loading state
            let content = `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Work Orders</h2>
                        <button class="btn btn-primary" onclick="showCreateWorkOrderModal()">+ Create Work Order</button>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Active Work Orders</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="text-align: center; padding: 2rem;">Loading work orders...</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Fetch work orders from Supabase
            try {
                const { data: workOrders, error } = await supabase
                    .from('work_orders')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error fetching work orders:', error);
                    // Return static fallback data if database isn't set up
                    return getFallbackWorkOrdersContent();
                }
                
                // Build table with real data
                let tableRows = '';
                if (workOrders && workOrders.length > 0) {
                    workOrders.forEach(order => {
                        const statusClass = order.status === 'in_progress' ? 'in-progress' : order.status;
                        const statusText = order.status ? order.status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Pending';
                        const date = order.created_at ? new Date(order.created_at).toLocaleDateString() : 'Not scheduled';
                        const orderTitle = order.title || `Order #${order.id?.slice(0,8) || 'N/A'}`;
                        const location = order.location || 'No location';
                        const category = order.category || 'General';
                        
                        tableRows += `
                            <tr>
                                <td><strong>${orderTitle}</strong></td>
                                <td>${location}</td>
                                <td>${category}</td>
                                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                <td>${date}</td>
                                <td><button class="btn btn-secondary btn-sm">View Details</button></td>
                            </tr>
                        `;
                    });
                } else {
                    tableRows = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-600);">
                                No work orders yet. Click "Create Work Order" to add your first one.
                            </td>
                        </tr>
                    `;
                }
                
                content = `
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="font-size: 1.875rem; font-weight: 700;">Work Orders</h2>
                            <button class="btn btn-primary" onclick="showCreateWorkOrderModal()">+ Create Work Order</button>
                        </div>
                        
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Active Work Orders (${workOrders?.length || 0} total)</h3>
                            </div>
                            <div style="padding: 1.5rem;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Order #</th>
                                            <th>Location</th>
                                            <th>Service Type</th>
                                            <th>Status</th>
                                            <th>Due Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error('Unexpected error:', err);
                return getFallbackWorkOrdersContent();
            }
            
            return content;
        }
        
        function getFallbackWorkOrdersContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Work Orders</h2>
                        <button class="btn btn-primary" onclick="showCreateWorkOrderModal()">+ Create Work Order</button>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Active Work Orders</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Order #</th>
                                        <th>Location</th>
                                        <th>Service Type</th>
                                        <th>Status</th>
                                        <th>Due Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>WO-2024-001</strong></td>
                                        <td>Seattle Downtown</td>
                                        <td>HVAC Maintenance</td>
                                        <td><span class="status-badge in-progress">In Progress</span></td>
                                        <td>2024-01-15</td>
                                        <td><button class="btn btn-secondary btn-sm">View Details</button></td>
                                    </tr>
                                    <tr>
                                        <td><strong>WO-2024-002</strong></td>
                                        <td>Bellevue Main St</td>
                                        <td>Plumbing Repair</td>
                                        <td><span class="status-badge pending">Pending</span></td>
                                        <td>2024-01-18</td>
                                        <td><button class="btn btn-secondary btn-sm">View Details</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function getRFPContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Request for Proposals</h2>
                        <button class="btn btn-secondary">View All RFPs</button>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Active RFPs</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>RFP #</th>
                                        <th>Project</th>
                                        <th>Location</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>RFP-2024-001</strong></td>
                                        <td>Kitchen Renovation</td>
                                        <td>Seattle Downtown</td>
                                        <td>2024-01-20</td>
                                        <td><span class="status-badge pending">Open</span></td>
                                        <td><button class="btn btn-primary btn-sm">Submit Proposal</button></td>
                                    </tr>
                                    <tr>
                                        <td><strong>RFP-2024-002</strong></td>
                                        <td>Office HVAC Upgrade</td>
                                        <td>Bellevue Main St</td>
                                        <td>2024-01-25</td>
                                        <td><span class="status-badge pending">Open</span></td>
                                        <td><button class="btn btn-primary btn-sm">Submit Proposal</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function getAnalyticsContent() {
            // Initialize analytics when content loads
            setTimeout(() => {
                initializeSupplierAnalytics();
            }, 100);
            
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Analytics Dashboard</h2>
                        <div style="display: flex; gap: 0.75rem;">
                            <select id="supplierAnalyticsPeriod" style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px;" onchange="updateSupplierAnalyticsPeriod(this.value)">
                                <option value="30d" selected>Last 30 Days</option>
                                <option value="90d">Last 90 Days</option>
                                <option value="1y">Last 12 Months</option>
                                <option value="all">All Time</option>
                            </select>
                            <button class="btn btn-secondary" onclick="exportSupplierAnalytics()">Export Data</button>
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="supplierAnalyticsLoading" style="display: flex; justify-content: center; align-items: center; height: 200px; color: var(--gray-500);">
                        <div>Loading analytics data...</div>
                    </div>
                    
                    <!-- Analytics Content -->
                    <div id="supplierAnalyticsContent" style="display: none;">
                        <!-- KPI Cards -->
                        <div id="supplierKPICards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        
                        <!-- Charts Section -->
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <div class="table-container">
                                <div class="table-header">
                                    <h3 class="table-title">Revenue Trends</h3>
                                </div>
                                <div style="padding: 1rem; height: 350px;">
                                    <canvas id="supplierRevenueChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <div class="table-header">
                                    <h3 class="table-title">Service Distribution</h3>
                                </div>
                                <div style="padding: 1rem; height: 350px; display: flex; align-items: center; justify-content: center;">
                                    <canvas id="supplierServiceChart" style="max-height: 300px;"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Performance Metrics -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div class="table-container">
                                <div class="table-header">
                                    <h3 class="table-title">Work Order Performance</h3>
                                </div>
                                <div style="padding: 1rem; height: 300px;">
                                    <canvas id="supplierPerformanceChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="table-container">
                                <div class="table-header">
                                    <h3 class="table-title">Performance Metrics</h3>
                                </div>
                                <div id="supplierPerformanceMetrics">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function getInvoicesContent() {
            try {
                // Fetch invoices from Supabase
                const { data: invoices, error } = await supabase
                    .from('invoices')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // Calculate totals
                let totalOutstanding = 0;
                let paidThisMonth = 0;
                let totalOverdue = 0;
                const currentMonth = new Date().getMonth();
                const today = new Date();
                
                if (invoices) {
                    invoices.forEach(inv => {
                        if (inv.status === 'pending' || inv.status === 'sent') {
                            totalOutstanding += parseFloat(inv.total_amount || inv.amount || 0);
                        }
                        if (inv.status === 'paid' && new Date(inv.paid_date || inv.updated_at).getMonth() === currentMonth) {
                            paidThisMonth += parseFloat(inv.total_amount || inv.amount || 0);
                        }
                        if (inv.status === 'overdue' || (inv.due_date && new Date(inv.due_date) < today && inv.status !== 'paid')) {
                            totalOverdue += parseFloat(inv.total_amount || inv.amount || 0);
                        }
                    });
                }
                
                // Build table rows
                let tableRows = '';
                if (invoices && invoices.length > 0) {
                    invoices.forEach(invoice => {
                        const statusClass = invoice.status === 'paid' ? 'success' : invoice.status === 'overdue' ? 'danger' : 'pending';
                        const dueDate = invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : 'Not set';
                        const amount = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(invoice.total_amount || invoice.amount || 0);
                        
                        tableRows += `
                            <tr>
                                <td><strong>${invoice.invoice_number}</strong></td>
                                <td>${invoice.client_name}</td>
                                <td>${amount}</td>
                                <td>${dueDate}</td>
                                <td><span class="status-badge ${statusClass}">${invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1)}</span></td>
                                <td><button class="btn btn-secondary btn-sm">View</button></td>
                            </tr>
                        `;
                    });
                } else {
                    tableRows = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No invoices yet</td></tr>';
                }
                
                return `
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2 style="font-size: 1.875rem; font-weight: 700;">Invoices</h2>
                            <button class="btn btn-primary">+ Create Invoice</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                                <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Total Outstanding</h4>
                                <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(totalOutstanding)}</p>
                            </div>
                            <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                                <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Paid This Month</h4>
                                <p style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(paidThisMonth)}</p>
                            </div>
                            <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                                <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Overdue</h4>
                                <p style="font-size: 1.5rem; font-weight: 700; color: var(--danger);">${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(totalOverdue)}</p>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Recent Invoices</h3>
                            </div>
                            <div style="padding: 1.5rem;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Invoice #</th>
                                            <th>Client</th>
                                            <th>Amount</th>
                                            <th>Due Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error fetching invoices:', error);
                // Return fallback content
                return getFallbackInvoicesContent();
            }
        }
        
        function getFallbackInvoicesContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Invoices</h2>
                        <button class="btn btn-primary">+ Create Invoice</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Total Outstanding</h4>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">$24,500.00</p>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Paid This Month</h4>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--success);">$18,200.00</p>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Overdue</h4>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--danger);">$3,200.00</p>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Recent Invoices</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Client</th>
                                        <th>Amount</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>INV-2024-001</strong></td>
                                        <td>Seattle Downtown</td>
                                        <td>$5,200.00</td>
                                        <td>2024-01-15</td>
                                        <td><span class="status-badge success">Paid</span></td>
                                        <td><button class="btn btn-secondary btn-sm">View</button></td>
                                    </tr>
                                    <tr>
                                        <td><strong>INV-2024-002</strong></td>
                                        <td>Bellevue Main St</td>
                                        <td>$3,800.00</td>
                                        <td>2024-01-20</td>
                                        <td><span class="status-badge pending">Pending</span></td>
                                        <td><button class="btn btn-secondary btn-sm">View</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function getCompanyContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Company Settings</h2>
                        <button class="btn btn-primary">Save Changes</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Company Information</h3>
                            </div>
                            <div style="padding: 1.5rem;">
                                <div style="space-y: 1rem;">
                                    <div style="margin-bottom: 1rem;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Company Name</label>
                                        <input type="text" value="Hwood Group Suppliers" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    </div>
                                    <div style="margin-bottom: 1rem;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Business Address</label>
                                        <textarea style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px; resize: vertical;" rows="3">1234 Business Blvd
Seattle, WA 98101
United States</textarea>
                                    </div>
                                    <div style="margin-bottom: 1rem;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Phone</label>
                                        <input type="tel" value="+1 (206) 555-0123" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    </div>
                                    <div style="margin-bottom: 1rem;">
                                        <label style="display: block; font-weight: 600; margin-bottom: 0.5rem;">Email</label>
                                        <input type="email" value="contact@hwood.com" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Service Areas</h3>
                            </div>
                            <div style="padding: 1.5rem;">
                                <div style="space-y: 0.5rem;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="checkbox" checked id="seattle">
                                        <label for="seattle">Seattle Metro Area</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="checkbox" checked id="bellevue">
                                        <label for="bellevue">Bellevue</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="checkbox" checked id="tacoma">
                                        <label for="tacoma">Tacoma</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="checkbox" id="everett">
                                        <label for="everett">Everett</label>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="checkbox" id="renton">
                                        <label for="renton">Renton</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container" style="margin-top: 2rem;">
                        <div class="table-header">
                            <h3 class="table-title">Service Categories</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" checked id="hvac">
                                    <label for="hvac">HVAC Services</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" checked id="plumbing">
                                    <label for="plumbing">Plumbing</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" checked id="electrical">
                                    <label for="electrical">Electrical</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="carpentry">
                                    <label for="carpentry">Carpentry</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="painting">
                                    <label for="painting">Painting</label>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="cleaning">
                                    <label for="cleaning">Cleaning Services</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getAdminContent() {
            return `<div>
                <h1>Administration</h1>
                <p>Administrative functions</p>
            </div>`;
        }

        // Add all missing content functions
        async function getLocationsContent() {
            // Fetch locations from Supabase
            let locations = [];
            
            try {
                const { data, error } = await supabase
                    .from('locations')
                    .select('*')
                    .order('name', { ascending: true });
                    
                if (data && !error) {
                    locations = data;
                }
            } catch (err) {
                console.error('Error fetching locations:', err);
            }
            
            // Generate location cards
            const locationCards = locations.length > 0 ? locations.map(location => `
                <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <div style="width: 50px; height: 50px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.5rem;">📍</div>
                        <div>
                            <h3 style="font-weight: 600; margin-bottom: 0.25rem;">${location.name}</h3>
                            <p style="color: var(--gray-600); font-size: 0.875rem;">${location.address}${location.city ? `, ${location.city}` : ''}${location.state ? `, ${location.state}` : ''} ${location.zip || ''}</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <span style="color: var(--gray-600); font-size: 0.875rem;">Active Work Orders</span>
                            <p style="font-weight: 600; color: var(--primary);">${location.active_work_orders || 0}</p>
                        </div>
                        <div>
                            <span style="color: var(--gray-600); font-size: 0.875rem;">Assets</span>
                            <p style="font-weight: 600; color: var(--primary);">${location.total_assets || 0}</p>
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-sm" style="width: 100%;" onclick="viewLocationDetails('${location.id}')">View Details</button>
                </div>
            `).join('') : `
                <div style="grid-column: 1/-1; background: white; padding: 3rem; border-radius: 8px; border: 1px solid var(--gray-200); text-align: center;">
                    <p style="color: var(--gray-500);">No locations found. Click "+ Add Location" to create your first location.</p>
                </div>
            `;
            
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Locations</h2>
                        <button class="btn btn-primary">+ Add Location</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        ${locationCards}
                    </div>
                </div>
            `;
        }

        async function getSubcontractorsContent() {
            // Fetch subcontractors from Supabase
            let subcontractors = [];
            
            try {
                const { data, error } = await supabase
                    .from('subcontractors')
                    .select('*')
                    .eq('status', 'active')
                    .order('company_name', { ascending: true });
                    
                if (data && !error) {
                    subcontractors = data;
                }
            } catch (err) {
                console.error('Error fetching subcontractors:', err);
            }
            
            // Generate table rows
            const subcontractorRows = subcontractors.length > 0 ? subcontractors.map(sub => {
                const rating = sub.rating || 0;
                const stars = '⭐'.repeat(Math.floor(rating));
                const specializations = sub.specialization ? sub.specialization.join(', ') : 'N/A';
                
                return `
                    <tr>
                        <td><strong>${sub.company_name}</strong></td>
                        <td>${sub.contact_name || 'N/A'}<br><small>${sub.email || ''}</small></td>
                        <td>${specializations}</td>
                        <td>${stars} ${rating.toFixed(1)}</td>
                        <td><span class="status-badge success">${sub.active_jobs || 0}</span></td>
                        <td><button class="btn btn-secondary btn-sm" onclick="viewSubcontractorProfile('${sub.id}')">View Profile</button></td>
                    </tr>
                `;
            }).join('') : `
                <tr>
                    <td colspan="6" style="text-align: center; color: var(--gray-500); padding: 2rem;">No active subcontractors found</td>
                </tr>
            `;
            
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Subcontractors</h2>
                        <button class="btn btn-primary">+ Add Subcontractor</button>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Active Subcontractors</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Company</th>
                                        <th>Contact</th>
                                        <th>Specialization</th>
                                        <th>Rating</th>
                                        <th>Active Jobs</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${subcontractorRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        async function getFieldTechsContent() {
            // Fetch field techs from Supabase
            let fieldTechs = [];
            
            try {
                const { data, error } = await supabase
                    .from('field_techs')
                    .select('*')
                    .order('name', { ascending: true });
                    
                if (data && !error) {
                    fieldTechs = data;
                }
            } catch (err) {
                console.error('Error fetching field techs:', err);
            }
            
            // Generate tech cards
            const techCards = fieldTechs.length > 0 ? fieldTechs.map(tech => {
                const statusBadgeClass = {
                    'available': 'success',
                    'on_site': 'progress',
                    'off_duty': 'secondary',
                    'vacation': 'warning'
                }[tech.status] || 'secondary';
                
                const specializations = tech.specialization ? tech.specialization.join(', ') : 'General';
                
                return `
                    <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="width: 50px; height: 50px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.5rem;">👷</div>
                            <div>
                                <h3 style="font-weight: 600; margin-bottom: 0.25rem;">${tech.name}</h3>
                                <p style="color: var(--gray-600); font-size: 0.875rem;">${specializations}</p>
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: var(--gray-600); font-size: 0.875rem;">Status</span>
                                <span class="status-badge ${statusBadgeClass}">${tech.status.replace('_', ' ').charAt(0).toUpperCase() + tech.status.replace('_', ' ').slice(1)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: var(--gray-600); font-size: 0.875rem;">Current Jobs</span>
                                <span style="font-weight: 600;">${tech.current_jobs || 0}</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-sm" style="width: 100%;" onclick="viewTechDetails('${tech.id}')">View Profile</button>
                    </div>
                `;
            }).join('') : `
                <div style="grid-column: 1/-1; background: white; padding: 3rem; border-radius: 8px; border: 1px solid var(--gray-200); text-align: center;">
                    <p style="color: var(--gray-500);">No field technicians found. Click "+ Add Technician" to add your first technician.</p>
                </div>
            `;
            
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Field Technicians</h2>
                        <button class="btn btn-primary">+ Add Technician</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        ${techCards}
                    </div>
                </div>
            `;
        }

        async function getAssetsContent() {
            // Fetch assets from Supabase
            let assets = [];
            
            try {
                const { data, error } = await supabase
                    .from('assets')
                    .select('*')
                    .order('next_maintenance', { ascending: true });
                    
                if (data && !error) {
                    assets = data;
                }
            } catch (err) {
                console.error('Error fetching assets:', err);
            }
            
            // Generate table rows
            const assetRows = assets.length > 0 ? assets.map(asset => {
                const statusBadgeClass = {
                    'operational': 'success',
                    'maintenance': 'warning',
                    'repair': 'danger',
                    'retired': 'secondary'
                }[asset.status] || 'secondary';
                
                const lastMaintenance = asset.last_maintenance 
                    ? new Date(asset.last_maintenance).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                    : 'N/A';
                    
                const nextMaintenance = asset.next_maintenance
                    ? new Date(asset.next_maintenance).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                    : 'N/A';
                
                return `
                    <tr>
                        <td><strong>${asset.asset_id}</strong></td>
                        <td>${asset.name}<br><small>${asset.manufacturer || ''} ${asset.model || ''}</small></td>
                        <td>${asset.location_name || 'Unassigned'}</td>
                        <td><span class="status-badge ${statusBadgeClass}">${asset.status.charAt(0).toUpperCase() + asset.status.slice(1)}</span></td>
                        <td>${lastMaintenance}</td>
                        <td>${nextMaintenance}</td>
                        <td><button class="btn btn-secondary btn-sm" onclick="scheduleAssetMaintenance('${asset.id}')">Schedule</button></td>
                    </tr>
                `;
            }).join('') : `
                <tr>
                    <td colspan="7" style="text-align: center; color: var(--gray-500); padding: 2rem;">No assets found</td>
                </tr>
            `;
            
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Asset Management</h2>
                        <button class="btn btn-primary">+ Add Asset</button>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Equipment Inventory</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Asset ID</th>
                                        <th>Equipment</th>
                                        <th>Location</th>
                                        <th>Status</th>
                                        <th>Last Maintenance</th>
                                        <th>Next Due</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${assetRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function getDocumentsContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Shared Documents</h2>
                        <button class="btn btn-primary">+ Upload Document</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200); cursor: pointer;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="width: 40px; height: 40px; background: var(--danger); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white;">📄</div>
                                <div style="flex: 1;">
                                    <h4 style="font-weight: 600; margin-bottom: 0.25rem;">Safety Manual.pdf</h4>
                                    <p style="color: var(--gray-600); font-size: 0.875rem;">2.4 MB • Updated Jan 5, 2024</p>
                                </div>
                            </div>
                            <button class="btn btn-secondary btn-sm" style="width: 100%;">Download</button>
                        </div>
                        
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200); cursor: pointer;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="width: 40px; height: 40px; background: var(--success); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white;">📈</div>
                                <div style="flex: 1;">
                                    <h4 style="font-weight: 600; margin-bottom: 0.25rem;">Service Contract.docx</h4>
                                    <p style="color: var(--gray-600); font-size: 0.875rem;">1.8 MB • Updated Dec 28, 2023</p>
                                </div>
                            </div>
                            <button class="btn btn-secondary btn-sm" style="width: 100%;">Download</button>
                        </div>
                        
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200); cursor: pointer;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="width: 40px; height: 40px; background: var(--primary); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: white;">🗺</div>
                                <div style="flex: 1;">
                                    <h4 style="font-weight: 600; margin-bottom: 0.25rem;">Building Plans.dwg</h4>
                                    <p style="color: var(--gray-600); font-size: 0.875rem;">5.2 MB • Updated Dec 20, 2023</p>
                                </div>
                            </div>
                            <button class="btn btn-secondary btn-sm" style="width: 100%;">Download</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function getReportsContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Reports</h2>
                        <button class="btn btn-primary">+ Generate Report</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <h3 style="font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">📈 Monthly Performance</h3>
                            <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Work orders, revenue, and completion rates for the current month.</p>
                            <button class="btn btn-primary" style="width: 100%;">Generate Report</button>
                        </div>
                        
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <h3 style="font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">📅 Asset Maintenance</h3>
                            <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Maintenance schedules, asset conditions, and upcoming service requirements.</p>
                            <button class="btn btn-primary" style="width: 100%;">Generate Report</button>
                        </div>
                        
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <h3 style="font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">💰 Financial Summary</h3>
                            <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Invoice status, payments received, and outstanding balances.</p>
                            <button class="btn btn-primary" style="width: 100%;">Generate Report</button>
                        </div>
                        
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <h3 style="font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">👥 Team Performance</h3>
                            <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Individual technician performance, work completion times, and customer ratings.</p>
                            <button class="btn btn-primary" style="width: 100%;">Generate Report</button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Recent Reports</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Report Name</th>
                                        <th>Generated By</th>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>December Performance Report</strong></td>
                                        <td>System</td>
                                        <td>Jan 1, 2024</td>
                                        <td><span class="status-badge primary">Monthly</span></td>
                                        <td><button class="btn btn-secondary btn-sm">Download PDF</button></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Q4 Asset Maintenance</strong></td>
                                        <td>Admin</td>
                                        <td>Dec 30, 2023</td>
                                        <td><span class="status-badge success">Quarterly</span></td>
                                        <td><button class="btn btn-secondary btn-sm">Download PDF</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function getFeedbackContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Customer Feedback</h2>
                        <select style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            <option>All Ratings</option>
                            <option>5 Stars</option>
                            <option>4 Stars</option>
                            <option>3 Stars or Below</option>
                        </select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Average Rating</h4>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">4.8/5.0</p>
                            <div style="color: var(--warning);">⭐⭐⭐⭐⭐</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Total Reviews</h4>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">247</p>
                            <span style="color: var(--success); font-size: 0.875rem;">↑ 23 this month</span>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Response Rate</h4>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">94%</p>
                            <span style="color: var(--success); font-size: 0.875rem;">↑ 2% from last month</span>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Recent Reviews</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="space-y: 1rem;">
                                <div style="border-bottom: 1px solid var(--gray-200); padding-bottom: 1rem; margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <div>
                                            <strong>Sarah M. - Seattle Downtown</strong>
                                            <div style="color: var(--warning);">⭐⭐⭐⭐⭐</div>
                                        </div>
                                        <span style="color: var(--gray-600); font-size: 0.875rem;">Jan 8, 2024</span>
                                    </div>
                                    <p style="color: var(--gray-700);">"Excellent HVAC maintenance service. Mike was professional, thorough, and completed the work ahead of schedule. The system is running perfectly now."</p>
                                    <div style="margin-top: 0.5rem;">
                                        <span style="background: var(--gray-100); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; color: var(--gray-600);">Work Order: WO-2024-001</span>
                                    </div>
                                </div>
                                
                                <div style="border-bottom: 1px solid var(--gray-200); padding-bottom: 1rem; margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <div>
                                            <strong>David R. - Bellevue Main St</strong>
                                            <div style="color: var(--warning);">⭐⭐⭐⭐⭐</div>
                                        </div>
                                        <span style="color: var(--gray-600); font-size: 0.875rem;">Jan 6, 2024</span>
                                    </div>
                                    <p style="color: var(--gray-700);">"Fast response time and high-quality plumbing repair. Lisa explained the issue clearly and provided preventive maintenance tips."</p>
                                    <div style="margin-top: 0.5rem;">
                                        <span style="background: var(--gray-100); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; color: var(--gray-600);">Work Order: WO-2024-002</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getBudgetContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Budget Management</h2>
                        <select style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            <option>2024 Budget</option>
                            <option>2023 Budget</option>
                        </select>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Annual Budget</h4>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">$2,400,000</p>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Spent YTD</h4>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--success);">$158,400</p>
                            <span style="color: var(--gray-600); font-size: 0.875rem;">6.6% of budget</span>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Remaining</h4>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">$2,241,600</p>
                            <span style="color: var(--success); font-size: 0.875rem;">On track</span>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                            <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Projected Annual</h4>
                            <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">$2,200,000</p>
                            <span style="color: var(--success); font-size: 0.875rem;">Under budget</span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Budget by Category</h3>
                            </div>
                            <div style="padding: 1.5rem;">
                                <div style="space-y: 1rem;">
                                    <div style="margin-bottom: 1.5rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                            <span style="font-weight: 600;">HVAC Services</span>
                                            <span style="font-weight: 600;">$82,400 / $800,000</span>
                                        </div>
                                        <div style="background: var(--gray-200); height: 12px; border-radius: 6px;">
                                            <div style="background: var(--primary); height: 100%; width: 10.3%; border-radius: 6px;"></div>
                                        </div>
                                        <span style="color: var(--gray-600); font-size: 0.875rem;">10.3% used</span>
                                    </div>
                                    
                                    <div style="margin-bottom: 1.5rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                            <span style="font-weight: 600;">Plumbing Services</span>
                                            <span style="font-weight: 600;">$45,200 / $600,000</span>
                                        </div>
                                        <div style="background: var(--gray-200); height: 12px; border-radius: 6px;">
                                            <div style="background: var(--success); height: 100%; width: 7.5%; border-radius: 6px;"></div>
                                        </div>
                                        <span style="color: var(--gray-600); font-size: 0.875rem;">7.5% used</span>
                                    </div>
                                    
                                    <div style="margin-bottom: 1.5rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                            <span style="font-weight: 600;">Electrical Work</span>
                                            <span style="font-weight: 600;">$30,800 / $500,000</span>
                                        </div>
                                        <div style="background: var(--gray-200); height: 12px; border-radius: 6px;">
                                            <div style="background: var(--warning); height: 100%; width: 6.2%; border-radius: 6px;"></div>
                                        </div>
                                        <span style="color: var(--gray-600); font-size: 0.875rem;">6.2% used</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Monthly Spending</h3>
                            </div>
                            <div style="padding: 2rem; text-align: center;">
                                <div style="height: 200px; background: var(--gray-50); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--gray-500);">
                                    📊 Spending Chart<br><small>Chart integration needed</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getQuotesClientContent() {
            return `<div><h1>Client Quotes</h1><p>Quotes for clients</p></div>`;
        }

        function getQuotesSubcontractorContent() {
            return `<div><h1>Subcontractor Quotes</h1><p>Quotes for subcontractors</p></div>`;
        }

        function getProposalBuilderContent() {
            return `<div><h1>Proposal Builder</h1><p>Build proposals</p></div>`;
        }

        function getTeamManagementContent() {
            return Promise.resolve(`<div><h1>Team Management</h1><p>Manage your team</p></div>`);
        }

        // Define loadSection globally AFTER content functions
        window.loadSection = function(section, param) {
            console.log('Loading section:', section, param);
            
            // Find content element - it might be in the main content area
            let content = document.getElementById('content');
            if (!content) {
                // If no content div, try to find the main content area
                content = document.querySelector('main') || document.querySelector('.main-content') || document.body;
                console.log('Using fallback content element:', content);
            }

            // Update navigation active states
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate current nav item
            const currentNav = document.querySelector(`a[href="#${section}"]`) || document.querySelector(`[onclick*="${section}"]`);
            if (currentNav) {
                currentNav.classList.add('active');
            }

            // Load section content
            switch (section) {
                case 'dashboard':
                    content.innerHTML = getDashboardContent();
                    break;
                case 'inbox':
                    content.innerHTML = getInboxContent();
                    break;
                case 'work-orders':
                    // Work orders is async now
                    getWorkOrdersContent().then(html => {
                        content.innerHTML = html;
                    }).catch(err => {
                        console.error('Error loading work orders:', err);
                        content.innerHTML = getFallbackWorkOrdersContent();
                    });
                    break;
                case 'work-orders-calendar':
                    content.innerHTML = getWorkOrdersCalendarContent();
                    break;
                case 'rfps':
                    // RFPs is async now
                    getRFPsContent().then(html => {
                        content.innerHTML = html;
                    }).catch(err => {
                        console.error('Error loading RFPs:', err);
                        content.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-500);">Error loading RFPs</div>';
                    });
                    break;
                case 'analytics':
                    content.innerHTML = getAnalyticsContent();
                    break;
                case 'quote-editor':
                    content.innerHTML = getQuoteEditorContent();
                    break;
                case 'invoices':
                    getInvoicesContent().then(html => {
                        content.innerHTML = html;
                    }).catch(err => {
                        console.error('Error loading invoices:', err);
                        content.innerHTML = getFallbackInvoicesContent();
                    });
                    break;
                case 'company':
                    content.innerHTML = getCompanyContent();
                    break;
                case 'admin':
                    content.innerHTML = getAdminContent();
                    break;
                case 'team':
                    // Show loading state
                    content.innerHTML = '<div style="text-align: center; padding: 2rem;">Loading team members...</div>';
                    // Load team content asynchronously
                    getTeamManagementContent().then(html => {
                        content.innerHTML = html;
                    }).catch(error => {
                        console.error('Error loading team content:', error);
                        content.innerHTML = '<div style="text-align: center; padding: 2rem; color: red;">Error loading team members</div>';
                    });
                    break;
                case 'locations':
                    // Locations is async now
                    getLocationsContent().then(html => {
                        content.innerHTML = html;
                    }).catch(err => {
                        console.error('Error loading locations:', err);
                        content.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-500);">Error loading locations</div>';
                    });
                    break;
                case 'subcontractors':
                    // Subcontractors is async now
                    getSubcontractorsContent().then(html => {
                        content.innerHTML = html;
                    }).catch(err => {
                        console.error('Error loading subcontractors:', err);
                        content.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-500);">Error loading subcontractors</div>';
                    });
                    break;
                case 'field-techs':
                    // Field techs is async now
                    getFieldTechsContent().then(html => {
                        content.innerHTML = html;
                    }).catch(err => {
                        console.error('Error loading field techs:', err);
                        content.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-500);">Error loading field technicians</div>';
                    });
                    break;
                case 'assets':
                    // Assets is async now
                    getAssetsContent().then(html => {
                        content.innerHTML = html;
                    }).catch(err => {
                        console.error('Error loading assets:', err);
                        content.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray-500);">Error loading assets</div>';
                    });
                    break;
                case 'documents':
                    content.innerHTML = getDocumentsContent();
                    break;
                case 'reports':
                    content.innerHTML = getReportsContent();
                    break;
                case 'feedback':
                    content.innerHTML = getFeedbackContent();
                    break;
                case 'budget':
                    content.innerHTML = getBudgetContent();
                    break;
                case 'quotes-client':
                    content.innerHTML = getQuotesClientContent();
                    break;
                case 'quotes-subcontractor':
                    content.innerHTML = getQuotesSubcontractorContent();
                    break;
                case 'proposal-builder':
                    content.innerHTML = getProposalBuilderContent();
                    break;
                default:
                    console.log('Unknown section:', section);
                    content.innerHTML = `<div><h1>${section}</h1><p>Content for ${section} is not yet implemented.</p></div>`;
            }
        };


        // Initialize on page load
        window.addEventListener('load', function() {
            console.log('Page loaded, defining loadSection...');
            window.loadSection('dashboard');
            // Initialize database (only works on Vercel)
            initializeDatabase();
        });
    </script>
</head>
<body>
    <!-- Toast Notification Container -->
    <div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10000;"></div>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <img src="https://cdn.prod.website-files.com/67edc7c78e3151d3b06686b2/681007b1b7f5a5cc527f1b94_Hey_SPRUCE_logo_font.png" alt="Hey Spruce" style="height: 32px; width: auto;">
                <span class="portal-badge">Supplier Portal</span>
            </div>
            
            <!-- Global Search -->
            <div class="header-search" style="flex: 1; max-width: 400px; margin: 0 2rem;">
                <div style="position: relative;">
                    <input type="text" 
                           id="supplierGlobalSearch" 
                           placeholder="Search RFPs, work orders, clients..." 
                           style="width: 100%; padding: 0.5rem 0.75rem 0.5rem 2.5rem; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 0.875rem;"
                           onkeyup="handleSupplierGlobalSearch(this.value)"
                           onkeydown="handleSupplierSearchKeydown(event)">
                    <div style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--gray-400); pointer-events: none;">
                        🔍
                    </div>
                    <div id="supplierSearchResults" class="search-results" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--gray-200); border-top: none; border-radius: 0 0 6px 6px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 1000; display: none; max-height: 300px; overflow-y: auto;">
                        <!-- Search results will be populated here -->
                    </div>
                    <div style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); font-size: 0.75rem; color: var(--gray-400); pointer-events: none;">
                        Ctrl+K
                    </div>
                </div>
            </div>
            
            <!-- Right side navigation -->
            <div style="display: flex; align-items: center; gap: 1rem;">
                <!-- Location Filter -->
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="color: var(--gray-600); font-size: 0.875rem;">Location:</span>
                    <select id="headerLocationFilter" onchange="filterByLocation(this.value)" style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; background: white; font-size: 0.875rem;">
                        <option value="all">All Locations</option>
                        <option value="seattle">Seattle - Downtown</option>
                        <option value="bellevue">Bellevue - Main St</option>
                        <option value="tacoma">Tacoma - Pacific Ave</option>
                        <option value="everett">Everett - Industrial</option>
                    </select>
                </div>
                
                <!-- User Dropdown -->
                <div class="user-dropdown" id="userDropdown" style="position: relative;">
                    <button class="user-dropdown-toggle" onclick="toggleUserDropdown()" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.375rem 0.5rem; border-radius: 6px; background: white; cursor: pointer; transition: all 0.2s; border: 1px solid var(--gray-200); box-shadow: 0 1px 2px rgba(0,0,0,0.05);" onmouseover="this.style.background='var(--gray-50)'; this.style.borderColor='var(--gray-300)';" onmouseout="this.style.background='white'; this.style.borderColor='var(--gray-200)';">
                        <div style="width: 28px; height: 28px; border-radius: 4px; background: var(--gray-100); display: flex; align-items: center; justify-content: center; color: var(--gray-700); font-weight: 600; font-size: 0.75rem; border: 1px solid var(--gray-200);">
                            JS
                        </div>
                        <span style="font-weight: 500; color: var(--gray-700); font-size: 0.875rem;">Jacob Shure</span>
                        <span class="dropdown-arrow" style="font-size: 0.625rem; color: var(--gray-500); transition: transform 0.2s;">▼</span>
                    </button>
                    
                    <!-- User Dropdown Menu -->
                    <div class="user-dropdown-menu" id="userDropdownMenu" style="display: none; position: absolute; top: calc(100% + 0.5rem); right: 0; background: white; border: 1px solid var(--gray-200); border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 240px; z-index: 1000;">
                        <div style="padding: 1rem; border-bottom: 1px solid var(--gray-200);">
                            <div style="font-weight: 600; color: var(--gray-900); margin-bottom: 0.25rem;">Hwood Group Suppliers</div>
                            <div style="font-size: 0.875rem; color: var(--gray-600);">jacob@hwood.com</div>
                        </div>
                        <div style="padding: 0.5rem 0;">
                            <a href="#profile" onclick="loadUserSettings('profile'); closeUserDropdown(); return false;" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: var(--gray-700); text-decoration: none; transition: all 0.2s;" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='transparent'">
                                <span>👤</span>
                                <span>Profile</span>
                            </a>
                            <a href="#settings" onclick="loadSection('company'); closeUserDropdown(); return false;" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: var(--gray-700); text-decoration: none; transition: all 0.2s;" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='transparent'">
                                <span>⚙️</span>
                                <span>Settings</span>
                            </a>
                            <a href="#team" onclick="loadSection('team'); closeUserDropdown(); return false;" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: var(--gray-700); text-decoration: none; transition: all 0.2s;" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='transparent'">
                                <span>👥</span>
                                <span>Team Management</span>
                            </a>
                            <div style="height: 1px; background: var(--gray-200); margin: 0;"></div>
                            <a href="#" onclick="alert('Logging out...'); return false;" style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: var(--gray-700); text-decoration: none; transition: all 0.2s;" onmouseover="this.style.background='var(--gray-50)'" onmouseout="this.style.background='transparent'">
                                <span>🚪</span>
                                <span>Sign Out</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-title">Main</div>
            <a href="#dashboard" class="nav-item active" onclick="loadSection('dashboard')">
                Dashboard
            </a>
            <a href="#inbox" class="nav-item" onclick="loadSection('inbox')">
                Inbox
                <span class="badge">3</span>
            </a>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-title">Workflow</div>
            <!-- Step 1: RFPs come in -->
            <a href="#rfps" class="nav-item" onclick="loadSection('rfps'); return false;">
                1. RFPs & Bid Requests
                <span class="badge">5</span>
            </a>
            <!-- Step 2: Quotes are created -->
            <div class="nav-group">
                <a href="#quotes" class="nav-item expandable" onclick="toggleQuotesExpansion(event); return false;">
                    2. Quotes & Proposals
                    <span class="expand-icon" style="margin-left: auto; font-size: 0.75rem; transition: transform 0.2s;">▼</span>
                </a>
                <div class="nav-subitems" id="quotes-subitems" style="margin-left: 2rem; padding-left: 1rem; border-left: 1px solid var(--gray-300); display: block;">
                    <a href="#quotes-client" class="nav-item" onclick="loadSection('quotes-client')" style="font-size: 0.875rem; color: var(--gray-600);">
                        Client Quotes
                    </a>
                    <a href="#quotes-subcontractor" class="nav-item" onclick="loadSection('quotes-subcontractor')" style="font-size: 0.875rem; color: var(--gray-600);">
                        Vendor Quotes
                    </a>
                    <a href="#proposal-builder" class="nav-item" onclick="loadSection('proposal-builder')" style="font-size: 0.875rem; color: var(--gray-600);">
                        Proposal Builder
                    </a>
                </div>
            </div>
            <!-- Step 3: Work Orders are created -->
            <a href="#work-orders" class="nav-item" onclick="loadSection('work-orders'); return false;">
                3. Work Orders
                <span class="badge">12</span>
            </a>
            <!-- Step 4: Invoices are generated -->
            <a href="#invoices" class="nav-item" onclick="loadSection('invoices')">
                4. Invoices & Payments
            </a>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-title">Management</div>
            <a href="#locations" class="nav-item" onclick="loadSection('locations')">
                Locations
            </a>
            <a href="#subcontractors" class="nav-item" onclick="loadSection('subcontractors')">
                Subcontractors
            </a>
            <a href="#field-techs" class="nav-item" onclick="loadSection('field-techs')">
                Field Techs
            </a>
            <a href="#assets" class="nav-item" onclick="loadSection('assets')">
                Assets
            </a>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-title">Analytics</div>
            <a href="#documents" class="nav-item" onclick="loadSection('documents')">
                Shared Documents
                <span class="notification-badge" id="documentsBadge" style="background: var(--warning); color: white; font-size: 0.75rem; padding: 0.125rem 0.375rem; border-radius: 10px; margin-left: auto;">2</span>
            </a>
            <a href="#analytics" class="nav-item" onclick="loadSection('analytics')">
                Analytics
            </a>
            <a href="#reports" class="nav-item" onclick="loadSection('reports')">
                Reports
            </a>
            <a href="#feedback" class="nav-item" onclick="loadSection('feedback')">
                Customer Feedback
            </a>
            <a href="#budget" class="nav-item" onclick="loadSection('budget')">
                Budget Management
            </a>
        </div>
        
        <div class="sidebar-section">
            <div class="sidebar-title">Settings</div>
            <a href="#company" class="nav-item" onclick="loadSection('company')">
                Company
            </a>
            <a href="#admin" class="nav-item" onclick="loadSection('admin')">
                Admin
            </a>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="main-content">
        <!-- Breadcrumb Navigation -->
        <div id="breadcrumbContainer" style="padding: 0 20px;"></div>
        
        <div id="content">
            <!-- Content will be loaded dynamically by JavaScript -->
        </div>
    </main>
    
    <!-- Advanced Features Script -->
    <script src="/scripts/advanced-features.js"></script>
    
    <script>
        console.log('Script loading...');
        
        console.log('loadSection defined:', typeof window.loadSection);
        
        // Global functions for work orders
        function switchWorkTab(tab, type) {
            document.querySelectorAll('.work-tab').forEach(t => {
                t.style.background = 'transparent';
                t.style.color = 'white';
                t.style.opacity = '0.8';
            });
            tab.style.background = 'white';
            tab.style.color = '#0f766e';
            tab.style.opacity = '1';
        }
        
        let activeSubStatusFilters = [];
        
        function openSubStatusModal() {
            document.getElementById('subStatusModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        function closeSubStatusModal() {
            document.getElementById('subStatusModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function filterSubStatuses() {
            const searchTerm = document.getElementById('subStatusSearch').value.toLowerCase();
            const items = document.querySelectorAll('.substatus-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                const parent = item.closest('div');
                if (text.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
                
                // Hide/show group headers if no items are visible
                const visibleItems = parent.querySelectorAll('.substatus-item:not([style*="display: none"])');
                const header = parent.querySelector('h4');
                if (header) {
                    header.style.display = visibleItems.length > 0 ? 'block' : 'none';
                }
            });
        }
        
        function clearAllSubStatusFilters() {
            const checkboxes = document.querySelectorAll('#subStatusModal input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
            activeSubStatusFilters = [];
            updateActiveFiltersDisplay();
        }
        
        function applySubStatusFilters() {
            const checkboxes = document.querySelectorAll('#subStatusModal input[type="checkbox"]:checked');
            activeSubStatusFilters = Array.from(checkboxes).map(cb => ({
                value: cb.dataset.status,
                label: cb.parentElement.textContent.replace(/\([^)]*\)/g, '').trim()
            }));
            
            updateActiveFiltersDisplay();
            closeSubStatusModal();
            // Here you would filter the table based on selected sub-statuses
        }
        
        function updateActiveFiltersDisplay() {
            const container = document.getElementById('activeSubStatusFilters');
            const button = document.querySelector('button[onclick="openSubStatusModal()"] span:last-child');
            
            container.innerHTML = '';
            button.textContent = `${activeSubStatusFilters.length} Active`;
            
            activeSubStatusFilters.forEach((filter, index) => {
                const pill = document.createElement('div');
                pill.className = 'active-filter-pill';
                pill.innerHTML = `
                    ${filter.label}
                    <button onclick="removeSubStatusFilter('${filter.value}')" title="Remove filter">&times;</button>
                `;
                container.appendChild(pill);
            });
        }
        
        function removeSubStatusFilter(value) {
            activeSubStatusFilters = activeSubStatusFilters.filter(f => f.value !== value);
            
            // Uncheck the corresponding checkbox
            const checkbox = document.querySelector(`#subStatusModal input[data-status="${value}"]`);
            if (checkbox) checkbox.checked = false;
            
            updateActiveFiltersDisplay();
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('subStatusModal');
            if (event.target === modal) {
                closeSubStatusModal();
            }
        });

        function handleWorkOrderAction(btn, action) {
            const row = btn.closest('tr');
            const table = row.closest('table');
            
            // Check if this is the dashboard table or full work orders table
            const isDashboardTable = table.querySelector('th:nth-child(4)')?.textContent?.trim() === 'Status';
            
            let statusCell, subStatusCell, checkinCell, actionsCell;
            
            if (isDashboardTable) {
                // Dashboard table structure: Order #, Client, Location, Status, Scheduled, Actions
                statusCell = row.cells[3];
                actionsCell = row.cells[5];
                // Dashboard doesn't have sub-status or checkin columns
            } else {
                // Full work orders table structure
                statusCell = row.cells[4];
                subStatusCell = row.cells[5];
                checkinCell = row.cells[7];
                actionsCell = row.cells[8];
            }
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            switch(action) {
                case 'schedule':
                    // Open the schedule modal
                    openScheduleModal();
                    break;
                    
                case 'start':
                    // Update status to In Progress/Tech En Route
                    statusCell.innerHTML = '<span class="status-badge progress">In Progress</span>';
                    if (subStatusCell) subStatusCell.innerHTML = '<span style="font-size: 0.8125rem; color: #6b7280;">Tech En Route</span>';
                    // Show Check In button
                    actionsCell.innerHTML = '<button onclick="handleWorkOrderAction(this, \'checkin\')" class="btn btn-primary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Check In</button>';
                    
                    // Update Next Step section if it exists
                    const nextStepContainer = document.querySelector('.table-container[style*="border-left: 4px solid"]');
                    if (nextStepContainer) {
                        const nextStepContent = nextStepContainer.querySelector('div > div');
                        if (nextStepContent) {
                            nextStepContent.innerHTML = `
                                <div>
                                    <h3 style="font-size: 1rem; font-weight: 600; color: var(--gray-900); margin-bottom: 0.25rem;">Next Step</h3>
                                    <p style="font-size: 0.875rem; color: var(--gray-600);">Tech needs to check in at the location</p>
                                </div>
                                <button class="btn btn-primary" onclick="openCheckinModal()">Check In</button>
                            `;
                        }
                    }
                    
                    alert('Work started. Tech is en route.');
                    break;
                    
                case 'checkin':
                    // Open the check-in modal
                    openCheckinModal();
                    break;
                    
                case 'checkout':
                    // Open the checkout modal
                    openCheckoutModal();
                    break;
                    
                case 'resume':
                    // Resume from hold status
                    statusCell.innerHTML = '<span class="status-badge progress">In Progress</span>';
                    if (subStatusCell) subStatusCell.innerHTML = '<span style="font-size: 0.8125rem; color: #6b7280;">Tech Working</span>';
                    if (checkinCell) checkinCell.innerHTML = `<span style="color: #10b981; font-size: 0.875rem;">Checked in: ${time}</span>`;
                    actionsCell.innerHTML = '<button onclick="handleWorkOrderAction(this, \'checkout\')" class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Check Out</button>';
                    break;
                    
                case 'invoice':
                    // Update to Invoiced
                    if (subStatusCell) subStatusCell.innerHTML = '<span style="font-size: 0.8125rem; color: #6b7280;">Invoiced</span>';
                    actionsCell.innerHTML = '<button onclick="handleWorkOrderAction(this, \'archive\')" class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Archive</button>';
                    // Here you would typically open an invoicing modal or redirect to invoice creation
                    alert('Invoice created successfully. Work order ready for archiving after payment.');
                    break;
                    
                case 'archive':
                    // Archive the work order
                    if (confirm('Are you sure you want to archive this work order?')) {
                        row.style.transition = 'opacity 0.3s';
                        row.style.opacity = '0';
                        setTimeout(() => row.remove(), 300);
                    }
                    break;
                    
                default:
                    console.log('Unknown action:', action);
            }
        }
        
        
        
        function getWorkOrdersCalendarContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Work Orders Calendar</h2>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <button class="btn btn-secondary" onclick="loadSection('work-orders')">List View</button>
                            <button class="btn btn-primary" onclick="showCreateWorkOrderModal()">+ Create Work Order</button>
                        </div>
                    </div>
                    
                    <!-- Calendar Controls -->
                    <div class="table-container" style="margin-bottom: 1.5rem;">
                        <div class="table-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 class="table-title">Calendar View</h3>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <select id="calendarView" onchange="changeCalendarView()" style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="month">Month</option>
                                    <option value="week">Week</option>
                                    <option value="day">Day</option>
                                </select>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-secondary" onclick="previousPeriod()" style="padding: 0.5rem 1rem;">‹</button>
                                    <button class="btn btn-secondary" onclick="nextPeriod()" style="padding: 0.5rem 1rem;">›</button>
                                    <button class="btn btn-secondary" onclick="goToToday()" style="padding: 0.5rem 1rem;">Today</button>
                                </div>
                            </div>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div id="currentPeriod" style="text-align: center; font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; color: var(--primary);">
                                <!-- Current period will be displayed here -->
                            </div>
                            <div id="calendarGrid" style="min-height: 500px;">
                                <!-- Calendar will be rendered here -->
                            </div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="table-container" style="margin-bottom: 1.5rem;">
                        <div class="table-header">
                            <h3 class="table-title">Legend</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="display: flex; flex-wrap: wrap; gap: 1.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 20px; height: 20px; background: #22c55e; border-radius: 4px;"></div>
                                    <span>Scheduled</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 20px; height: 20px; background: #3b82f6; border-radius: 4px;"></div>
                                    <span>In Progress</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 20px; height: 20px; background: #f59e0b; border-radius: 4px;"></div>
                                    <span>Pending</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 20px; height: 20px; background: #ef4444; border-radius: 4px;"></div>
                                    <span>Overdue</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 20px; height: 20px; background: #8b5cf6; border-radius: 4px;"></div>
                                    <span>Recurring</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Work Order Details Modal will appear when clicking on calendar events -->
                </div>
            `;
        }

        async function getRFPsContent() {
            // Fetch RFPs from Supabase
            let rfps = [];
            let stats = {
                open: 0,
                bids: 0,
                avgResponseTime: '3.2 hrs',
                successRate: '87%'
            };
            
            try {
                const { data, error } = await supabase
                    .from('rfps')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (data && !error) {
                    rfps = data;
                    // Calculate stats
                    stats.open = rfps.filter(r => r.status === 'open').length;
                    stats.bids = rfps.reduce((sum, r) => sum + (r.bid_count || 0), 0);
                }
            } catch (err) {
                console.error('Error fetching RFPs:', err);
            }
            
            // Generate table rows for RFPs
            const rfpRows = rfps.length > 0 ? rfps.map(rfp => {
                const statusBadgeClass = {
                    'open': 'new',
                    'closed': 'completed',
                    'awarded': 'success',
                    'cancelled': 'cancelled'
                }[rfp.status] || 'pending';
                
                const budgetRange = rfp.budget_min && rfp.budget_max 
                    ? `$${rfp.budget_min.toLocaleString()} - $${rfp.budget_max.toLocaleString()}`
                    : 'TBD';
                
                const dueDate = rfp.due_date 
                    ? new Date(rfp.due_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                    : 'No deadline';
                    
                return `
                    <tr>
                        <td><strong>${rfp.rfp_number}</strong></td>
                        <td>${rfp.location_name || 'N/A'}</td>
                        <td>${rfp.title}</td>
                        <td>${rfp.location_name || 'N/A'}</td>
                        <td>${budgetRange}</td>
                        <td>${dueDate}</td>
                        <td><span class="status-badge ${statusBadgeClass}">${rfp.status.charAt(0).toUpperCase() + rfp.status.slice(1)}</span></td>
                        <td>
                            <button onclick="viewRFPDetails('${rfp.rfp_number}')" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View</button>
                            ${rfp.status === 'open' ? `<button onclick="sendToBidders('${rfp.rfp_number}')" class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Send to Bidders</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('') : `
                <tr>
                    <td colspan="8" style="text-align: center; color: var(--gray-500); padding: 2rem;">No RFPs found</td>
                </tr>
            `;
            
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">RFPs & Bid Requests</h2>
                        <button class="btn btn-primary" onclick="showCreateRFPModal()">+ Create RFP</button>
                    </div>
                    
                    <!-- RFP Stats -->
                    <div class="dashboard-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-label">Open RFPs</div>
                            <div class="stat-value">${stats.open}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Bids Received</div>
                            <div class="stat-value">${stats.bids}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg Response Time</div>
                            <div class="stat-value">${stats.avgResponseTime}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Success Rate</div>
                            <div class="stat-value">${stats.successRate}</div>
                        </div>
                    </div>
                    
                    <!-- RFP Tabs -->
                    <div style="display: flex; gap: 1rem; border-bottom: 2px solid var(--gray-200); margin-bottom: 2rem;">
                        <button onclick="switchRFPTab('incoming')" class="tab-btn active" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid var(--primary); color: var(--primary); font-weight: 600; cursor: pointer;">
                            Incoming RFPs (Client Requests)
                        </button>
                        <button onclick="switchRFPTab('outgoing')" class="tab-btn" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; color: var(--gray-600); font-weight: 600; cursor: pointer;">
                            Outgoing Bid Requests
                        </button>
                        <button onclick="switchRFPTab('awarded')" class="tab-btn" style="padding: 0.75rem 1.5rem; background: none; border: none; border-bottom: 3px solid transparent; color: var(--gray-600); font-weight: 600; cursor: pointer;">
                            Awarded Contracts
                        </button>
                    </div>
                    
                    <!-- Incoming RFPs Tab -->
                    <div id="incomingRFPsTab" class="rfp-tab-content">
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">New Service Requests from Clients</h3>
                                <button class="btn btn-secondary" onclick="filterRFPs()">Filter</button>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>RFP #</th>
                                        <th>Client</th>
                                        <th>Service Type</th>
                                        <th>Location</th>
                                        <th>Budget Range</th>
                                        <th>Deadline</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rfpRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Outgoing Bid Requests Tab -->
                    <div id="outgoingBidsTab" class="rfp-tab-content" style="display: none;">
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Bid Requests Sent to Vendors</h3>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>RFP #</th>
                                        <th>Service</th>
                                        <th>Vendors Invited</th>
                                        <th>Responses</th>
                                        <th>Lowest Bid</th>
                                        <th>Highest Bid</th>
                                        <th>Deadline</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>RFP-2025-002</strong></td>
                                        <td>Kitchen Deep Clean</td>
                                        <td>8 vendors</td>
                                        <td>5 received</td>
                                        <td>$2,150</td>
                                        <td>$3,200</td>
                                        <td>Jan 18, 2025</td>
                                        <td>
                                            <button onclick="compareBids('RFP-2025-002')" class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Compare Bids</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>RFP-2025-003</strong></td>
                                        <td>Plumbing Maintenance</td>
                                        <td>6 vendors</td>
                                        <td>3 received</td>
                                        <td>$5,500</td>
                                        <td>$7,800</td>
                                        <td>Jan 22, 2025</td>
                                        <td>
                                            <button onclick="compareBids('RFP-2025-003')" class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Compare Bids</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Awarded Contracts Tab -->
                    <div id="awardedContractsTab" class="rfp-tab-content" style="display: none;">
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Awarded Contracts</h3>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Contract #</th>
                                        <th>Original RFP</th>
                                        <th>Vendor</th>
                                        <th>Amount</th>
                                        <th>Start Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>CON-2025-001</strong></td>
                                        <td>RFP-2024-098</td>
                                        <td>Seattle HVAC Pro</td>
                                        <td>$18,500</td>
                                        <td>Jan 10, 2025</td>
                                        <td><span class="status-badge progress">In Progress</span></td>
                                        <td>
                                            <button onclick="viewContract('CON-2025-001')" class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View Contract</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getWorkOrdersContent() {
            console.log('getWorkOrdersContent called - returning content');
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: center; gap: 2rem;">
                            <h2 style="font-size: 1.875rem; font-weight: 700;">Work Orders</h2>
                            <!-- View Toggle -->
                            <div style="display: flex; align-items: center; background: var(--gray-100); border-radius: 8px; padding: 2px;">
                                <button id="listViewBtn" onclick="switchWorkOrderView('list')" class="view-toggle-btn active" style="padding: 0.5rem 1rem; border: none; background: white; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--gray-900); transition: all 0.2s;">
                                    List
                                </button>
                                <button id="calendarViewBtn" onclick="switchWorkOrderView('calendar')" class="view-toggle-btn" style="padding: 0.5rem 1rem; border: none; background: transparent; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--gray-600); transition: all 0.2s;">
                                    Calendar
                                </button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-secondary" onclick="showPreventativeMaintenanceModal()">+ Preventative Maintenance</button>
                            <button class="btn btn-primary" onclick="showCreateWorkOrderModal()">+ Create Work Order</button>
                        </div>
                    </div>
                    
                    <!-- List View Container -->
                    <div id="listViewContainer">
                    
                    <!-- Pipeline Stage Bar -->
                    <div style="background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between; position: relative;">
                            <!-- Progress Line -->
                            <div style="position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: var(--gray-200); z-index: 0;"></div>
                            
                            <!-- Stage Items -->
                            <div style="display: flex; justify-content: space-between; width: 100%; position: relative; z-index: 1;">
                                <div style="text-align: center; flex: 1; cursor: pointer;" onclick="filterByStage('requested')">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #f3e8ff; border: 2px solid #6b21a8; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #6b21a8; transition: all 0.2s ease;">2</div>
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #6b21a8;">REQUESTED</div>
                                </div>
                                <div style="text-align: center; flex: 1; cursor: pointer;" onclick="filterByStage('open')">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #dbeafe; border: 2px solid #1e40af; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #1e40af; transition: all 0.2s ease;">3</div>
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #1e40af;">OPEN</div>
                                </div>
                                <div style="text-align: center; flex: 1; cursor: pointer;" onclick="filterByStage('in-progress')">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #fef3c7; border: 2px solid #92400e; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #92400e; transition: all 0.2s ease;">4</div>
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #92400e;">IN PROGRESS</div>
                                </div>
                                <div style="text-align: center; flex: 1; cursor: pointer;" onclick="filterByStage('on-hold')">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #fee2e2; border: 2px solid #991b1b; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #991b1b; transition: all 0.2s ease;">1</div>
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #991b1b;">ON HOLD</div>
                                </div>
                                <div style="text-align: center; flex: 1; cursor: pointer;" onclick="filterByStage('completed')">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #d1fae5; border: 2px solid #065f46; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #065f46; transition: all 0.2s ease;">8</div>
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #065f46;">COMPLETED</div>
                                </div>
                                <div style="text-align: center; flex: 1; cursor: pointer;" onclick="filterByStage('cancelled')">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #f3f4f6; border: 2px solid #4b5563; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #4b5563; transition: all 0.2s ease;">1</div>
                                    <div style="font-size: 0.75rem; font-weight: 600; color: #4b5563;">CANCELLED</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sub-Status Filter Control -->
                    <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1.5rem;">
                        <button onclick="openSubStatusModal()" class="btn btn-secondary" style="padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>Filter by Sub-Status</span>
                            <span style="background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">6 Active</span>
                        </button>
                        <div id="activeSubStatusFilters" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <!-- Active filters will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Sub-Status Filter Modal -->
                    <div id="subStatusModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; padding: 2rem;">
                        <div style="max-width: 800px; margin: 0 auto; background: white; border-radius: 12px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                            <!-- Modal Header -->
                            <div style="padding: 1.5rem; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="font-size: 1.25rem; font-weight: 600; margin: 0;">Filter by Sub-Status</h3>
                                <button onclick="closeSubStatusModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">&times;</button>
                            </div>
                            
                            <!-- Search -->
                            <div style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--gray-200);">
                                <input type="search" id="subStatusSearch" placeholder="Search sub-statuses..." 
                                    style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px;" 
                                    oninput="filterSubStatuses()">
                            </div>
                            
                            <!-- Sub-Status Lists -->
                            <div style="flex: 1; overflow-y: auto; padding: 1.5rem;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                                    <!-- Requested -->
                                    <div>
                                        <h4 style="font-size: 0.875rem; font-weight: 600; color: #6b21a8; margin-bottom: 1rem; text-transform: uppercase;">Requested Stage</h4>
                                        <div class="substatus-group">
                                            <label class="substatus-item"><input type="checkbox" data-status="unassigned"> Unassigned <span class="count">(0)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="pending_confirmation"> Pending Confirmation <span class="count">(0)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="assigned_internal"> Assigned to Internal Team <span class="count">(0)</span></label>
                                        </div>
                                    </div>
                                    
                                    <!-- Open -->
                                    <div>
                                        <h4 style="font-size: 0.875rem; font-weight: 600; color: #1e40af; margin-bottom: 1rem; text-transform: uppercase;">Open Stage</h4>
                                        <div class="substatus-group">
                                            <label class="substatus-item"><input type="checkbox" data-status="confirmed"> Confirmed <span class="count">(3)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="tech_assigned"> Tech Assigned <span class="count">(1)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="tech_scheduled"> Tech Scheduled <span class="count">(0)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="tech_rescheduled"> Tech Rescheduled <span class="count">(0)</span></label>
                                        </div>
                                    </div>
                                    
                                    <!-- In Progress -->
                                    <div>
                                        <h4 style="font-size: 0.875rem; font-weight: 600; color: #92400e; margin-bottom: 1rem; text-transform: uppercase;">In Progress Stage</h4>
                                        <div class="substatus-group">
                                            <label class="substatus-item"><input type="checkbox" data-status="tech_working"> Tech Working <span class="count">(2)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="work_incomplete"> Work Incomplete <span class="count">(0)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="work_unsatisfactory"> Work Unsatisfactory <span class="count">(0)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="waiting_review"> Waiting for Review <span class="count">(0)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="waiting_quote"> Waiting for Quote <span class="count">(0)</span></label>
                                        </div>
                                    </div>
                                    
                                    <!-- On Hold -->
                                    <div>
                                        <h4 style="font-size: 0.875rem; font-weight: 600; color: #991b1b; margin-bottom: 1rem; text-transform: uppercase;">On Hold Stage</h4>
                                        <div class="substatus-group">
                                            <label class="substatus-item"><input type="checkbox" data-status="parts_received"> Parts Received <span class="count">(0)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="proposal_approved"> Proposal Approved <span class="count">(0)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="waiting_proposal"> Waiting for Proposal <span class="count">(0)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="waiting_proposal_approval"> Waiting for Proposal Approval <span class="count">(0)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="parts_requested"> Parts Requested <span class="count">(0)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="parts_on_order"> Parts on Order <span class="count">(0)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="delayed_third_party"> Delayed by Third Party <span class="count">(0)</span></label>
                                        </div>
                                    </div>
                                    
                                    <!-- Completed -->
                                    <div>
                                        <h4 style="font-size: 0.875rem; font-weight: 600; color: #065f46; margin-bottom: 1rem; text-transform: uppercase;">Completed Stage</h4>
                                        <div class="substatus-group">
                                            <label class="substatus-item"><input type="checkbox" data-status="completed_internal"> Completed by Internal Tech <span class="count">(0)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="internal_work_reviewed"> Internal Work Reviewed <span class="count">(0)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="work_reviewed_completed"> Work Reviewed and Completed <span class="count">(1)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="invoiced"> Invoiced <span class="count">(0)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="payment_made"> Payment Made <span class="count">(0)</span></label>
                                            <label class="substatus-item"><input type="checkbox" data-status="payment_accepted"> Payment Accepted <span class="count">(0)</span></label>
                                        </div>
                                    </div>
                                    
                                    <!-- Cancelled -->
                                    <div>
                                        <h4 style="font-size: 0.875rem; font-weight: 600; color: #4b5563; margin-bottom: 1rem; text-transform: uppercase;">Cancelled Stage</h4>
                                        <div class="substatus-group">
                                            <label class="substatus-item"><input type="checkbox" data-status="cancelled_reason"> Cancelled With Reason <span class="count">(0)</span></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Modal Footer -->
                            <div style="padding: 1.5rem; border-top: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
                                <button onclick="clearAllSubStatusFilters()" class="btn btn-secondary">Clear All</button>
                                <div style="display: flex; gap: 0.75rem;">
                                    <button onclick="closeSubStatusModal()" class="btn btn-secondary">Cancel</button>
                                    <button onclick="applySubStatusFilters()" class="btn btn-primary">Apply Filters</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Work Orders Table -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Active Work Orders</h3>
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                                <input type="text" id="workOrderSearch" placeholder="Search work orders..." 
                                    onkeyup="filterWorkOrders()" 
                                    style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px; width: 200px;">
                                <select id="dateRangeFilter" onchange="filterWorkOrders()" 
                                    style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                </select>
                                <select id="statusFilter" onchange="filterWorkOrders()" style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="">All Status</option>
                                    <option value="requested">Requested</option>
                                    <option value="open">Open</option>
                                    <option value="progress">In Progress</option>
                                    <option value="hold">On Hold</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                                <select id="priorityFilter" onchange="filterWorkOrders()" style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="">All Priority</option>
                                    <option value="emergency">Emergency</option>
                                    <option value="urgent">Urgent</option>
                                    <option value="standard">Standard</option>
                                </select>
                                <button class="btn btn-secondary" onclick="exportToCSV('workorders')" style="padding: 0.5rem 1rem;">
                                    <span style="margin-right: 0.25rem;">↓</span> Export
                                </button>
                            </div>
                        </div>
                        <div id="bulkActionsBar" style="display: none; padding: 1rem 1.5rem; background: var(--gray-50); border-bottom: 1px solid var(--gray-200);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span><strong id="selectedCount">0</strong> work orders selected</span>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-secondary" onclick="bulkAssign()">Bulk Assign</button>
                                    <button class="btn btn-secondary" onclick="bulkSchedule()">Bulk Schedule</button>
                                    <button class="btn btn-secondary" onclick="bulkUpdateStatus()">Update Status</button>
                                    <button class="btn btn-secondary" onclick="clearSelection()">Clear Selection</button>
                                </div>
                            </div>
                        </div>
                        <table id="workOrdersTable" style="width: 100%; table-layout: fixed;">
                            <thead>
                                <tr>
                                    <th style="width: 3%;"><input type="checkbox" id="selectAllWO" onchange="toggleAllWorkOrders()"></th>
                                    <th style="width: 7%;">WO #</th>
                                    <th style="width: 9%;">Location</th>
                                    <th style="width: 7%;">Type</th>
                                    <th style="width: 7%;">Priority</th>
                                    <th style="width: 9%;">Status</th>
                                    <th style="width: 11%;">Sub-Status</th>
                                    <th style="width: 10%;">Tech</th>
                                    <th style="width: 8%;">Check-in</th>
                                    <th style="width: 25%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="checkbox" class="wo-checkbox" data-wo="1989975" onchange="updateBulkSelection()"></td>
                                    <td><a href="#" onclick="loadWorkOrderDetail('1989975'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">#1989975</a></td>
                                    <td>Delilah LA</td>
                                    <td>Signs</td>
                                    <td><span style="padding: 0.15rem 0.3rem; background: #fee2e2; color: #991b1b; border-radius: 3px; font-size: 0.7rem; font-weight: 600;">EMRG</span></td>
                                    <td><span class="status-badge progress">In Progress</span></td>
                                    <td style="font-size: 0.75rem; color: #6b7280;">Tech Working</td>
                                    <td>John Smith</td>
                                    <td style="color: #10b981; font-size: 0.875rem;">9:08 AM</td>
                                    <td>
                                        <button onclick="handleWorkOrderAction(this, 'checkout')" class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Check Out</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" class="wo-checkbox" data-wo="1989976" onchange="updateBulkSelection()"></td>
                                    <td><a href="#" onclick="loadWorkOrderDetail('1989976'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">#1989976</a></td>
                                    <td>Poppy</td>
                                    <td>HVAC</td>
                                    <td><span style="padding: 0.15rem 0.3rem; background: #e5e7eb; color: #6b7280; border-radius: 3px; font-size: 0.7rem; font-weight: 600;">STD</span></td>
                                    <td><span class="status-badge requested">Requested</span></td>
                                    <td style="font-size: 0.75rem; color: #6b7280;">Unassigned</td>
                                    <td>-</td>
                                    <td style="color: #6b7280; font-size: 0.875rem;">-</td>
                                    <td>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button onclick="handleWorkOrderAction(this, 'schedule')" class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Schedule</button>
                                            <button onclick="handleWorkOrderAction(this, 'start')" class="btn btn-primary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Start Work</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" class="wo-checkbox" data-wo="1989974" onchange="updateBulkSelection()"></td>
                                    <td><a href="#" onclick="loadWorkOrderDetail('1989974'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">#1989974</a></td>
                                    <td>Delilah LA</td>
                                    <td>General</td>
                                    <td><span style="padding: 0.15rem 0.3rem; background: #e5e7eb; color: #6b7280; border-radius: 3px; font-size: 0.7rem; font-weight: 600;">STD</span></td>
                                    <td><span class="status-badge open">Open</span></td>
                                    <td style="font-size: 0.75rem; color: #6b7280;">Tech Assigned</td>
                                    <td>Mike Johnson</td>
                                    <td style="color: #6b7280; font-size: 0.875rem;">-</td>
                                    <td>
                                        <button onclick="handleWorkOrderAction(this, 'checkin')" class="btn btn-primary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Check In</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" class="wo-checkbox" data-wo="1989973" onchange="updateBulkSelection()"></td>
                                    <td><a href="#" onclick="loadWorkOrderDetail('1989973'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">#1989973</a></td>
                                    <td>Bootsy Bellows</td>
                                    <td>Plumbing</td>
                                    <td><span style="padding: 0.15rem 0.3rem; background: #fed7aa; color: #9a3412; border-radius: 3px; font-size: 0.7rem; font-weight: 600;">URG</span></td>
                                    <td><span class="status-badge requested">Requested</span></td>
                                    <td style="font-size: 0.75rem; color: #6b7280;">Unassigned</td>
                                    <td>-</td>
                                    <td style="color: #6b7280; font-size: 0.875rem;">-</td>
                                    <td>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button onclick="handleWorkOrderAction(this, 'schedule')" class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Schedule</button>
                                            <button onclick="handleWorkOrderAction(this, 'start')" class="btn btn-primary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Start Work</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" class="wo-checkbox" data-wo="1989972" onchange="updateBulkSelection()"></td>
                                    <td><a href="#" onclick="loadWorkOrderDetail('1989972'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">#1989972</a></td>
                                    <td>Poppy</td>
                                    <td>Plumbing</td>
                                    <td><span style="padding: 0.15rem 0.3rem; background: #fed7aa; color: #9a3412; border-radius: 3px; font-size: 0.7rem; font-weight: 600;">URG</span></td>
                                    <td><span class="status-badge progress">In Progress</span></td>
                                    <td style="font-size: 0.75rem; color: #6b7280;">Tech Working</td>
                                    <td>Sarah Lee</td>
                                    <td style="color: #10b981; font-size: 0.875rem;">2:15 PM</td>
                                    <td>
                                        <button onclick="handleWorkOrderAction(this, 'checkout')" class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Check Out</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" class="wo-checkbox" data-wo="1989971" onchange="updateBulkSelection()"></td>
                                    <td><a href="#" onclick="loadWorkOrderDetail('1989971'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">#1989971</a></td>
                                    <td>Nice Guy</td>
                                    <td>Electrical</td>
                                    <td><span style="padding: 0.15rem 0.3rem; background: #e5e7eb; color: #6b7280; border-radius: 3px; font-size: 0.7rem; font-weight: 600;">STD</span></td>
                                    <td><span class="status-badge hold">On Hold</span></td>
                                    <td style="font-size: 0.75rem; color: #6b7280;">Waiting Parts</td>
                                    <td>Tom Wilson</td>
                                    <td style="color: #6b7280; font-size: 0.875rem;">-</td>
                                    <td>
                                        <button onclick="handleWorkOrderAction(this, 'resume')" class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Resume Work</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" class="wo-checkbox" data-wo="1989970" onchange="updateBulkSelection()"></td>
                                    <td><a href="#" onclick="loadWorkOrderDetail('1989970'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">#1989970</a></td>
                                    <td>Delilah LA</td>
                                    <td>Doors</td>
                                    <td><span style="padding: 0.15rem 0.3rem; background: #e5e7eb; color: #6b7280; border-radius: 3px; font-size: 0.7rem; font-weight: 600;">STD</span></td>
                                    <td><span class="status-badge open">Open</span></td>
                                    <td style="font-size: 0.75rem; color: #6b7280;">Tech Assigned</td>
                                    <td>Jane Doe</td>
                                    <td style="color: #6b7280; font-size: 0.875rem;">-</td>
                                    <td>
                                        <button onclick="handleWorkOrderAction(this, 'checkin')" class="btn btn-primary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Check In</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" class="wo-checkbox" data-wo="1989969" onchange="updateBulkSelection()"></td>
                                    <td><a href="#" onclick="loadWorkOrderDetail('1989969'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">#1989969</a></td>
                                    <td>Bootsy Bellows</td>
                                    <td>Cleaning</td>
                                    <td><span style="padding: 0.15rem 0.3rem; background: #e5e7eb; color: #6b7280; border-radius: 3px; font-size: 0.7rem; font-weight: 600;">STD</span></td>
                                    <td><span class="status-badge open">Open</span></td>
                                    <td style="font-size: 0.75rem; color: #6b7280;">Tech Scheduled</td>
                                    <td>Team A</td>
                                    <td style="color: #6b7280; font-size: 0.875rem;">-</td>
                                    <td>
                                        <button onclick="handleWorkOrderAction(this, 'checkin')" class="btn btn-primary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Check In</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" class="wo-checkbox" data-wo="1989961" onchange="updateBulkSelection()"></td>
                                    <td><a href="#" onclick="loadWorkOrderDetail('1989961'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">#1989961</a></td>
                                    <td>Delilah LA</td>
                                    <td>Doors</td>
                                    <td><span style="padding: 0.15rem 0.3rem; background: #fed7aa; color: #9a3412; border-radius: 3px; font-size: 0.7rem; font-weight: 600;">URG</span></td>
                                    <td><span class="status-badge completed">Completed</span></td>
                                    <td style="font-size: 0.75rem; color: #6b7280;">Invoiced</td>
                                    <td>Jane Doe</td>
                                    <td style="color: #10b981; font-size: 0.875rem;">Done</td>
                                    <td>
                                        <button onclick="handleWorkOrderAction(this, 'archive')" class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Archive</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" class="wo-checkbox" data-wo="1989960" onchange="updateBulkSelection()"></td>
                                    <td><a href="#" onclick="loadWorkOrderDetail('1989960'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">#1989960</a></td>
                                    <td>Nice Guy</td>
                                    <td>HVAC</td>
                                    <td><span style="padding: 0.15rem 0.3rem; background: #e5e7eb; color: #6b7280; border-radius: 3px; font-size: 0.7rem; font-weight: 600;">STD</span></td>
                                    <td><span class="status-badge cancelled">Cancelled</span></td>
                                    <td style="font-size: 0.75rem; color: #6b7280;">Cancelled Reason</td>
                                    <td>Mike Johnson</td>
                                    <td style="color: #6b7280; font-size: 0.875rem;">-</td>
                                    <td>
                                        <button onclick="handleWorkOrderAction(this, 'archive')" class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Archive</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" class="wo-checkbox" data-wo="1989959" onchange="updateBulkSelection()"></td>
                                    <td><a href="#" onclick="loadWorkOrderDetail('1989959'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">#1989959</a></td>
                                    <td>Poppy</td>
                                    <td>Painting</td>
                                    <td><span style="padding: 0.15rem 0.3rem; background: #e5e7eb; color: #6b7280; border-radius: 3px; font-size: 0.7rem; font-weight: 600;">STD</span></td>
                                    <td><span class="status-badge progress">In Progress</span></td>
                                    <td style="font-size: 0.75rem; color: #6b7280;">Work Incomplete</td>
                                    <td>Bob Ross</td>
                                    <td style="color: #10b981; font-size: 0.875rem;">11:30 AM</td>
                                    <td>
                                        <button onclick="handleWorkOrderAction(this, 'checkout')" class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Check Out</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" class="wo-checkbox" data-wo="1989958" onchange="updateBulkSelection()"></td>
                                    <td><a href="#" onclick="loadWorkOrderDetail('1989958'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">#1989958</a></td>
                                    <td>Delilah LA</td>
                                    <td>HVAC</td>
                                    <td><span style="padding: 0.15rem 0.3rem; background: #fed7aa; color: #9a3412; border-radius: 3px; font-size: 0.7rem; font-weight: 600;">URG</span></td>
                                    <td><span class="status-badge completed">Completed</span></td>
                                    <td style="font-size: 0.75rem; color: #6b7280;">Work Reviewed</td>
                                    <td>Alice Tech</td>
                                    <td style="color: #10b981; font-size: 0.875rem;">Done</td>
                                    <td>
                                        <button onclick="handleWorkOrderAction(this, 'invoice')" class="btn btn-primary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Invoice</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><input type="checkbox" class="wo-checkbox" data-wo="1989957" onchange="updateBulkSelection()"></td>
                                    <td><a href="#" onclick="loadWorkOrderDetail('1989957'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">#1989957</a></td>
                                    <td>Nice Guy</td>
                                    <td>Plumbing</td>
                                    <td><span style="padding: 0.15rem 0.3rem; background: #e5e7eb; color: #6b7280; border-radius: 3px; font-size: 0.7rem; font-weight: 600;">STD</span></td>
                                    <td><span class="status-badge completed">Completed</span></td>
                                    <td style="font-size: 0.75rem; color: #6b7280;">Payment Accepted</td>
                                    <td>Sam Plumber</td>
                                    <td style="color: #10b981; font-size: 0.875rem;">Done</td>
                                    <td>
                                        <button onclick="handleWorkOrderAction(this, 'archive')" class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;">Archive</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                    
                    <!-- Calendar View Container -->
                    <div id="calendarViewContainer" style="display: none;">
                        <!-- Pipeline Stage Bar (same as list view) -->
                        <div style="background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; justify-content: space-between; position: relative;">
                                <!-- Progress Line -->
                                <div style="position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: var(--gray-200); z-index: 0;"></div>
                                
                                <!-- Stage Items -->
                                <div style="display: flex; justify-content: space-between; width: 100%; position: relative; z-index: 1;">
                                    <div style="text-align: center; flex: 1; cursor: pointer;" onclick="filterByStage('requested')">
                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #f3e8ff; border: 2px solid #6b21a8; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #6b21a8; transition: all 0.2s ease;">2</div>
                                        <div style="font-size: 0.75rem; font-weight: 600; color: #6b21a8;">REQUESTED</div>
                                    </div>
                                    <div style="text-align: center; flex: 1; cursor: pointer;" onclick="filterByStage('open')">
                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #dbeafe; border: 2px solid #1e40af; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #1e40af; transition: all 0.2s ease;">3</div>
                                        <div style="font-size: 0.75rem; font-weight: 600; color: #1e40af;">OPEN</div>
                                    </div>
                                    <div style="text-align: center; flex: 1; cursor: pointer;" onclick="filterByStage('in-progress')">
                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #fef3c7; border: 2px solid #92400e; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #92400e; transition: all 0.2s ease;">4</div>
                                        <div style="font-size: 0.75rem; font-weight: 600; color: #92400e;">IN PROGRESS</div>
                                    </div>
                                    <div style="text-align: center; flex: 1; cursor: pointer;" onclick="filterByStage('on-hold')">
                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #fee2e2; border: 2px solid #991b1b; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #991b1b; transition: all 0.2s ease;">1</div>
                                        <div style="font-size: 0.75rem; font-weight: 600; color: #991b1b;">ON HOLD</div>
                                    </div>
                                    <div style="text-align: center; flex: 1; cursor: pointer;" onclick="filterByStage('completed')">
                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #d1fae5; border: 2px solid #065f46; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #065f46; transition: all 0.2s ease;">8</div>
                                        <div style="font-size: 0.75rem; font-weight: 600; color: #065f46;">COMPLETED</div>
                                    </div>
                                    <div style="text-align: center; flex: 1; cursor: pointer;" onclick="filterByStage('cancelled')">
                                        <div style="width: 40px; height: 40px; border-radius: 50%; background: #f3f4f6; border: 2px solid #4b5563; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #4b5563; transition: all 0.2s ease;">1</div>
                                        <div style="font-size: 0.75rem; font-weight: 600; color: #4b5563;">CANCELLED</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Calendar Controls -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <!-- Calendar View Options -->
                                <div style="display: flex; align-items: center; background: var(--gray-100); border-radius: 8px; padding: 2px;">
                                    <button onclick="switchCalendarView('month')" class="calendar-view-btn active" style="padding: 0.5rem 1rem; border: none; background: white; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--gray-900); transition: all 0.2s;">
                                        Month
                                    </button>
                                    <button onclick="switchCalendarView('week')" class="calendar-view-btn" style="padding: 0.5rem 1rem; border: none; background: transparent; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--gray-600); transition: all 0.2s;">
                                        Week
                                    </button>
                                    <button onclick="switchCalendarView('day')" class="calendar-view-btn" style="padding: 0.5rem 1rem; border: none; background: transparent; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--gray-600); transition: all 0.2s;">
                                        Day
                                    </button>
                                </div>
                                
                                <!-- Navigation Controls -->
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <button onclick="navigateCalendar('prev')" style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                        ←
                                    </button>
                                    <button onclick="navigateCalendar('today')" style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px; background: white; cursor: pointer; font-weight: 600;">
                                        Today
                                    </button>
                                    <button onclick="navigateCalendar('next')" style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                                        →
                                    </button>
                                </div>

                                <!-- Current Date Display -->
                                <div id="currentCalendarDate" style="font-weight: 600; color: var(--gray-700); margin-left: 1rem;">
                                    September 2025
                                </div>
                            </div>
                        </div>

                        <!-- Sub-Status Filter Control (same as list view) -->
                        <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1.5rem;">
                            <button onclick="openSubStatusModal()" class="btn btn-secondary" style="padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span>Filter by Sub-Status</span>
                                <span style="background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">6 Active</span>
                            </button>
                            <div id="activeSubStatusFilters" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <!-- Active filters will be populated here -->
                            </div>
                        </div>

                        <!-- Calendar Grid Container -->
                        <div id="calendarGrid" style="background: white; border: 1px solid var(--gray-200); border-radius: 12px; overflow: hidden;">
                            <!-- Month View (default) -->
                            <div id="monthView" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--gray-200);">
                                <!-- Calendar Header -->
                                <div style="background: var(--gray-50); padding: 0.75rem; font-weight: 600; text-align: center; color: var(--gray-700);">Sun</div>
                                <div style="background: var(--gray-50); padding: 0.75rem; font-weight: 600; text-align: center; color: var(--gray-700);">Mon</div>
                                <div style="background: var(--gray-50); padding: 0.75rem; font-weight: 600; text-align: center; color: var(--gray-700);">Tue</div>
                                <div style="background: var(--gray-50); padding: 0.75rem; font-weight: 600; text-align: center; color: var(--gray-700);">Wed</div>
                                <div style="background: var(--gray-50); padding: 0.75rem; font-weight: 600; text-align: center; color: var(--gray-700);">Thu</div>
                                <div style="background: var(--gray-50); padding: 0.75rem; font-weight: 600; text-align: center; color: var(--gray-700);">Fri</div>
                                <div style="background: var(--gray-50); padding: 0.75rem; font-weight: 600; text-align: center; color: var(--gray-700);">Sat</div>
                                
                                <!-- Full Month Calendar Days (September 2025) -->
                                <!-- Week 1 -->
                                <div style="background: var(--gray-50); padding: 0.75rem; min-height: 100px; color: var(--gray-400); font-size: 0.875rem;">31</div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px; position: relative; cursor: pointer;" onclick="viewDayDetail('2025-09-01')">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">1</div>
                                    <div style="background: var(--primary); color: white; font-size: 0.75rem; padding: 2px 4px; border-radius: 3px; margin-bottom: 2px;">HVAC</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">2</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px; cursor: pointer;" onclick="viewDayDetail('2025-09-03')">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">3</div>
                                    <div style="background: var(--warning); color: white; font-size: 0.75rem; padding: 2px 4px; border-radius: 3px; margin-bottom: 2px;">Clean</div>
                                    <div style="background: var(--success); color: white; font-size: 0.75rem; padding: 2px 4px; border-radius: 3px;">Repair</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">4</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px; cursor: pointer;" onclick="viewDayDetail('2025-09-05')">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">5</div>
                                    <div style="background: var(--danger); color: white; font-size: 0.75rem; padding: 2px 4px; border-radius: 3px;">Emergency</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">6</div>
                                </div>

                                <!-- Week 2 -->
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">7</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px; cursor: pointer;" onclick="viewDayDetail('2025-09-08')">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">8</div>
                                    <div style="background: var(--success); color: white; font-size: 0.75rem; padding: 2px 4px; border-radius: 3px;">Maintenance</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">9</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">10</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">11</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px; cursor: pointer;" onclick="viewDayDetail('2025-09-12')">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">12</div>
                                    <div style="background: var(--primary); color: white; font-size: 0.75rem; padding: 2px 4px; border-radius: 3px; margin-bottom: 2px;">HVAC</div>
                                    <div style="background: var(--warning); color: white; font-size: 0.75rem; padding: 2px 4px; border-radius: 3px;">Clean</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">13</div>
                                </div>

                                <!-- Week 3 -->
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">14</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px; cursor: pointer;" onclick="viewDayDetail('2025-09-15')">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">15</div>
                                    <div style="background: var(--success); color: white; font-size: 0.75rem; padding: 2px 4px; border-radius: 3px;">Inspection</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">16</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">17</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px; cursor: pointer;" onclick="viewDayDetail('2025-09-18')">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">18</div>
                                    <div style="background: var(--danger); color: white; font-size: 0.75rem; padding: 2px 4px; border-radius: 3px;">Urgent</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">19</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">20</div>
                                </div>

                                <!-- Week 4 -->
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">21</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px; cursor: pointer;" onclick="viewDayDetail('2025-09-22')">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">22</div>
                                    <div style="background: var(--warning); color: white; font-size: 0.75rem; padding: 2px 4px; border-radius: 3px;">Deep Clean</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">23</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">24</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px; cursor: pointer;" onclick="viewDayDetail('2025-09-25')">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">25</div>
                                    <div style="background: var(--primary); color: white; font-size: 0.75rem; padding: 2px 4px; border-radius: 3px;">HVAC</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">26</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">27</div>
                                </div>

                                <!-- Week 5 -->
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">28</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px; cursor: pointer;" onclick="viewDayDetail('2025-09-29')">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">29</div>
                                    <div style="background: var(--success); color: white; font-size: 0.75rem; padding: 2px 4px; border-radius: 3px;">Monthly</div>
                                </div>
                                <div style="background: white; padding: 0.75rem; min-height: 100px;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900); margin-bottom: 0.5rem;">30</div>
                                </div>
                                <div style="background: var(--gray-50); padding: 0.75rem; min-height: 100px; color: var(--gray-400); font-size: 0.875rem;">1</div>
                                <div style="background: var(--gray-50); padding: 0.75rem; min-height: 100px; color: var(--gray-400); font-size: 0.875rem;">2</div>
                                <div style="background: var(--gray-50); padding: 0.75rem; min-height: 100px; color: var(--gray-400); font-size: 0.875rem;">3</div>
                                <div style="background: var(--gray-50); padding: 0.75rem; min-height: 100px; color: var(--gray-400); font-size: 0.875rem;">4</div>

                                <!-- Week 6 -->
                                <div style="background: var(--gray-50); padding: 0.75rem; min-height: 100px; color: var(--gray-400); font-size: 0.875rem;">5</div>
                                <div style="background: var(--gray-50); padding: 0.75rem; min-height: 100px; color: var(--gray-400); font-size: 0.875rem;">6</div>
                                <div style="background: var(--gray-50); padding: 0.75rem; min-height: 100px; color: var(--gray-400); font-size: 0.875rem;">7</div>
                                <div style="background: var(--gray-50); padding: 0.75rem; min-height: 100px; color: var(--gray-400); font-size: 0.875rem;">8</div>
                                <div style="background: var(--gray-50); padding: 0.75rem; min-height: 100px; color: var(--gray-400); font-size: 0.875rem;">9</div>
                                <div style="background: var(--gray-50); padding: 0.75rem; min-height: 100px; color: var(--gray-400); font-size: 0.875rem;">10</div>
                                <div style="background: var(--gray-50); padding: 0.75rem; min-height: 100px; color: var(--gray-400); font-size: 0.875rem;">11</div>
                            </div>

                            <!-- Week View (hidden by default) -->
                            <div id="weekView" style="display: none;">
                                <!-- Week Header -->
                                <div style="display: grid; grid-template-columns: 80px repeat(7, 1fr); gap: 1px; background: var(--gray-200); border-bottom: 1px solid var(--gray-300);">
                                    <div style="background: var(--gray-50); padding: 0.75rem; font-weight: 600; text-align: center; color: var(--gray-700);"></div>
                                    <div style="background: var(--gray-50); padding: 0.75rem; font-weight: 600; text-align: center; color: var(--gray-700);">
                                        <div style="font-size: 0.875rem;">Sun</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; margin-top: 0.25rem;">1</div>
                                    </div>
                                    <div style="background: var(--gray-50); padding: 0.75rem; font-weight: 600; text-align: center; color: var(--gray-700);">
                                        <div style="font-size: 0.875rem;">Mon</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; margin-top: 0.25rem;">2</div>
                                    </div>
                                    <div style="background: var(--gray-50); padding: 0.75rem; font-weight: 600; text-align: center; color: var(--gray-700);">
                                        <div style="font-size: 0.875rem;">Tue</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; margin-top: 0.25rem;">3</div>
                                    </div>
                                    <div style="background: var(--gray-50); padding: 0.75rem; font-weight: 600; text-align: center; color: var(--gray-700);">
                                        <div style="font-size: 0.875rem;">Wed</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; margin-top: 0.25rem;">4</div>
                                    </div>
                                    <div style="background: var(--gray-50); padding: 0.75rem; font-weight: 600; text-align: center; color: var(--gray-700);">
                                        <div style="font-size: 0.875rem;">Thu</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; margin-top: 0.25rem;">5</div>
                                    </div>
                                    <div style="background: var(--gray-50); padding: 0.75rem; font-weight: 600; text-align: center; color: var(--gray-700);">
                                        <div style="font-size: 0.875rem;">Fri</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; margin-top: 0.25rem;">6</div>
                                    </div>
                                    <div style="background: var(--gray-50); padding: 0.75rem; font-weight: 600; text-align: center; color: var(--gray-700);">
                                        <div style="font-size: 0.875rem;">Sat</div>
                                        <div style="font-size: 1.25rem; font-weight: 700; margin-top: 0.25rem;">7</div>
                                    </div>
                                </div>

                                <!-- Week Time Slots -->
                                <div style="max-height: 600px; overflow-y: auto;">
                                    <!-- 6 AM -->
                                    <div style="display: grid; grid-template-columns: 80px repeat(7, 1fr); gap: 1px; background: var(--gray-200); min-height: 60px;">
                                        <div style="background: var(--gray-50); padding: 0.5rem; font-size: 0.75rem; color: var(--gray-600); text-align: center; font-weight: 500;">6 AM</div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem;"></div>
                                    </div>

                                    <!-- 8 AM -->
                                    <div style="display: grid; grid-template-columns: 80px repeat(7, 1fr); gap: 1px; background: var(--gray-200); min-height: 60px;">
                                        <div style="background: var(--gray-50); padding: 0.5rem; font-size: 0.75rem; color: var(--gray-600); text-align: center; font-weight: 500;">8 AM</div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);">
                                            <div style="background: var(--primary); color: white; font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;" onclick="viewDayDetail('2025-09-02')">
                                                HVAC Maintenance
                                            </div>
                                        </div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem;"></div>
                                    </div>

                                    <!-- 10 AM -->
                                    <div style="display: grid; grid-template-columns: 80px repeat(7, 1fr); gap: 1px; background: var(--gray-200); min-height: 60px;">
                                        <div style="background: var(--gray-50); padding: 0.5rem; font-size: 0.75rem; color: var(--gray-600); text-align: center; font-weight: 500;">10 AM</div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);">
                                            <div style="background: var(--warning); color: white; font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;" onclick="viewDayDetail('2025-09-04')">
                                                Deep Clean
                                            </div>
                                        </div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem;"></div>
                                    </div>

                                    <!-- 12 PM -->
                                    <div style="display: grid; grid-template-columns: 80px repeat(7, 1fr); gap: 1px; background: var(--gray-200); min-height: 60px;">
                                        <div style="background: var(--gray-50); padding: 0.5rem; font-size: 0.75rem; color: var(--gray-600); text-align: center; font-weight: 500;">12 PM</div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);">
                                            <div style="background: var(--danger); color: white; font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;" onclick="viewDayDetail('2025-09-06')">
                                                Emergency
                                            </div>
                                        </div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem;"></div>
                                    </div>

                                    <!-- 2 PM -->
                                    <div style="display: grid; grid-template-columns: 80px repeat(7, 1fr); gap: 1px; background: var(--gray-200); min-height: 60px;">
                                        <div style="background: var(--gray-50); padding: 0.5rem; font-size: 0.75rem; color: var(--gray-600); text-align: center; font-weight: 500;">2 PM</div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);">
                                            <div style="background: var(--success); color: white; font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;" onclick="viewDayDetail('2025-09-07')">
                                                Inspection
                                            </div>
                                        </div>
                                        <div style="background: white; padding: 0.5rem;"></div>
                                    </div>

                                    <!-- 4 PM -->
                                    <div style="display: grid; grid-template-columns: 80px repeat(7, 1fr); gap: 1px; background: var(--gray-200); min-height: 60px;">
                                        <div style="background: var(--gray-50); padding: 0.5rem; font-size: 0.75rem; color: var(--gray-600); text-align: center; font-weight: 500;">4 PM</div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem; border-right: 1px solid var(--gray-100);"></div>
                                        <div style="background: white; padding: 0.5rem;"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Day View (hidden by default) -->
                            <div id="dayView" style="display: none;">
                                <!-- Day Header -->
                                <div style="background: var(--gray-50); padding: 1.5rem; border-bottom: 1px solid var(--gray-200); text-align: center;">
                                    <h3 style="font-size: 1.25rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.5rem;">Friday, September 5, 2025</h3>
                                    <p style="color: var(--gray-600);">2 work orders scheduled</p>
                                </div>

                                <!-- Day Schedule -->
                                <div style="max-height: 600px; overflow-y: auto;">
                                    <!-- Morning Hours -->
                                    <div style="border-bottom: 1px solid var(--gray-100);">
                                        <div style="display: grid; grid-template-columns: 80px 1fr; gap: 0;">
                                            <div style="background: var(--gray-50); padding: 1rem 0.5rem; font-size: 0.875rem; color: var(--gray-600); text-align: center; font-weight: 500; border-right: 1px solid var(--gray-200);">
                                                6:00 AM
                                            </div>
                                            <div style="background: white; padding: 1rem; border-bottom: 1px solid var(--gray-100);">
                                                <!-- Empty time slot -->
                                            </div>
                                        </div>
                                    </div>

                                    <div style="border-bottom: 1px solid var(--gray-100);">
                                        <div style="display: grid; grid-template-columns: 80px 1fr; gap: 0;">
                                            <div style="background: var(--gray-50); padding: 1rem 0.5rem; font-size: 0.875rem; color: var(--gray-600); text-align: center; font-weight: 500; border-right: 1px solid var(--gray-200);">
                                                8:00 AM
                                            </div>
                                            <div style="background: white; padding: 1rem; border-bottom: 1px solid var(--gray-100);">
                                                <!-- Empty time slot -->
                                            </div>
                                        </div>
                                    </div>

                                    <div style="border-bottom: 1px solid var(--gray-100);">
                                        <div style="display: grid; grid-template-columns: 80px 1fr; gap: 0;">
                                            <div style="background: var(--gray-50); padding: 1rem 0.5rem; font-size: 0.875rem; color: var(--gray-600); text-align: center; font-weight: 500; border-right: 1px solid var(--gray-200);">
                                                10:00 AM
                                            </div>
                                            <div style="background: white; padding: 1rem; border-bottom: 1px solid var(--gray-100);">
                                                <div style="background: linear-gradient(135deg, var(--danger), #dc2626); color: white; padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);" onclick="viewWorkOrderDetail('WO-2025-001')">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                                        <h4 style="font-weight: 600; margin: 0;">🚨 Emergency Repair</h4>
                                                        <span style="font-size: 0.75rem; opacity: 0.9;">10:00 AM - 12:00 PM</span>
                                                    </div>
                                                    <p style="margin: 0; opacity: 0.9; font-size: 0.875rem;">Walk-in cooler complete failure - Lodge Bread Downtown</p>
                                                    <div style="margin-top: 0.5rem; font-size: 0.75rem; opacity: 0.8;">
                                                        Tech: Mike Johnson • Priority: Critical
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div style="border-bottom: 1px solid var(--gray-100);">
                                        <div style="display: grid; grid-template-columns: 80px 1fr; gap: 0;">
                                            <div style="background: var(--gray-50); padding: 1rem 0.5rem; font-size: 0.875rem; color: var(--gray-600); text-align: center; font-weight: 500; border-right: 1px solid var(--gray-200);">
                                                12:00 PM
                                            </div>
                                            <div style="background: white; padding: 1rem; border-bottom: 1px solid var(--gray-100);">
                                                <!-- Empty time slot -->
                                            </div>
                                        </div>
                                    </div>

                                    <div style="border-bottom: 1px solid var(--gray-100);">
                                        <div style="display: grid; grid-template-columns: 80px 1fr; gap: 0;">
                                            <div style="background: var(--gray-50); padding: 1rem 0.5rem; font-size: 0.875rem; color: var(--gray-600); text-align: center; font-weight: 500; border-right: 1px solid var(--gray-200);">
                                                2:00 PM
                                            </div>
                                            <div style="background: white; padding: 1rem; border-bottom: 1px solid var(--gray-100);">
                                                <div style="background: linear-gradient(135deg, var(--success), #059669); color: white; padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);" onclick="viewWorkOrderDetail('WO-2025-002')">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                                        <h4 style="font-weight: 600; margin: 0;">Routine Maintenance</h4>
                                                        <span style="font-size: 0.75rem; opacity: 0.9;">2:00 PM - 4:00 PM</span>
                                                    </div>
                                                    <p style="margin: 0; opacity: 0.9; font-size: 0.875rem;">Monthly HVAC filter replacement and inspection</p>
                                                    <div style="margin-top: 0.5rem; font-size: 0.75rem; opacity: 0.8;">
                                                        Tech: Sarah Chen • Priority: Normal
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div style="border-bottom: 1px solid var(--gray-100);">
                                        <div style="display: grid; grid-template-columns: 80px 1fr; gap: 0;">
                                            <div style="background: var(--gray-50); padding: 1rem 0.5rem; font-size: 0.875rem; color: var(--gray-600); text-align: center; font-weight: 500; border-right: 1px solid var(--gray-200);">
                                                4:00 PM
                                            </div>
                                            <div style="background: white; padding: 1rem; border-bottom: 1px solid var(--gray-100);">
                                                <!-- Empty time slot -->
                                            </div>
                                        </div>
                                    </div>

                                    <div style="border-bottom: 1px solid var(--gray-100);">
                                        <div style="display: grid; grid-template-columns: 80px 1fr; gap: 0;">
                                            <div style="background: var(--gray-50); padding: 1rem 0.5rem; font-size: 0.875rem; color: var(--gray-600); text-align: center; font-weight: 500; border-right: 1px solid var(--gray-200);">
                                                6:00 PM
                                            </div>
                                            <div style="background: white; padding: 1rem; border-bottom: 1px solid var(--gray-100);">
                                                <!-- Empty time slot -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getClientQuotesContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Client Quotes</h2>
                        <button class="btn btn-primary" onclick="createNewQuote()">+ Create Quote</button>
                    </div>
                    
                    <!-- Tabs like your reference -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--gray-200);">
                        <button class="client-quote-tab active" onclick="switchClientQuoteTab('all')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid var(--primary); color: var(--gray-900); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            All
                        </button>
                        <button class="client-quote-tab" onclick="switchClientQuoteTab('pending')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Pending <span style="color: var(--gray-500); font-size: 0.875rem;">0</span>
                        </button>
                        <button class="client-quote-tab" onclick="switchClientQuoteTab('declined')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Declined <span style="color: var(--gray-500); font-size: 0.875rem;">0</span>
                        </button>
                        <button class="client-quote-tab" onclick="switchClientQuoteTab('approved')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Approved <span style="color: var(--gray-500); font-size: 0.875rem;">0</span>
                        </button>
                        <button class="client-quote-tab" onclick="switchClientQuoteTab('expired')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Expired <span style="color: var(--gray-500); font-size: 0.875rem;">0</span>
                        </button>
                    </div>
                    
                    <!-- Search and Filters -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div style="display: flex; gap: 0.75rem; align-items: center;">
                            <div style="position: relative;">
                                <input type="search" placeholder="Search" style="padding: 0.5rem 1rem; padding-left: 2.5rem; border: 1px solid var(--gray-300); border-radius: 6px; width: 300px;">
                                <div style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--gray-400);"></div>
                            </div>
                            <button style="padding: 0.5rem 1rem; background: none; border: 1px solid var(--gray-300); border-radius: 6px; color: var(--gray-600); cursor: pointer;">
                                Newest
                                <span style="margin-left: 0.5rem;">▼</span>
                            </button>
                        </div>
                        <button class="btn btn-secondary" style="display: flex; align-items: center; gap: 0.5rem;">
                            OPEN VIEW
                        </button>
                    </div>
                    
                    <!-- Empty State -->
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4rem 2rem; text-align: center;">
                        <div style="width: 64px; height: 64px; margin-bottom: 1.5rem; opacity: 0.5;">
                        </div>
                        <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--gray-900); margin-bottom: 0.5rem;">
                            Looks like your team hasn't created any quotes.
                        </h3>
                        <p style="color: var(--gray-500); font-size: 0.875rem;">
                            Create a quote for a work order from the work order detail page.
                        </p>
                    </div>
                </div>
            `;
        }
        
        function getInvoicesContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Invoices</h2>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn btn-secondary" onclick="createInvoiceFromQuote()">Create from Quote</button>
                            <button class="btn btn-primary" onclick="createNewInvoice()">+ Create Invoice</button>
                        </div>
                    </div>
                    
                    <!-- Invoice Status Tabs -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--gray-200);">
                        <button class="invoice-tab active" onclick="switchInvoiceTab('all')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid var(--primary); color: var(--gray-900); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            All
                        </button>
                        <button class="invoice-tab" onclick="switchInvoiceTab('draft')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Draft <span style="color: var(--gray-500); font-size: 0.875rem;">3</span>
                        </button>
                        <button class="invoice-tab" onclick="switchInvoiceTab('sent')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Sent <span style="color: var(--gray-500); font-size: 0.875rem;">5</span>
                        </button>
                        <button class="invoice-tab" onclick="switchInvoiceTab('paid')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Paid <span style="color: var(--gray-500); font-size: 0.875rem;">12</span>
                        </button>
                        <button class="invoice-tab" onclick="switchInvoiceTab('overdue')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Overdue <span style="color: var(--danger); font-size: 0.875rem;">2</span>
                        </button>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-value">$45,231</div>
                            <div class="stat-label">Outstanding</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">$125,450</div>
                            <div class="stat-label">Paid This Month</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">12</div>
                            <div class="stat-label">Overdue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">20</div>
                            <div class="stat-label">Total Invoices</div>
                        </div>
                    </div>
                    
                    <div class="table-container" id="invoice-table-container">
                        <div class="table-header">
                            <h3 class="table-title">All Invoices</h3>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <input type="search" placeholder="Search invoices..." style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                <button class="btn btn-secondary" onclick="exportInvoices()">Export</button>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Client</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Due Date</th>
                                    <th>Created From</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invoice-table-body">
                                <tr>
                                    <td><a href="#" onclick="viewInvoice('INV-2024-001'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">INV-2024-001</a></td>
                                    <td>Chili's</td>
                                    <td>$2,500.00</td>
                                    <td><span class="status-badge completed">Paid</span></td>
                                    <td>Jan 10, 2024</td>
                                    <td>Quote #Q-2024-001</td>
                                    <td>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="viewInvoice('INV-2024-001')">View</button>
                                            <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="downloadInvoice('INV-2024-001')">Download</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td><a href="#" onclick="viewInvoice('INV-2024-002'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">INV-2024-002</a></td>
                                    <td>McDonald's</td>
                                    <td>$1,850.00</td>
                                    <td><span class="status-badge pending">Sent</span></td>
                                    <td>Feb 15, 2024</td>
                                    <td>Quote #Q-2024-003</td>
                                    <td>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="viewInvoice('INV-2024-002')">View</button>
                                            <button class="btn btn-primary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="sendReminder('INV-2024-002')">Remind</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td><a href="#" onclick="viewInvoice('INV-2024-003'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">INV-2024-003</a></td>
                                    <td>Taco Bell</td>
                                    <td>$3,200.00</td>
                                    <td><span class="status-badge danger">Overdue</span></td>
                                    <td>Jan 20, 2024</td>
                                    <td>Quote #Q-2024-005</td>
                                    <td>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="viewInvoice('INV-2024-003')">View</button>
                                            <button class="btn btn-danger" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="sendFinalNotice('INV-2024-003')">Final Notice</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function getAssetsContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Asset Management</h2>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-label">Total Assets</div>
                            <div class="stat-value">524</div>
                            <div class="stat-trend positive">+12 this month</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Managed Assets</div>
                            <div class="stat-value">497</div>
                            <div class="stat-trend">Requiring Maintenance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Value</div>
                            <div class="stat-value">$2.4M</div>
                            <div class="stat-trend">Asset Portfolio</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Maintenance Due</div>
                            <div class="stat-value">18</div>
                            <div class="stat-trend negative">Within 30 days</div>
                        </div>
                    </div>
                    
                    <!-- Main Container -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">All Assets</h3>
                            <div style="display: flex; gap: 0.75rem;">
                                <button class="btn btn-primary" onclick="addAsset()">+ Add Asset</button>
                                <button class="btn btn-secondary" onclick="downloadAssets()">Export</button>
                            </div>
                        </div>
                        
                        <!-- Asset Type Tabs inside container -->
                        <div style="display: flex; gap: 2rem; padding: 0 1.5rem; border-bottom: 2px solid var(--gray-200);">
                            <button id="managed-assets-tab" class="asset-type-tab active" onclick="switchAssetType('managed')" 
                                style="padding: 1rem 0; background: none; border: none; border-bottom: 3px solid var(--primary); color: var(--gray-900); cursor: pointer; font-weight: 600; font-size: 0.875rem; margin-bottom: -2px;">
                                MANAGED ASSETS
                            </button>
                            <button id="general-assets-tab" class="asset-type-tab" onclick="switchAssetType('general')" 
                                style="padding: 1rem 0; background: none; border: none; border-bottom: 3px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 600; font-size: 0.875rem; margin-bottom: -2px;">
                                GENERAL ASSETS
                            </button>
                        </div>
                        
                        <!-- Search and Filters Bar -->
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: var(--gray-50); border-bottom: 1px solid var(--gray-200);">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <input type="search" placeholder="Search assets..." 
                                    style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px; width: 300px; background: white;">
                                <select id="assetGroupFilter" onchange="filterByAssetGroup()" style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; min-width: 150px; background: white;">
                                    <option value="all">All Groups</option>
                                    <option value="hvac">HVAC</option>
                                    <option value="appliance">Appliance</option>
                                    <option value="furniture">Furniture / Fixtures</option>
                                    <option value="doors">Doors</option>
                                    <option value="electrical">Electrical</option>
                                    <option value="plumbing">Plumbing</option>
                                </select>
                                <select id="locationFilter" onchange="filterByLocation()" style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; min-width: 150px; background: white;">
                                    <option value="all">All Locations</option>
                                    <option value="mcdonalds">McDonald's - Sunset</option>
                                    <option value="burgerking">Burger King - Melrose</option>
                                    <option value="delilah">Delilah LA</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" id="activeToggle" checked onchange="filterActiveAssets()" 
                                        style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-size: 0.875rem; font-weight: 500;">Active Only</span>
                                </label>
                                <button class="btn btn-secondary" onclick="viewAssetGrid()" style="padding: 0.5rem;">
                                    <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Managed Assets Content -->
                        <div id="managed-assets-content">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="width: 100px;">Asset ID</th>
                                        <th style="width: 80px;">Photo</th>
                                        <th>Asset</th>
                                        <th style="width: 250px;">Actions</th>
                                        <th style="width: 180px;">Asset Group</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><a href="#" onclick="viewAssetDetail('2788410'); return false;" style="color: var(--primary); font-weight: 600;">2788410</a></td>
                                        <td>
                                            <div style="width: 50px; height: 50px; background: var(--gray-200); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                                <svg style="width: 24px; height: 24px; color: var(--gray-400);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                            </div>
                                        </td>
                                        <td>Curtains</td>
                                        <td>
                                            <button class="btn btn-primary" onclick="createServiceRequest('2788410')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                                + CREATE SERVICE REQUEST
                                            </button>
                                        </td>
                                        <td>Furniture / Fixtures</td>
                                    </tr>
                                    <tr>
                                        <td><a href="#" onclick="viewAssetDetail('2779041'); return false;" style="color: var(--primary); font-weight: 600;">2779041</a></td>
                                        <td>
                                            <img src="/assets/dishwasher.jpg" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;" 
                                                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" alt="Asset">
                                            <div style="width: 50px; height: 50px; background: var(--gray-200); border-radius: 4px; display: none; align-items: center; justify-content: center;">
                                                <svg style="width: 24px; height: 24px; color: var(--gray-400);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                            </div>
                                        </td>
                                        <td>Ecotrak Service Dishwasher</td>
                                        <td>
                                            <button class="btn btn-primary" onclick="createServiceRequest('2779041')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                                + CREATE SERVICE REQUEST
                                            </button>
                                        </td>
                                        <td>Appliance</td>
                                    </tr>
                                    <tr>
                                        <td><a href="#" onclick="viewAssetDetail('2763466'); return false;" style="color: var(--primary); font-weight: 600;">2763466</a></td>
                                        <td>
                                            <div style="width: 50px; height: 50px; background: var(--gray-200); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                                <svg style="width: 24px; height: 24px; color: var(--gray-400);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                            </div>
                                        </td>
                                        <td>Stairs</td>
                                        <td>
                                            <button class="btn btn-primary" onclick="createServiceRequest('2763466')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                                + CREATE SERVICE REQUEST
                                            </button>
                                        </td>
                                        <td>Doors</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-top: 1px solid var(--gray-200);">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 0.875rem; color: var(--gray-600);">Rows per page:</span>
                                    <select style="padding: 0.25rem 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                        <option>50</option>
                                        <option>100</option>
                                        <option>200</option>
                                    </select>
                                </div>
                                <div style="font-size: 0.875rem; color: var(--gray-600);">
                                    1-50 of 497
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="prevPage()" style="padding: 0.25rem 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; background: white;">‹</button>
                                    <button onclick="nextPage()" style="padding: 0.25rem 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; background: white;">›</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- General Assets Content (Hidden by default) -->
                        <div id="general-assets-content" style="display: none;">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="width: 100px;">Asset ID</th>
                                        <th style="width: 80px;">Photo</th>
                                        <th>Description</th>
                                        <th>Location</th>
                                        <th>Category</th>
                                        <th>Value</th>
                                        <th style="width: 200px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><a href="#" onclick="viewAssetDetail('GA-001'); return false;" style="color: var(--primary); font-weight: 600;">GA-001</a></td>
                                        <td>
                                            <div style="width: 50px; height: 50px; background: var(--gray-200); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                                <svg style="width: 24px; height: 24px; color: var(--gray-400);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                            </div>
                                        </td>
                                        <td>Office Desk - Executive</td>
                                        <td>McDonald's - Sunset</td>
                                        <td>Furniture</td>
                                        <td>$1,200</td>
                                        <td>
                                            <button class="btn btn-secondary" onclick="editGeneralAsset('GA-001')" style="padding: 0.4rem 0.8rem; font-size: 0.875rem;">Edit</button>
                                            <button class="btn btn-secondary" onclick="viewGeneralAsset('GA-001')" style="padding: 0.4rem 0.8rem; font-size: 0.875rem;">View</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><a href="#" onclick="viewAssetDetail('GA-002'); return false;" style="color: var(--primary); font-weight: 600;">GA-002</a></td>
                                        <td>
                                            <div style="width: 50px; height: 50px; background: var(--gray-200); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                                <svg style="width: 24px; height: 24px; color: var(--gray-400);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                            </div>
                                        </td>
                                        <td>Conference Table</td>
                                        <td>Burger King - Melrose</td>
                                        <td>Furniture</td>
                                        <td>$3,500</td>
                                        <td>
                                            <button class="btn btn-secondary" onclick="editGeneralAsset('GA-002')" style="padding: 0.4rem 0.8rem; font-size: 0.875rem;">Edit</button>
                                            <button class="btn btn-secondary" onclick="viewGeneralAsset('GA-002')" style="padding: 0.4rem 0.8rem; font-size: 0.875rem;">View</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
        window.getAssetsContent = getAssetsContent;
        
        function getAssetDetailContent(assetId) {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <div>
                            <button class="btn btn-secondary" onclick="loadSection('assets')" style="margin-bottom: 1rem;">← Back to Assets</button>
                            <h2 style="font-size: 1.875rem; font-weight: 700;">Asset Detail: ${assetId}</h2>
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn btn-secondary" onclick="scheduleMaintenance('${assetId}')">Schedule Maintenance</button>
                            <button class="btn btn-primary" onclick="editAsset('${assetId}')">Edit Asset</button>
                        </div>
                    </div>
                    
                    <!-- Asset Overview Cards -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Equipment Information</h3>
                            </div>
                            <div style="padding: 1.5rem;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                                    <div>
                                        <label style="font-size: 0.875rem; color: var(--gray-600);">Asset ID</label>
                                        <p style="font-weight: 600; margin-top: 0.25rem;">${assetId}</p>
                                    </div>
                                    <div>
                                        <label style="font-size: 0.875rem; color: var(--gray-600);">Equipment Name</label>
                                        <p style="font-weight: 600; margin-top: 0.25rem;">Carrier 50XC Rooftop Unit</p>
                                    </div>
                                    <div>
                                        <label style="font-size: 0.875rem; color: var(--gray-600);">Location</label>
                                        <p style="font-weight: 600; margin-top: 0.25rem;">McDonald's - Sunset Strip</p>
                                    </div>
                                    <div>
                                        <label style="font-size: 0.875rem; color: var(--gray-600);">Category</label>
                                        <p style="font-weight: 600; margin-top: 0.25rem;">HVAC</p>
                                    </div>
                                    <div>
                                        <label style="font-size: 0.875rem; color: var(--gray-600);">Manufacturer</label>
                                        <p style="font-weight: 600; margin-top: 0.25rem;">Carrier Corporation</p>
                                    </div>
                                    <div>
                                        <label style="font-size: 0.875rem; color: var(--gray-600);">Model Number</label>
                                        <p style="font-weight: 600; margin-top: 0.25rem;">50XC-048</p>
                                    </div>
                                    <div>
                                        <label style="font-size: 0.875rem; color: var(--gray-600);">Serial Number</label>
                                        <p style="font-weight: 600; margin-top: 0.25rem;">4923NW89234</p>
                                    </div>
                                    <div>
                                        <label style="font-size: 0.875rem; color: var(--gray-600);">Install Date</label>
                                        <p style="font-weight: 600; margin-top: 0.25rem;">March 15, 2019</p>
                                    </div>
                                    <div>
                                        <label style="font-size: 0.875rem; color: var(--gray-600);">Warranty Expires</label>
                                        <p style="font-weight: 600; margin-top: 0.25rem;">March 15, 2029</p>
                                    </div>
                                    <div>
                                        <label style="font-size: 0.875rem; color: var(--gray-600);">Status</label>
                                        <p><span class="status-badge completed">Operational</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="stat-card" style="margin-bottom: 1rem;">
                                <div class="stat-label">Asset Value</div>
                                <div class="stat-value">$45,000</div>
                                <p style="font-size: 0.875rem; color: var(--gray-600); margin-top: 0.5rem;">Original Cost</p>
                            </div>
                            <div class="stat-card" style="margin-bottom: 1rem;">
                                <div class="stat-label">Total Spend</div>
                                <div class="stat-value">$8,450</div>
                                <p style="font-size: 0.875rem; color: var(--gray-600); margin-top: 0.5rem;">Lifetime Maintenance</p>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Next Service</div>
                                <div class="stat-value" style="font-size: 1.25rem;">Jan 15</div>
                                <p style="font-size: 0.875rem; color: var(--gray-600); margin-top: 0.5rem;">Quarterly PM</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Maintenance History -->
                    <div class="table-container" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3 class="table-title">Maintenance History</h3>
                            <button class="btn btn-secondary" onclick="downloadMaintenanceReport('${assetId}')">Download Report</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Work Order</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Technician</th>
                                    <th>Cost</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Oct 15, 2024</td>
                                    <td><a href="#" style="color: var(--primary);">#WO-8923</a></td>
                                    <td>Preventive</td>
                                    <td>Quarterly PM - Filter replacement, coil cleaning</td>
                                    <td>ABC Maintenance</td>
                                    <td>$450</td>
                                    <td><span class="status-badge completed">Completed</span></td>
                                </tr>
                                <tr>
                                    <td>Sep 3, 2024</td>
                                    <td><a href="#" style="color: var(--primary);">#WO-8456</a></td>
                                    <td>Repair</td>
                                    <td>Compressor failure - replaced compressor unit</td>
                                    <td>ABC Maintenance</td>
                                    <td>$3,200</td>
                                    <td><span class="status-badge completed">Completed</span></td>
                                </tr>
                                <tr>
                                    <td>Jul 15, 2024</td>
                                    <td><a href="#" style="color: var(--primary);">#WO-7823</a></td>
                                    <td>Preventive</td>
                                    <td>Quarterly PM - Standard service</td>
                                    <td>ABC Maintenance</td>
                                    <td>$450</td>
                                    <td><span class="status-badge completed">Completed</span></td>
                                </tr>
                                <tr>
                                    <td>Apr 15, 2024</td>
                                    <td><a href="#" style="color: var(--primary);">#WO-6234</a></td>
                                    <td>Preventive</td>
                                    <td>Quarterly PM - Belt adjustment, filter change</td>
                                    <td>ABC Maintenance</td>
                                    <td>$450</td>
                                    <td><span class="status-badge completed">Completed</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Cost Analysis -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Cost Breakdown (Last 12 Months)</h3>
                            </div>
                            <div style="padding: 1.5rem;">
                                <div style="margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Preventive Maintenance</span>
                                        <strong>$1,800</strong>
                                    </div>
                                    <div style="height: 8px; background: var(--gray-200); border-radius: 4px;">
                                        <div style="width: 35%; height: 100%; background: var(--success); border-radius: 4px;"></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Repairs</span>
                                        <strong>$3,200</strong>
                                    </div>
                                    <div style="height: 8px; background: var(--gray-200); border-radius: 4px;">
                                        <div style="width: 65%; height: 100%; background: var(--warning); border-radius: 4px;"></div>
                                    </div>
                                </div>
                                <div style="padding-top: 1rem; border-top: 1px solid var(--gray-200);">
                                    <div style="display: flex; justify-content: space-between;">
                                        <strong>Total Spend</strong>
                                        <strong style="color: var(--primary); font-size: 1.25rem;">$5,000</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Documents</h3>
                                <button class="btn btn-secondary" onclick="uploadDocument('${assetId}')">Upload</button>
                            </div>
                            <div style="padding: 1.5rem;">
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    <a href="#" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: var(--gray-50); border-radius: 6px; text-decoration: none; color: var(--gray-900);">
                                        <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 500;">Installation Manual</div>
                                            <div style="font-size: 0.75rem; color: var(--gray-600);">PDF • 2.4 MB</div>
                                        </div>
                                    </a>
                                    <a href="#" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: var(--gray-50); border-radius: 6px; text-decoration: none; color: var(--gray-900);">
                                        <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 500;">Warranty Certificate</div>
                                            <div style="font-size: 0.75rem; color: var(--gray-600);">PDF • 156 KB</div>
                                        </div>
                                    </a>
                                    <a href="#" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: var(--gray-50); border-radius: 6px; text-decoration: none; color: var(--gray-900);">
                                        <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 500;">Service History 2024</div>
                                            <div style="font-size: 0.75rem; color: var(--gray-600);">Excel • 89 KB</div>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        window.getAssetDetailContent = getAssetDetailContent;
        
        function viewAssetDetail(assetId) {
            loadSection('asset-detail', assetId);
        }
        window.viewAssetDetail = viewAssetDetail;
        
        function addAsset() {
            showAddAssetModal();
        }
        window.addAsset = addAsset;
        
        function showAddAssetModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>Add New Asset</h3>
                        <button class="close-btn" onclick="closeAddAssetModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="add-asset-form">
                            <!-- Asset Type Selection -->
                            <div style="margin-bottom: 2rem;">
                                <h4 style="font-size: 1rem; font-weight: 600; color: var(--gray-700); margin-bottom: 1rem;">Select Asset Type</h4>
                                <div style="display: flex; gap: 2rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="radio" name="assetType" value="managed" checked onchange="toggleAssetFormFields()"
                                            style="width: 20px; height: 20px;">
                                        <span style="font-weight: 500;">Managed Asset (Requires maintenance tracking)</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                        <input type="radio" name="assetType" value="general" onchange="toggleAssetFormFields()"
                                            style="width: 20px; height: 20px;">
                                        <span style="font-weight: 500;">General Asset (No maintenance required)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Managed Asset Fields -->
                            <div id="managed-asset-fields">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div style="grid-column: 1 / -1;">
                                        <h4 style="font-size: 1rem; font-weight: 600; color: var(--gray-700); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--gray-200);">Equipment Information</h4>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Asset <span style="color: var(--danger);">*</span>
                                        </label>
                                        <input type="text" name="managed_asset" required placeholder="e.g., Curtains, Ecotrak Service Dishwasher"
                                            style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Photo
                                        </label>
                                        <input type="file" name="managed_photo" accept="image/*"
                                            style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Asset Group <span style="color: var(--danger);">*</span>
                                        </label>
                                        <select name="managed_asset_group" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                            <option value="">Select asset group...</option>
                                            <option value="HVAC">HVAC</option>
                                            <option value="Appliance">Appliance</option>
                                            <option value="Furniture / Fixtures">Furniture / Fixtures</option>
                                            <option value="Doors">Doors</option>
                                            <option value="Electrical">Electrical</option>
                                            <option value="Plumbing">Plumbing</option>
                                            <option value="Roofing">Roofing</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Location <span style="color: var(--danger);">*</span>
                                        </label>
                                        <select name="managed_location" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                            <option value="">Select location...</option>
                                            <option value="mcdonalds-sunset">McDonald's - Sunset Strip</option>
                                            <option value="burger-king-melrose">Burger King - Melrose</option>
                                            <option value="delilah-la">Delilah LA</option>
                                        </select>
                                    </div>
                                    
                                    <div style="grid-column: 1 / -1;">
                                        <h4 style="font-size: 1rem; font-weight: 600; color: var(--gray-700); margin-top: 1rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--gray-200);">Maintenance Schedule</h4>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Service Type
                                        </label>
                                        <select name="service_type" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                            <option value="">Select service type...</option>
                                            <option value="Preventive Maintenance">Preventive Maintenance</option>
                                            <option value="Inspection">Inspection</option>
                                            <option value="Cleaning">Cleaning</option>
                                            <option value="Calibration">Calibration</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Frequency
                                        </label>
                                        <select name="frequency" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                            <option value="">Select frequency...</option>
                                            <option value="Weekly">Weekly</option>
                                            <option value="Monthly">Monthly</option>
                                            <option value="Quarterly">Quarterly</option>
                                            <option value="Semi-Annual">Semi-Annual</option>
                                            <option value="Annual">Annual</option>
                                            <option value="As Needed">As Needed</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Last Service Date
                                        </label>
                                        <input type="date" name="last_service_date"
                                            style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Next Service Date
                                        </label>
                                        <input type="date" name="next_service_date"
                                            style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    </div>
                                    
                                    <div style="grid-column: 1 / -1;">
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Notes
                                        </label>
                                        <textarea name="managed_notes" rows="3" placeholder="Add any additional notes about this asset..."
                                            style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; resize: vertical;"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- General Asset Fields -->
                            <div id="general-asset-fields" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div style="grid-column: 1 / -1;">
                                        <h4 style="font-size: 1rem; font-weight: 600; color: var(--gray-700); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--gray-200);">Asset Information</h4>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Description <span style="color: var(--danger);">*</span>
                                        </label>
                                        <input type="text" name="general_description" required placeholder="e.g., Office Desk - Executive"
                                            style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Category <span style="color: var(--danger);">*</span>
                                        </label>
                                        <select name="general_category" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                            <option value="">Select category...</option>
                                            <option value="Furniture">Furniture</option>
                                            <option value="Electronics">Electronics</option>
                                            <option value="Office Equipment">Office Equipment</option>
                                            <option value="Kitchen Equipment">Kitchen Equipment</option>
                                            <option value="Tools">Tools</option>
                                            <option value="Decorations">Decorations</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Location <span style="color: var(--danger);">*</span>
                                        </label>
                                        <select name="general_location" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                            <option value="">Select location...</option>
                                            <option value="mcdonalds-sunset">McDonald's - Sunset Strip</option>
                                            <option value="burger-king-melrose">Burger King - Melrose</option>
                                            <option value="delilah-la">Delilah LA</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Value <span style="color: var(--danger);">*</span>
                                        </label>
                                        <input type="number" name="general_value" required placeholder="0.00" step="0.01"
                                            style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Purchase Date
                                        </label>
                                        <input type="date" name="general_purchase_date"
                                            style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Quantity
                                        </label>
                                        <input type="number" name="general_quantity" placeholder="1" min="1"
                                            style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Photo
                                        </label>
                                        <input type="file" name="general_photo" accept="image/*"
                                            style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Vendor
                                        </label>
                                        <input type="text" name="general_vendor" placeholder="e.g., Office Depot"
                                            style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    </div>
                                    
                                    <div style="grid-column: 1 / -1;">
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Notes
                                        </label>
                                        <textarea name="general_notes" rows="3" placeholder="Add any additional notes about this asset..."
                                            style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; resize: vertical;"></textarea>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeAddAssetModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveAsset()">Save Asset</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            // Initialize form fields based on default selection
            toggleAssetFormFields();
        }
        window.showAddAssetModal = showAddAssetModal;
        
        function closeAddAssetModal() {
            const modal = document.querySelector('.modal.active');
            if (modal) {
                modal.remove();
            }
        }
        window.closeAddAssetModal = closeAddAssetModal;
        
        function saveAsset() {
            const assetType = document.querySelector('input[name="assetType"]:checked')?.value;
            const form = document.getElementById('add-asset-form');
            
            if (assetType === 'managed') {
                const asset = form.querySelector('input[name="managed_asset"]')?.value;
                const assetGroup = form.querySelector('select[name="managed_asset_group"]')?.value;
                const location = form.querySelector('select[name="managed_location"]')?.value;
                
                if (!asset || !assetGroup || !location) {
                    showToast('Please fill in all required fields', 'warning');
                    return;
                }
                
                showToast(`Managed Asset "${asset}" added successfully`, 'success');
            } else {
                const description = form.querySelector('input[name="general_description"]')?.value;
                const category = form.querySelector('select[name="general_category"]')?.value;
                const location = form.querySelector('select[name="general_location"]')?.value;
                const value = form.querySelector('input[name="general_value"]')?.value;
                
                if (!description || !category || !location || !value) {
                    showToast('Please fill in all required fields', 'warning');
                    return;
                }
                
                showToast(`General Asset "${description}" added successfully`, 'success');
            }
            
            closeAddAssetModal();
            loadSection('assets');
        }
        window.saveAsset = saveAsset;
        
        function exportAssets() {
            showToast('Exporting assets report to CSV...', 'info');
        }
        window.exportAssets = exportAssets;
        
        function filterAssets(category) {
            // Update active tab
            document.querySelectorAll('.asset-tab').forEach(tab => {
                tab.style.borderBottom = '2px solid transparent';
                tab.style.color = 'var(--gray-600)';
            });
            event.target.style.borderBottom = '2px solid var(--primary)';
            event.target.style.color = 'var(--gray-900)';
            
            showToast(`Filtering assets by ${category}`, 'info');
        }
        window.filterAssets = filterAssets;
        
        function scheduleMaintenance(assetId) {
            showToast(`Opening maintenance scheduler for ${assetId}...`, 'info');
        }
        window.scheduleMaintenance = scheduleMaintenance;
        
        function editAsset(assetId) {
            showToast(`Opening asset editor for ${assetId}...`, 'info');
        }
        window.editAsset = editAsset;
        
        function downloadMaintenanceReport(assetId) {
            showToast(`Downloading maintenance report for ${assetId}...`, 'info');
        }
        window.downloadMaintenanceReport = downloadMaintenanceReport;
        
        function uploadDocument(assetId) {
            showToast(`Opening document uploader for ${assetId}...`, 'info');
        }
        window.uploadDocument = uploadDocument;
        
        function switchAssetType(type) {
            const managedTab = document.getElementById('managed-assets-tab');
            const generalTab = document.getElementById('general-assets-tab');
            const managedContent = document.getElementById('managed-assets-content');
            const generalContent = document.getElementById('general-assets-content');
            
            if (type === 'managed') {
                managedTab.style.borderBottom = '3px solid var(--primary)';
                managedTab.style.color = 'var(--gray-900)';
                generalTab.style.borderBottom = '3px solid transparent';
                generalTab.style.color = 'var(--gray-600)';
                managedContent.style.display = 'block';
                generalContent.style.display = 'none';
            } else {
                generalTab.style.borderBottom = '3px solid var(--primary)';
                generalTab.style.color = 'var(--gray-900)';
                managedTab.style.borderBottom = '3px solid transparent';
                managedTab.style.color = 'var(--gray-600)';
                generalContent.style.display = 'block';
                managedContent.style.display = 'none';
            }
        }
        window.switchAssetType = switchAssetType;
        
        function toggleAssetFormFields() {
            const assetType = document.querySelector('input[name="assetType"]:checked')?.value;
            const managedFields = document.getElementById('managed-asset-fields');
            const generalFields = document.getElementById('general-asset-fields');
            
            if (managedFields && generalFields) {
                if (assetType === 'managed') {
                    managedFields.style.display = 'block';
                    generalFields.style.display = 'none';
                    // Update required attributes
                    managedFields.querySelectorAll('[required]').forEach(field => field.setAttribute('required', ''));
                    generalFields.querySelectorAll('[required]').forEach(field => field.removeAttribute('required'));
                } else {
                    managedFields.style.display = 'none';
                    generalFields.style.display = 'block';
                    // Update required attributes
                    generalFields.querySelectorAll('[required]').forEach(field => field.setAttribute('required', ''));
                    managedFields.querySelectorAll('[required]').forEach(field => field.removeAttribute('required'));
                }
            }
        }
        window.toggleAssetFormFields = toggleAssetFormFields;
        
        function createServiceRequest(assetId) {
            showToast(`Opening service request form for asset ${assetId}...`, 'info');
            // In production, this would open a service request modal
        }
        window.createServiceRequest = createServiceRequest;
        
        function filterActiveAssets() {
            const isActive = document.getElementById('activeToggle')?.checked;
            showToast(`Filtering ${isActive ? 'active' : 'all'} assets...`, 'info');
        }
        window.filterActiveAssets = filterActiveAssets;
        
        function searchAssets() {
            const searchTerm = document.querySelector('input[type="search"]')?.value;
            if (searchTerm) {
                showToast(`Searching for "${searchTerm}"...`, 'info');
            }
        }
        window.searchAssets = searchAssets;
        
        function downloadAssets() {
            showToast('Downloading assets report...', 'info');
        }
        window.downloadAssets = downloadAssets;
        
        function viewAssetGrid() {
            showToast('Switching to grid view...', 'info');
        }
        window.viewAssetGrid = viewAssetGrid;
        
        function getSharedDocumentsContent() {
            return `
                <div class="header-bar">
                    <h1 class="header-title">Shared Documents</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="showDocumentFilters()">
                            📂 Filter by Client
                        </button>
                        <button class="btn btn-primary" onclick="uploadDocument()">
                            ↑ Upload Document
                        </button>
                    </div>
                </div>
                
                <!-- Document Statistics -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div class="stat-value">24</div>
                        <div class="stat-label">Documents Shared</div>
                        <div class="stat-change">From 8 clients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">2</div>
                        <div class="stat-label">Pending Signatures</div>
                        <div class="stat-change negative">Action required</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">5</div>
                        <div class="stat-label">Uploaded This Week</div>
                        <div class="stat-change positive">Compliance docs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">12</div>
                        <div class="stat-label">Digital Signatures</div>
                        <div class="stat-change">Completed this month</div>
                    </div>
                </div>
                
                <!-- Document Categories -->
                <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
                    <button class="btn btn-secondary active" onclick="filterDocuments('all')">All Documents (24)</button>
                    <button class="btn btn-secondary" onclick="filterDocuments('contracts')">Contracts (8)</button>
                    <button class="btn btn-secondary" onclick="filterDocuments('compliance')">Compliance (6)</button>
                    <button class="btn btn-secondary" onclick="filterDocuments('invoices')">Invoices (10)</button>
                </div>
                
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Document Library</h3>
                        <div class="table-actions">
                            <input type="search" placeholder="Search documents..." class="search-input">
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllDocs"></th>
                                <th>Document Name</th>
                                <th>Client</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Shared Date</th>
                                <th>Size</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="checkbox" class="doc-select"></td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: var(--primary);">📄</span>
                                        <a href="#" style="color: var(--primary); text-decoration: none;">HVAC Service Agreement - McDonald's.pdf</a>
                                    </div>
                                </td>
                                <td>McDonald's Corp</td>
                                <td><span class="badge">Contract</span></td>
                                <td><span class="badge badge-warning">Signature Pending</span></td>
                                <td>Nov 25, 2024</td>
                                <td>2.1 MB</td>
                                <td>
                                    <button class="btn btn-sm" onclick="viewDocument('supplier-1')">View</button>
                                    <button class="btn btn-sm" onclick="downloadDocument('supplier-1')">Download</button>
                                    <button class="btn btn-sm btn-warning" onclick="signDocument('supplier-1')">✍️ Sign</button>
                                </td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="doc-select"></td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: var(--success);">📋</span>
                                        <a href="#" style="color: var(--primary); text-decoration: none;">Insurance Certificate - General Liability.pdf</a>
                                    </div>
                                </td>
                                <td>The Nice Guy Restaurant</td>
                                <td><span class="badge badge-info">Compliance</span></td>
                                <td><span class="badge badge-success">Active</span></td>
                                <td>Nov 20, 2024</td>
                                <td>1.5 MB</td>
                                <td>
                                    <button class="btn btn-sm" onclick="viewDocument('supplier-2')">View</button>
                                    <button class="btn btn-sm" onclick="downloadDocument('supplier-2')">Download</button>
                                    <button class="btn btn-sm" onclick="updateDocument('supplier-2')">Update</button>
                                </td>
                            </tr>
                            <tr>
                                <td><input type="checkbox" class="doc-select"></td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <span style="color: var(--info);">💰</span>
                                        <a href="#" style="color: var(--primary); text-decoration: none;">Invoice #2024-11-15 - HVAC Maintenance.pdf</a>
                                    </div>
                                </td>
                                <td>Burger King - Hollywood</td>
                                <td><span class="badge badge-secondary">Invoice</span></td>
                                <td><span class="badge badge-success">Paid</span></td>
                                <td>Nov 15, 2024</td>
                                <td>892 KB</td>
                                <td>
                                    <button class="btn btn-sm" onclick="viewDocument('supplier-3')">View</button>
                                    <button class="btn btn-sm" onclick="downloadDocument('supplier-3')">Download</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Signature Modal -->
                <div id="signatureModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h2>Digital Signature Required</h2>
                            <span class="close" onclick="closeSignatureModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div style="background: var(--info-light); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                <h4>Document: HVAC Service Agreement - McDonald's.pdf</h4>
                                <p>Client: McDonald's Corp</p>
                                <p>This document requires your digital signature to proceed with the work order.</p>
                            </div>
                            
                            <div style="border: 2px dashed var(--gray-300); border-radius: 8px; padding: 2rem; text-align: center; margin-bottom: 1.5rem;">
                                <div id="signatureCanvas" style="width: 100%; height: 200px; border: 1px solid var(--gray-300); border-radius: 4px; cursor: crosshair; background: white;">
                                    <p style="padding-top: 80px; color: var(--gray-500);">Draw your signature here</p>
                                </div>
                                <div style="margin-top: 1rem;">
                                    <button class="btn btn-sm btn-secondary" onclick="clearSignature()">Clear</button>
                                </div>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <input type="checkbox" id="agreeToTerms">
                                <label for="agreeToTerms">I agree to the terms and conditions outlined in this document</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeSignatureModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="submitSignature()">Submit Signature</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Digital signature functions for supplier portal
        function signDocument(docId) {
            document.getElementById('signatureModal').style.display = 'block';
        }
        window.signDocument = signDocument;
        
        function closeSignatureModal() {
            document.getElementById('signatureModal').style.display = 'none';
        }
        window.closeSignatureModal = closeSignatureModal;
        
        function clearSignature() {
            const canvas = document.getElementById('signatureCanvas');
            canvas.innerHTML = '<p style="padding-top: 80px; color: var(--gray-500);">Draw your signature here</p>';
        }
        window.clearSignature = clearSignature;
        
        function submitSignature() {
            const termsChecked = document.getElementById('agreeToTerms').checked;
            if (!termsChecked) {
                showToast('Please agree to the terms and conditions', 'error');
                return;
            }
            
            showToast('Document signed successfully!', 'success');
            closeSignatureModal();
            
            // Update the document badge
            const badge = document.getElementById('documentsBadge');
            if (badge) {
                let count = parseInt(badge.textContent) - 1;
                if (count > 0) {
                    badge.textContent = count;
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        window.submitSignature = submitSignature;
        
        function uploadDocument() {
            showToast('Document upload functionality coming soon', 'info');
        }
        window.uploadDocument = uploadDocument;
        
        function filterDocuments(type) {
            showToast(`Filtering documents by: ${type}`, 'info');
        }
        window.filterDocuments = filterDocuments;
        
        function updateDocument(docId) {
            showToast('Document updated successfully', 'success');
        }
        window.updateDocument = updateDocument;
        
        function getAnalyticsContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Analytics Dashboard</h2>
                        <div style="display: flex; gap: 0.75rem;">
                            <select style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                <option>Last 30 Days</option>
                                <option>Last 90 Days</option>
                                <option>Last 12 Months</option>
                                <option>Year to Date</option>
                                <option>All Time</option>
                            </select>
                            <button class="btn btn-secondary" onclick="exportAnalytics()">Export Data</button>
                        </div>
                    </div>
                    
                    <!-- KPI Cards -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-label">Total Spend</div>
                            <div class="stat-value">$487,293</div>
                            <div class="stat-trend positive">↑ 12% vs last period</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Cost Savings</div>
                            <div class="stat-value">$52,847</div>
                            <div class="stat-trend positive">10.8% reduction</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg Resolution Time</div>
                            <div class="stat-value">4.2 days</div>
                            <div class="stat-trend positive">↓ 18% improvement</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Service Satisfaction</div>
                            <div class="stat-value">94.3%</div>
                            <div class="stat-trend">+2.1% vs last month</div>
                        </div>
                    </div>
                    
                    <!-- Charts Section -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Spend Trend</h3>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm" onclick="changeChartView('daily')">Daily</button>
                                    <button class="btn btn-sm btn-primary" onclick="changeChartView('monthly')">Monthly</button>
                                    <button class="btn btn-sm" onclick="changeChartView('yearly')">Yearly</button>
                                </div>
                            </div>
                            <div style="padding: 2rem; height: 300px; display: flex; align-items: center; justify-content: center; background: var(--gray-50);">
                                <div style="text-align: center; color: var(--gray-500);">
                                    <svg style="width: 48px; height: 48px; margin: 0 auto;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <p style="margin-top: 1rem;">Spend trend chart will be displayed here</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Category Breakdown</h3>
                            </div>
                            <div style="padding: 1.5rem;">
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>HVAC</span>
                                        <strong>$145,280</strong>
                                    </div>
                                    <div style="height: 8px; background: var(--gray-200); border-radius: 4px;">
                                        <div style="width: 65%; height: 100%; background: var(--primary); border-radius: 4px;"></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Plumbing</span>
                                        <strong>$87,432</strong>
                                    </div>
                                    <div style="height: 8px; background: var(--gray-200); border-radius: 4px;">
                                        <div style="width: 45%; height: 100%; background: var(--secondary); border-radius: 4px;"></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>Electrical</span>
                                        <strong>$72,981</strong>
                                    </div>
                                    <div style="height: 8px; background: var(--gray-200); border-radius: 4px;">
                                        <div style="width: 38%; height: 100%; background: var(--success); border-radius: 4px;"></div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>General Maintenance</span>
                                        <strong>$181,600</strong>
                                    </div>
                                    <div style="height: 8px; background: var(--gray-200); border-radius: 4px;">
                                        <div style="width: 80%; height: 100%; background: var(--warning); border-radius: 4px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Metrics -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Service Provider Performance</h3>
                            <button class="btn btn-secondary" onclick="viewDetailedAnalytics()">View Details</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Provider</th>
                                    <th>Jobs Completed</th>
                                    <th>Avg Response Time</th>
                                    <th>On-Time Rate</th>
                                    <th>Quality Score</th>
                                    <th>Total Spend</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>ABC Maintenance</strong></td>
                                    <td>87</td>
                                    <td>2.3 hours</td>
                                    <td><span class="status-badge completed">98%</span></td>
                                    <td>4.8/5.0</td>
                                    <td>$145,280</td>
                                </tr>
                                <tr>
                                    <td><strong>XYZ Plumbing</strong></td>
                                    <td>52</td>
                                    <td>3.1 hours</td>
                                    <td><span class="status-badge completed">94%</span></td>
                                    <td>4.6/5.0</td>
                                    <td>$87,432</td>
                                </tr>
                                <tr>
                                    <td><strong>Quick Electric</strong></td>
                                    <td>41</td>
                                    <td>1.8 hours</td>
                                    <td><span class="status-badge completed">96%</span></td>
                                    <td>4.9/5.0</td>
                                    <td>$72,981</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        window.getAnalyticsContent = getAnalyticsContent;
        
        // Supplier Analytics JavaScript Functions
        let supplierAnalyticsCharts = {};
        let currentSupplierAnalyticsPeriod = '30d';
        
        async function initializeSupplierAnalytics() {
            try {
                showSupplierAnalyticsLoading(true);
                await loadSupplierAnalyticsData(currentSupplierAnalyticsPeriod);
                showSupplierAnalyticsLoading(false);
            } catch (error) {
                console.error('Failed to initialize supplier analytics:', error);
                showSupplierAnalyticsError('Failed to load analytics data');
            }
        }
        
        async function loadSupplierAnalyticsData(period) {
            const token = localStorage.getItem('supabase_token');
            if (!token) {
                throw new Error('Authentication required');
            }
            
            try {
                // Load different types of analytics data for suppliers
                const [financial, performance, workOrders] = await Promise.all([
                    fetch(`/api/analytics?type=financial&period=${period}`, {
                        headers: { Authorization: `Bearer ${token}` }
                    }).then(r => r.json()),
                    fetch(`/api/analytics?type=performance&period=${period}`, {
                        headers: { Authorization: `Bearer ${token}` }
                    }).then(r => r.json()),
                    fetch(`/api/analytics?type=work-orders&period=${period}`, {
                        headers: { Authorization: `Bearer ${token}` }
                    }).then(r => r.json())
                ]);
                
                // Update KPI cards
                updateSupplierKPICards(financial.data, performance.data, workOrders.data);
                
                // Create or update charts
                createSupplierRevenueChart(financial.data);
                createSupplierServiceChart(financial.data);
                createSupplierPerformanceChart(workOrders.data);
                
                // Update performance metrics table
                updateSupplierPerformanceMetrics(performance.data);
                
            } catch (error) {
                console.error('Supplier Analytics API Error:', error);
                throw error;
            }
        }
        
        function updateSupplierKPICards(financial, performance, workOrders) {
            const kpiHTML = `
                <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                    <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Total Revenue</h4>
                    <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">$${(financial.total_spend || 0).toLocaleString()}</p>
                    <span style="color: var(--success); font-size: 0.875rem;">↑ 12% from last month</span>
                </div>
                <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                    <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Work Orders Completed</h4>
                    <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${workOrders.total || 0}</p>
                    <span style="color: var(--success); font-size: 0.875rem;">↑ ${performance.completion_rate}% rate</span>
                </div>
                <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                    <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Avg Response Time</h4>
                    <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${workOrders.average_completion_time || 0} hrs</p>
                    <span style="color: var(--success); font-size: 0.875rem;">↓ 15% improvement</span>
                </div>
                <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--gray-200);">
                    <h4 style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Customer Satisfaction</h4>
                    <p style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${performance.average_rating || 0}★</p>
                    <span style="color: var(--success); font-size: 0.875rem;">↑ ${performance.customer_satisfaction}% satisfaction</span>
                </div>
            `;
            document.getElementById('supplierKPICards').innerHTML = kpiHTML;
        }
        
        function createSupplierRevenueChart(data) {
            const ctx = document.getElementById('supplierRevenueChart').getContext('2d');
            
            if (supplierAnalyticsCharts.revenue) {
                supplierAnalyticsCharts.revenue.destroy();
            }
            
            const monthlyData = data.monthly_spend || [];
            const labels = monthlyData.map(d => d.month);
            const amounts = monthlyData.map(d => d.amount);
            
            supplierAnalyticsCharts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue',
                        data: amounts,
                        borderColor: '#16a085',
                        backgroundColor: 'rgba(22, 160, 133, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createSupplierServiceChart(data) {
            const ctx = document.getElementById('supplierServiceChart').getContext('2d');
            
            if (supplierAnalyticsCharts.service) {
                supplierAnalyticsCharts.service.destroy();
            }
            
            const categoryData = data.category_breakdown || [];
            const labels = categoryData.map(d => d.category);
            const amounts = categoryData.map(d => d.amount);
            
            supplierAnalyticsCharts.service = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: amounts,
                        backgroundColor: [
                            '#16a085',
                            '#2ecc71',
                            '#3498db',
                            '#9b59b6',
                            '#e74c3c',
                            '#f39c12'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function createSupplierPerformanceChart(data) {
            const ctx = document.getElementById('supplierPerformanceChart').getContext('2d');
            
            if (supplierAnalyticsCharts.performance) {
                supplierAnalyticsCharts.performance.destroy();
            }
            
            const statusData = data.status_distribution || {};
            
            supplierAnalyticsCharts.performance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Pending', 'In Progress', 'Completed', 'Cancelled'],
                    datasets: [{
                        label: 'Work Orders',
                        data: [
                            statusData.pending || 0,
                            statusData.in_progress || 0,
                            statusData.completed || 0,
                            statusData.cancelled || 0
                        ],
                        backgroundColor: [
                            '#f39c12',
                            '#3498db',
                            '#2ecc71',
                            '#e74c3c'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function updateSupplierPerformanceMetrics(data) {
            const metricsHTML = `
                <div style="padding: 1.5rem;">
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">Completion Rate</span>
                            <span style="font-size: 1.25rem; font-weight: 700; color: var(--success);">${data.completion_rate}%</span>
                        </div>
                    </div>
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">On-Time Rate</span>
                            <span style="font-size: 1.25rem; font-weight: 700; color: var(--success);">${data.on_time_rate}%</span>
                        </div>
                    </div>
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--gray-50); border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">Average Rating</span>
                            <span style="font-size: 1.25rem; font-weight: 700; color: var(--warning);">${data.average_rating}★</span>
                        </div>
                    </div>
                    <div style="padding: 1rem; background: var(--gray-50); border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">Total Jobs</span>
                            <span style="font-size: 1.25rem; font-weight: 700; color: var(--primary);">${data.total_jobs}</span>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('supplierPerformanceMetrics').innerHTML = metricsHTML;
        }
        
        function showSupplierAnalyticsLoading(show) {
            document.getElementById('supplierAnalyticsLoading').style.display = show ? 'flex' : 'none';
            document.getElementById('supplierAnalyticsContent').style.display = show ? 'none' : 'block';
        }
        
        function showSupplierAnalyticsError(message) {
            document.getElementById('supplierAnalyticsLoading').innerHTML = `
                <div style="text-align: center; color: var(--danger);">
                    <div style="font-size: 1.5rem; margin-bottom: 1rem;">⚠️</div>
                    <div>${message}</div>
                    <button class="btn btn-secondary" onclick="initializeSupplierAnalytics()" style="margin-top: 1rem;">
                        Retry
                    </button>
                </div>
            `;
            document.getElementById('supplierAnalyticsLoading').style.display = 'flex';
            document.getElementById('supplierAnalyticsContent').style.display = 'none';
        }
        
        async function updateSupplierAnalyticsPeriod(period) {
            currentSupplierAnalyticsPeriod = period;
            await loadSupplierAnalyticsData(period);
            showToast(`Analytics updated for ${period} period`, 'info');
        }
        
        function exportSupplierAnalytics() {
            showToast('Exporting supplier analytics data...', 'info');
        }
        
        // Export global functions
        window.initializeSupplierAnalytics = initializeSupplierAnalytics;
        window.updateSupplierAnalyticsPeriod = updateSupplierAnalyticsPeriod;
        window.exportSupplierAnalytics = exportSupplierAnalytics;
        
        // Supplier Global Search Functions
        let supplierSearchTimeout;
        let supplierSearchData = {
            rfps: [
                { id: 'RFP-2024-001', title: 'Kitchen Equipment Replacement', client: 'Pizza Palace', type: 'rfp' },
                { id: 'RFP-2024-002', title: 'HVAC System Upgrade', client: 'Burger King', type: 'rfp' },
                { id: 'RFP-2024-003', title: 'Deep Cleaning Service', client: 'Fine Dining Co', type: 'rfp' }
            ],
            workOrders: [
                { id: 'WO-2024-101', title: 'Emergency HVAC Repair', client: 'McDonald\'s Downtown', type: 'work-order' },
                { id: 'WO-2024-102', title: 'Kitchen Deep Clean', client: 'Tasty Burgers', type: 'work-order' },
                { id: 'WO-2024-103', title: 'Electrical Maintenance', client: 'Coffee House', type: 'work-order' }
            ],
            clients: [
                { id: 'client-001', title: 'Pizza Palace', location: 'Downtown Seattle', type: 'client' },
                { id: 'client-002', title: 'Burger King', location: 'Bellevue Mall', type: 'client' },
                { id: 'client-003', title: 'Fine Dining Co', location: 'Capitol Hill', type: 'client' }
            ]
        };
        
        function handleSupplierGlobalSearch(query) {
            clearTimeout(supplierSearchTimeout);
            
            if (query.length < 2) {
                hideSupplierSearchResults();
                return;
            }
            
            supplierSearchTimeout = setTimeout(() => {
                performSupplierSearch(query);
            }, 300);
        }
        
        function performSupplierSearch(query) {
            const results = [];
            const lowerQuery = query.toLowerCase();
            
            // Search RFPs
            supplierSearchData.rfps.forEach(rfp => {
                if (rfp.title.toLowerCase().includes(lowerQuery) || 
                    rfp.client.toLowerCase().includes(lowerQuery) ||
                    rfp.id.toLowerCase().includes(lowerQuery)) {
                    results.push(rfp);
                }
            });
            
            // Search work orders
            supplierSearchData.workOrders.forEach(wo => {
                if (wo.title.toLowerCase().includes(lowerQuery) || 
                    wo.client.toLowerCase().includes(lowerQuery) ||
                    wo.id.toLowerCase().includes(lowerQuery)) {
                    results.push(wo);
                }
            });
            
            // Search clients
            supplierSearchData.clients.forEach(client => {
                if (client.title.toLowerCase().includes(lowerQuery) || 
                    client.location.toLowerCase().includes(lowerQuery)) {
                    results.push(client);
                }
            });
            
            displaySupplierSearchResults(results, query);
        }
        
        function displaySupplierSearchResults(results, query) {
            const resultsContainer = document.getElementById('supplierSearchResults');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: var(--gray-500);">
                        No results found for "${query}"
                    </div>
                `;
            } else {
                const resultHTML = results.map(result => {
                    let icon, subtitle;
                    switch(result.type) {
                        case 'rfp':
                            icon = '📋';
                            subtitle = result.client;
                            break;
                        case 'work-order':
                            icon = '🔧';
                            subtitle = result.client;
                            break;
                        case 'client':
                            icon = '🏢';
                            subtitle = result.location;
                            break;
                    }
                    
                    return `
                        <div class="search-result-item" style="padding: 0.75rem; border-bottom: 1px solid var(--gray-100); cursor: pointer; transition: background-color 0.15s;" 
                             onclick="selectSupplierSearchResult('${result.type}', '${result.id}')"
                             onmouseover="this.style.backgroundColor='var(--gray-50)'"
                             onmouseout="this.style.backgroundColor='white'">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 1.25rem;">${icon}</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--gray-900);">${result.title}</div>
                                    <div style="font-size: 0.875rem; color: var(--gray-600);">${subtitle}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                resultsContainer.innerHTML = resultHTML;
            }
            
            resultsContainer.style.display = 'block';
        }
        
        function selectSupplierSearchResult(type, id) {
            hideSupplierSearchResults();
            document.getElementById('supplierGlobalSearch').value = '';
            
            // Navigate to the appropriate section
            switch(type) {
                case 'rfp':
                    showSection('rfps');
                    showToast(`Navigated to RFP ${id}`, 'info');
                    break;
                case 'work-order':
                    showSection('work-orders');
                    showToast(`Navigated to work order ${id}`, 'info');
                    break;
                case 'client':
                    showSection('dashboard'); // Could be clients section if it exists
                    showToast(`Navigated to client ${id}`, 'info');
                    break;
            }
        }
        
        function hideSupplierSearchResults() {
            document.getElementById('supplierSearchResults').style.display = 'none';
        }
        
        function handleSupplierSearchKeydown(event) {
            const resultsContainer = document.getElementById('supplierSearchResults');
            
            if (event.key === 'Escape') {
                hideSupplierSearchResults();
                document.getElementById('supplierGlobalSearch').blur();
            } else if (event.key === 'Enter') {
                const firstResult = resultsContainer.querySelector('.search-result-item');
                if (firstResult) {
                    firstResult.click();
                }
            }
        }
        
        // Keyboard shortcut for search (Ctrl+K) - supplier version
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const searchInput = document.getElementById('supplierGlobalSearch');
                if (searchInput) {
                    searchInput.focus();
                }
            }
        });
        
        // Hide search results when clicking outside - supplier version
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.header-search')) {
                hideSupplierSearchResults();
            }
        });
        
        // Export supplier search functions
        window.handleSupplierGlobalSearch = handleSupplierGlobalSearch;
        window.handleSupplierSearchKeydown = handleSupplierSearchKeydown;
        window.selectSupplierSearchResult = selectSupplierSearchResult;
        
        function getReportsContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Reports</h2>
                        <button class="btn btn-primary" onclick="createCustomReport()">+ Create Custom Report</button>
                    </div>
                    
                    <!-- Report Categories -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
                        <!-- Savings Reports -->
                        <div class="table-container" style="cursor: pointer;" onclick="openReportSection('savings')">
                            <div style="padding: 2rem;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="width: 48px; height: 48px; background: var(--success-light); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <svg style="width: 24px; height: 24px; color: var(--success);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.25rem;">Savings</h3>
                                        <p style="color: var(--gray-600); font-size: 0.875rem;">Cost reduction and savings analysis</p>
                                    </div>
                                </div>
                                <div style="border-top: 1px solid var(--gray-200); padding-top: 1rem;">
                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• Monthly Savings Report</li>
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• YoY Cost Comparison</li>
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• Budget vs Actual</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Spend Analysis -->
                        <div class="table-container" style="cursor: pointer;" onclick="openReportSection('spend')">
                            <div style="padding: 2rem;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="width: 48px; height: 48px; background: var(--primary-light); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <svg style="width: 24px; height: 24px; color: var(--primary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.25rem;">Spend Analysis</h3>
                                        <p style="color: var(--gray-600); font-size: 0.875rem;">Detailed spending breakdown</p>
                                    </div>
                                </div>
                                <div style="border-top: 1px solid var(--gray-200); padding-top: 1rem;">
                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• Category Spend Report</li>
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• Location Spend Analysis</li>
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• Vendor Spend Summary</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Asset Analysis -->
                        <div class="table-container" style="cursor: pointer;" onclick="openReportSection('assets')">
                            <div style="padding: 2rem;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="width: 48px; height: 48px; background: var(--warning-light); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <svg style="width: 24px; height: 24px; color: var(--warning);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.25rem;">Asset Analysis</h3>
                                        <p style="color: var(--gray-600); font-size: 0.875rem;">Equipment and asset reports</p>
                                    </div>
                                </div>
                                <div style="border-top: 1px solid var(--gray-200); padding-top: 1rem;">
                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• Asset Lifecycle Report</li>
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• Maintenance Cost Analysis</li>
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• Asset Depreciation Report</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Workflow Analysis -->
                        <div class="table-container" style="cursor: pointer;" onclick="openReportSection('workflow')">
                            <div style="padding: 2rem;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="width: 48px; height: 48px; background: var(--secondary-light); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <svg style="width: 24px; height: 24px; color: var(--secondary);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.25rem;">Workflow Analysis</h3>
                                        <p style="color: var(--gray-600); font-size: 0.875rem;">Process efficiency metrics</p>
                                    </div>
                                </div>
                                <div style="border-top: 1px solid var(--gray-200); padding-top: 1rem;">
                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• Work Order Completion Time</li>
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• Response Time Analysis</li>
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• First-Time Fix Rate</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Service Provider Analysis -->
                        <div class="table-container" style="cursor: pointer;" onclick="openReportSection('providers')">
                            <div style="padding: 2rem;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="width: 48px; height: 48px; background: var(--info-light); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <svg style="width: 24px; height: 24px; color: var(--info);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.25rem;">Service Provider Analysis</h3>
                                        <p style="color: var(--gray-600); font-size: 0.875rem;">Vendor performance reports</p>
                                    </div>
                                </div>
                                <div style="border-top: 1px solid var(--gray-200); padding-top: 1rem;">
                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• Provider Performance Scorecard</li>
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• Quality Metrics Report</li>
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• Provider Comparison Report</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Feedback Analysis -->
                        <div class="table-container" style="cursor: pointer;" onclick="openReportSection('feedback')">
                            <div style="padding: 2rem;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="width: 48px; height: 48px; background: var(--danger-light); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <svg style="width: 24px; height: 24px; color: var(--danger);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 0.25rem;">Feedback Analysis</h3>
                                        <p style="color: var(--gray-600); font-size: 0.875rem;">Customer satisfaction reports</p>
                                    </div>
                                </div>
                                <div style="border-top: 1px solid var(--gray-200); padding-top: 1rem;">
                                    <ul style="list-style: none; padding: 0; margin: 0;">
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• Satisfaction Score Report</li>
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• Complaint Analysis</li>
                                        <li style="padding: 0.5rem 0; color: var(--gray-700);">• NPS Trend Report</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Reports -->
                    <div class="table-container" style="margin-top: 2rem;">
                        <div class="table-header">
                            <h3 class="table-title">Recent Reports</h3>
                            <button class="btn btn-secondary" onclick="viewAllReports()">View All</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Report Name</th>
                                    <th>Type</th>
                                    <th>Created By</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Q3 2024 Spend Analysis</strong></td>
                                    <td><span class="status-badge">Spend Analysis</span></td>
                                    <td>John Doe</td>
                                    <td>Oct 15, 2024</td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary" onclick="viewReport('q3-spend')">View</button>
                                        <button class="btn btn-sm btn-secondary" onclick="downloadReport('q3-spend')">Download</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>September Maintenance Report</strong></td>
                                    <td><span class="status-badge">Asset Analysis</span></td>
                                    <td>Jane Smith</td>
                                    <td>Oct 1, 2024</td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary" onclick="viewReport('sept-maint')">View</button>
                                        <button class="btn btn-sm btn-secondary" onclick="downloadReport('sept-maint')">Download</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Vendor Performance Scorecard</strong></td>
                                    <td><span class="status-badge">Service Provider</span></td>
                                    <td>Mike Johnson</td>
                                    <td>Sep 28, 2024</td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary" onclick="viewReport('vendor-score')">View</button>
                                        <button class="btn btn-sm btn-secondary" onclick="downloadReport('vendor-score')">Download</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        window.getReportsContent = getReportsContent;
        
        // Analytics helper functions
        function exportAnalytics() {
            showToast('Exporting analytics data...', 'info');
        }
        window.exportAnalytics = exportAnalytics;
        
        function changeChartView(view) {
            showToast(`Switching to ${view} view...`, 'info');
        }
        window.changeChartView = changeChartView;
        
        function viewDetailedAnalytics() {
            showToast('Loading detailed analytics...', 'info');
        }
        window.viewDetailedAnalytics = viewDetailedAnalytics;
        
        // Reports helper functions
        function createCustomReport() {
            showToast('Opening custom report builder...', 'info');
        }
        window.createCustomReport = createCustomReport;
        
        function openReportSection(section) {
            showToast(`Opening ${section} reports...`, 'info');
        }
        window.openReportSection = openReportSection;
        
        function viewAllReports() {
            showToast('Loading all reports...', 'info');
        }
        window.viewAllReports = viewAllReports;
        
        function viewReport(reportId) {
            showToast(`Opening report ${reportId}...`, 'info');
        }
        window.viewReport = viewReport;
        
        function downloadReport(reportId) {
            showToast(`Downloading report ${reportId}...`, 'info');
        }
        window.downloadReport = downloadReport;
        
        function getBudgetContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Budget Management</h2>
                        <div style="display: flex; gap: 0.75rem;">
                            <select id="budgetPeriod" onchange="updateBudgetPeriod()" style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                <option value="current">Current Period (P1)</option>
                                <option value="p2">Period 2</option>
                                <option value="p3">Period 3</option>
                                <option value="q1">Q1 2025</option>
                                <option value="q2">Q2 2025</option>
                                <option value="ytd">Year to Date</option>
                            </select>
                            <button class="btn btn-secondary" onclick="editBudgetSettings()">
                                <svg style="width: 16px; height: 16px; margin-right: 0.5rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                Budget Settings
                            </button>
                            <button class="btn btn-primary" onclick="createNewBudget()">+ Create Budget</button>
                        </div>
                    </div>
                    
                    <!-- Period Overview -->
                    <div class="table-container" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3 class="table-title">Period 1: Dec 28, 2024 - Jan 24, 2025</h3>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <span style="font-size: 0.875rem; color: var(--gray-600);">28 days remaining</span>
                            </div>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 2rem;">
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">Total Revenue Forecast</div>
                                    <div style="font-size: 1.5rem; font-weight: 700;">$2,765,499</div>
                                    <div style="font-size: 0.75rem; color: var(--success); margin-top: 0.25rem;">↑ 8.3% vs last period</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">R&M Budget Allocated</div>
                                    <div style="font-size: 1.5rem; font-weight: 700;">$93,487</div>
                                    <div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;">3.38% of revenue</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">Budget Spent</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--warning);">$47,832</div>
                                    <div style="font-size: 0.75rem; color: var(--warning); margin-top: 0.25rem;">51.2% consumed</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.875rem; color: var(--gray-600); margin-bottom: 0.5rem;">Budget Remaining</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">$45,655</div>
                                    <div style="font-size: 0.75rem; color: var(--success); margin-top: 0.25rem;">48.8% available</div>
                                </div>
                            </div>
                            
                            <!-- Budget Progress Bar -->
                            <div style="margin-top: 2rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 500;">Budget Utilization</span>
                                    <span style="font-weight: 500;">$47,832 / $93,487</span>
                                </div>
                                <div style="height: 20px; background: var(--gray-200); border-radius: 10px; overflow: hidden;">
                                    <div style="width: 51.2%; height: 100%; background: linear-gradient(90deg, var(--success) 0%, var(--warning) 50%, var(--danger) 100%); border-radius: 10px; transition: width 0.3s;"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem; color: var(--gray-600);">
                                    <span>0%</span>
                                    <span>25%</span>
                                    <span>50%</span>
                                    <span>75%</span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Location Budgets Table -->
                    <div class="table-container" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3 class="table-title">Location Budget Breakdown</h3>
                            <div style="display: flex; gap: 0.75rem;">
                                <button class="btn btn-secondary" onclick="exportBudgetReport()">Export</button>
                                <button class="btn btn-secondary" onclick="adjustBudgets()">Adjust Budgets</button>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Location</th>
                                    <th>Revenue Forecast</th>
                                    <th>R&M %</th>
                                    <th>R&M Budget</th>
                                    <th>Spent</th>
                                    <th>Remaining</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>McDonald's - Sunset</strong></td>
                                    <td>$475,980.00</td>
                                    <td>
                                        <span style="color: var(--success); font-weight: 600;">3.28%</span>
                                    </td>
                                    <td>$15,612.00</td>
                                    <td>$7,344.59</td>
                                    <td style="color: var(--success); font-weight: 600;">$8,267.41</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div style="width: 100px; height: 6px; background: var(--gray-200); border-radius: 3px;">
                                                <div style="width: 47%; height: 100%; background: var(--success); border-radius: 3px;"></div>
                                            </div>
                                            <span style="font-size: 0.75rem;">47%</span>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary" onclick="viewLocationBudget('mcdonalds-sunset')">View</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Burger King - Melrose</strong></td>
                                    <td>$1,097,557.00</td>
                                    <td>
                                        <span style="color: var(--success); font-weight: 600;">3.33%</span>
                                    </td>
                                    <td>$36,549.00</td>
                                    <td>$23,580.91</td>
                                    <td style="color: var(--warning); font-weight: 600;">$12,968.09</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div style="width: 100px; height: 6px; background: var(--gray-200); border-radius: 3px;">
                                                <div style="width: 65%; height: 100%; background: var(--warning); border-radius: 3px;"></div>
                                            </div>
                                            <span style="font-size: 0.75rem;">65%</span>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary" onclick="viewLocationBudget('burger-king-melrose')">View</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Delilah LA</strong></td>
                                    <td>$635,746.00</td>
                                    <td>
                                        <span style="color: var(--success); font-weight: 600;">3.33%</span>
                                    </td>
                                    <td>$21,170.00</td>
                                    <td>$4,165.61</td>
                                    <td style="color: var(--success); font-weight: 600;">$17,004.39</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div style="width: 100px; height: 6px; background: var(--gray-200); border-radius: 3px;">
                                                <div style="width: 20%; height: 100%; background: var(--success); border-radius: 3px;"></div>
                                            </div>
                                            <span style="font-size: 0.75rem;">20%</span>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary" onclick="viewLocationBudget('delilah-la')">View</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Poppy</strong></td>
                                    <td>$1,126,102.00</td>
                                    <td>
                                        <span style="color: var(--success); font-weight: 600;">3.34%</span>
                                    </td>
                                    <td>$37,612.00</td>
                                    <td>$23,811.14</td>
                                    <td style="color: var(--warning); font-weight: 600;">$13,800.86</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div style="width: 100px; height: 6px; background: var(--gray-200); border-radius: 3px;">
                                                <div style="width: 63%; height: 100%; background: var(--warning); border-radius: 3px;"></div>
                                            </div>
                                            <span style="font-size: 0.75rem;">63%</span>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary" onclick="viewLocationBudget('poppy')">View</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Craig's</strong></td>
                                    <td>$525,399.00</td>
                                    <td>
                                        <span style="color: var(--danger); font-weight: 600;">4.36%</span>
                                    </td>
                                    <td>$22,907.00</td>
                                    <td>$17,134.00</td>
                                    <td style="color: var(--danger); font-weight: 600;">$5,773.00</td>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <div style="width: 100px; height: 6px; background: var(--gray-200); border-radius: 3px;">
                                                <div style="width: 75%; height: 100%; background: var(--danger); border-radius: 3px;"></div>
                                            </div>
                                            <span style="font-size: 0.75rem; color: var(--danger);">75%</span>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="viewLocationBudget('craigs')">Alert</button>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot style="border-top: 2px solid var(--gray-300);">
                                <tr style="font-weight: 600;">
                                    <td>Total</td>
                                    <td>$2,765,499.00</td>
                                    <td>3.38%</td>
                                    <td>$93,487.00</td>
                                    <td>$47,832.00</td>
                                    <td style="color: var(--success);">$45,655.00</td>
                                    <td colspan="2">
                                        <span class="status-badge completed">On Track</span>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <!-- Budget Trends -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Budget Trend (Last 6 Periods)</h3>
                            </div>
                            <div style="padding: 2rem; height: 250px; display: flex; align-items: center; justify-content: center; background: var(--gray-50);">
                                <div style="text-align: center; color: var(--gray-500);">
                                    <svg style="width: 48px; height: 48px; margin: 0 auto;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                                    </svg>
                                    <p style="margin-top: 1rem;">Budget trend chart will be displayed here</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Budget Alerts</h3>
                                <button class="btn btn-sm btn-secondary" onclick="configureBudgetAlerts()">Configure</button>
                            </div>
                            <div style="padding: 1.5rem;">
                                <div style="margin-bottom: 1rem; padding: 1rem; background: var(--danger-light); border-left: 4px solid var(--danger); border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <div style="font-weight: 600; color: var(--danger); margin-bottom: 0.25rem;">Craig's - Budget Alert</div>
                                            <div style="font-size: 0.875rem; color: var(--gray-700);">75% of budget consumed with 28 days remaining</div>
                                        </div>
                                        <button class="btn btn-sm btn-danger" onclick="viewAlert('craigs')">View</button>
                                    </div>
                                </div>
                                <div style="margin-bottom: 1rem; padding: 1rem; background: var(--warning-light); border-left: 4px solid var(--warning); border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <div style="font-weight: 600; color: var(--warning); margin-bottom: 0.25rem;">2 Locations Approaching Limit</div>
                                            <div style="font-size: 0.875rem; color: var(--gray-700);">Burger King and Poppy at 60%+ utilization</div>
                                        </div>
                                        <button class="btn btn-sm btn-warning" onclick="viewAlert('multiple')">Review</button>
                                    </div>
                                </div>
                                <div style="padding: 1rem; background: var(--success-light); border-left: 4px solid var(--success); border-radius: 4px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                                            <div style="font-weight: 600; color: var(--success); margin-bottom: 0.25rem;">Overall Budget Health</div>
                                            <div style="font-size: 0.875rem; color: var(--gray-700);">Total budget utilization at 51.2% - On track</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Budget Settings Modal (Hidden by default) -->
                    <div id="budgetSettingsModal" style="display: none;">
                        <!-- Modal content will be added here -->
                    </div>
                </div>
            `;
        }
        window.getBudgetContent = getBudgetContent;
        
        // Budget helper functions
        function updateBudgetPeriod() {
            const period = document.getElementById('budgetPeriod')?.value;
            showToast(`Loading budget data for ${period}...`, 'info');
        }
        window.updateBudgetPeriod = updateBudgetPeriod;
        
        function editBudgetSettings() {
            showBudgetSettingsModal();
        }
        window.editBudgetSettings = editBudgetSettings;
        
        function showBudgetSettingsModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>Budget Settings</h3>
                        <button class="close-btn" onclick="closeBudgetSettingsModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="budget-settings-form">
                            <div style="margin-bottom: 2rem;">
                                <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Default R&M Percentage</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Standard R&M % <span style="color: var(--danger);">*</span>
                                        </label>
                                        <input type="number" id="defaultRMPercent" value="3.33" min="0" max="100" step="0.01"
                                            style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <p style="font-size: 0.75rem; color: var(--gray-600); margin-top: 0.25rem;">Applied to all new locations</p>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Alert Threshold %
                                        </label>
                                        <input type="number" id="alertThreshold" value="70" min="0" max="100" step="5"
                                            style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <p style="font-size: 0.75rem; color: var(--gray-600); margin-top: 0.25rem;">Send alert when budget reaches this %</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 2rem;">
                                <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Budget Period Settings</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Period Type
                                        </label>
                                        <select id="periodType" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                            <option value="monthly">Monthly (28 days)</option>
                                            <option value="quarterly">Quarterly</option>
                                            <option value="annual">Annual</option>
                                            <option value="custom">Custom</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Forecast Method
                                        </label>
                                        <select id="forecastMethod" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                            <option value="historical">Historical Average</option>
                                            <option value="growth">Growth Projection</option>
                                            <option value="manual">Manual Entry</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Notification Settings</h4>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" checked>
                                        <span>Email alerts when budget exceeds threshold</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" checked>
                                        <span>Weekly budget summary reports</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox">
                                        <span>Daily budget updates for high-usage locations</span>
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeBudgetSettingsModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveBudgetSettings()">Save Settings</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        window.showBudgetSettingsModal = showBudgetSettingsModal;
        
        function closeBudgetSettingsModal() {
            const modal = document.querySelector('.modal.active');
            if (modal) {
                modal.remove();
            }
        }
        window.closeBudgetSettingsModal = closeBudgetSettingsModal;
        
        function saveBudgetSettings() {
            const rmPercent = document.getElementById('defaultRMPercent')?.value;
            const threshold = document.getElementById('alertThreshold')?.value;
            showToast(`Budget settings updated: R&M ${rmPercent}%, Alert at ${threshold}%`, 'success');
            closeBudgetSettingsModal();
        }
        window.saveBudgetSettings = saveBudgetSettings;
        
        function createNewBudget() {
            showToast('Opening budget creation wizard...', 'info');
        }
        window.createNewBudget = createNewBudget;
        
        function exportBudgetReport() {
            showToast('Exporting budget report to Excel...', 'info');
        }
        window.exportBudgetReport = exportBudgetReport;
        
        function adjustBudgets() {
            showToast('Opening budget adjustment tool...', 'info');
        }
        window.adjustBudgets = adjustBudgets;
        
        function viewLocationBudget(locationId) {
            showToast(`Loading budget details for ${locationId}...`, 'info');
        }
        window.viewLocationBudget = viewLocationBudget;
        
        function configureBudgetAlerts() {
            showToast('Opening alert configuration...', 'info');
        }
        window.configureBudgetAlerts = configureBudgetAlerts;
        
        function viewAlert(alertId) {
            showToast(`Viewing alert details for ${alertId}...`, 'info');
        }
        window.viewAlert = viewAlert;
        
        function filterByAssetGroup() {
            const group = document.getElementById('assetGroupFilter')?.value;
            showToast(`Filtering by asset group: ${group}`, 'info');
        }
        window.filterByAssetGroup = filterByAssetGroup;
        
        function getCompanyContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Company Settings</h2>
                        <button class="btn btn-primary" onclick="saveCompanySettings()">Save Changes</button>
                    </div>
                    
                    <div class="table-container" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3 class="table-title">Company Information</h3>
                        </div>
                        <div style="padding: 2rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Company Name
                                    </label>
                                    <input type="text" value="Hey Spruce" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Business Type
                                    </label>
                                    <select style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <option>Facility Management</option>
                                        <option>Property Management</option>
                                        <option>Restaurant Group</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Tax ID / EIN
                                    </label>
                                    <input type="text" value="XX-XXXXXXX" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Phone Number
                                    </label>
                                    <input type="tel" value="(555) 123-4567" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                </div>
                                <div style="grid-column: 1 / -1;">
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Business Address
                                    </label>
                                    <textarea rows="2" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">123 Main Street, Los Angeles, CA 90001</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Billing Information</h3>
                        </div>
                        <div style="padding: 2rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Billing Email
                                    </label>
                                    <input type="email" value="billing@heyspruce.com" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Payment Terms
                                    </label>
                                    <select style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <option>Net 30</option>
                                        <option>Net 15</option>
                                        <option>Due on Receipt</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        window.getCompanyContent = getCompanyContent;
        
        async function getTeamManagementContent() {
            // Load team members from Supabase with fallback
            let teamMembers = [];
            let dataSource = 'localStorage';
            
            try {
                const response = await fetch('/api/team-members');
                if (response.ok) {
                    const data = await response.json();
                    // Handle both array response and object with members array
                    if (Array.isArray(data)) {
                        teamMembers = data;
                        dataSource = 'Supabase';
                    } else if (data && data.members) {
                        teamMembers = data.members;
                        dataSource = 'Supabase';
                    } else if (data && data.error) {
                        console.warn('Supabase error:', data.error);
                        throw new Error(data.error);
                    }
                }
            } catch (error) {
                console.error('Error loading team members from Supabase:', error);
                // Fall back to localStorage if API fails
                teamMembers = JSON.parse(localStorage.getItem('teamMembers') || '[]');
                console.log('Using localStorage fallback');
            }
            
            // If still no members, use defaults
            if (!teamMembers || teamMembers.length === 0) {
                teamMembers = [
                    { id: '1', name: 'Jacob Shure', email: 'jacob@hwood.com', role: 'Admin', department: 'Management', status: 'Active' },
                    { id: '2', name: 'Emily Chen', email: 'emily.chen@hwood.com', role: 'Vendor Manager', department: 'Procurement', status: 'Active' },
                    { id: '3', name: 'Robert Davis', email: 'robert.davis@hwood.com', role: 'Coordinator', department: 'Operations', status: 'Active' },
                    { id: '4', name: 'Lisa Martinez', email: 'lisa.martinez@hwood.com', role: 'Analyst', department: 'Finance', status: 'Pending' }
                ];
                dataSource = 'defaults';
            }
            
            console.log(`Team members loaded from: ${dataSource} (${teamMembers.length} members)`);
            
            // Generate table rows from team members
            const tableRows = teamMembers.map(member => `
                <tr>
                    <td>${member.name}</td>
                    <td>${member.email}</td>
                    <td>${member.role}</td>
                    <td>${member.department}</td>
                    <td><span class="badge badge-${member.status === 'Active' ? 'success' : 'warning'}">${member.status}</span></td>
                    <td>
                        ${member.status === 'Active' ? 
                            `<button class="btn-icon" onclick="editTeamMember('${member.id}')">✏️</button>` :
                            `<button class="btn-icon" onclick="resendInvite('${member.id}')">📧</button>`
                        }
                        <button class="btn-icon" onclick="removeTeamMember('${member.id}')">🗑️</button>
                    </td>
                </tr>
            `).join('');
            
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Team Management</h2>
                        <button class="btn btn-primary" onclick="openAddTeamMemberModal()">+ Add Team Member</button>
                    </div>
                    
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Team Members</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Department</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="teamMembersTableBody">
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function getAdminContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Admin Settings</h2>
                    </div>
                    
                    <!-- User Management -->
                    <div class="table-container" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3 class="table-title">User Management</h3>
                            <button class="btn btn-primary" onclick="addNewUser()">+ Add User</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>John Doe</strong></td>
                                    <td>john@heyspruce.com</td>
                                    <td>Administrator</td>
                                    <td><span class="status-badge completed">Active</span></td>
                                    <td>2 hours ago</td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary" onclick="editUser('john')">Edit</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Jane Smith</strong></td>
                                    <td>jane@heyspruce.com</td>
                                    <td>Manager</td>
                                    <td><span class="status-badge completed">Active</span></td>
                                    <td>1 day ago</td>
                                    <td>
                                        <button class="btn btn-sm btn-secondary" onclick="editUser('jane')">Edit</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- System Settings -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">System Settings</h3>
                        </div>
                        <div style="padding: 2rem;">
                            <div style="display: grid; gap: 1.5rem;">
                                <div>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" checked>
                                        <span>Enable email notifications</span>
                                    </label>
                                </div>
                                <div>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox" checked>
                                        <span>Require approval for work orders over $5,000</span>
                                    </label>
                                </div>
                                <div>
                                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="checkbox">
                                        <span>Enable two-factor authentication</span>
                                    </label>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Default Currency
                                    </label>
                                    <select style="width: 250px; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <option>USD - US Dollar</option>
                                        <option>EUR - Euro</option>
                                        <option>GBP - British Pound</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-primary" style="margin-top: 2rem;" onclick="saveAdminSettings()">Save Settings</button>
                        </div>
                    </div>
                </div>
            `;
        }
        window.getAdminContent = getAdminContent;
        
        function saveCompanySettings() {
            showToast('Company settings saved successfully', 'success');
        }
        window.saveCompanySettings = saveCompanySettings;
        
        // Team Management Functions
        function openAddTeamMemberModal() {
            addNewUser(); // Reuse existing function
        }
        
        async function editTeamMember(id) {
            // Try to load from Supabase first, then fall back to localStorage
            let member = null;
            
            try {
                const response = await fetch('/api/team-members');
                if (response.ok) {
                    const teamMembers = await response.json();
                    member = teamMembers.find(m => m.id === id);
                }
            } catch (error) {
                console.error('Error loading from Supabase:', error);
            }
            
            // Fall back to localStorage
            if (!member) {
                const teamMembers = JSON.parse(localStorage.getItem('teamMembers') || '[]');
                member = teamMembers.find(m => m.id === id);
            }
            
            if (!member) {
                showToast('Team member not found', 'error');
                return;
            }
            
            // Extract data from the member object
            const nameParts = member.name.split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';
            const email = member.email;
            const role = member.role;
            const department = member.department;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>Edit Team Member</h3>
                        <button class="close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form onsubmit="updateTeamMember(event, '${id}')">
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label>First Name</label>
                                    <input type="text" id="editFirstName" required value="${firstName}">
                                </div>
                                <div class="form-group">
                                    <label>Last Name</label>
                                    <input type="text" id="editLastName" required value="${lastName}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Email Address</label>
                                <input type="email" id="editEmail" required value="${email}">
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <select id="editRole" required>
                                    <option value="Administrator" ${role === 'Admin' || role === 'Administrator' ? 'selected' : ''}>Administrator</option>
                                    <option value="Manager" ${role === 'Manager' || role === 'Vendor Manager' ? 'selected' : ''}>Manager</option>
                                    <option value="Technician" ${role === 'Technician' ? 'selected' : ''}>Technician</option>
                                    <option value="Viewer" ${role === 'Viewer' ? 'selected' : ''}>Viewer</option>
                                    <option value="Coordinator" ${role === 'Coordinator' ? 'selected' : ''}>Coordinator</option>
                                    <option value="Analyst" ${role === 'Analyst' ? 'selected' : ''}>Analyst</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Department</label>
                                <input type="text" id="editDepartment" value="${department}">
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Update Team Member</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function updateTeamMember(event, id) {
            event.preventDefault();
            const firstName = document.getElementById('editFirstName').value;
            const lastName = document.getElementById('editLastName').value;
            const email = document.getElementById('editEmail').value;
            const role = document.getElementById('editRole').value;
            const department = document.getElementById('editDepartment').value;
            
            // Update in Supabase
            const updatedMember = {
                name: `${firstName} ${lastName}`,
                email: email,
                role: role,
                department: department
            };
            
            try {
                const response = await fetch(`/api/team-members?id=${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updatedMember)
                });
                
                if (!response.ok) {
                    console.error('Failed to update in Supabase');
                }
            } catch (error) {
                console.error('Error updating in Supabase:', error);
            }
            
            // Also update in localStorage
            const teamMembers = JSON.parse(localStorage.getItem('teamMembers') || '[]');
            const memberIndex = teamMembers.findIndex(m => m.id === id);
            if (memberIndex !== -1) {
                teamMembers[memberIndex] = {
                    ...teamMembers[memberIndex],
                    ...updatedMember
                };
                localStorage.setItem('teamMembers', JSON.stringify(teamMembers));
            }
            
            // Close modal
            document.querySelector('.modal').remove();
            
            showToast(`Team member ${firstName} ${lastName} updated successfully`, 'success');
            
            // Refresh the team section
            const currentSection = window.location.hash.replace('#', '') || 'dashboard';
            if (currentSection === 'team') {
                setTimeout(() => loadSection('team'), 100);
            }
        }
        
        async function removeTeamMember(id) {
            if (confirm('Are you sure you want to remove this team member? They will lose access to the system.')) {
                // Delete from Supabase
                try {
                    const response = await fetch(`/api/team-members?id=${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        console.error('Failed to delete from Supabase');
                    }
                } catch (error) {
                    console.error('Error deleting from Supabase:', error);
                }
                
                // Also remove from localStorage
                let teamMembers = JSON.parse(localStorage.getItem('teamMembers') || '[]');
                teamMembers = teamMembers.filter(member => member.id !== id);
                localStorage.setItem('teamMembers', JSON.stringify(teamMembers));
                
                showToast('Team member removed successfully', 'success');
                
                // Remove the row from the table
                const button = event.target;
                const row = button.closest('tr');
                if (row) {
                    row.style.opacity = '0.5';
                    setTimeout(() => {
                        row.remove();
                    }, 300);
                }
            }
        }
        
        async function resendInvite(id) {
            // Get the email from the row (in a real app, this would come from the database)
            const button = event.target;
            const row = button.closest('tr');
            const email = row.cells[1].textContent;
            const name = row.cells[0].textContent;
            const role = row.cells[2].textContent;
            
            try {
                const response = await fetch('/api/team-invite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        firstName: name.split(' ')[0],
                        lastName: name.split(' ')[1] || '',
                        email: email,
                        role: role,
                        clientPortalAccess: false,
                        inviteUrl: `${window.location.origin}/supplier-signup.html?email=${encodeURIComponent(email)}&role=${encodeURIComponent(role)}`
                    })
                });
                
                if (response.ok) {
                    showToast(`Invitation resent to ${email}`, 'success');
                } else {
                    showToast('Failed to resend invitation', 'error');
                }
            } catch (error) {
                console.error('Error resending invite:', error);
                showToast('Failed to resend invitation', 'error');
            }
        }
        
        function addNewUser() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>Add New User</h3>
                        <button class="close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form onsubmit="submitNewUser(event)">
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label>First Name</label>
                                    <input type="text" id="userFirstName" required>
                                </div>
                                <div class="form-group">
                                    <label>Last Name</label>
                                    <input type="text" id="userLastName" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Email Address</label>
                                <input type="email" id="userEmail" required>
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <select id="userRole" required>
                                    <option value="">Select Role</option>
                                    <option value="Administrator">Administrator</option>
                                    <option value="Manager">Manager</option>
                                    <option value="Technician">Technician</option>
                                    <option value="Viewer">Viewer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="clientPortalAccess"> 
                                    Grant Client Portal Access (Administrator role required)
                                </label>
                            </div>
                            <div class="form-group">
                                <label>Location Access</label>
                                <select id="userLocationAccess" multiple style="height: 100px;">
                                    <option value="all">All Locations</option>
                                    <option value="corporate-hq">Corporate HQ</option>
                                    <option value="warehouse-1">Warehouse 1</option>
                                    <option value="retail-store-1">Retail Store 1</option>
                                </select>
                                <small>Hold Ctrl/Cmd to select multiple locations</small>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Add User</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Enable/disable client portal access based on role
            document.getElementById('userRole').addEventListener('change', function() {
                const clientPortalCheckbox = document.getElementById('clientPortalAccess');
                if (this.value === 'Administrator') {
                    clientPortalCheckbox.disabled = false;
                } else {
                    clientPortalCheckbox.checked = false;
                    clientPortalCheckbox.disabled = true;
                }
            });
        }
        window.addNewUser = addNewUser;
        
        async function submitNewUser(event) {
            event.preventDefault();
            const firstName = document.getElementById('userFirstName').value;
            const lastName = document.getElementById('userLastName').value;
            const email = document.getElementById('userEmail').value;
            const role = document.getElementById('userRole').value;
            const clientPortalAccess = document.getElementById('clientPortalAccess').checked;
            
            // Close modal immediately after getting values
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => modal.remove());
            
            // Create new team member object
            const newMember = {
                id: Date.now().toString(),
                name: `${firstName} ${lastName}`,
                email: email,
                role: role,
                department: clientPortalAccess ? 'All' : 'Operations',
                status: 'Pending',
                clientPortalAccess: clientPortalAccess
            };
            
            // Save to Supabase
            try {
                const response = await fetch('/api/team-members', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newMember)
                });
                
                if (response.ok) {
                    const savedMember = await response.json();
                    newMember.id = savedMember.id; // Update with Supabase ID
                }
            } catch (error) {
                console.error('Error saving to Supabase:', error);
            }
            
            // Also save to localStorage as backup
            const teamMembers = JSON.parse(localStorage.getItem('teamMembers') || '[]');
            teamMembers.push(newMember);
            localStorage.setItem('teamMembers', JSON.stringify(teamMembers));
            
            try {
                // Send invitation email - use full URL for Vercel
                const apiUrl = window.location.hostname === 'localhost' 
                    ? '/api/team-invite' 
                    : `${window.location.origin}/api/team-invite`;
                    
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        firstName,
                        lastName,
                        email,
                        role,
                        clientPortalAccess,
                        inviteUrl: `${window.location.origin}/supplier-signup.html?email=${encodeURIComponent(email)}&role=${encodeURIComponent(role)}`
                    })
                });

                let data = {};
                try {
                    data = await response.json();
                } catch (e) {
                    console.error('Response parsing error:', e);
                    console.log('Response status:', response.status);
                }
                
                if (response.ok && data.success) {
                    showToast(`Invitation sent to ${firstName} ${lastName} at ${email}`, 'success');
                    
                    // Add the new member to the table
                    const tbody = document.querySelector('#content table tbody') || document.querySelector('#teamMembersTableBody');
                    if (tbody) {
                        const newRow = document.createElement('tr');
                        newRow.innerHTML = `
                            <td>${firstName} ${lastName}</td>
                            <td>${email}</td>
                            <td>${role}</td>
                            <td>${clientPortalAccess ? 'All' : 'Operations'}</td>
                            <td><span class="badge badge-warning">Pending</span></td>
                            <td>
                                <button class="btn-icon" onclick="resendInvite('${newMember.id}')">📧</button>
                                <button class="btn-icon" onclick="removeTeamMember('${newMember.id}')">🗑️</button>
                            </td>
                        `;
                        tbody.appendChild(newRow);
                    }
                } else {
                    console.log('Email service not configured or failed:', data);
                    showToast(`User ${firstName} ${lastName} added locally (email service pending)`, 'warning');
                    
                    // Still add the member to the table
                    const tbody = document.querySelector('#content table tbody');
                    if (tbody) {
                        const newRow = document.createElement('tr');
                        newRow.innerHTML = `
                            <td>${firstName} ${lastName}</td>
                            <td>${email}</td>
                            <td>${role}</td>
                            <td>${clientPortalAccess ? 'All' : 'Operations'}</td>
                            <td><span class="badge badge-warning">Pending</span></td>
                            <td>
                                <button class="btn-icon" onclick="resendInvite('new')">📧</button>
                                <button class="btn-icon" onclick="removeTeamMember('new')">🗑️</button>
                            </td>
                        `;
                        tbody.appendChild(newRow);
                    }
                }
            } catch (error) {
                console.error('Error sending invite:', error);
                showToast(`User ${firstName} ${lastName} added locally (will retry email)`, 'warning');
                
                // Still add the member to the table on error
                const tbody = document.querySelector('#content table tbody');
                if (tbody) {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td>${firstName} ${lastName}</td>
                        <td>${email}</td>
                        <td>${role}</td>
                        <td>${clientPortalAccess ? 'All' : 'Operations'}</td>
                        <td><span class="badge badge-warning">Pending</span></td>
                        <td>
                            <button class="btn-icon" onclick="resendInvite('new')">📧</button>
                            <button class="btn-icon" onclick="removeTeamMember('new')">🗑️</button>
                        </td>
                    `;
                    tbody.appendChild(newRow);
                }
            }
        }
        window.submitNewUser = submitNewUser;
        window.updateTeamMember = updateTeamMember;
        window.editTeamMember = editTeamMember;
        window.removeTeamMember = removeTeamMember;
        window.resendInvite = resendInvite;
        
        function editUser(userId) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>Edit User</h3>
                        <button class="close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form onsubmit="submitEditUser(event, '${userId}')">
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label>First Name</label>
                                    <input type="text" id="editUserFirstName" value="${userId === 'john' ? 'John' : 'Jane'}" required>
                                </div>
                                <div class="form-group">
                                    <label>Last Name</label>
                                    <input type="text" id="editUserLastName" value="${userId === 'john' ? 'Doe' : 'Smith'}" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Email Address</label>
                                <input type="email" id="editUserEmail" value="${userId}@heyspruce.com" required>
                            </div>
                            <div class="form-group">
                                <label>Role</label>
                                <select id="editUserRole" required>
                                    <option value="Administrator" ${userId === 'john' ? 'selected' : ''}>Administrator</option>
                                    <option value="Manager" ${userId === 'jane' ? 'selected' : ''}>Manager</option>
                                    <option value="Technician">Technician</option>
                                    <option value="Viewer">Viewer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="editClientPortalAccess" ${userId === 'john' ? 'checked' : ''}> 
                                    Grant Client Portal Access (Administrator role required)
                                </label>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <select id="editUserStatus">
                                    <option value="Active" selected>Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Suspended">Suspended</option>
                                </select>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger" onclick="deactivateUser('${userId}')">Deactivate User</button>
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Enable/disable client portal access based on role
            document.getElementById('editUserRole').addEventListener('change', function() {
                const clientPortalCheckbox = document.getElementById('editClientPortalAccess');
                if (this.value === 'Administrator') {
                    clientPortalCheckbox.disabled = false;
                } else {
                    clientPortalCheckbox.checked = false;
                    clientPortalCheckbox.disabled = true;
                }
            });
        }
        window.editUser = editUser;
        
        function submitEditUser(event, userId) {
            event.preventDefault();
            const firstName = document.getElementById('editUserFirstName').value;
            const lastName = document.getElementById('editUserLastName').value;
            const role = document.getElementById('editUserRole').value;
            const clientPortalAccess = document.getElementById('editClientPortalAccess').checked;
            
            showToast(`User ${firstName} ${lastName} updated successfully`, 'success');
            document.querySelector('.modal').remove();
            loadSection('admin');
        }
        window.submitEditUser = submitEditUser;
        
        function deactivateUser(userId) {
            if (confirm('Are you sure you want to deactivate this user? They will lose access to all systems.')) {
                showToast(`User ${userId} deactivated`, 'success');
                document.querySelector('.modal').remove();
                loadSection('admin');
            }
        }
        window.deactivateUser = deactivateUser;
        
        function saveAdminSettings() {
            showToast('Admin settings saved successfully', 'success');
        }
        window.saveAdminSettings = saveAdminSettings;
        
        function filterByLocation() {
            const location = document.getElementById('locationFilter')?.value;
            showToast(`Filtering by location: ${location}`, 'info');
        }
        window.filterByLocation = filterByLocation;
        
        function editGeneralAsset(assetId) {
            showToast(`Opening editor for general asset ${assetId}...`, 'info');
        }
        window.editGeneralAsset = editGeneralAsset;
        
        function viewGeneralAsset(assetId) {
            loadSection('asset-detail', assetId);
        }
        window.viewGeneralAsset = viewGeneralAsset;
        
        function prevPage() {
            showToast('Loading previous page...', 'info');
        }
        window.prevPage = prevPage;
        
        function nextPage() {
            showToast('Loading next page...', 'info');
        }
        window.nextPage = nextPage;
        
        // Missing modal functions implementations
        function handleWorkOrderAction(action, orderId) {
            showToast(`Performing ${action} on work order ${orderId}...`, 'info');
        }
        
        function openSubStatusModal() {
            showToast('Opening sub-status filter modal...', 'info');
        }
        
        function closeSubStatusModal() {
            const modal = document.querySelector('.modal.active');
            if (modal) modal.remove();
        }
        
        function clearAllSubStatusFilters() {
            showToast('Clearing all sub-status filters...', 'info');
        }
        
        function applySubStatusFilters() {
            showToast('Applying sub-status filters...', 'info');
        }
        
        function removeSubStatusFilter(filter) {
            showToast(`Removing filter: ${filter}`, 'info');
        }
        
        function openCheckinModal() {
            showToast('Opening check-in modal...', 'info');
        }
        
        function closeCheckinModal() {
            const modal = document.querySelector('.modal.active');
            if (modal) modal.remove();
        }
        
        function submitCheckin() {
            showToast('Submitting check-in...', 'success');
            closeCheckinModal();
        }
        
        function openScheduleModal() {
            showToast('Opening schedule modal...', 'info');
        }
        
        function closeScheduleModal() {
            const modal = document.querySelector('.modal.active');
            if (modal) modal.remove();
        }
        
        function submitSchedule() {
            showToast('Submitting schedule...', 'success');
            closeScheduleModal();
        }
        
        function openCheckoutModal() {
            showToast('Opening checkout modal...', 'info');
        }
        
        function closeCheckoutModal() {
            const modal = document.querySelector('.modal.active');
            if (modal) modal.remove();
        }
        
        function submitCheckout() {
            showToast('Submitting checkout...', 'success');
            closeCheckoutModal();
        }
        
        function submitSubcontract() {
            showToast('Submitting subcontract...', 'success');
        }
        
        function switchClientQuoteTab(tab) {
            showToast(`Switching to ${tab} quotes...`, 'info');
        }
        
        function toggleQuotesExpansion() {
            const submenu = document.querySelector('.quotes-submenu');
            if (submenu) {
                submenu.style.display = submenu.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function exportInvoices() {
            showToast('Exporting invoices to CSV...', 'info');
        }
        
        // Removed duplicate confirmProposalSend function
        
        function deleteLocation(locationId) {
            if (confirm('Are you sure you want to delete this location?')) {
                showToast(`Location deleted successfully`, 'success');
                closeLocationModal();
                loadSection('locations');
            }
        }
        
        function updateLocation() {
            showToast('Location updated successfully', 'success');
            closeLocationModal();
            loadSection('locations');
        }
        
        function exportLocations() {
            showToast('Exporting locations to CSV...', 'info');
        }
        
        function assignContact(contactId) {
            showToast(`Opening assignment modal for contact ${contactId}...`, 'info');
        }
        
        function deleteContact(contactId) {
            if (confirm('Are you sure you want to delete this contact?')) {
                showToast(`Contact deleted successfully`, 'success');
                closeContactModal();
                loadSection('locations');
            }
        }
        
        function updateContact() {
            showToast('Contact updated successfully', 'success');
            closeContactModal();
            loadSection('locations');
        }
        
        function exportContacts() {
            showToast('Exporting contacts to CSV...', 'info');
        }
        
        function closeAssignmentModal() {
            const modal = document.querySelector('.modal.active');
            if (modal) modal.remove();
        }
        
        function saveContactAssignment() {
            showToast('Contact assignment saved successfully', 'success');
            closeAssignmentModal();
        }
        
        function markAllAsRead() {
            showToast('All messages marked as read', 'success');
            loadSection('inbox');
        }
        
        function markAsRead(messageId) {
            showToast(`Message ${messageId} marked as read`, 'success');
        }
        
        function openInboxSettings() {
            showToast('Opening inbox settings...', 'info');
        }
        
        function closeInboxSettings() {
            const modal = document.querySelector('.modal.active');
            if (modal) modal.remove();
        }
        
        function saveInboxSettings() {
            showToast('Inbox settings saved successfully', 'success');
            closeInboxSettings();
        }
        
        function openAddPartsModal() {
            showToast('Opening add parts modal...', 'info');
        }
        
        function closeAddPartsModal() {
            const modal = document.querySelector('.modal.active');
            if (modal) modal.remove();
        }
        
        function addPart() {
            showToast('Part added successfully', 'success');
            closeAddPartsModal();
        }
        
        function openAddEquipmentModal() {
            showToast('Opening add equipment modal...', 'info');
        }
        
        function closeAddEquipmentModal() {
            const modal = document.querySelector('.modal.active');
            if (modal) modal.remove();
        }
        
        function addEquipment() {
            showToast('Equipment added successfully', 'success');
            closeAddEquipmentModal();
        }
        
        function loadWorkOrderDetail(orderNumber) {
            loadSection('work-order-detail', orderNumber);
            // Load Google Maps if not already loaded
            if (typeof google === 'undefined' || !google.maps) {
                loadGoogleMaps();
            } else {
                // Initialize map after content loads
                setTimeout(() => {
                    initMap();
                }, 100);
            }
        }
        
        function initMap() {
            // Check if Google Maps is loaded
            if (typeof google === 'undefined' || !google.maps) {
                console.log('Google Maps not loaded yet');
                return;
            }
            
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.log('Map element not found');
                return;
            }
            
            // Default to Delilah LA location (you would get this from your data)
            const location = { lat: 34.0522, lng: -118.2437 }; // Los Angeles coordinates
            
            // Create map
            const map = new google.maps.Map(mapElement, {
                center: location,
                zoom: 15,
                mapTypeControl: false,
                streetViewControl: true,
                fullscreenControl: true,
                zoomControl: true,
                styles: [
                    {
                        featureType: "poi",
                        elementType: "labels",
                        stylers: [{ visibility: "off" }]
                    }
                ]
            });
            
            // Add marker
            const marker = new google.maps.Marker({
                position: location,
                map: map,
                title: 'Delilah LA',
                animation: google.maps.Animation.DROP
            });
            
            // Add info window
            const infoWindow = new google.maps.InfoWindow({
                content: `
                    <div style="padding: 0.5rem;">
                        <strong>Delilah LA</strong><br>
                        123 Main Street<br>
                        Los Angeles, CA 90001
                    </div>
                `
            });
            
            marker.addListener('click', () => {
                infoWindow.open(map, marker);
            });
        }
        
        function createProposal(orderNumber) {
            // Navigate to proposal builder with work order data
            window.location.href = `/proposal-builder.html?wo=${orderNumber}`;
        }
        
        function createInvoice(orderNumber) {
            // Open invoice creation modal or navigate to invoice page
            if (confirm(`Create invoice for Work Order #${orderNumber}?`)) {
                // Here you would typically:
                // 1. Generate invoice from work order data
                // 2. Navigate to invoice page or open modal
                alert(`Invoice created for Work Order #${orderNumber}`);
                
                // For now, navigate to invoices section
                loadSection('invoices');
            }
        }
        
        function openSubcontractModal(orderNumber) {
            // Store the work order number for use in submission
            window.currentSubcontractOrder = orderNumber;
            const modal = document.getElementById('subcontractModal');
            if (modal) {
                modal.classList.add('active');
            }
        }
        
        function closeSubcontractModal() {
            const modal = document.getElementById('subcontractModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        function openAddPartsModal() {
            const modal = document.getElementById('addPartsModal');
            if (modal) {
                modal.classList.add('active');
            }
        }
        
        function closeAddPartsModal() {
            const modal = document.getElementById('addPartsModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        function addPart() {
            const partName = document.getElementById('partName').value;
            const partQuantity = document.getElementById('partQuantity').value;
            const partCost = document.getElementById('partCost').value;
            const partNotes = document.getElementById('partNotes').value;
            
            if (!partName || !partQuantity) {
                alert('Please enter part name and quantity');
                return;
            }
            
            const partsList = document.getElementById('partsList');
            if (partsList) {
                // Remove "No parts added" message if it exists
                if (partsList.querySelector('p')) {
                    partsList.innerHTML = '';
                }
                
                // Add new part item
                const partItem = document.createElement('div');
                partItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--gray-50); border-radius: 6px; margin-bottom: 0.5rem;';
                partItem.innerHTML = `
                    <div>
                        <div style="font-weight: 500; font-size: 0.875rem;">${partName}</div>
                        <div style="font-size: 0.75rem; color: var(--gray-600);">Qty: ${partQuantity} | Cost: $${partCost || '0.00'}</div>
                        ${partNotes ? `<div style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem;">${partNotes}</div>` : ''}
                    </div>
                    <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="this.parentElement.remove()">Remove</button>
                `;
                partsList.appendChild(partItem);
            }
            
            // Clear form
            document.getElementById('partName').value = '';
            document.getElementById('partQuantity').value = '1';
            document.getElementById('partCost').value = '';
            document.getElementById('partNotes').value = '';
            
            closeAddPartsModal();
        }
        
        function openAddEquipmentModal() {
            const modal = document.getElementById('addEquipmentModal');
            if (modal) {
                modal.classList.add('active');
            }
        }
        
        function closeAddEquipmentModal() {
            const modal = document.getElementById('addEquipmentModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        function addEquipment() {
            const equipmentSelect = document.getElementById('equipmentSelect');
            const stockLocation = document.getElementById('stockLocation').value;
            const serialNumber = document.getElementById('serialNumber').value;
            
            if (!equipmentSelect.value) {
                alert('Please select equipment');
                return;
            }
            
            const equipmentName = equipmentSelect.options[equipmentSelect.selectedIndex].text;
            const equipmentList = document.getElementById('equipmentList');
            
            if (equipmentList) {
                // Remove "No equipment added" message if it exists
                if (equipmentList.querySelector('p')) {
                    equipmentList.innerHTML = '';
                }
                
                // Add new equipment item
                const equipmentItem = document.createElement('div');
                equipmentItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--gray-50); border-radius: 6px; margin-bottom: 0.5rem;';
                
                let details = [];
                if (stockLocation) {
                    const locationText = document.querySelector(`#stockLocation option[value="${stockLocation}"]`).text;
                    details.push(`Location: ${locationText}`);
                }
                if (serialNumber) {
                    details.push(`S/N: ${serialNumber}`);
                }
                
                equipmentItem.innerHTML = `
                    <div>
                        <div style="font-weight: 500; font-size: 0.875rem;">${equipmentName}</div>
                        ${details.length > 0 ? `<div style="font-size: 0.75rem; color: var(--gray-600);">${details.join(' | ')}</div>` : ''}
                    </div>
                    <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="this.parentElement.remove()">Remove</button>
                `;
                equipmentList.appendChild(equipmentItem);
            }
            
            // Clear form
            document.getElementById('equipmentSelect').value = '';
            document.getElementById('stockLocation').value = '';
            document.getElementById('serialNumber').value = '';
            
            closeAddEquipmentModal();
        }
        
        function submitSubcontract() {
            // Get form values
            const subcontractor = document.getElementById('subcontractor').value;
            const assignmentNotes = document.getElementById('assignmentNotes').value;
            const dueDate = document.getElementById('subcontractDueDate').value;
            const agreedPrice = document.getElementById('agreedPrice').value;
            
            if (!subcontractor) {
                alert('Please select a subcontractor');
                return;
            }
            
            // Here you would typically send this data to your backend
            console.log('Subcontract submitted:', {
                workOrder: window.currentSubcontractOrder,
                subcontractor,
                assignmentNotes,
                dueDate,
                agreedPrice
            });
            
            // Update the subcontracted status in the work order details
            const subcontractedFields = document.querySelectorAll('div:contains("Subcontracted")');
            subcontractedFields.forEach(field => {
                const valueDiv = field.nextElementSibling;
                if (valueDiv) {
                    valueDiv.textContent = 'Assigned to ' + document.querySelector(`#subcontractor option[value="${subcontractor}"]`).textContent;
                }
            });
            
            alert(`Work Order #${window.currentSubcontractOrder} has been assigned to subcontractor`);
            closeSubcontractModal();
        }
        
        function getWorkOrderDetailContent(orderNumber) {
            // Determine status and next step based on order number (in real app, this would come from data)
            let status = 'progress';
            let statusText = 'In Progress';
            let nextStepTitle = 'Next Step';
            let nextStepDescription = '';
            let nextStepButton = '';
            
            // Simulate different statuses based on order number
            if (orderNumber === '1989975') {
                // Not started yet
                nextStepDescription = 'Schedule service and assign technician';
                nextStepButton = '<button class="btn btn-primary" onclick="openScheduleModal()">Schedule</button>';
            } else if (orderNumber === '1989974') {
                // Scheduled
                nextStepDescription = 'Tech needs to start work and head to location';
                nextStepButton = '<button class="btn btn-primary" onclick="handleWorkOrderAction(this, \'start\')">Start Work</button>';
            } else if (orderNumber === '1989973') {
                // En route
                nextStepDescription = 'Tech needs to check in at the location';
                nextStepButton = '<button class="btn btn-primary" onclick="openCheckinModal()">Check In</button>';
            } else if (orderNumber === '1989972') {
                // Checked in
                nextStepDescription = 'Complete work and check out when finished';
                nextStepButton = '<button class="btn btn-primary" onclick="openCheckoutModal()">Check Out</button>';
            } else {
                // Default - needs scheduling
                nextStepDescription = 'Schedule service and assign technician';
                nextStepButton = '<button class="btn btn-primary" onclick="openScheduleModal()">Schedule</button>';
            }
            
            return `
                <div>
                    <!-- Breadcrumb -->
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem; font-size: 0.875rem;">
                        <a href="#" onclick="loadSection('work-orders'); return false;" style="color: var(--gray-600); text-decoration: none;">Work Orders</a>
                        <span style="color: var(--gray-400);">›</span>
                        <span style="color: var(--gray-900);">WO ${orderNumber}</span>
                    </div>
                    
                    <!-- Page Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <h2 style="font-size: 1.875rem; font-weight: 700;">Work Order ${orderNumber}</h2>
                            <span class="status-badge ${status}">${statusText}</span>
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn btn-secondary" onclick="loadSection('work-orders')">Back to List</button>
                            <button class="btn btn-secondary" onclick="openSubcontractModal('${orderNumber}')">Subcontract</button>
                            <button class="btn btn-secondary" onclick="createProposal('${orderNumber}')">Create Proposal</button>
                            <button class="btn btn-secondary" onclick="createInvoice('${orderNumber}')">Create Invoice</button>
                        </div>
                    </div>
                    
                    <!-- Content Grid -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem;">
                        <!-- Left Column -->
                        <div>
                            <!-- Next Steps -->
                            <div class="table-container" style="background: var(--gray-50); border-left: 4px solid var(--primary);">
                                <div style="padding: 1rem 1.5rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <h3 style="font-size: 1rem; font-weight: 600; color: var(--gray-900); margin-bottom: 0.25rem;">${nextStepTitle}</h3>
                                            <p style="font-size: 0.875rem; color: var(--gray-600);">${nextStepDescription}</p>
                                        </div>
                                        ${nextStepButton}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Work Order Details -->
                            <div class="table-container" style="margin-top: 1.5rem;">
                                <div class="table-header">
                                    <h3 class="table-title">Work Order Details</h3>
                                </div>
                                <div style="padding: 1.5rem;">
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                                        <div>
                                            <div style="font-size: 0.75rem; font-weight: 500; color: var(--gray-500); text-transform: uppercase; margin-bottom: 0.25rem;">Work Order #</div>
                                            <div style="font-size: 0.875rem; color: var(--gray-900);">${orderNumber}</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; font-weight: 500; color: var(--gray-500); text-transform: uppercase; margin-bottom: 0.25rem;">Priority</div>
                                            <div style="font-size: 0.875rem; color: var(--danger); font-weight: 600;">Emergency - 4 Hrs</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; font-weight: 500; color: var(--gray-500); text-transform: uppercase; margin-bottom: 0.25rem;">Service Type</div>
                                            <div style="font-size: 0.875rem; color: var(--gray-900);">Door knob broken</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; font-weight: 500; color: var(--gray-500); text-transform: uppercase; margin-bottom: 0.25rem;">Status</div>
                                            <div style="font-size: 0.875rem; color: var(--gray-900);">In Progress - Tech Working</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; font-weight: 500; color: var(--gray-500); text-transform: uppercase; margin-bottom: 0.25rem;">Created Date</div>
                                            <div style="font-size: 0.875rem; color: var(--gray-900);">Aug 23, 2025 at 8:00 AM</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 0.75rem; font-weight: 500; color: var(--gray-500); text-transform: uppercase; margin-bottom: 0.25rem;">Due Date</div>
                                            <div style="font-size: 0.875rem; color: var(--gray-900);">Aug 23, 2025 at 12:00 PM</div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 1.5rem;">
                                        <div style="font-size: 0.75rem; font-weight: 500; color: var(--gray-500); text-transform: uppercase; margin-bottom: 0.25rem;">Description</div>
                                        <div style="font-size: 0.875rem; color: var(--gray-900); line-height: 1.5;">Front entrance door knob is broken and needs immediate replacement. Door cannot lock properly, creating a security issue.</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Location -->
                            <div class="table-container" style="margin-top: 1.5rem;">
                                <div class="table-header">
                                    <h3 class="table-title">Location</h3>
                                </div>
                                <div style="padding: 1.5rem;">
                                    <div style="font-size: 0.875rem; color: var(--gray-900);">
                                        <strong>Delilah LA</strong><br>
                                        123 Main Street<br>
                                        Los Angeles, CA 90001
                                    </div>
                                    <div id="map" style="width: 100%; height: 300px; border-radius: 6px; margin-top: 1rem; background: var(--gray-100);">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Parts & Equipment -->
                            <div class="table-container" style="margin-top: 1.5rem;">
                                <div class="table-header" style="display: flex; justify-content: space-between; align-items: center;">
                                    <h3 class="table-title">Parts & Equipment</h3>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;" onclick="openAddPartsModal()">+ Add Parts</button>
                                        <button class="btn btn-secondary" style="padding: 0.375rem 0.75rem; font-size: 0.75rem;" onclick="openAddEquipmentModal()">+ Add Equipment</button>
                                    </div>
                                </div>
                                <div style="padding: 1.5rem;">
                                    <!-- Parts Section -->
                                    <div style="margin-bottom: 2rem;">
                                        <h4 style="font-size: 0.875rem; font-weight: 600; color: var(--gray-700); margin-bottom: 1rem;">PARTS</h4>
                                        <div id="partsList" style="min-height: 60px;">
                                            <p style="text-align: center; color: var(--gray-400); font-size: 0.875rem;">No parts added</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Equipment Section -->
                                    <div>
                                        <h4 style="font-size: 0.875rem; font-weight: 600; color: var(--gray-700); margin-bottom: 1rem;">EQUIPMENT</h4>
                                        <div id="equipmentList" style="min-height: 60px;">
                                            <p style="text-align: center; color: var(--gray-400); font-size: 0.875rem;">No equipment added</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Internal Notes -->
                            <div class="table-container" style="margin-top: 1.5rem;">
                                <div class="table-header">
                                    <h3 class="table-title">Internal Notes</h3>
                                </div>
                                <div style="padding: 1.5rem;">
                                    <div style="padding: 1rem; background: var(--gray-50); border-radius: 6px; margin-bottom: 1rem;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                            <span style="font-weight: 500; font-size: 0.875rem;">System</span>
                                            <span style="font-size: 0.75rem; color: var(--gray-500);">Aug 23, 2025 9:08 AM</span>
                                        </div>
                                        <div style="font-size: 0.875rem; color: var(--gray-700);">Work order created and assigned to technician.</div>
                                    </div>
                                    <div style="padding: 1rem; background: var(--gray-50); border-radius: 6px; margin-bottom: 1rem;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                            <span style="font-weight: 500; font-size: 0.875rem;">John Smith</span>
                                            <span style="font-size: 0.75rem; color: var(--gray-500);">Aug 23, 2025 9:30 AM</span>
                                        </div>
                                        <div style="font-size: 0.875rem; color: var(--gray-700);">On my way to the location. Will need to pick up replacement door knob from supplier.</div>
                                    </div>
                                    <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                                        <textarea placeholder="Add a note..." style="flex: 1; padding: 0.625rem; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 0.875rem; min-height: 80px;"></textarea>
                                        <button class="btn btn-primary">Add Note</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div>
                            <!-- Timeline -->
                            <div class="table-container">
                                <div class="table-header">
                                    <h3 class="table-title">Timeline</h3>
                                </div>
                                <div style="padding: 1.5rem;">
                                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                                        <div style="display: flex; gap: 1rem;">
                                            <div style="width: 10px; height: 10px; border-radius: 50%; background: var(--success); margin-top: 0.25rem;"></div>
                                            <div>
                                                <div style="font-size: 0.875rem; font-weight: 500;">Work Order Created</div>
                                                <div style="font-size: 0.75rem; color: var(--gray-500);">Aug 23, 2025 8:00 AM</div>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 1rem;">
                                            <div style="width: 10px; height: 10px; border-radius: 50%; background: var(--success); margin-top: 0.25rem;"></div>
                                            <div>
                                                <div style="font-size: 0.875rem; font-weight: 500;">Tech En Route</div>
                                                <div style="font-size: 0.75rem; color: var(--gray-500);">Aug 23, 2025 9:00 AM</div>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 1rem;">
                                            <div style="width: 10px; height: 10px; border-radius: 50%; background: var(--gray-400); margin-top: 0.25rem;"></div>
                                            <div>
                                                <div style="font-size: 0.875rem; font-weight: 500;">Tech Checked In</div>
                                                <div style="font-size: 0.75rem; color: var(--gray-500);">Pending</div>
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 1rem;">
                                            <div style="width: 10px; height: 10px; border-radius: 50%; background: var(--gray-400); margin-top: 0.25rem;"></div>
                                            <div>
                                                <div style="font-size: 0.875rem; font-weight: 500;">Work Completed</div>
                                                <div style="font-size: 0.75rem; color: var(--gray-500);">Pending</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Client Information -->
                            <div class="table-container" style="margin-top: 1.5rem;">
                                <div class="table-header">
                                    <h3 class="table-title">Client Information</h3>
                                </div>
                                <div style="padding: 1.5rem;">
                                    <div style="margin-bottom: 1rem;">
                                        <div style="font-size: 0.75rem; font-weight: 500; color: var(--gray-500); text-transform: uppercase; margin-bottom: 0.25rem;">Company</div>
                                        <div style="font-size: 0.875rem;">The h.wood Group</div>
                                    </div>
                                    <div style="margin-bottom: 1rem;">
                                        <div style="font-size: 0.75rem; font-weight: 500; color: var(--gray-500); text-transform: uppercase; margin-bottom: 0.25rem;">Location</div>
                                        <div style="font-size: 0.875rem;">Delilah LA</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.75rem; font-weight: 500; color: var(--gray-500); text-transform: uppercase; margin-bottom: 0.25rem;">Contact</div>
                                        <div style="font-size: 0.875rem;">Jane Doe<br>(555) 123-4567</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getInboxContent() {
            return `
                <div>
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Inbox</h2>
                        <button class="btn btn-secondary" onclick="openInboxSettings()">Settings</button>
                    </div>
                    
                    <!-- Tabs -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--gray-200);">
                        <button class="inbox-tab" onclick="switchInboxTab('important')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid var(--primary); color: var(--gray-900); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Important
                        </button>
                        <button class="inbox-tab" onclick="switchInboxTab('notes')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Notes
                        </button>
                        <button class="inbox-tab" onclick="switchInboxTab('status')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Status Updates
                        </button>
                    </div>
                    
                    <!-- Filters Bar -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <input type="text" placeholder="Search by WO#" style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px; width: 200px; font-size: 0.875rem;">
                            <div style="display: flex; gap: 0.5rem;">
                                <button id="filter-all" class="btn btn-secondary" onclick="filterInboxMessages('all')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">All</button>
                                <button id="filter-unread" class="btn btn-primary" onclick="filterInboxMessages('unread')" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Unread</button>
                            </div>
                        </div>
                        <button onclick="markAllAsRead()" style="background: none; border: none; color: var(--primary); cursor: pointer; font-weight: 500; font-size: 0.875rem;">MARK ALL READ</button>
                    </div>
                    
                    <!-- Messages Container -->
                    <div id="inbox-messages" style="margin-top: 2rem;">
                        <div id="important-messages" style="display: block;">
                            <!-- Important Messages -->
                            <div class="inbox-message unread" onclick="openInboxMessage('1989975')" style="background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid var(--primary); cursor: pointer; transition: all 0.2s;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <span style="font-weight: 600; color: var(--gray-900);">WO #1989975</span>
                                            <span style="background: var(--danger); color: white; font-size: 0.625rem; padding: 0.125rem 0.375rem; border-radius: 4px;">URGENT</span>
                                            <span style="font-size: 0.75rem; color: var(--gray-500);">2 hours ago</span>
                                        </div>
                                        <p style="color: var(--gray-700); margin-bottom: 0.25rem;">Emergency work order assigned - Door knob broken at Delilah LA</p>
                                        <p style="color: var(--gray-500); font-size: 0.875rem;">Response required within 4 hours</p>
                                    </div>
                                    <button onclick="event.stopPropagation(); markAsRead(this)" style="background: none; border: none; color: var(--gray-400); cursor: pointer;">Mark Read</button>
                                </div>
                            </div>
                            
                            <div class="inbox-message unread" onclick="openInboxMessage('invoices')" style="background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid var(--warning); cursor: pointer; transition: all 0.2s;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <span style="font-weight: 600; color: var(--gray-900);">Invoice Reminder</span>
                                            <span style="font-size: 0.75rem; color: var(--gray-500);">1 day ago</span>
                                        </div>
                                        <p style="color: var(--gray-700); margin-bottom: 0.25rem;">3 completed work orders pending invoicing</p>
                                        <p style="color: var(--gray-500); font-size: 0.875rem;">WO #1989961, WO #1989960, WO #1989959</p>
                                    </div>
                                    <button onclick="event.stopPropagation(); markAsRead(this)" style="background: none; border: none; color: var(--gray-400); cursor: pointer;">Mark Read</button>
                                </div>
                            </div>
                            
                            <div class="inbox-message" onclick="openInboxMessage('rfp')" style="background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: all 0.2s;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <span style="font-weight: 600; color: var(--gray-900);">New RFP Available</span>
                                            <span style="font-size: 0.75rem; color: var(--gray-500);">3 days ago</span>
                                        </div>
                                        <p style="color: var(--gray-700); margin-bottom: 0.25rem;">HVAC Maintenance Contract - Multiple Locations</p>
                                        <p style="color: var(--gray-500); font-size: 0.875rem;">Deadline: Aug 30, 2025</p>
                                    </div>
                                    <button onclick="event.stopPropagation(); markAsRead(this)" style="background: none; border: none; color: var(--success); cursor: pointer;">Read</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="notes-messages" style="display: none;">
                            <!-- Notes Messages -->
                            <div class="inbox-message" onclick="openInboxMessage('1989974')" style="background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: all 0.2s;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <span style="font-weight: 600; color: var(--gray-900);">Note on WO #1989974</span>
                                            <span style="font-size: 0.75rem; color: var(--gray-500);">5 hours ago</span>
                                        </div>
                                        <p style="color: var(--gray-700); margin-bottom: 0.25rem;">Client mentioned they prefer morning appointments</p>
                                        <p style="color: var(--gray-500); font-size: 0.875rem;">From: Jane Doe - The h.wood Group</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="status-messages" style="display: none;">
                            <!-- Status Update Messages -->
                            <div class="inbox-message" onclick="openInboxMessage('1989973')" style="background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: all 0.2s;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <span style="font-weight: 600; color: var(--gray-900);">WO #1989973 Status Update</span>
                                            <span style="font-size: 0.75rem; color: var(--gray-500);">30 minutes ago</span>
                                        </div>
                                        <p style="color: var(--gray-700); margin-bottom: 0.25rem;">Tech checked in at location</p>
                                        <p style="color: var(--gray-500); font-size: 0.875rem;">John Smith arrived at 9:30 AM</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="inbox-message" style="background: white; border: 1px solid var(--gray-200); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <span style="font-weight: 600; color: var(--gray-900);">WO #1989972 Completed</span>
                                            <span style="font-size: 0.75rem; color: var(--gray-500);">2 hours ago</span>
                                        </div>
                                        <p style="color: var(--gray-700); margin-bottom: 0.25rem;">Work order completed successfully</p>
                                        <p style="color: var(--gray-500); font-size: 0.875rem;">Ready for invoicing</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Empty State (hidden by default) -->
                        <div id="empty-inbox" style="display: none; text-align: center; padding: 4rem 2rem;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">📭</div>
                            <p style="color: var(--gray-600); font-size: 1.125rem;">You don't have any important notifications.</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function switchInboxTab(tab) {
            // Update tab styles
            document.querySelectorAll('.inbox-tab').forEach(t => {
                t.style.borderBottom = '2px solid transparent';
                t.style.color = 'var(--gray-600)';
            });
            
            event.target.style.borderBottom = '2px solid var(--primary)';
            event.target.style.color = 'var(--gray-900)';
            
            // Show/hide content
            document.getElementById('important-messages').style.display = tab === 'important' ? 'block' : 'none';
            document.getElementById('notes-messages').style.display = tab === 'notes' ? 'block' : 'none';
            document.getElementById('status-messages').style.display = tab === 'status' ? 'block' : 'none';
            
            // Check if empty
            const activeSection = document.getElementById(tab === 'important' ? 'important-messages' : 
                                                         tab === 'notes' ? 'notes-messages' : 
                                                         'status-messages');
            const hasMessages = activeSection && activeSection.children.length > 0;
            document.getElementById('empty-inbox').style.display = hasMessages ? 'none' : 'block';
        }
        
        function openInboxSettings() {
            const modal = document.getElementById('inboxSettingsModal');
            if (modal) {
                modal.classList.add('active');
            }
        }
        
        function closeInboxSettings() {
            const modal = document.getElementById('inboxSettingsModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        function saveInboxSettings() {
            // Get all settings values
            const emailNotifications = document.getElementById('emailNotifications').checked;
            const smsNotifications = document.getElementById('smsNotifications').checked;
            const pushNotifications = document.getElementById('pushNotifications').checked;
            const frequency = document.getElementById('notificationFrequency').value;
            const quietStart = document.getElementById('quietHoursStart').value;
            const quietEnd = document.getElementById('quietHoursEnd').value;
            
            // Save settings (in real app, this would save to backend)
            console.log('Settings saved:', {
                emailNotifications,
                smsNotifications,
                pushNotifications,
                frequency,
                quietHours: `${quietStart} - ${quietEnd}`
            });
            
            alert('Settings saved successfully!');
            closeInboxSettings();
        }
        
        function markAllAsRead() {
            document.querySelectorAll('.inbox-message.unread').forEach(message => {
                message.classList.remove('unread');
                message.style.borderLeftColor = 'var(--gray-300)';
                const button = message.querySelector('button');
                if (button) button.style.color = 'var(--success)';
            });
            
            // Hide badge
            const badge = document.querySelector('.nav-item .badge');
            if (badge) {
                badge.style.display = 'none';
            }
        }
        
        function markAsRead(button) {
            const message = button.closest('.inbox-message');
            message.classList.remove('unread');
            message.style.borderLeftColor = 'var(--gray-300)';
            button.style.color = 'var(--success)';
            
            // Update badge count
            const badge = document.querySelector('.nav-item .badge');
            if (badge) {
                let count = parseInt(badge.textContent) - 1;
                if (count > 0) {
                    badge.textContent = count;
                } else {
                    badge.style.display = 'none';
                }
            }
        }
        
        function filterInboxMessages(filter) {
            const allMessages = document.querySelectorAll('.inbox-message');
            const allBtn = document.getElementById('filter-all');
            const unreadBtn = document.getElementById('filter-unread');
            
            if (filter === 'all') {
                // Show all messages
                allMessages.forEach(msg => {
                    msg.style.display = 'block';
                });
                // Update button styles
                allBtn.classList.remove('btn-secondary');
                allBtn.classList.add('btn-primary');
                unreadBtn.classList.remove('btn-primary');
                unreadBtn.classList.add('btn-secondary');
            } else if (filter === 'unread') {
                // Show only unread messages
                allMessages.forEach(msg => {
                    if (msg.classList.contains('unread')) {
                        msg.style.display = 'block';
                    } else {
                        msg.style.display = 'none';
                    }
                });
                // Update button styles
                unreadBtn.classList.remove('btn-secondary');
                unreadBtn.classList.add('btn-primary');
                allBtn.classList.remove('btn-primary');
                allBtn.classList.add('btn-secondary');
            }
        }
        
        function openInboxMessage(messageId) {
            if (messageId === '1989975' || messageId === '1989974' || messageId === '1989973') {
                // Navigate to the work order detail
                loadWorkOrderDetail(messageId);
            } else if (messageId === 'invoices') {
                // Navigate to invoices section
                loadSection('invoices');
            } else if (messageId === 'rfp') {
                // Show RFP details modal or navigate to RFP section
                alert('Opening RFP details...');
            }
        }
        
        function getLocationDetailContent(locationId) {
            // Sample data - in real app would fetch from database
            const locationData = {
                'hwood-main': {
                    name: 'The h.wood Group - Main',
                    businessType: 'Corporate',
                    parentCompany: '',
                    currency: 'USD',
                    address: '9040 W Sunset Blvd, West Hollywood, CA',
                    phone: '(310) 555-0199',
                    website: 'https://hwoodgroup.com',
                    subscribers: 'operations@hwoodgroup.com, facilities@hwoodgroup.com',
                    revenue: '$1.2M',
                    activeJobs: 2,
                    completedJobs: 156,
                    primaryContact: 'David Chang'
                },
                'delilah-la': {
                    name: 'Delilah LA',
                    businessType: 'Restaurant',
                    parentCompany: 'The h.wood Group',
                    currency: 'USD',
                    address: '7969 Santa Monica Blvd, West Hollywood, CA',
                    phone: '(323) 555-0147',
                    website: 'https://delilahla.com',
                    subscribers: 'sarah@delilahla.com, manager@delilahla.com',
                    revenue: '$245K',
                    activeJobs: 1,
                    completedJobs: 42,
                    primaryContact: 'Sarah Martinez'
                },
                'mcdonalds-sunset': {
                    name: 'McDonald\'s - Sunset Strip',
                    businessType: 'Quick Service',
                    parentCompany: '',
                    currency: 'USD',
                    address: '8966 Sunset Blvd, West Hollywood, CA',
                    phone: '(323) 555-0234',
                    website: 'https://mcdonalds.com',
                    subscribers: 'jennifer.kim@mcdonalds.com',
                    revenue: '$89K',
                    activeJobs: 1,
                    completedJobs: 28,
                    primaryContact: 'Jennifer Kim'
                }
            };

            const data = locationData[locationId] || locationData['hwood-main'];

            return `
                <div>
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--gray-200);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <button onclick="loadSection('locations')" style="background: none; border: none; color: var(--gray-600); cursor: pointer; font-size: 1.5rem;">←</button>
                            <div>
                                <h2 style="font-size: 1.875rem; font-weight: 700; margin-bottom: 0.25rem;">${data.name}</h2>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <span class="status-badge completed">${data.businessType}</span>
                                    ${data.parentCompany ? `<span style="color: var(--gray-600); font-size: 0.875rem;">Part of ${data.parentCompany}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn btn-secondary" onclick="editLocation('${locationId}')">Edit Location</button>
                            <button class="btn btn-primary" onclick="createWorkOrderForLocation('${locationId}')">+ New Work Order</button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="dashboard-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-value">${data.revenue}</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.activeJobs}</div>
                            <div class="stat-label">Active Jobs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.completedJobs}</div>
                            <div class="stat-label">Completed Jobs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.currency}</div>
                            <div class="stat-label">Currency</div>
                        </div>
                    </div>

                    <!-- Location Details -->
                    <div class="table-container" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3 class="table-title">Location Information</h3>
                            <button class="btn btn-secondary" onclick="editLocation('${locationId}')">Edit</button>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                <div>
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-500); margin-bottom: 0.25rem;">Address</label>
                                        <div style="font-size: 1rem; color: var(--gray-900);">${data.address}</div>
                                    </div>
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-500); margin-bottom: 0.25rem;">Phone</label>
                                        <div style="font-size: 1rem; color: var(--gray-900);">${data.phone}</div>
                                    </div>
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-500); margin-bottom: 0.25rem;">Website</label>
                                        <div style="font-size: 1rem;"><a href="${data.website}" target="_blank" style="color: var(--primary); text-decoration: none;">${data.website}</a></div>
                                    </div>
                                </div>
                                <div>
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-500); margin-bottom: 0.25rem;">Primary Contact</label>
                                        <div style="font-size: 1rem; color: var(--gray-900);">${data.primaryContact}</div>
                                    </div>
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-500); margin-bottom: 0.25rem;">Default Work Order Subscribers</label>
                                        <div style="font-size: 0.875rem; color: var(--gray-600);">${data.subscribers}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Associated Contacts -->
                    <div class="table-container" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3 class="table-title">Contacts</h3>
                            <button class="btn btn-secondary" onclick="addContactToLocation('${locationId}')">+ Add Contact</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Title</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Role</th>
                                    <th>Notifications</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${locationId === 'delilah-la' ? `
                                <tr>
                                    <td><strong>Sarah Martinez</strong></td>
                                    <td>General Manager</td>
                                    <td>sarah@delilahla.com</td>
                                    <td>(323) 555-0147</td>
                                    <td><span class="status-badge completed">Primary</span></td>
                                    <td>Enabled</td>
                                    <td>
                                        <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editContact('sarah-martinez')">Edit</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Alex Thompson</strong></td>
                                    <td>Assistant Manager</td>
                                    <td>alex@delilahla.com</td>
                                    <td>(323) 555-0148</td>
                                    <td><span class="status-badge pending">Secondary</span></td>
                                    <td>Enabled</td>
                                    <td>
                                        <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editContact('alex-thompson')">Edit</button>
                                    </td>
                                </tr>
                                ` : locationId === 'mcdonalds-sunset' ? `
                                <tr>
                                    <td><strong>Jennifer Kim</strong></td>
                                    <td>Store Manager</td>
                                    <td>jennifer.kim@mcdonalds.com</td>
                                    <td>(323) 555-0234</td>
                                    <td><span class="status-badge completed">Primary</span></td>
                                    <td>Enabled</td>
                                    <td>
                                        <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editContact('jennifer-kim')">Edit</button>
                                    </td>
                                </tr>
                                ` : `
                                <tr>
                                    <td><strong>David Chang</strong></td>
                                    <td>Operations Director</td>
                                    <td>david@hwoodgroup.com</td>
                                    <td>(310) 555-0199</td>
                                    <td><span class="status-badge completed">Primary</span></td>
                                    <td>Enabled</td>
                                    <td>
                                        <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editContact('david-chang')">Edit</button>
                                    </td>
                                </tr>
                                `}
                            </tbody>
                        </table>
                    </div>

                    <!-- Recent Work Orders -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Recent Work Orders</h3>
                            <button class="btn btn-secondary" onclick="viewAllWorkOrders('${locationId}')">View All</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Order #</th>
                                    <th>Service</th>
                                    <th>Status</th>
                                    <th>Scheduled</th>
                                    <th>Technician</th>
                                    <th>Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>#12345</strong></td>
                                    <td>HVAC Maintenance</td>
                                    <td><span class="status-badge pending">In Progress</span></td>
                                    <td>Today 2:00 PM</td>
                                    <td>John Smith</td>
                                    <td>$450</td>
                                    <td>
                                        <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;">View</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>#12344</strong></td>
                                    <td>Plumbing Repair</td>
                                    <td><span class="status-badge completed">Completed</span></td>
                                    <td>Feb 20, 2024</td>
                                    <td>Mike Wilson</td>
                                    <td>$280</td>
                                    <td>
                                        <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;">View</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>#12343</strong></td>
                                    <td>Electrical Inspection</td>
                                    <td><span class="status-badge completed">Completed</span></td>
                                    <td>Feb 15, 2024</td>
                                    <td>Sarah Johnson</td>
                                    <td>$350</td>
                                    <td>
                                        <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;">View</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function createWorkOrderForLocation(locationId) {
            showToast(`Creating new work order for location...`, 'info');
            loadSection('work-orders');
        }

        function addContactToLocation(locationId) {
            addContact();
        }

        function viewAllWorkOrders(locationId) {
            showToast(`Loading all work orders for location...`, 'info');
            loadSection('work-orders');
        }

        function getLocationsContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Locations & Contacts</h2>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn btn-secondary" onclick="addContact()">+ Add Contact</button>
                            <button class="btn btn-primary" onclick="addLocation()">+ Add Location</button>
                        </div>
                    </div>
                    
                    <!-- Location Management Tabs -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--gray-200);">
                        <button class="location-tab active" onclick="switchLocationTab('locations')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid var(--primary); color: var(--gray-900); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Locations
                        </button>
                        <button class="location-tab" onclick="switchLocationTab('contacts')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Contacts
                        </button>
                        <button class="location-tab" onclick="switchLocationTab('hierarchy')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Hierarchy View
                        </button>
                    </div>
                    
                    <!-- Locations Tab Content -->
                    <div id="locations-tab-content">
                        <div class="dashboard-grid" style="margin-bottom: 1.5rem;">
                            <div class="stat-card">
                                <div class="stat-value">24</div>
                                <div class="stat-label">Total Locations</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">8</div>
                                <div class="stat-label">Multi-Unit Clients</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">67</div>
                                <div class="stat-label">Active Contacts</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">$245K</div>
                                <div class="stat-label">Monthly Revenue</div>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Location Directory</h3>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <select onchange="filterLocationsByClient(this.value)" style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <option value="">All Clients</option>
                                        <option value="hwood">The h.wood Group</option>
                                        <option value="olive-garden">Olive Garden</option>
                                        <option value="mcdonalds">McDonald's</option>
                                        <option value="burger-king">Burger King</option>
                                    </select>
                                    <input type="search" placeholder="Search locations..." 
                                        style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <button class="btn btn-secondary" onclick="exportLocations()">Export</button>
                                </div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Location Name</th>
                                        <th>Client/Parent</th>
                                        <th>Type</th>
                                        <th>Address</th>
                                        <th>Primary Contact</th>
                                        <th>Phone</th>
                                        <th>Active Jobs</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <span style="color: var(--primary); font-size: 0.75rem;">●</span>
                                                <a href="#" onclick="viewLocation('hwood-main'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">The h.wood Group - Main</a>
                                            </div>
                                        </td>
                                        <td><span style="font-size: 0.875rem; color: var(--gray-600);">Parent Company</span></td>
                                        <td><span class="status-badge pending">Corporate</span></td>
                                        <td>9040 W Sunset Blvd, West Hollywood, CA</td>
                                        <td>David Chang</td>
                                        <td>(310) 555-0199</td>
                                        <td>2</td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="viewLocation('hwood-main')">View</button>
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editLocation('hwood-main')">Edit</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <span style="color: var(--gray-400); font-size: 0.75rem; margin-left: 1rem;">└</span>
                                                <a href="#" onclick="viewLocation('delilah-la'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">Delilah LA</a>
                                            </div>
                                        </td>
                                        <td>The h.wood Group</td>
                                        <td><span class="status-badge completed">Restaurant</span></td>
                                        <td>7969 Santa Monica Blvd, West Hollywood, CA</td>
                                        <td>Sarah Martinez</td>
                                        <td>(323) 555-0147</td>
                                        <td>1</td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="viewLocation('delilah-la')">View</button>
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editLocation('delilah-la')">Edit</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <span style="color: var(--gray-400); font-size: 0.75rem; margin-left: 1rem;">└</span>
                                                <a href="#" onclick="viewLocation('bootsy-bellows'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">Bootsy Bellows</a>
                                            </div>
                                        </td>
                                        <td>The h.wood Group</td>
                                        <td><span class="status-badge completed">Nightclub</span></td>
                                        <td>9081 Santa Monica Blvd, West Hollywood, CA</td>
                                        <td>Marcus Rodriguez</td>
                                        <td>(310) 555-0892</td>
                                        <td>3</td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="viewLocation('bootsy-bellows')">View</button>
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editLocation('bootsy-bellows')">Edit</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <span style="color: var(--primary); font-size: 0.75rem;">●</span>
                                                <a href="#" onclick="viewLocation('mcdonalds-sunset'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">McDonald's - Sunset Strip</a>
                                            </div>
                                        </td>
                                        <td><span style="font-size: 0.875rem; color: var(--gray-600);">Standalone</span></td>
                                        <td><span class="status-badge completed">Quick Service</span></td>
                                        <td>8966 Sunset Blvd, West Hollywood, CA</td>
                                        <td>Jennifer Kim</td>
                                        <td>(323) 555-0234</td>
                                        <td>1</td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="viewLocation('mcdonalds-sunset')">View</button>
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editLocation('mcdonalds-sunset')">Edit</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                <span style="color: var(--primary); font-size: 0.75rem;">●</span>
                                                <a href="#" onclick="viewLocation('burger-king-melrose'); return false;" style="color: var(--primary); text-decoration: none; font-weight: 700;">Burger King - Melrose</a>
                                            </div>
                                        </td>
                                        <td><span style="font-size: 0.875rem; color: var(--gray-600);">Standalone</span></td>
                                        <td><span class="status-badge completed">Quick Service</span></td>
                                        <td>7511 Melrose Ave, Los Angeles, CA</td>
                                        <td>Robert Johnson</td>
                                        <td>(323) 555-0567</td>
                                        <td>2</td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="viewLocation('burger-king-melrose')">View</button>
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editLocation('burger-king-melrose')">Edit</button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Contacts Tab Content (Hidden by default) -->
                    <div id="contacts-tab-content" style="display: none;">
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Contact Directory</h3>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <select onchange="filterContactsByLocation(this.value)" style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <option value="">All Locations</option>
                                        <option value="hwood-main">The h.wood Group</option>
                                        <option value="delilah-la">Delilah LA</option>
                                        <option value="bootsy-bellows">Bootsy Bellows</option>
                                    </select>
                                    <input type="search" placeholder="Search contacts..." 
                                        style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <button class="btn btn-secondary" onclick="exportContacts()">Export</button>
                                </div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Title</th>
                                        <th>Location</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Role</th>
                                        <th>Work Order Notifications</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>David Chang</strong></td>
                                        <td>Operations Director</td>
                                        <td>The h.wood Group - Main</td>
                                        <td>david@hwoodgroup.com</td>
                                        <td>(310) 555-0199</td>
                                        <td><span class="status-badge completed">Primary</span></td>
                                        <td>Enabled</td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editContact('david-chang')">Edit</button>
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="assignContact('david-chang')">Assign</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Sarah Martinez</strong></td>
                                        <td>General Manager</td>
                                        <td>Delilah LA</td>
                                        <td>sarah@delilahla.com</td>
                                        <td>(323) 555-0147</td>
                                        <td><span class="status-badge completed">Primary</span></td>
                                        <td>Enabled</td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editContact('sarah-martinez')">Edit</button>
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="assignContact('sarah-martinez')">Assign</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Marcus Rodriguez</strong></td>
                                        <td>Venue Manager</td>
                                        <td>Bootsy Bellows</td>
                                        <td>marcus@bootsybellows.com</td>
                                        <td>(310) 555-0892</td>
                                        <td><span class="status-badge completed">Primary</span></td>
                                        <td>Enabled</td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editContact('marcus-rodriguez')">Edit</button>
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="assignContact('marcus-rodriguez')">Assign</button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Jennifer Kim</strong></td>
                                        <td>Store Manager</td>
                                        <td>McDonald's - Sunset Strip</td>
                                        <td>jennifer.kim@mcdonalds.com</td>
                                        <td>(323) 555-0234</td>
                                        <td><span class="status-badge completed">Primary</span></td>
                                        <td>Enabled</td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editContact('jennifer-kim')">Edit</button>
                                                <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="assignContact('jennifer-kim')">Assign</button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Hierarchy Tab Content (Hidden by default) -->
                    <div id="hierarchy-tab-content" style="display: none;">
                        <div class="table-container">
                            <div class="table-header">
                                <h3 class="table-title">Multi-Unit Hierarchy View</h3>
                            </div>
                            <div style="padding: 1.5rem;">
                                <!-- The h.wood Group Hierarchy -->
                                <div style="margin-bottom: 2rem; border-left: 3px solid var(--primary); padding-left: 1rem;">
                                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                                        <h4 style="font-size: 1.125rem; font-weight: 600; color: var(--primary);">The h.wood Group</h4>
                                        <span style="font-size: 0.875rem; color: var(--gray-600);">Corporate Parent • 3 Locations</span>
                                    </div>
                                    <div style="margin-left: 1rem;">
                                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--gray-50); border-radius: 6px;">
                                            
                                            <span style="flex: 1; font-weight: 500;">Delilah LA</span>
                                            <span style="color: var(--gray-600); font-size: 0.875rem;">Restaurant • Sarah Martinez</span>
                                            <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; margin-left: 1rem;" onclick="viewLocation('delilah-la')">View</button>
                                        </div>
                                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--gray-50); border-radius: 6px;">
                                            
                                            <span style="flex: 1; font-weight: 500;">Bootsy Bellows</span>
                                            <span style="color: var(--gray-600); font-size: 0.875rem;">Nightclub • Marcus Rodriguez</span>
                                            <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; margin-left: 1rem;" onclick="viewLocation('bootsy-bellows')">View</button>
                                        </div>
                                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: var(--gray-50); border-radius: 6px;">
                                            
                                            <span style="flex: 1; font-weight: 500;">Nice Guy</span>
                                            <span style="color: var(--gray-600); font-size: 0.875rem;">Restaurant • Alex Thompson</span>
                                            <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem; margin-left: 1rem;" onclick="viewLocation('nice-guy')">View</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Standalone Locations -->
                                <div style="margin-bottom: 2rem;">
                                    <h4 style="font-size: 1.125rem; font-weight: 600; color: var(--gray-700); margin-bottom: 1rem;">Standalone Locations</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                                        <div style="border: 1px solid var(--gray-200); border-radius: 8px; padding: 1rem;">
                                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                                                <h5 style="font-weight: 600; color: var(--gray-900);">McDonald's - Sunset Strip</h5>
                                                <span class="status-badge completed">Quick Service</span>
                                            </div>
                                            <p style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Jennifer Kim • (323) 555-0234</p>
                                            <p style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 1rem;">8966 Sunset Blvd, West Hollywood, CA</p>
                                            <button class="btn btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="viewLocation('mcdonalds-sunset')">View Location</button>
                                        </div>
                                        
                                        <div style="border: 1px solid var(--gray-200); border-radius: 8px; padding: 1rem;">
                                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 0.5rem;">
                                                <h5 style="font-weight: 600; color: var(--gray-900);">Burger King - Melrose</h5>
                                                <span class="status-badge completed">Quick Service</span>
                                            </div>
                                            <p style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 0.5rem;">Robert Johnson • (323) 555-0567</p>
                                            <p style="color: var(--gray-600); font-size: 0.875rem; margin-bottom: 1rem;">7511 Melrose Ave, Los Angeles, CA</p>
                                            <button class="btn btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="viewLocation('burger-king-melrose')">View Location</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getSubcontractorsContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Subcontractors</h2>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn btn-primary" onclick="addSubcontractor()">+ Add Subcontractor</button>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="dashboard-grid" style="margin-bottom: 1.5rem;">
                        <div class="stat-card">
                            <div class="stat-value">18</div>
                            <div class="stat-label">Active Subcontractors</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">42</div>
                            <div class="stat-label">Total Contacts</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">$324K</div>
                            <div class="stat-label">Monthly Volume</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">5.5%</div>
                            <div class="stat-label">Avg Platform Fee</div>
                        </div>
                    </div>
                    
                    <!-- Subcontractors Tree View -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Subcontractor Directory</h3>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <input type="search" placeholder="Search subcontractors..." 
                                    style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                <button class="btn btn-secondary" onclick="exportSubcontractors()">Export</button>
                            </div>
                        </div>
                        <div style="padding: 1.5rem;">
                            <!-- ABC Maintenance Services -->
                            <div style="margin-bottom: 2rem; border-left: 3px solid var(--primary); padding-left: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <div style="display: flex; align-items: center; gap: 1rem; cursor: pointer;" onclick="toggleSubcontractorContacts('abc-maintenance')">
                                        <span id="abc-maintenance-arrow" style="font-size: 0.875rem; transition: transform 0.2s;">▶</span>
                                        <div>
                                            <h4 style="font-size: 1.125rem; font-weight: 600; color: var(--primary); margin: 0;">ABC Maintenance Services</h4>
                                            <div style="display: flex; gap: 1rem; margin-top: 0.25rem;">
                                                <span style="font-size: 0.875rem; color: var(--gray-600);">HVAC & Electrical</span>
                                                <span class="status-badge completed">Stripe Connected</span>
                                                <span style="font-size: 0.875rem; color: var(--gray-600);">Platform Fee: 5%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="viewSubcontractor('abc-maintenance')">View</button>
                                        <button class="btn btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="editSubcontractor('abc-maintenance')">Edit</button>
                                        <button class="btn btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="addSubcontractorContact('abc-maintenance')">+ Add Contact</button>
                                    </div>
                                </div>
                                <div id="abc-maintenance-contacts" style="display: none; margin-left: 2rem;">
                                    <div style="display: flex; align-items: center; padding: 0.5rem; background: var(--gray-50); border-radius: 6px; margin-bottom: 0.5rem;">
                                        
                                        <div style="flex: 1;">
                                            <strong>John Smith</strong> - Operations Manager
                                            <div style="font-size: 0.875rem; color: var(--gray-600);">john@abcmaintenance.com • (555) 123-4567</div>
                                        </div>
                                        <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editSubcontractorContact('john-smith')">Edit</button>
                                    </div>
                                    <div style="display: flex; align-items: center; padding: 0.5rem; background: var(--gray-50); border-radius: 6px; margin-bottom: 0.5rem;">
                                        
                                        <div style="flex: 1;">
                                            <strong>Sarah Johnson</strong> - Field Coordinator
                                            <div style="font-size: 0.875rem; color: var(--gray-600);">sarah@abcmaintenance.com • (555) 123-4568</div>
                                        </div>
                                        <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editSubcontractorContact('sarah-johnson')">Edit</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Quick Fix Solutions -->
                            <div style="margin-bottom: 2rem; border-left: 3px solid var(--primary); padding-left: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <div style="display: flex; align-items: center; gap: 1rem; cursor: pointer;" onclick="toggleSubcontractorContacts('quick-fix')">
                                        <span id="quick-fix-arrow" style="font-size: 0.875rem; transition: transform 0.2s;">▶</span>
                                        <div>
                                            <h4 style="font-size: 1.125rem; font-weight: 600; color: var(--primary); margin: 0;">Quick Fix Solutions</h4>
                                            <div style="display: flex; gap: 1rem; margin-top: 0.25rem;">
                                                <span style="font-size: 0.875rem; color: var(--gray-600);">Plumbing & General</span>
                                                <span class="status-badge pending">Stripe Pending</span>
                                                <span style="font-size: 0.875rem; color: var(--gray-600);">Platform Fee: 6%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="viewSubcontractor('quick-fix')">View</button>
                                        <button class="btn btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="editSubcontractor('quick-fix')">Edit</button>
                                        <button class="btn btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="addSubcontractorContact('quick-fix')">+ Add Contact</button>
                                        <button class="btn btn-primary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="resendStripeInvite('quick-fix')">Resend Invite</button>
                                    </div>
                                </div>
                                <div id="quick-fix-contacts" style="display: none; margin-left: 2rem;">
                                    <div style="display: flex; align-items: center; padding: 0.5rem; background: var(--gray-50); border-radius: 6px; margin-bottom: 0.5rem;">
                                        
                                        <div style="flex: 1;">
                                            <strong>Mike Wilson</strong> - Owner
                                            <div style="font-size: 0.875rem; color: var(--gray-600);">mike@quickfixsolutions.com • (555) 234-5678</div>
                                        </div>
                                        <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editSubcontractorContact('mike-wilson')">Edit</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pro Electric Co -->
                            <div style="margin-bottom: 2rem; border-left: 3px solid var(--primary); padding-left: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <div style="display: flex; align-items: center; gap: 1rem; cursor: pointer;" onclick="toggleSubcontractorContacts('pro-electric')">
                                        <span id="pro-electric-arrow" style="font-size: 0.875rem; transition: transform 0.2s;">▶</span>
                                        <div>
                                            <h4 style="font-size: 1.125rem; font-weight: 600; color: var(--primary); margin: 0;">Pro Electric Co</h4>
                                            <div style="display: flex; gap: 1rem; margin-top: 0.25rem;">
                                                <span style="font-size: 0.875rem; color: var(--gray-600);">Electrical Specialist</span>
                                                <span class="status-badge completed">Stripe Connected</span>
                                                <span style="font-size: 0.875rem; color: var(--gray-600);">Platform Fee: 5.5%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="viewSubcontractor('pro-electric')">View</button>
                                        <button class="btn btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="editSubcontractor('pro-electric')">Edit</button>
                                        <button class="btn btn-secondary" style="padding: 0.3rem 0.6rem; font-size: 0.75rem;" onclick="addSubcontractorContact('pro-electric')">+ Add Contact</button>
                                    </div>
                                </div>
                                <div id="pro-electric-contacts" style="display: none; margin-left: 2rem;">
                                    <div style="display: flex; align-items: center; padding: 0.5rem; background: var(--gray-50); border-radius: 6px; margin-bottom: 0.5rem;">
                                        
                                        <div style="flex: 1;">
                                            <strong>Robert Martinez</strong> - Lead Electrician
                                            <div style="font-size: 0.875rem; color: var(--gray-600);">robert@proelectric.com • (555) 345-6789</div>
                                        </div>
                                        <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editSubcontractorContact('robert-martinez')">Edit</button>
                                    </div>
                                    <div style="display: flex; align-items: center; padding: 0.5rem; background: var(--gray-50); border-radius: 6px; margin-bottom: 0.5rem;">
                                        
                                        <div style="flex: 1;">
                                            <strong>Lisa Chen</strong> - Project Manager
                                            <div style="font-size: 0.875rem; color: var(--gray-600);">lisa@proelectric.com • (555) 345-6790</div>
                                        </div>
                                        <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editSubcontractorContact('lisa-chen')">Edit</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Subcontractor Management Functions
        function toggleSubcontractorContacts(subcontractorId) {
            const contactsDiv = document.getElementById(`${subcontractorId}-contacts`);
            const arrow = document.getElementById(`${subcontractorId}-arrow`);
            
            if (contactsDiv) {
                if (contactsDiv.style.display === 'none') {
                    contactsDiv.style.display = 'block';
                    arrow.style.transform = 'rotate(90deg)';
                } else {
                    contactsDiv.style.display = 'none';
                    arrow.style.transform = 'rotate(0deg)';
                }
            }
        }
        window.toggleSubcontractorContacts = toggleSubcontractorContacts;

        function addSubcontractor() {
            showAddSubcontractorModal();
        }
        window.addSubcontractor = addSubcontractor;

        function showAddSubcontractorModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3>Add New Subcontractor</h3>
                        <button class="close-btn" onclick="closeSubcontractorModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="subcontractor-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div style="grid-column: 1 / -1;">
                                <h4 style="font-size: 1rem; font-weight: 600; color: var(--gray-700); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--gray-200);">Company Information</h4>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Company Name <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="text" id="subcontractorName" required 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Service Type <span style="color: var(--danger);">*</span>
                                </label>
                                <select id="serviceType" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="">Select service type...</option>
                                    <option value="HVAC">HVAC</option>
                                    <option value="Electrical">Electrical</option>
                                    <option value="Plumbing">Plumbing</option>
                                    <option value="General Maintenance">General Maintenance</option>
                                    <option value="Painting">Painting</option>
                                    <option value="Carpentry">Carpentry</option>
                                    <option value="Landscaping">Landscaping</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Business Email <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="email" id="businessEmail" required 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Phone Number
                                </label>
                                <input type="tel" id="businessPhone" 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Business Address
                                </label>
                                <textarea id="businessAddress" rows="2" 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; resize: vertical;"></textarea>
                            </div>
                            
                            <div style="grid-column: 1 / -1;">
                                <h4 style="font-size: 1rem; font-weight: 600; color: var(--gray-700); margin-top: 1rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--gray-200);">Stripe Connect & Platform Fee</h4>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Platform Fee (%) <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="number" id="platformFee" required min="0" max="100" step="0.5" value="5.0"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                <p style="font-size: 0.75rem; color: var(--gray-600); margin-top: 0.25rem;">Standard platform fee is 5-6%</p>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Tax ID / EIN
                                </label>
                                <input type="text" id="taxId" 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 500; color: var(--gray-700);">
                                    <input type="checkbox" id="sendStripeInvite" checked>
                                    Send Stripe Connect invitation email to business email
                                </label>
                                <p style="font-size: 0.75rem; color: var(--gray-600); margin-top: 0.5rem; margin-left: 1.5rem;">
                                    The subcontractor will receive an email invitation to connect their Stripe account for payment processing
                                </p>
                            </div>
                            
                            <div style="grid-column: 1 / -1;">
                                <h4 style="font-size: 1rem; font-weight: 600; color: var(--gray-700); margin-top: 1rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--gray-200);">Primary Contact (Optional)</h4>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Contact Name
                                </label>
                                <input type="text" id="contactName" 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Contact Title
                                </label>
                                <input type="text" id="contactTitle" placeholder="e.g., Operations Manager"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Contact Email
                                </label>
                                <input type="email" id="contactEmail" 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Contact Phone
                                </label>
                                <input type="tel" id="contactPhone" 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeSubcontractorModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveSubcontractor()">Save & Send Stripe Invite</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeSubcontractorModal() {
            const modal = document.querySelector('.modal.active');
            if (modal) {
                modal.remove();
            }
        }
        window.closeSubcontractorModal = closeSubcontractorModal;

        async function saveSubcontractor() {
            const name = document.getElementById('subcontractorName')?.value;
            const serviceType = document.getElementById('serviceType')?.value;
            const email = document.getElementById('businessEmail')?.value;
            const platformFee = document.getElementById('platformFee')?.value;
            const sendInvite = document.getElementById('sendStripeInvite')?.checked;
            
            if (!name || !serviceType || !email || !platformFee) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            // Send Stripe Connect invitation if checked
            if (sendInvite) {
                try {
                    const response = await fetch('/api/vendors/invite', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: email,
                            businessName: name,
                            platformFee: parseFloat(platformFee),
                            serviceType: serviceType
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showToast(`Subcontractor "${name}" added and Stripe invitation sent to ${email}`, 'success');
                    } else {
                        showToast(`Subcontractor added, but failed to send Stripe invitation: ${data.error}`, 'warning');
                    }
                } catch (error) {
                    console.error('Error sending Stripe invitation:', error);
                    showToast(`Subcontractor added, but failed to send Stripe invitation`, 'warning');
                }
            } else {
                showToast(`Subcontractor "${name}" added successfully`, 'success');
            }
            
            closeSubcontractorModal();
            
            // Refresh the page to show new subcontractor
            loadSection('subcontractors');
        }
        window.saveSubcontractor = saveSubcontractor;

        function viewSubcontractor(subcontractorId) {
            loadSection('subcontractor-detail', subcontractorId);
        }
        window.viewSubcontractor = viewSubcontractor;

        function editSubcontractor(subcontractorId) {
            showEditSubcontractorModal(subcontractorId);
        }
        window.editSubcontractor = editSubcontractor;
        
        function showEditSubcontractorModal(subcontractorId) {
            // Get mock data for the subcontractor
            const subcontractorData = {
                'abc-maintenance': {
                    name: 'ABC Maintenance Services',
                    serviceType: 'HVAC',
                    email: 'contact@abcmaintenance.com',
                    phone: '(555) 123-4567',
                    address: '123 Industrial Way, Los Angeles, CA 90001',
                    platformFee: '5.0',
                    taxId: '12-3456789',
                    stripeConnected: true
                },
                'xyz-electric': {
                    name: 'XYZ Electric Co.',
                    serviceType: 'Electrical',
                    email: 'info@xyzelectric.com',
                    phone: '(555) 987-6543',
                    address: '456 Power St, Burbank, CA 91502',
                    platformFee: '5.5',
                    taxId: '98-7654321',
                    stripeConnected: true
                },
                'quick-plumbing': {
                    name: 'Quick Plumbing Solutions',
                    serviceType: 'Plumbing',
                    email: 'service@quickplumbing.com',
                    phone: '(555) 555-0123',
                    address: '789 Water Way, Pasadena, CA 91101',
                    platformFee: '6.0',
                    taxId: '45-6789012',
                    stripeConnected: false
                }
            };
            
            const data = subcontractorData[subcontractorId] || {};
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3>Edit Subcontractor</h3>
                        <button class="close-btn" onclick="closeEditSubcontractorModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="edit-subcontractor-form" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div style="grid-column: 1 / -1;">
                                <h4 style="font-size: 1rem; font-weight: 600; color: var(--gray-700); margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--gray-200);">Company Information</h4>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Company Name <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="text" id="editSubcontractorName" required value="${data.name || ''}"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Service Type <span style="color: var(--danger);">*</span>
                                </label>
                                <select id="editServiceType" required style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="">Select service type...</option>
                                    <option value="HVAC" ${data.serviceType === 'HVAC' ? 'selected' : ''}>HVAC</option>
                                    <option value="Electrical" ${data.serviceType === 'Electrical' ? 'selected' : ''}>Electrical</option>
                                    <option value="Plumbing" ${data.serviceType === 'Plumbing' ? 'selected' : ''}>Plumbing</option>
                                    <option value="General Maintenance" ${data.serviceType === 'General Maintenance' ? 'selected' : ''}>General Maintenance</option>
                                    <option value="Painting" ${data.serviceType === 'Painting' ? 'selected' : ''}>Painting</option>
                                    <option value="Carpentry" ${data.serviceType === 'Carpentry' ? 'selected' : ''}>Carpentry</option>
                                    <option value="Landscaping" ${data.serviceType === 'Landscaping' ? 'selected' : ''}>Landscaping</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Business Email <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="email" id="editBusinessEmail" required value="${data.email || ''}"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Phone Number
                                </label>
                                <input type="tel" id="editBusinessPhone" value="${data.phone || ''}"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Business Address
                                </label>
                                <textarea id="editBusinessAddress" rows="2" 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; resize: vertical;">${data.address || ''}</textarea>
                            </div>
                            
                            <div style="grid-column: 1 / -1;">
                                <h4 style="font-size: 1rem; font-weight: 600; color: var(--gray-700); margin-top: 1rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--gray-200);">Stripe Connect & Platform Fee</h4>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Platform Fee (%) <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="number" id="editPlatformFee" required min="0" max="100" step="0.5" value="${data.platformFee || '5.0'}"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                <p style="font-size: 0.75rem; color: var(--gray-600); margin-top: 0.25rem;">Standard platform fee is 5-6%</p>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Tax ID / EIN
                                </label>
                                <input type="text" id="editTaxId" value="${data.taxId || ''}"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            ${data.stripeConnected ? `
                            <div style="grid-column: 1 / -1;">
                                <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background-color: var(--success-light); border-radius: 6px;">
                                    <span style="color: var(--success);">Yes</span>
                                    <span style="color: var(--success); font-weight: 500;">Stripe Account Connected</span>
                                    <button type="button" class="btn btn-secondary" style="margin-left: auto;" onclick="resendStripeInvite('${subcontractorId}')">Resend Invitation</button>
                                </div>
                            </div>
                            ` : `
                            <div style="grid-column: 1 / -1;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 500; color: var(--gray-700);">
                                    <input type="checkbox" id="editSendStripeInvite">
                                    Send Stripe Connect invitation email
                                </label>
                            </div>
                            `}
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeEditSubcontractorModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="updateSubcontractor('${subcontractorId}')">Save Changes</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeEditSubcontractorModal() {
            const modal = document.querySelector('.modal.active');
            if (modal) {
                modal.remove();
            }
        }
        window.closeEditSubcontractorModal = closeEditSubcontractorModal;
        
        async function updateSubcontractor(subcontractorId) {
            const name = document.getElementById('editSubcontractorName')?.value;
            const serviceType = document.getElementById('editServiceType')?.value;
            const email = document.getElementById('editBusinessEmail')?.value;
            const platformFee = document.getElementById('editPlatformFee')?.value;
            
            if (!name || !serviceType || !email || !platformFee) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }
            
            showToast(`Subcontractor "${name}" updated successfully`, 'success');
            closeEditSubcontractorModal();
            loadSection('subcontractors');
        }
        window.updateSubcontractor = updateSubcontractor;

        function addSubcontractorContact(subcontractorId) {
            showAddSubcontractorContactModal(subcontractorId);
        }
        window.addSubcontractorContact = addSubcontractorContact;

        function showAddSubcontractorContactModal(subcontractorId) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>Add Contact</h3>
                        <button class="close-btn" onclick="closeSubcontractorContactModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="subcontractor-contact-form" style="display: grid; gap: 1rem;">
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Name <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="text" id="subContactName" required placeholder="Enter name of the person"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Title
                                </label>
                                <input type="text" id="subContactTitle" placeholder="Enter title of the person. Ex. Manager"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Phone Number
                                </label>
                                <input type="tel" id="subContactPhone" placeholder="Enter phone numbers"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Email
                                </label>
                                <input type="email" id="subContactEmail" placeholder="Enter emails"
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Notes
                                </label>
                                <textarea id="subContactNotes" rows="4" placeholder="Additional notes..."
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; resize: vertical;"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeSubcontractorContactModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveSubcontractorContact('${subcontractorId}')">Save Contact</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeSubcontractorContactModal() {
            const modal = document.querySelector('.modal.active');
            if (modal) {
                modal.remove();
            }
        }
        window.closeSubcontractorContactModal = closeSubcontractorContactModal;

        function saveSubcontractorContact(subcontractorId) {
            const name = document.getElementById('subContactName')?.value;
            
            if (!name) {
                showToast('Please enter the contact name', 'warning');
                return;
            }
            
            showToast(`Contact "${name}" added successfully`, 'success');
            closeSubcontractorContactModal();
            
            // Expand the contacts section to show new contact
            const contactsDiv = document.getElementById(`${subcontractorId}-contacts`);
            const arrow = document.getElementById(`${subcontractorId}-arrow`);
            if (contactsDiv) {
                contactsDiv.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            }
        }
        window.saveSubcontractorContact = saveSubcontractorContact;

        function editSubcontractorContact(contactId) {
            showToast(`Opening editor for contact...`, 'info');
        }
        window.editSubcontractorContact = editSubcontractorContact;

        function resendStripeInvite(subcontractorId) {
            showToast(`Resending Stripe Connect invitation...`, 'info');
        }
        window.resendStripeInvite = resendStripeInvite;

        function exportSubcontractors() {
            showToast('Exporting subcontractors to CSV...', 'info');
        }
        window.exportSubcontractors = exportSubcontractors;

        function getSubcontractorDetailContent(subcontractorId) {
            // Sample data - in real app would fetch from database
            const subcontractorData = {
                'abc-maintenance': {
                    name: 'ABC Maintenance Services',
                    serviceType: 'HVAC & Electrical',
                    email: 'info@abcmaintenance.com',
                    phone: '(555) 123-4567',
                    address: '123 Main St, Los Angeles, CA 90001',
                    platformFee: '5%',
                    stripeStatus: 'Connected',
                    revenue: '$145K',
                    activeJobs: 3,
                    completedJobs: 87
                }
            };

            const data = subcontractorData[subcontractorId] || subcontractorData['abc-maintenance'];

            return `
                <div>
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--gray-200);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <button onclick="loadSection('subcontractors')" style="background: none; border: none; color: var(--gray-600); cursor: pointer; font-size: 1.5rem;">←</button>
                            <div>
                                <h2 style="font-size: 1.875rem; font-weight: 700; margin-bottom: 0.25rem;">${data.name}</h2>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <span class="status-badge completed">${data.serviceType}</span>
                                    <span class="status-badge ${data.stripeStatus === 'Connected' ? 'completed' : 'pending'}">Stripe ${data.stripeStatus}</span>
                                    <span style="color: var(--gray-600); font-size: 0.875rem;">Platform Fee: ${data.platformFee}</span>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn btn-secondary" onclick="editSubcontractor('${subcontractorId}')">Edit Subcontractor</button>
                            <button class="btn btn-primary" onclick="createWorkOrderForSubcontractor('${subcontractorId}')">+ Assign Work Order</button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="dashboard-grid" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-value">${data.revenue}</div>
                            <div class="stat-label">Total Revenue</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.activeJobs}</div>
                            <div class="stat-label">Active Jobs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.completedJobs}</div>
                            <div class="stat-label">Completed Jobs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${data.platformFee}</div>
                            <div class="stat-label">Platform Fee</div>
                        </div>
                    </div>

                    <!-- Subcontractor Details -->
                    <div class="table-container" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3 class="table-title">Subcontractor Information</h3>
                            <button class="btn btn-secondary" onclick="editSubcontractor('${subcontractorId}')">Edit</button>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                                <div>
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-500); margin-bottom: 0.25rem;">Business Email</label>
                                        <div style="font-size: 1rem; color: var(--gray-900);">${data.email}</div>
                                    </div>
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-500); margin-bottom: 0.25rem;">Phone</label>
                                        <div style="font-size: 1rem; color: var(--gray-900);">${data.phone}</div>
                                    </div>
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-500); margin-bottom: 0.25rem;">Address</label>
                                        <div style="font-size: 1rem; color: var(--gray-900);">${data.address}</div>
                                    </div>
                                </div>
                                <div>
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-500); margin-bottom: 0.25rem;">Stripe Connect Status</label>
                                        <div style="font-size: 1rem;">
                                            <span class="status-badge ${data.stripeStatus === 'Connected' ? 'completed' : 'pending'}">${data.stripeStatus}</span>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-500); margin-bottom: 0.25rem;">Platform Fee</label>
                                        <div style="font-size: 1rem; color: var(--gray-900);">${data.platformFee}</div>
                                    </div>
                                    <div style="margin-bottom: 1.5rem;">
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-500); margin-bottom: 0.25rem;">Service Types</label>
                                        <div style="font-size: 1rem; color: var(--gray-900);">${data.serviceType}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contacts -->
                    <div class="table-container" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3 class="table-title">Contacts</h3>
                            <button class="btn btn-secondary" onclick="addSubcontractorContact('${subcontractorId}')">+ Add Contact</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Title</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>John Smith</strong></td>
                                    <td>Operations Manager</td>
                                    <td>john@abcmaintenance.com</td>
                                    <td>(555) 123-4567</td>
                                    <td>Primary contact for scheduling</td>
                                    <td>
                                        <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editSubcontractorContact('john-smith')">Edit</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Sarah Johnson</strong></td>
                                    <td>Field Coordinator</td>
                                    <td>sarah@abcmaintenance.com</td>
                                    <td>(555) 123-4568</td>
                                    <td>Handles field operations</td>
                                    <td>
                                        <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;" onclick="editSubcontractorContact('sarah-johnson')">Edit</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Recent Work Orders -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Recent Work Orders</h3>
                            <button class="btn btn-secondary" onclick="viewAllSubcontractorOrders('${subcontractorId}')">View All</button>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Order #</th>
                                    <th>Location</th>
                                    <th>Service</th>
                                    <th>Status</th>
                                    <th>Due Date</th>
                                    <th>Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>#12345</strong></td>
                                    <td>Delilah LA</td>
                                    <td>HVAC Maintenance</td>
                                    <td><span class="status-badge pending">In Progress</span></td>
                                    <td>Today 2:00 PM</td>
                                    <td>$1,200</td>
                                    <td>
                                        <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;">View</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>#12342</strong></td>
                                    <td>Bootsy Bellows</td>
                                    <td>Electrical Repair</td>
                                    <td><span class="status-badge completed">Completed</span></td>
                                    <td>Feb 20, 2024</td>
                                    <td>$850</td>
                                    <td>
                                        <button class="btn btn-secondary" style="padding: 0.2rem 0.4rem; font-size: 0.75rem;">View</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function createWorkOrderForSubcontractor(subcontractorId) {
            showToast(`Creating work order for subcontractor...`, 'info');
        }

        function viewAllSubcontractorOrders(subcontractorId) {
            showToast(`Loading all work orders for subcontractor...`, 'info');
        }

        function getSubcontractorQuotesContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Bid Portal</h2>
                        <button class="btn btn-primary" onclick="sendWorkOrderToBid()">Send Work Order to Bid</button>
                    </div>
                    
                    <!-- Tabs -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--gray-200);">
                        <button class="sub-quote-tab active" onclick="switchBidTab('open')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid var(--primary); color: var(--gray-900); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Open Bids <span style="color: var(--gray-500); font-size: 0.875rem;" id="openBidsCount">2</span>
                        </button>
                        <button class="sub-quote-tab" onclick="switchBidTab('awarded')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Awarded <span style="color: var(--gray-500); font-size: 0.875rem;" id="awardedBidsCount">1</span>
                        </button>
                        <button class="sub-quote-tab" onclick="switchBidTab('completed')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Completed <span style="color: var(--gray-500); font-size: 0.875rem;" id="completedBidsCount">0</span>
                        </button>
                    </div>
                    
                    <!-- Search and Filters -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center;">
                        <input type="text" placeholder="Search bids..." style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px; width: 300px;">
                        <select style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px; background: white;">
                            <option>Sort: Newest First</option>
                            <option>Sort: Oldest First</option>
                            <option>Sort: Price (Low to High)</option>
                            <option>Sort: Price (High to Low)</option>
                        </select>
                    </div>
                    
                    <!-- Bid Cards Container -->
                    <div id="bidCardsContainer">
                        <!-- Open Bids -->
                        <div id="openBidsContent">
                            <div class="table-container" style="margin-bottom: 1.5rem;">
                                <div class="table-header">
                                    <h3 class="table-title">HVAC Repair - Lodge Bread Downtown</h3>
                                    <span style="color: var(--warning); font-weight: 600; font-size: 0.875rem;">Expires in 2 days</span>
                                </div>
                                <div style="padding: 1.5rem;">
                                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                                        <div>
                                            <p style="color: var(--gray-600); margin-bottom: 1rem;">
                                                Walk-in cooler not maintaining temperature. Unit is making unusual sounds and ice buildup around evaporator coils.
                                            </p>
                                            <div style="display: flex; gap: 2rem; margin-bottom: 1rem;">
                                                <div><strong>Location:</strong> 1234 Main St, Seattle WA</div>
                                                <div><strong>Priority:</strong> <span style="color: var(--warning);">High</span></div>
                                                <div><strong>Posted:</strong> 2 hours ago</div>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="margin-bottom: 1rem;">
                                                <div style="color: var(--gray-600); font-size: 0.875rem;">Bids Received</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">3</div>
                                            </div>
                                            <button class="btn btn-outline" onclick="viewBidDetails('wo-001')" style="margin-bottom: 0.5rem;">View Bids</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-container" style="margin-bottom: 1.5rem;">
                                <div class="table-header">
                                    <h3 class="table-title">Kitchen Deep Clean - Tasty Burgers</h3>
                                    <span style="color: var(--success); font-weight: 600; font-size: 0.875rem;">5 days remaining</span>
                                </div>
                                <div style="padding: 1.5rem;">
                                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                                        <div>
                                            <p style="color: var(--gray-600); margin-bottom: 1rem;">
                                                Monthly deep clean including hood system, grease traps, and equipment sanitization.
                                            </p>
                                            <div style="display: flex; gap: 2rem; margin-bottom: 1rem;">
                                                <div><strong>Location:</strong> 5678 Oak Ave, Seattle WA</div>
                                                <div><strong>Priority:</strong> <span style="color: var(--success);">Medium</span></div>
                                                <div><strong>Posted:</strong> 1 day ago</div>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="margin-bottom: 1rem;">
                                                <div style="color: var(--gray-600); font-size: 0.875rem;">Bids Received</div>
                                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">1</div>
                                            </div>
                                            <button class="btn btn-outline" onclick="viewBidDetails('wo-002')" style="margin-bottom: 0.5rem;">View Bids</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Awarded Bids -->
                        <div id="awardedBidsContent" style="display: none;">
                            <div class="table-container" style="margin-bottom: 1.5rem;">
                                <div class="table-header">
                                    <h3 class="table-title">Dishwasher Repair - Pizza Palace</h3>
                                    <span style="color: var(--success); font-weight: 600; font-size: 0.875rem;">Awarded to Seattle HVAC Pro</span>
                                </div>
                                <div style="padding: 1.5rem;">
                                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                                        <div>
                                            <p style="color: var(--gray-600); margin-bottom: 1rem;">
                                                Commercial dishwasher not draining properly. Needs pump inspection and potential replacement.
                                            </p>
                                            <div style="display: flex; gap: 2rem; margin-bottom: 1rem;">
                                                <div><strong>Winning Bid:</strong> $450</div>
                                                <div><strong>Platform Fee (15%):</strong> $67.50</div>
                                                <div><strong>Client Quote:</strong> $517.50</div>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <button class="btn btn-primary" onclick="sendClientQuote('wo-003')" style="margin-bottom: 0.5rem;">Send Client Quote</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Completed Bids -->
                        <div id="completedBidsContent" style="display: none;">
                            <div style="text-align: center; padding: 4rem 2rem;">
                                <div style="margin-bottom: 2rem;">
                                    <span style="font-size: 2rem; color: var(--success); font-weight: bold;">COMPLETED</span>
                                </div>
                                <h3 style="font-size: 1.5rem; font-weight: 600; color: var(--gray-700); margin-bottom: 1rem;">
                                    No completed bids yet
                                </h3>
                                <p style="color: var(--gray-500); font-size: 1rem;">
                                    Completed jobs will appear here once work is finished and invoiced.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getRecurringServicesContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Recurring Services Calendar</h2>
                        <button class="btn btn-primary" onclick="addNewRecurringService()">Add Service</button>
                    </div>
                    
                    <!-- Service Frequency Options -->
                    <div class="table-container" style="margin-bottom: 1.5rem;">
                        <div class="table-header">
                            <h3 class="table-title">Service Frequency</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="margin-bottom: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="serviceFrequency" value="monthly" checked style="width: 18px; height: 18px;">
                                    <span style="font-weight: 600;">Service by Month</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="serviceFrequency" value="daily" style="width: 18px; height: 18px;">
                                    <span style="font-weight: 600;">Service by Day</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Calendar -->
                    <div id="monthlyCalendar" class="table-container" style="margin-bottom: 1.5rem;">
                        <div class="table-header">
                            <h3 class="table-title">Select Service Months</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div id="monthGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
                                <!-- Calendar months will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- Date Options -->
                    <div class="table-container" style="margin-bottom: 1.5rem;">
                        <div class="table-header">
                            <h3 class="table-title">Date Options</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Service Period</label>
                                    <select style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                        <option>WO in Advance</option>
                                        <option>1 Week in Advance</option>
                                        <option>2 Weeks in Advance</option>
                                        <option>1 Month in Advance</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Date of the Next Work Order</label>
                                    <input type="date" id="nextWorkOrderDate" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Current Recurring Services -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">Current Recurring Services</h3>
                        </div>
                        <div id="recurringServicesList" style="padding: 1.5rem;">
                            <!-- Recurring services will be loaded here -->
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getProposalBuilderContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Proposal Builder</h2>
                    </div>
                    
                    <!-- Proposal Type Selection -->
                    <div class="table-container" style="margin-bottom: 1.5rem;">
                        <div class="table-header">
                            <h3 class="table-title">Proposal Type</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="display: flex; gap: 1rem;">
                                <label style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--gray-300); border-radius: 8px; cursor: pointer; flex: 1;">
                                    <input type="radio" name="proposalType" value="maintenance" checked onchange="switchProposalType('maintenance')" style="margin-right: 0.5rem;">
                                    <div>
                                        <div style="font-weight: 600;">Equipment Maintenance</div>
                                        <div style="font-size: 0.875rem; color: var(--gray-600);">HVAC, Refrigeration, Kitchen Equipment</div>
                                    </div>
                                </label>
                                <label style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--gray-300); border-radius: 8px; cursor: pointer; flex: 1;">
                                    <input type="radio" name="proposalType" value="cleaning" onchange="switchProposalType('cleaning')" style="margin-right: 0.5rem;">
                                    <div>
                                        <div style="font-weight: 600;">Cleaning Services</div>
                                        <div style="font-size: 0.875rem; color: var(--gray-600);">Janitorial, Deep Clean, Sanitization</div>
                                    </div>
                                </label>
                                <label style="display: flex; align-items: center; padding: 1rem; border: 2px solid var(--gray-300); border-radius: 8px; cursor: pointer; flex: 1;">
                                    <input type="radio" name="proposalType" value="combined" onchange="switchProposalType('combined')" style="margin-right: 0.5rem;">
                                    <div>
                                        <div style="font-weight: 600;">Combined Services</div>
                                        <div style="font-size: 0.875rem; color: var(--gray-600);">Maintenance + Cleaning Bundle</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Client Information -->
                    <div class="table-container" style="margin-bottom: 1.5rem;">
                        <div class="table-header">
                            <h3 class="table-title">Client Information</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Client Name <span style="color: var(--danger);">*</span>
                                    </label>
                                    <input type="text" id="clientName" placeholder="e.g., Lodge Bread" onchange="updateProposalPreview()" 
                                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Client Contact <span style="color: var(--danger);">*</span>
                                    </label>
                                    <input type="text" id="clientContact" placeholder="Email or Phone" onchange="updateProposalPreview()" 
                                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                </div>
                            </div>
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Locations
                                    </label>
                                    <input type="text" id="locations" placeholder="e.g., Culver City, Woodland Hills, Beverly Hills" onchange="updateProposalPreview()" 
                                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Proposal Date <span style="color: var(--danger);">*</span>
                                    </label>
                                    <input type="date" id="proposalDate" onchange="updateProposalPreview()" 
                                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                </div>
                            </div>
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Facility Type
                                    </label>
                                    <select id="facilityType" onchange="updateProposalPreview()" 
                                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <option value="">Select Type</option>
                                        <option value="Restaurant">Restaurant</option>
                                        <option value="Office">Office Building</option>
                                        <option value="Retail">Retail Store</option>
                                        <option value="Medical">Medical Facility</option>
                                        <option value="Industrial">Industrial/Warehouse</option>
                                        <option value="Educational">Educational Institution</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Square Footage
                                    </label>
                                    <input type="text" id="squareFootage" placeholder="e.g., 5,000 sq ft" onchange="updateProposalPreview()" 
                                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Service Coverage (Dynamic based on proposal type) -->
                    <div id="coverageSection" class="table-container" style="margin-bottom: 1.5rem;">
                        <div class="table-header">
                            <h3 class="table-title" id="coverageTitle">Equipment Coverage</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <!-- Maintenance Equipment Section -->
                            <div id="maintenanceSection">
                                <div class="form-grid" style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 1rem; margin-bottom: 1rem; align-items: end;">
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Equipment Category
                                        </label>
                                        <select id="equipmentCategory" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                            <option value="">Select Category</option>
                                            <option value="Refrigeration">Refrigeration</option>
                                            <option value="HVAC">HVAC</option>
                                            <option value="Kitchen Equipment">Kitchen Equipment</option>
                                            <option value="Electrical">Electrical Systems</option>
                                            <option value="Plumbing">Plumbing Fixtures</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Equipment Details
                                        </label>
                                        <input type="text" id="equipmentDetails" placeholder="e.g., True undercounters, Hussman display fridges" 
                                            style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-primary" onclick="addEquipmentItem()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Add Equipment</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cleaning Areas Section (Hidden by default) -->
                            <div id="cleaningSection" style="display: none;">
                                <!-- Cleaning Service Type Selection -->
                                <div style="background: var(--gray-50); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Service Frequency & Pricing Model</label>
                                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                                        <label style="display: flex; align-items: center;">
                                            <input type="radio" name="cleaningPricingModel" value="detailed" checked onchange="toggleCleaningPricingModel('detailed')" style="margin-right: 0.5rem;">
                                            <span>Detailed Area Pricing</span>
                                        </label>
                                        <label style="display: flex; align-items: center;">
                                            <input type="radio" name="cleaningPricingModel" value="monthly" onchange="toggleCleaningPricingModel('monthly')" style="margin-right: 0.5rem;">
                                            <span>Simple Monthly Rate</span>
                                        </label>
                                        <label style="display: flex; align-items: center;">
                                            <input type="radio" name="cleaningPricingModel" value="nightly" onchange="toggleCleaningPricingModel('nightly')" style="margin-right: 0.5rem;">
                                            <span>Nightly Service Rate</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Detailed Area Pricing (default) -->
                                <div id="detailedCleaningSection">
                                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; margin-bottom: 1rem; align-items: end;">
                                        <div>
                                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                                Area Type
                                            </label>
                                            <select id="areaType" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                                <option value="">Select Area</option>
                                                <option value="Dining Area">Dining Area</option>
                                                <option value="Kitchen">Kitchen</option>
                                                <option value="Restrooms">Restrooms</option>
                                                <option value="Office Space">Office Space</option>
                                                <option value="Common Areas">Common Areas</option>
                                                <option value="Parking Lot">Parking Lot</option>
                                                <option value="Windows">Windows</option>
                                                <option value="Floors">Floor Care</option>
                                                <option value="Carpet">Carpet Cleaning</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                                Size/Count
                                            </label>
                                            <input type="text" id="areaSize" placeholder="e.g., 2,000 sq ft, 4 units" 
                                                style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                                Frequency
                                            </label>
                                            <select id="cleaningFrequency" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                                <option value="Daily">Daily (5x/week)</option>
                                                <option value="Daily7">Daily (7x/week)</option>
                                                <option value="3x Week">3x per Week</option>
                                                <option value="2x Week">2x per Week</option>
                                                <option value="Weekly">Weekly</option>
                                                <option value="Bi-Weekly">Bi-Weekly</option>
                                                <option value="Monthly">Monthly</option>
                                                <option value="Quarterly">Quarterly</option>
                                                <option value="As Needed">As Needed</option>
                                            </select>
                                        </div>
                                        <div>
                                            <button class="btn btn-primary" onclick="addCleaningArea()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Add Area</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Simple Pricing Section (hidden by default) -->
                                <div id="simpleCleaningSection" style="display: none;">
                                    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; align-items: end;">
                                        <div>
                                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                                <span id="simplePriceLabel">Monthly Cost</span> <span style="color: var(--danger);">*</span>
                                            </label>
                                            <input type="number" id="simpleCleaningCost" placeholder="$ 0.00" 
                                                style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                                Service Frequency
                                            </label>
                                            <select id="simpleFrequency" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                                <option value="5 nights/week">5 Nights per Week</option>
                                                <option value="7 nights/week">7 Nights per Week</option>
                                                <option value="3 nights/week">3 Nights per Week</option>
                                                <option value="Custom">Custom Schedule</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                                Service Times
                                            </label>
                                            <input type="text" id="serviceTimes" placeholder="e.g., 10 PM - 2 AM" 
                                                style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        </div>
                                    </div>
                                    <div style="margin-top: 1rem;">
                                        <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                            Services Included
                                        </label>
                                        <textarea id="servicesIncluded" rows="3" placeholder="e.g., Trash removal, floor cleaning, restroom sanitization, surface wiping..." 
                                            style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; resize: vertical;"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div id="coverageList" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem;"></div>
                        </div>
                    </div>
                    
                    <!-- Services & Pricing -->
                    <div class="table-container" style="margin-bottom: 1.5rem;">
                        <div class="table-header">
                            <h3 class="table-title">Services & Pricing</h3>
                            <button class="btn btn-primary" onclick="addProposalService()" style="font-size: 0.875rem;">+ Add Service</button>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div id="servicesList">
                                <div style="background: var(--gray-50); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                                    <div class="form-grid" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: center; margin-bottom: 0.5rem;">
                                        <input type="text" placeholder="Service Name" id="service-0-name" onchange="updateProposalPreview()" 
                                            style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <select id="service-0-frequency" onchange="updateProposalPreview()" 
                                            style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                            <option value="Monthly">Monthly</option>
                                            <option value="Quarterly">Quarterly</option>
                                            <option value="Bi-Annual">Bi-Annual</option>
                                            <option value="Annual">Annual</option>
                                        </select>
                                        <input type="number" placeholder="Price" id="service-0-price" onchange="updateProposalPreview()" 
                                            style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; text-align: right;">
                                        <button class="btn btn-danger" onclick="removeProposalService(0)" style="padding: 0.5rem 0.75rem; font-size: 0.875rem;">Remove</button>
                                    </div>
                                    <input type="text" placeholder="Notes/Equipment" id="service-0-notes" onchange="updateProposalPreview()" 
                                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Live Preview -->
                    <div class="table-container" style="margin-bottom: 1.5rem;">
                        <div class="table-header">
                            <h3 class="table-title">Live Preview</h3>
                            <div style="display: flex; gap: 0.75rem;">
                                <button class="btn btn-secondary" onclick="exportProposalPDF()">Export PDF</button>
                                <button class="btn btn-primary" onclick="sendProposalEmail()">Send to Client</button>
                            </div>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div id="proposalPreview" style="background: white; padding: 2rem; border: 1px solid var(--gray-300); border-radius: 6px; min-height: 600px;">
                                <div style="text-align: center; margin-bottom: 2rem;">
                                    <h2>Preventive Maintenance Plan</h2>
                                    <h3 id="previewClientName">Client Name</h3>
                                    <div style="width: 150px; height: 60px; background: var(--primary); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; border-radius: 6px;">HEY SPRUCE</div>
                                </div>
                                
                                <div style="margin: 2rem 0;">
                                    <p><strong>Prepared For:</strong> <span id="previewClient">Client Name</span></p>
                                    <p><strong>Contact:</strong> <span id="previewContact">Contact Info</span></p>
                                    <p><strong>Prepared By:</strong> Hey Spruce – Cleaning & Maintenance Solutions</p>
                                    <p><strong>Date:</strong> <span id="previewDate">Today's Date</span></p>
                                </div>
                                
                                <div style="margin: 2rem 0;">
                                    <h3>1. Overview</h3>
                                    <p>Hey Spruce provides <span id="previewClientName2">your business</span> with a proactive cleaning and maintenance program designed to:</p>
                                    <ul style="margin-left: 2rem; margin-top: 0.5rem;">
                                        <li>Reduce downtime and unexpected repair costs</li>
                                        <li>Maintain health & safety standards</li>
                                        <li>Extend the life of kitchen equipment</li>
                                        <li>Keep front- and back-of-house spotless for staff and customers</li>
                                    </ul>
                                </div>
                                
                                <div style="margin: 2rem 0;">
                                    <h3>2. Covered Equipment</h3>
                                    <p id="previewLocations">All equipment at your locations</p>
                                    <div id="previewEquipment" style="margin-top: 1rem;"></div>
                                </div>
                                
                                <div style="margin: 2rem 0;">
                                    <h3>3. Service Schedule & Pricing</h3>
                                    <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                                        <thead>
                                            <tr>
                                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--gray-300); background: var(--gray-50); font-weight: 600;">Service</th>
                                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--gray-300); background: var(--gray-50); font-weight: 600;">Frequency</th>
                                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--gray-300); background: var(--gray-50); font-weight: 600;">Notes</th>
                                                <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--gray-300); background: var(--gray-50); font-weight: 600;">Price</th>
                                            </tr>
                                        </thead>
                                        <tbody id="previewServices">
                                            <tr>
                                                <td colspan="4" style="padding: 0.75rem; text-align: center; color: var(--gray-500); border-bottom: 1px solid var(--gray-300);">No services added yet</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div style="margin-top: 1rem; text-align: right;">
                                        <strong>Monthly Total: $<span id="monthlyTotal">0</span></strong>
                                    </div>
                                </div>
                                
                                <div style="margin: 3rem 0;">
                                    <h3>4. Agreement</h3>
                                    <p>Hey Spruce will provide the above services according to the agreed schedule.</p>
                                    <div style="margin-top: 2rem;">
                                        <p>Authorized Signature (<span id="previewClientSig">Client</span>): _____________________</p>
                                        <p style="margin-top: 1rem;">Date: _______________</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Email Modal -->
                    <div id="proposalEmailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 500px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
                            <h3 style="margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 600;">Send Proposal</h3>
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">Client Email</label>
                                <input type="email" id="proposalSendEmail" placeholder="client@example.com" 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">Message</label>
                                <textarea id="proposalSendMessage" rows="4" placeholder="Hi, please find attached our maintenance proposal..." 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; resize: vertical;"></textarea>
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button class="btn btn-secondary" onclick="closeProposalModal()">Cancel</button>
                                <button class="btn btn-primary" onclick="confirmProposalSend()">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function getQuoteEditorContent(quoteId) {
            const isEdit = quoteId && quoteId !== 'new';
            const title = isEdit ? `Edit Quote ${quoteId}` : 'Create New Quote';
            
            return `
                <div>
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--gray-200);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <button onclick="loadSection('quotes')" style="background: none; border: none; color: var(--gray-600); cursor: pointer; font-size: 1.5rem;">←</button>
                            <h2 style="font-size: 1.875rem; font-weight: 700;">${title}</h2>
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn btn-secondary" onclick="saveQuoteDraft()">Save Draft</button>
                            <button class="btn btn-primary" onclick="submitQuote()">Submit Quote</button>
                        </div>
                    </div>
                    
                    <!-- Quote Details Section -->
                    <div class="table-container" style="margin-bottom: 1.5rem;">
                        <div class="table-header">
                            <h3 class="table-title">Quote Details</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Client <span style="color: var(--danger);">*</span>
                                </label>
                                <select id="quoteClient" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="">Select a location...</option>
                                    <optgroup label="The h.wood Group">
                                        <option value="hwood-main">The h.wood Group - Main</option>
                                        <option value="delilah-la">Delilah LA</option>
                                        <option value="bootsy-bellows">Bootsy Bellows</option>
                                        <option value="nice-guy">Nice Guy</option>
                                    </optgroup>
                                    <optgroup label="Standalone Locations">
                                        <option value="mcdonalds-sunset">McDonald's - Sunset Strip</option>
                                        <option value="burger-king-melrose">Burger King - Melrose</option>
                                        <option value="taco-bell-hollywood">Taco Bell - Hollywood</option>
                                    </optgroup>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Quote Title <span style="color: var(--danger);">*</span>
                                </label>
                                <input type="text" id="quoteTitle" placeholder="Enter quote title..." 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Scope of Work
                                </label>
                                <div style="border: 1px solid var(--gray-300); border-radius: 6px; overflow: hidden;">
                                    <div style="background: var(--gray-50); padding: 0.5rem; border-bottom: 1px solid var(--gray-300); display: flex; gap: 0.5rem;">
                                        <button onclick="formatText('bold')" style="padding: 0.25rem 0.5rem; background: white; border: 1px solid var(--gray-300); border-radius: 4px; cursor: pointer;" title="Bold">
                                            <strong>B</strong>
                                        </button>
                                        <button onclick="formatText('italic')" style="padding: 0.25rem 0.5rem; background: white; border: 1px solid var(--gray-300); border-radius: 4px; cursor: pointer;" title="Italic">
                                            <em>I</em>
                                        </button>
                                        <button onclick="formatText('underline')" style="padding: 0.25rem 0.5rem; background: white; border: 1px solid var(--gray-300); border-radius: 4px; cursor: pointer;" title="Underline">
                                            <u>U</u>
                                        </button>
                                        <span style="width: 1px; background: var(--gray-300); margin: 0 0.25rem;"></span>
                                        <button onclick="formatText('list')" style="padding: 0.25rem 0.5rem; background: white; border: 1px solid var(--gray-300); border-radius: 4px; cursor: pointer;" title="Bullet List">
                                            •
                                        </button>
                                        <button onclick="formatText('number')" style="padding: 0.25rem 0.5rem; background: white; border: 1px solid var(--gray-300); border-radius: 4px; cursor: pointer;" title="Numbered List">
                                            1.
                                        </button>
                                    </div>
                                    <div contenteditable="true" id="scopeEditor" 
                                        style="min-height: 200px; padding: 1rem; background: white; outline: none;"
                                        placeholder="Describe the work to be performed..."></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cost Breakdown Section -->
                    <div class="table-container" style="margin-bottom: 1.5rem;">
                        <div class="table-header">
                            <h3 class="table-title">Cost Breakdown</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <!-- Simplified Cost Categories -->
                            <div style="background: var(--gray-50); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                                
                                <!-- Incurred Cost -->
                                <div style="background: white; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid var(--primary); padding: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                        <div style="flex: 1;">
                                            <span style="font-weight: 500; color: var(--gray-900);">Incurred Cost</span>
                                            <div style="font-size: 0.875rem; color: var(--gray-600); margin-top: 0.25rem;">Materials, supplies, and direct costs</div>
                                        </div>
                                        <span id="incurredTotal" style="font-weight: 600; color: var(--primary); min-width: 80px; text-align: right;">$0.00</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        <input type="text" id="incurredCostDescription" placeholder="Description..." 
                                               style="flex: 1; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                        <input type="number" id="incurredCostAmount" placeholder="0.00" step="0.01" 
                                               onchange="updateCategoryTotal('incurred')" 
                                               style="width: 100px; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; text-align: right;">
                                        <span style="font-size: 0.875rem; color: var(--gray-600); width: 30px;">USD</span>
                                        <button class="btn btn-secondary" onclick="addIncurredCost()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Add</button>
                                    </div>
                                </div>
                                
                                <!-- Labor -->
                                <div style="background: white; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid var(--primary); padding: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                        <div style="flex: 1;">
                                            <span style="font-weight: 500; color: var(--gray-900);">Labor</span>
                                            <div style="font-size: 0.875rem; color: var(--gray-600); margin-top: 0.25rem;">Technician time and labor costs</div>
                                        </div>
                                        <span id="laborTotal" style="font-weight: 600; color: var(--primary); min-width: 80px; text-align: right;">$0.00</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 2fr 80px 60px 80px 100px 40px 100px; gap: 0.5rem; align-items: center;">
                                        <input type="text" id="laborTaskType" placeholder="Task type (e.g., Technician)" 
                                               style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                        <input type="number" id="laborTasks" placeholder="1" min="1" onchange="calculateLaborCost()"
                                               style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; text-align: center;">
                                        <input type="number" id="laborDays" placeholder="1" min="1" step="0.5" onchange="calculateLaborCost()"
                                               style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; text-align: center;">
                                        <input type="number" id="laborRate" placeholder="0.00" step="0.01" onchange="calculateLaborCost()"
                                               style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; text-align: right;">
                                        <input type="number" id="laborCostAmount" placeholder="0.00" step="0.01" readonly
                                               onchange="updateCategoryTotal('labor')" 
                                               style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; text-align: right; background: var(--gray-50);">
                                        <span style="font-size: 0.875rem; color: var(--gray-600);">USD</span>
                                        <button class="btn btn-secondary" onclick="addLaborCost()" style="padding: 0.5rem 0.75rem; font-size: 0.875rem;">Add</button>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 2fr 80px 60px 80px 100px 40px 100px; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.75rem; color: var(--gray-500);">
                                        <div>Task Type</div>
                                        <div style="text-align: center;">Tasks</div>
                                        <div style="text-align: center;">Days</div>
                                        <div style="text-align: right;">Rate/Day</div>
                                        <div style="text-align: right;">Total</div>
                                        <div></div>
                                        <div></div>
                                    </div>
                                </div>
                                
                                <!-- Parts -->
                                <div style="background: white; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid var(--primary); padding: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                        <div style="flex: 1;">
                                            <span style="font-weight: 500; color: var(--gray-900);">Parts</span>
                                            <div style="font-size: 0.875rem; color: var(--gray-600); margin-top: 0.25rem;">Equipment parts and components</div>
                                        </div>
                                        <span id="partsTotal" style="font-weight: 600; color: var(--primary); min-width: 80px; text-align: right;">$0.00</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 2fr 80px 60px 60px 80px 100px 40px 100px; gap: 0.5rem; align-items: center;">
                                        <input type="text" id="partsDescription" placeholder="Part description" 
                                               style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                        <input type="text" id="partsNumber" placeholder="Part #" 
                                               style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                        <select id="partsUnitType" style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; font-size: 0.875rem;">
                                            <option>each</option>
                                            <option>lb</option>
                                            <option>ft</option>
                                            <option>hr</option>
                                        </select>
                                        <input type="number" id="partsQuantity" placeholder="1" min="1" onchange="calculatePartsCost()"
                                               style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; text-align: center;">
                                        <input type="number" id="partsUnitPrice" placeholder="0.00" step="0.01" onchange="calculatePartsCost()"
                                               style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; text-align: right;">
                                        <input type="number" id="partsCostAmount" placeholder="0.00" step="0.01" readonly
                                               onchange="updateCategoryTotal('parts')" 
                                               style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; text-align: right; background: var(--gray-50);">
                                        <span style="font-size: 0.875rem; color: var(--gray-600);">USD</span>
                                        <button class="btn btn-secondary" onclick="addPartsCost()" style="padding: 0.5rem 0.75rem; font-size: 0.875rem;">Add</button>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 2fr 80px 60px 60px 80px 100px 40px 100px; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.75rem; color: var(--gray-500);">
                                        <div>Description</div>
                                        <div style="text-align: center;">Part #</div>
                                        <div style="text-align: center;">Unit</div>
                                        <div style="text-align: center;">Qty</div>
                                        <div style="text-align: right;">Unit Price</div>
                                        <div style="text-align: right;">Total</div>
                                        <div></div>
                                        <div></div>
                                    </div>
                                </div>
                                
                                <!-- Equipment -->
                                <div style="background: white; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid var(--primary); padding: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                        <div style="flex: 1;">
                                            <span style="font-weight: 500; color: var(--gray-900);">Equipment</span>
                                            <div style="font-size: 0.875rem; color: var(--gray-600); margin-top: 0.25rem;">Equipment rental and usage costs</div>
                                        </div>
                                        <span id="equipmentTotal" style="font-weight: 600; color: var(--primary); min-width: 80px; text-align: right;">$0.00</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 2fr 100px 100px 100px 40px 100px; gap: 0.5rem; align-items: center;">
                                        <input type="text" id="equipmentDescription" placeholder="Equipment description" 
                                               style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                        <input type="text" id="equipmentNumber" placeholder="Equipment #" 
                                               style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                        <input type="text" id="equipmentSerial" placeholder="Serial #" 
                                               style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                        <input type="number" id="equipmentCostAmount" placeholder="0.00" step="0.01" 
                                               onchange="updateCategoryTotal('equipment')" 
                                               style="padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; text-align: right;">
                                        <span style="font-size: 0.875rem; color: var(--gray-600);">USD</span>
                                        <button class="btn btn-secondary" onclick="addEquipmentCost()" style="padding: 0.5rem 0.75rem; font-size: 0.875rem;">Add</button>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 2fr 100px 100px 100px 40px 100px; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.75rem; color: var(--gray-500);">
                                        <div>Description</div>
                                        <div style="text-align: center;">Equipment #</div>
                                        <div style="text-align: center;">Serial #</div>
                                        <div style="text-align: right;">Cost</div>
                                        <div></div>
                                        <div></div>
                                    </div>
                                </div>
                                
                                <!-- Travel -->
                                <div style="background: white; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid var(--primary); padding: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                        <div style="flex: 1;">
                                            <span style="font-weight: 500; color: var(--gray-900);">Travel</span>
                                            <div style="font-size: 0.875rem; color: var(--gray-600); margin-top: 0.25rem;">Transportation and travel expenses</div>
                                        </div>
                                        <span id="travelTotal" style="font-weight: 600; color: var(--primary); min-width: 80px; text-align: right;">$0.00</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                                        <input type="text" id="travelDescription" placeholder="Travel description..." 
                                               style="flex: 1; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                        <input type="number" id="travelCostAmount" placeholder="0.00" step="0.01" 
                                               onchange="updateCategoryTotal('travel')" 
                                               style="width: 100px; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px; text-align: right;">
                                        <span style="font-size: 0.875rem; color: var(--gray-600); width: 30px;">USD</span>
                                        <button class="btn btn-secondary" onclick="addTravelCost()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Add</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Added Cost Items List -->
                            <div id="costItemsList" style="margin-bottom: 2rem;"></div>
                            
                            <!-- Totals -->
                            <div style="border-top: 2px solid var(--gray-200); margin-top: 2rem; padding-top: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-weight: 500;">Total Before Tax:</span>
                                    <span id="totalBeforeTax" style="font-weight: 600;">$0.00 USD</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                    <span style="font-weight: 500;">Tax:</span>
                                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                                        <input type="number" id="taxAmount" placeholder="0" onchange="updateTotals()"
                                            style="width: 60px; text-align: right; padding: 0.25rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                        <span style="font-size: 0.875rem;">USD</span>
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 1.25rem; font-weight: 700; color: var(--primary);">
                                    <span>Total With Tax:</span>
                                    <span id="totalWithTax">$0.00 USD</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Attachments Section -->
                    <div class="table-container" style="margin-bottom: 1.5rem;">
                        <div class="table-header">
                            <h3 class="table-title">Attachments</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="border: 2px dashed var(--gray-300); border-radius: 8px; padding: 2rem; text-align: center; background: var(--gray-50);">
                                <div style="margin-bottom: 1rem;">
                                    <span style="font-size: 2rem; color: var(--gray-400);">+</span>
                                </div>
                                <p style="color: var(--gray-600); margin-bottom: 1rem;">Click or drag files to this area to upload</p>
                                <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFileUpload(event)">
                                <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
                                    Browse Files
                                </button>
                                <p style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.5rem;">
                                    Supported formats: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG
                                </p>
                            </div>
                            <div id="attachmentsList" style="margin-top: 1rem;">
                                <!-- Uploaded files will appear here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; justify-content: flex-end; gap: 1rem; padding: 1.5rem 0; border-top: 1px solid var(--gray-200);">
                        <button class="btn btn-secondary" onclick="loadSection('quotes')">Cancel</button>
                        <button class="btn btn-secondary" onclick="saveQuoteDraft()">Save Draft</button>
                        <button class="btn btn-primary" onclick="submitQuote()">Submit Quote</button>
                    </div>
                </div>
            `;
        }
        
        function getInvoiceEditorContent(invoiceId) {
            const isEdit = invoiceId && invoiceId !== 'new' && !invoiceId.startsWith('Q-');
            const isFromQuote = invoiceId && invoiceId.startsWith('Q-');
            const title = isEdit ? `Edit Invoice ${invoiceId}` : 
                         isFromQuote ? `Create Invoice from Quote ${invoiceId}` : 'Create New Invoice';
            
            // Pre-populate data if converting from quote
            const quoteData = isFromQuote ? {
                client: 'Burger King',
                amount: '$4,200.00',
                service: 'Kitchen Deep Clean & Maintenance'
            } : {};
            
            return `
                <div>
                    <!-- Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--gray-200);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <button onclick="loadSection('invoices')" style="background: none; border: none; color: var(--gray-600); cursor: pointer; font-size: 1.5rem;">←</button>
                            <h2 style="font-size: 1.875rem; font-weight: 700;">${title}</h2>
                        </div>
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn btn-secondary" onclick="saveInvoiceDraft()">Save Draft</button>
                            <button class="btn btn-primary" onclick="sendInvoice()">Send Invoice</button>
                        </div>
                    </div>
                    
                    ${isFromQuote ? `
                    <!-- Quote Reference -->
                    <div class="table-container" style="margin-bottom: 1.5rem; border-left: 4px solid var(--success);">
                        <div style="padding: 1rem; background: var(--success-light, #f0f9ff);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="color: var(--success); font-weight: 600;">Complete</span>
                                <span style="font-weight: 600; color: var(--success);">Converting from Approved Quote</span>
                            </div>
                            <p style="color: var(--gray-600); margin: 0; font-size: 0.875rem;">
                                This invoice is being created from approved quote ${invoiceId}. All quote details have been pre-populated.
                            </p>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Invoice Details Section -->
                    <div class="table-container" style="margin-bottom: 1.5rem;">
                        <div class="table-header">
                            <h3 class="table-title">Invoice Details</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Client <span style="color: var(--danger);">*</span>
                                    </label>
                                    <select id="invoiceClient" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <option value="">Select a location...</option>
                                        <optgroup label="The h.wood Group">
                                            <option value="hwood-main">The h.wood Group - Main</option>
                                            <option value="delilah-la">Delilah LA</option>
                                            <option value="bootsy-bellows">Bootsy Bellows</option>
                                            <option value="nice-guy">Nice Guy</option>
                                        </optgroup>
                                        <optgroup label="Standalone Locations">
                                            <option value="mcdonalds-sunset">McDonald's - Sunset Strip</option>
                                            <option value="burger-king-melrose" ${isFromQuote && quoteData.client === 'Burger King' ? 'selected' : ''}>Burger King - Melrose</option>
                                            <option value="taco-bell-hollywood">Taco Bell - Hollywood</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Invoice Number
                                    </label>
                                    <input type="text" id="invoiceNumber" placeholder="Auto-generated" readonly
                                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; background: var(--gray-50);" 
                                        value="${isEdit ? invoiceId : 'INV-' + new Date().getFullYear() + '-' + String(Math.floor(Math.random() * 1000) + 1).padStart(3, '0')}">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Issue Date <span style="color: var(--danger);">*</span>
                                    </label>
                                    <input type="date" id="invoiceIssueDate" 
                                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;"
                                        value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div>
                                    <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                        Due Date <span style="color: var(--danger);">*</span>
                                    </label>
                                    <input type="date" id="invoiceDueDate" 
                                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;"
                                        value="${new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}">
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Description of Services <span style="color: var(--danger);">*</span>
                                </label>
                                <textarea id="invoiceDescription" rows="4" placeholder="Describe the services provided..." 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; resize: vertical;">${isFromQuote ? quoteData.service || '' : ''}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Line Items Section -->
                    <div class="table-container" style="margin-bottom: 1.5rem;">
                        <div class="table-header">
                            <h3 class="table-title">Line Items</h3>
                            <button class="btn btn-secondary" onclick="addInvoiceLineItem()">+ Add Line Item</button>
                        </div>
                        <div style="padding: 0;">
                            <table style="width: 100%;">
                                <thead>
                                    <tr style="background: var(--gray-50);">
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--gray-200);">Description</th>
                                        <th style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--gray-200); width: 100px;">Quantity</th>
                                        <th style="padding: 0.75rem; text-align: right; border-bottom: 1px solid var(--gray-200); width: 120px;">Unit Price</th>
                                        <th style="padding: 0.75rem; text-align: right; border-bottom: 1px solid var(--gray-200); width: 120px;">Total</th>
                                        <th style="padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--gray-200); width: 60px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="invoice-line-items">
                                    ${isFromQuote ? `
                                    <tr>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200);">
                                            <input type="text" value="${quoteData.service || 'Kitchen Deep Clean & Maintenance'}" 
                                                style="width: 100%; border: none; background: transparent; outline: none;">
                                        </td>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200); text-align: center;">
                                            <input type="number" value="1" min="1" onchange="calculateInvoiceLineTotal(this)"
                                                style="width: 60px; text-align: center; border: 1px solid var(--gray-300); border-radius: 4px; padding: 0.25rem;">
                                        </td>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200); text-align: right;">
                                            <input type="number" value="4200.00" step="0.01" onchange="calculateInvoiceLineTotal(this)"
                                                style="width: 80px; text-align: right; border: 1px solid var(--gray-300); border-radius: 4px; padding: 0.25rem;">
                                        </td>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200); text-align: right; font-weight: 600;">
                                            $4,200.00
                                        </td>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200); text-align: center;">
                                            <button onclick="removeInvoiceLineItem(this)" style="color: var(--danger); background: none; border: none; cursor: pointer; font-size: 1.1rem;">×</button>
                                        </td>
                                    </tr>
                                    ` : `
                                    <tr>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200);">
                                            <input type="text" placeholder="Service description..." 
                                                style="width: 100%; border: none; background: transparent; outline: none;">
                                        </td>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200); text-align: center;">
                                            <input type="number" value="1" min="1" onchange="calculateInvoiceLineTotal(this)"
                                                style="width: 60px; text-align: center; border: 1px solid var(--gray-300); border-radius: 4px; padding: 0.25rem;">
                                        </td>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200); text-align: right;">
                                            <input type="number" placeholder="0.00" step="0.01" onchange="calculateInvoiceLineTotal(this)"
                                                style="width: 80px; text-align: right; border: 1px solid var(--gray-300); border-radius: 4px; padding: 0.25rem;">
                                        </td>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200); text-align: right; font-weight: 600;">
                                            $0.00
                                        </td>
                                        <td style="padding: 0.75rem; border-bottom: 1px solid var(--gray-200); text-align: center;">
                                            <button onclick="removeInvoiceLineItem(this)" style="color: var(--danger); background: none; border: none; cursor: pointer; font-size: 1.1rem;">×</button>
                                        </td>
                                    </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Invoice Totals -->
                    <div class="table-container" style="margin-bottom: 1.5rem;">
                        <div class="table-header">
                            <h3 class="table-title">Invoice Total</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="max-width: 400px; margin-left: auto;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--gray-200);">
                                    <span>Subtotal:</span>
                                    <span id="invoiceSubtotal">${isFromQuote ? '$4,200.00' : '$0.00'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                                    <span>Tax (8.25%):</span>
                                    <span id="invoiceTax">${isFromQuote ? '$346.50' : '$0.00'}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 1.25rem; font-weight: 700; color: var(--primary);">
                                    <span>Total:</span>
                                    <span id="invoiceTotal">${isFromQuote ? '$4,546.50' : '$0.00'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Terms -->
                    <div class="table-container" style="margin-bottom: 1.5rem;">
                        <div class="table-header">
                            <h3 class="table-title">Payment Terms & Notes</h3>
                        </div>
                        <div style="padding: 1.5rem;">
                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Payment Terms
                                </label>
                                <select id="paymentTerms" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="net-30">Net 30 days</option>
                                    <option value="net-15">Net 15 days</option>
                                    <option value="due-on-receipt">Due on receipt</option>
                                    <option value="net-60">Net 60 days</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">
                                    Additional Notes
                                </label>
                                <textarea id="invoiceNotes" rows="3" placeholder="Add any additional notes or payment instructions..." 
                                    style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 6px; resize: vertical;"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; justify-content: flex-end; gap: 1rem; padding: 1.5rem 0; border-top: 1px solid var(--gray-200);">
                        <button class="btn btn-secondary" onclick="loadSection('invoices')">Cancel</button>
                        <button class="btn btn-secondary" onclick="saveInvoiceDraft()">Save Draft</button>
                        <button class="btn btn-primary" onclick="sendInvoice()">Send Invoice</button>
                    </div>
                </div>
            `;
        }
        
        function getRFPsContent() {
            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="font-size: 1.875rem; font-weight: 700;">Request for Proposals</h2>
                        <button class="btn btn-secondary" onclick="exportToCSV('rfps')">
                            <span style="margin-right: 0.25rem;">↓</span> Export
                        </button>
                    </div>
                    
                    <!-- Tabs like Inbox -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--gray-200);">
                        <button class="rfp-tab active" onclick="switchRFPTab('all')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid var(--primary); color: var(--gray-900); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            All <span style="color: var(--gray-500); font-size: 0.875rem;">(13)</span>
                        </button>
                        <button class="rfp-tab" onclick="switchRFPTab('requested')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Requested <span style="color: var(--gray-500); font-size: 0.875rem;">(3)</span>
                        </button>
                        <button class="rfp-tab" onclick="switchRFPTab('interested')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Interested <span style="color: var(--gray-500); font-size: 0.875rem;">(2)</span>
                        </button>
                        <button class="rfp-tab" onclick="switchRFPTab('submitted')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Submitted <span style="color: var(--gray-500); font-size: 0.875rem;">(4)</span>
                        </button>
                        <button class="rfp-tab" onclick="switchRFPTab('review')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Under Review <span style="color: var(--gray-500); font-size: 0.875rem;">(1)</span>
                        </button>
                        <button class="rfp-tab" onclick="switchRFPTab('awarded')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Awarded <span style="color: var(--gray-500); font-size: 0.875rem;">(2)</span>
                        </button>
                        <button class="rfp-tab" onclick="switchRFPTab('declined')" style="padding: 0.75rem 0; background: none; border: none; border-bottom: 2px solid transparent; color: var(--gray-600); cursor: pointer; font-weight: 500; margin-bottom: -2px;">
                            Declined <span style="color: var(--gray-500); font-size: 0.875rem;">(1)</span>
                        </button>
                    </div>
                    
                    <!-- Search and Filter Bar -->
                    <div class="table-container">
                        <div class="table-header">
                            <h3 class="table-title">All RFPs</h3>
                            <div style="display: flex; gap: 0.75rem; align-items: center;">
                                <input type="text" id="rfpSearch" placeholder="Search RFPs..." 
                                    onkeyup="filterRFPs()" 
                                    style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px; width: 250px;">
                                <select id="rfpStatusFilter" onchange="filterRFPs()" 
                                    style="padding: 0.5rem 1rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                    <option value="">All Status</option>
                                    <option value="requested">Requested</option>
                                    <option value="interested">Interested</option>
                                    <option value="submitted">Submitted</option>
                                    <option value="review">Under Review</option>
                                    <option value="awarded">Awarded</option>
                                    <option value="declined">Declined</option>
                                </select>
                            </div>
                        </div>
                        <table id="rfpTable" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th style="width: 12%;">RFP #</th>
                                    <th style="width: 25%;">Title</th>
                                    <th style="width: 15%;">Client</th>
                                    <th style="width: 10%;">Type</th>
                                    <th style="width: 10%;">Deadline</th>
                                    <th style="width: 12%;">Value Range</th>
                                    <th style="width: 10%;">Status</th>
                                    <th style="width: 10%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><a href="#" onclick="viewRFPDetail('RFP-2025-001'); return false;" style="color: var(--primary); font-weight: 700;">#RFP-2025-001</a></td>
                                    <td><strong>HVAC Maintenance Contract</strong></td>
                                    <td>The h.wood Group</td>
                                    <td>Maintenance</td>
                                    <td style="color: var(--danger);">Aug 30, 2025</td>
                                    <td>$50K - $75K</td>
                                    <td><span class="status-badge requested">Requested</span></td>
                                    <td>
                                        <button class="btn btn-primary" onclick="submitProposal('RFP-2025-001')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Submit</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><a href="#" onclick="viewRFPDetail('RFP-2025-002'); return false;" style="color: var(--primary); font-weight: 700;">#RFP-2025-002</a></td>
                                    <td><strong>Kitchen Equipment Installation</strong></td>
                                    <td>Delilah LA</td>
                                    <td>Installation</td>
                                    <td>Sep 15, 2025</td>
                                    <td>$25K - $40K</td>
                                    <td><span class="status-badge requested">Requested</span></td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="markInterested('RFP-2025-002')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Interested</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><a href="#" onclick="viewRFPDetail('RFP-2025-003'); return false;" style="color: var(--primary); font-weight: 700;">#RFP-2025-003</a></td>
                                    <td><strong>Annual Plumbing Services</strong></td>
                                    <td>Bootsy Bellows</td>
                                    <td>Service Contract</td>
                                    <td>Sep 30, 2025</td>
                                    <td>$100K - $150K</td>
                                    <td><span class="status-badge" style="background: #fef3c7; color: #92400e;">Interested</span></td>
                                    <td>
                                        <button class="btn btn-primary" onclick="submitProposal('RFP-2025-003')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Submit</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><a href="#" onclick="viewRFPDetail('RFP-2025-004'); return false;" style="color: var(--primary); font-weight: 700;">#RFP-2025-004</a></td>
                                    <td><strong>Electrical System Upgrade</strong></td>
                                    <td>Nice Guy</td>
                                    <td>Construction</td>
                                    <td>Oct 10, 2025</td>
                                    <td>$200K - $300K</td>
                                    <td><span class="status-badge completed">Submitted</span></td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="viewSubmission('RFP-2025-004')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><a href="#" onclick="viewRFPDetail('RFP-2025-005'); return false;" style="color: var(--primary); font-weight: 700;">#RFP-2025-005</a></td>
                                    <td><strong>Painting & Renovation</strong></td>
                                    <td>Poppy</td>
                                    <td>Renovation</td>
                                    <td>Oct 20, 2025</td>
                                    <td>$75K - $100K</td>
                                    <td><span class="status-badge completed">Submitted</span></td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="viewSubmission('RFP-2025-005')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">View</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><a href="#" onclick="viewRFPDetail('RFP-2025-006'); return false;" style="color: var(--primary); font-weight: 700;">#RFP-2025-006</a></td>
                                    <td><strong>Security System Installation</strong></td>
                                    <td>Multiple Locations</td>
                                    <td>Installation</td>
                                    <td>Nov 1, 2025</td>
                                    <td>$150K - $200K</td>
                                    <td><span class="status-badge" style="background: #fef3c7; color: #92400e;">Under Review</span></td>
                                    <td>
                                        <button class="btn btn-secondary" disabled style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Pending</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><a href="#" onclick="viewRFPDetail('RFP-2024-098'); return false;" style="color: var(--primary); font-weight: 700;">#RFP-2024-098</a></td>
                                    <td><strong>Landscaping Services</strong></td>
                                    <td>The h.wood Group</td>
                                    <td>Maintenance</td>
                                    <td style="color: var(--gray-500);">Jul 15, 2024</td>
                                    <td>$60K - $80K</td>
                                    <td><span class="status-badge" style="background: #d1fae5; color: #065f46;">Awarded</span></td>
                                    <td>
                                        <button class="btn btn-success" onclick="viewContract('RFP-2024-098')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: var(--success); color: white;">Contract</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><a href="#" onclick="viewRFPDetail('RFP-2024-097'); return false;" style="color: var(--primary); font-weight: 700;">#RFP-2024-097</a></td>
                                    <td><strong>Fire Safety Equipment</strong></td>
                                    <td>Delilah LA</td>
                                    <td>Equipment</td>
                                    <td style="color: var(--gray-500);">Jun 30, 2024</td>
                                    <td>$40K - $60K</td>
                                    <td><span class="status-badge" style="background: #d1fae5; color: #065f46;">Awarded</span></td>
                                    <td>
                                        <button class="btn btn-success" onclick="viewContract('RFP-2024-097')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; background: var(--success); color: white;">Contract</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><a href="#" onclick="viewRFPDetail('RFP-2024-096'); return false;" style="color: var(--primary); font-weight: 700;">#RFP-2024-096</a></td>
                                    <td><strong>Roofing Repairs</strong></td>
                                    <td>Bootsy Bellows</td>
                                    <td>Repair</td>
                                    <td style="color: var(--gray-500);">Jun 15, 2024</td>
                                    <td>$30K - $50K</td>
                                    <td><span class="status-badge" style="background: #fee2e2; color: #991b1b;">Declined</span></td>
                                    <td>
                                        <button class="btn btn-secondary" disabled style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Closed</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><a href="#" onclick="viewRFPDetail('RFP-2025-007'); return false;" style="color: var(--primary); font-weight: 700;">#RFP-2025-007</a></td>
                                    <td><strong>Window Cleaning Services</strong></td>
                                    <td>Nice Guy</td>
                                    <td>Service</td>
                                    <td>Sep 5, 2025</td>
                                    <td>$15K - $25K</td>
                                    <td><span class="status-badge requested">Requested</span></td>
                                    <td>
                                        <button class="btn btn-primary" onclick="submitProposal('RFP-2025-007')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Submit</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // Modal Functions
        function openScheduleModal() {
            const modal = document.getElementById('scheduleModal');
            if (modal) {
                modal.classList.add('active');
            }
        }
        
        function closeScheduleModal() {
            const modal = document.getElementById('scheduleModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        async function submitSchedule() {
            // Get form values
            const leadTech = document.getElementById('leadTech').value;
            const additionalTechs = document.getElementById('additionalTechs').value;
            const scheduledDate = document.getElementById('scheduledDate').value;
            const stockLocations = document.getElementById('stockLocations').value;
            
            if (!scheduledDate) {
                alert('Please select a scheduled arrival time');
                return;
            }
            
            // Format scheduled date for email
            const dateObj = new Date(scheduledDate);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeWindow = dateObj.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit', 
                hour12: true 
            }) + ' - ' + 
            new Date(dateObj.getTime() + 2 * 60 * 60 * 1000).toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit', 
                hour12: true 
            });
            
            // Prepare work order data for email
            const workOrderData = {
                orderNumber: 'WO-' + Math.floor(Math.random() * 100000).toString().padStart(6, '0'),
                clientName: 'Customer Name', // This would come from the actual work order
                location: 'Service Location', // This would come from the actual work order  
                service: 'Service Type', // This would come from the actual work order
                date: formattedDate,
                timeWindow: timeWindow,
                estimatedCost: '$650.00', // This would come from the actual work order
                clientEmail: 'customer@example.com' // This would come from the actual work order
            };
            
            try {
                // Send scheduled email notification
                await sendWorkOrderScheduledEmail(workOrderData);
                console.log('Work order scheduled email sent successfully');
            } catch (error) {
                console.error('Failed to send scheduled email:', error);
                // Continue with scheduling even if email fails
            }
            
            // Here you would typically send this data to your backend
            console.log('Schedule submitted:', {
                leadTech,
                additionalTechs,
                scheduledDate,
                stockLocations
            });
            
            // Update all Schedule buttons to Reschedule
            const scheduleButtons = document.querySelectorAll('button[onclick*="schedule"]');
            scheduleButtons.forEach(button => {
                if (button.textContent.includes('Schedule') || button.textContent.includes('SCHEDULE')) {
                    button.textContent = 'Reschedule';
                }
            });
            
            // Update Next Step section if it exists
            const nextStepContainer = document.querySelector('.table-container[style*="border-left: 4px solid"]');
            if (nextStepContainer) {
                const nextStepContent = nextStepContainer.querySelector('div > div');
                if (nextStepContent) {
                    nextStepContent.innerHTML = `
                        <div>
                            <h3 style="font-size: 1rem; font-weight: 600; color: var(--gray-900); margin-bottom: 0.25rem;">Next Step</h3>
                            <p style="font-size: 0.875rem; color: var(--gray-600);">Tech needs to start work and head to location</p>
                        </div>
                        <button class="btn btn-primary" onclick="handleWorkOrderAction(this, 'start')">Start Work</button>
                    `;
                }
            }
            
            alert('Service scheduled successfully! Customer has been notified by email.');
            closeScheduleModal();
        }
        
        function openCheckoutModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>Complete Work Order & Generate Invoice</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                        <form id="checkoutForm" onsubmit="completeWorkOrderAndGenerateInvoice(event)">
                            <!-- Work Summary -->
                            <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                                <h4 style="font-weight: 600; margin-bottom: 0.75rem;">Work Order Summary</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                                    <div>
                                        <strong>Order #:</strong> WO-2024-001<br>
                                        <strong>Client:</strong> Lodge Bread - Downtown<br>
                                        <strong>Service:</strong> HVAC Repair
                                    </div>
                                    <div>
                                        <strong>Check In:</strong> 10:30 AM<br>
                                        <strong>Check Out:</strong> <span id="checkoutTime">--:--</span><br>
                                        <strong>Duration:</strong> <span id="workDuration">--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Work Performed -->
                            <div class="form-group">
                                <label style="font-weight: 600;">Work Performed</label>
                                <textarea required rows="4" placeholder="Describe the work completed..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;"></textarea>
                            </div>
                            
                            <!-- Parts & Materials -->
                            <div class="form-group">
                                <label style="font-weight: 600;">Parts & Materials Used</label>
                                <div id="partsContainer" style="margin-bottom: 0.5rem;">
                                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="text" placeholder="Part name" style="flex: 2; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                        <input type="number" placeholder="Qty" style="flex: 1; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                        <input type="number" placeholder="Price" step="0.01" style="flex: 1; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                                        <button type="button" onclick="addPartRow()" class="btn btn-secondary" style="padding: 0.5rem 1rem;">+</button>
                                    </div>
                                </div>
                                <button type="button" onclick="addPartRow()" class="btn btn-secondary" style="font-size: 0.875rem;">+ Add Part</button>
                            </div>
                            
                            <!-- Labor -->
                            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label style="font-weight: 600;">Labor Hours</label>
                                    <input type="number" id="laborHours" step="0.5" required placeholder="2.5" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;" onchange="calculateInvoiceTotal()">
                                </div>
                                <div class="form-group">
                                    <label style="font-weight: 600;">Hourly Rate</label>
                                    <input type="number" id="hourlyRate" value="85" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;" onchange="calculateInvoiceTotal()">
                                </div>
                            </div>
                            
                            <!-- Invoice As Option -->
                            <div class="form-group" style="margin-top: 1.5rem;">
                                <label style="font-weight: 600;">Invoice As</label>
                                <div style="display: flex; gap: 1rem; align-items: center;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="radio" name="invoiceAs" value="spruce" checked style="margin-right: 8px;">
                                        <span>Invoice as Hey Spruce (Platform)</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="radio" name="invoiceAs" value="vendor" style="margin-right: 8px;">
                                        <span>Invoice as Vendor/Subcontractor</span>
                                    </label>
                                </div>
                                <div id="vendorSelectContainer" style="display: none; margin-top: 0.5rem;">
                                    <select id="vendorSelect" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                                        <option value="">Select vendor...</option>
                                        <option value="abc-maintenance">ABC Maintenance Services</option>
                                        <option value="xyz-electric">XYZ Electric Co.</option>
                                        <option value="quick-plumbing">Quick Plumbing Solutions</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Invoice Totals -->
                            <div style="background: white; border: 2px solid var(--primary); border-radius: 8px; padding: 1rem; margin-top: 1.5rem;">
                                <h4 style="font-weight: 600; margin-bottom: 1rem; color: var(--primary);">Invoice Summary</h4>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Labor:</span>
                                        <span id="laborTotal">$0.00</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Parts & Materials:</span>
                                        <span id="partsTotal">$0.00</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid var(--gray-200);">
                                        <span>Subtotal:</span>
                                        <span id="subtotal">$0.00</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>Platform Fee:</span>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <input type="number" id="platformFeePercent" value="15" min="0" max="100" step="0.5" style="width: 60px; padding: 0.25rem; border: 1px solid var(--gray-300); border-radius: 4px;" onchange="calculateInvoiceTotal()">
                                            <span>% = $<span id="platformFeeAmount">0.00</span></span>
                                        </div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 1.125rem; padding-top: 0.5rem; border-top: 2px solid var(--primary);">
                                        <span>Total Invoice Amount:</span>
                                        <span id="invoiceTotal" style="color: var(--primary);">$0.00</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Customer Signature -->
                            <div class="form-group" style="margin-top: 1.5rem;">
                                <label style="font-weight: 600;">Customer Signature (Optional)</label>
                                <div style="border: 2px dashed var(--gray-300); border-radius: 8px; height: 150px; background: var(--gray-50); position: relative;">
                                    <canvas id="signaturePad" width="400" height="150" style="width: 100%; height: 100%; border-radius: 8px;"></canvas>
                                    <button type="button" onclick="clearSignature()" style="position: absolute; top: 10px; right: 10px; background: white; border: 1px solid var(--gray-300); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Clear</button>
                                </div>
                            </div>
                            
                            <!-- Send Options -->
                            <div class="form-group">
                                <label style="font-weight: 600;">Invoice Delivery</label>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <label style="display: block; cursor: pointer;">
                                        <input type="checkbox" checked style="margin-right: 8px; vertical-align: middle;">
                                        <span style="vertical-align: middle;">Email invoice to client</span>
                                    </label>
                                    <label style="display: block; cursor: pointer;">
                                        <input type="checkbox" checked style="margin-right: 8px; vertical-align: middle;">
                                        <span style="vertical-align: middle;">Send copy to accounting</span>
                                    </label>
                                    <label style="display: block; cursor: pointer;">
                                        <input type="checkbox" style="margin-right: 8px; vertical-align: middle;">
                                        <span style="vertical-align: middle;">Request immediate payment</span>
                                    </label>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="document.getElementById('checkoutForm').dispatchEvent(new Event('submit'))">Complete & Generate Invoice</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Set checkout time
            const now = new Date();
            document.getElementById('checkoutTime').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Calculate duration (assuming check-in was 2 hours ago for demo)
            document.getElementById('workDuration').textContent = '2 hours 15 minutes';
            
            // Initialize signature pad
            initializeSignaturePad();
            
            // Calculate initial total
            calculateInvoiceTotal();
            
            // Handle invoice-as radio button changes
            document.querySelectorAll('input[name="invoiceAs"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const vendorContainer = document.getElementById('vendorSelectContainer');
                    if (this.value === 'vendor') {
                        vendorContainer.style.display = 'block';
                    } else {
                        vendorContainer.style.display = 'none';
                    }
                });
            });
        }
        window.openCheckoutModal = openCheckoutModal;
        
        function calculateInvoiceTotal() {
            const laborHours = parseFloat(document.getElementById('laborHours')?.value || 0);
            const hourlyRate = parseFloat(document.getElementById('hourlyRate')?.value || 85);
            const laborTotal = laborHours * hourlyRate;
            
            // Calculate parts total (would sum all part rows in real implementation)
            const partsTotal = 0; // Placeholder
            
            const subtotal = laborTotal + partsTotal;
            const platformFeePercent = parseFloat(document.getElementById('platformFeePercent')?.value || 15);
            const platformFee = subtotal * (platformFeePercent / 100);
            const total = subtotal + platformFee;
            
            // Update displays
            document.getElementById('laborTotal').textContent = `$${laborTotal.toFixed(2)}`;
            document.getElementById('partsTotal').textContent = `$${partsTotal.toFixed(2)}`;
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('platformFeeAmount').textContent = platformFee.toFixed(2);
            document.getElementById('invoiceTotal').textContent = `$${total.toFixed(2)}`;
        }
        window.calculateInvoiceTotal = calculateInvoiceTotal;
        
        function completeWorkOrderAndGenerateInvoice(event) {
            event.preventDefault();
            
            // Get invoice-as selection
            const invoiceAs = document.querySelector('input[name="invoiceAs"]:checked')?.value;
            let invoiceFrom = 'Hey Spruce';
            
            if (invoiceAs === 'vendor') {
                const vendorSelect = document.getElementById('vendorSelect');
                const selectedVendor = vendorSelect.options[vendorSelect.selectedIndex]?.text;
                if (selectedVendor && selectedVendor !== 'Select vendor...') {
                    invoiceFrom = selectedVendor;
                } else {
                    showToast('Please select a vendor when invoicing as vendor', 'warning');
                    return;
                }
            }
            
            // Generate invoice number
            const invoiceNumber = `INV-${new Date().getFullYear()}-${Math.floor(Math.random() * 10000).toString().padStart(4, '0')}`;
            
            showToast(`Work order completed! Invoice ${invoiceNumber} generated from ${invoiceFrom} and sent.`, 'success');
            
            // Update the work order status in the table
            const activeRow = document.querySelector('tr[data-active="true"]');
            if (activeRow) {
                activeRow.cells[4].innerHTML = '<span class="status-badge completed">Completed</span>';
                activeRow.cells[5].innerHTML = `<span style="font-size: 0.8125rem; color: #6b7280;">Invoiced (${invoiceFrom})</span>`;
            }
            
            // Store invoice data for later reference
            const invoiceData = {
                invoiceNumber: invoiceNumber,
                invoiceFrom: invoiceFrom,
                invoiceAs: invoiceAs,
                vendorId: invoiceAs === 'vendor' ? document.getElementById('vendorSelect').value : null,
                total: document.getElementById('invoiceTotal').textContent,
                platformFee: document.getElementById('platformFeeAmount').textContent,
                timestamp: new Date().toISOString()
            };
            
            // Save to localStorage for demo
            let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            invoices.push(invoiceData);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            
            // Close modal
            document.querySelector('.modal.active').remove();
            
            // In a real app, this would:
            // 1. Save the work order completion details
            // 2. Generate and save the invoice with proper "invoice from" details
            // 3. Send invoice via email from the appropriate entity
            // 4. Update the database with vendor/platform invoice details
            // 5. Handle Stripe Connect payments if vendor invoice
        }
        window.completeWorkOrderAndGenerateInvoice = completeWorkOrderAndGenerateInvoice;
        
        function addPartRow() {
            const container = document.getElementById('partsContainer');
            const newRow = document.createElement('div');
            newRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
            newRow.innerHTML = `
                <input type="text" placeholder="Part name" style="flex: 2; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                <input type="number" placeholder="Qty" style="flex: 1; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;">
                <input type="number" placeholder="Price" step="0.01" style="flex: 1; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 4px;" onchange="calculateInvoiceTotal()">
                <button type="button" onclick="this.parentElement.remove(); calculateInvoiceTotal();" class="btn btn-danger" style="padding: 0.5rem 1rem;">−</button>
            `;
            container.appendChild(newRow);
        }
        window.addPartRow = addPartRow;
        
        function initializeSignaturePad() {
            const canvas = document.getElementById('signaturePad');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
            
            function startDrawing(e) {
                isDrawing = true;
                draw(e);
            }
            
            function draw(e) {
                if (!isDrawing) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const y = (e.clientY || e.touches[0].clientY) - rect.top;
                
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = '#000';
                
                ctx.lineTo(x * (canvas.width / rect.width), y * (canvas.height / rect.height));
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x * (canvas.width / rect.width), y * (canvas.height / rect.height));
            }
            
            function stopDrawing() {
                isDrawing = false;
                ctx.beginPath();
            }
        }
        
        function clearSignature() {
            const canvas = document.getElementById('signaturePad');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }
        
        // RFP Management Functions
        function switchRFPTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.rfp-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.style.borderBottom = '3px solid transparent';
                btn.style.color = 'var(--gray-600)';
            });
            
            // Show selected tab
            switch(tab) {
                case 'incoming':
                    document.getElementById('incomingRFPsTab').style.display = 'block';
                    break;
                case 'outgoing':
                    document.getElementById('outgoingBidsTab').style.display = 'block';
                    break;
                case 'awarded':
                    document.getElementById('awardedContractsTab').style.display = 'block';
                    break;
            }
            
            // Set active button style
            event.target.style.borderBottom = '3px solid var(--primary)';
            event.target.style.color = 'var(--primary)';
        }
        window.switchRFPTab = switchRFPTab;
        
        function sendToBidders(rfpId) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>Send RFP to Bidders</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: var(--gray-50); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <h4 style="font-weight: 600; margin-bottom: 0.5rem;">RFP Details</h4>
                            <div style="font-size: 0.875rem;">
                                <strong>RFP #:</strong> ${rfpId}<br>
                                <strong>Client:</strong> Lodge Bread<br>
                                <strong>Service:</strong> HVAC System Upgrade<br>
                                <strong>Budget:</strong> $15,000 - $25,000
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label style="font-weight: 600;">Select Vendors to Invite</label>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 300px; overflow-y: auto; padding: 1rem; background: white; border: 1px solid var(--gray-200); border-radius: 8px;">
                                <label style="display: flex; align-items: center; padding: 0.75rem; border: 1px solid var(--gray-200); border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" checked style="margin-right: 0.75rem;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600;">Seattle HVAC Pro</div>
                                        <div style="font-size: 0.75rem; color: var(--gray-600);">4.8★ • HVAC Specialist • 245 jobs completed</div>
                                    </div>
                                    <span style="color: var(--success);">Preferred</span>
                                </label>
                                <label style="display: flex; align-items: center; padding: 0.75rem; border: 1px solid var(--gray-200); border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" checked style="margin-right: 0.75rem;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600;">CoolTech Services</div>
                                        <div style="font-size: 0.75rem; color: var(--gray-600);">4.5★ • Refrigeration Expert • 156 jobs completed</div>
                                    </div>
                                </label>
                                <label style="display: flex; align-items: center; padding: 0.75rem; border: 1px solid var(--gray-200); border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" style="margin-right: 0.75rem;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600;">Elite Mechanical</div>
                                        <div style="font-size: 0.75rem; color: var(--gray-600);">4.7★ • Commercial HVAC • 189 jobs completed</div>
                                    </div>
                                </label>
                                <label style="display: flex; align-items: center; padding: 0.75rem; border: 1px solid var(--gray-200); border-radius: 6px; cursor: pointer;">
                                    <input type="checkbox" style="margin-right: 0.75rem;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600;">QuickFix HVAC</div>
                                        <div style="font-size: 0.75rem; color: var(--gray-600);">4.2★ • General HVAC • 67 jobs completed</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label style="font-weight: 600;">Bid Submission Deadline</label>
                            <input type="datetime-local" style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
                        </div>
                        
                        <div class="form-group">
                            <label style="font-weight: 600;">Additional Instructions for Bidders</label>
                            <textarea rows="3" placeholder="Any special requirements or instructions..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="sendRFPToBidders('${rfpId}')">Send to Selected Vendors</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        window.sendToBidders = sendToBidders;
        
        function sendRFPToBidders(rfpId) {
            showToast(`RFP ${rfpId} sent to selected vendors! They will receive email notifications.`, 'success');
            document.querySelector('.modal.active').remove();
            
            // Update the RFP status in the table
            // In a real app, this would update the database
        }
        window.sendRFPToBidders = sendRFPToBidders;
        
        function compareBids(rfpId) {
            // This would open a modal showing side-by-side bid comparison
            showToast(`Opening bid comparison for ${rfpId}...`, 'info');
        }
        window.compareBids = compareBids;
        
        function viewRFPDetails(rfpId) {
            // This would show full RFP details
            showToast(`Opening details for ${rfpId}...`, 'info');
        }
        window.viewRFPDetails = viewRFPDetails;
        
        function closeCheckoutModal() {
            const modal = document.getElementById('checkoutModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        function submitCheckout() {
            // Get form values
            const checkoutStatus = document.getElementById('checkoutStatus').value;
            const numTechs = document.getElementById('numTechs').value;
            const checkoutDate = document.getElementById('checkoutDate').value;
            const notes = document.getElementById('checkoutNotes').value;
            
            if (!checkoutStatus) {
                alert('Please select check out status');
                return;
            }
            
            if (!checkoutDate) {
                alert('Please select checked out time');
                return;
            }
            
            // Here you would typically send this data to your backend
            console.log('Checkout submitted:', {
                checkoutStatus,
                numTechs,
                checkoutDate,
                notes
            });
            
            // Update Next Step section if it exists
            const nextStepContainer = document.querySelector('.table-container[style*="border-left: 4px solid"]');
            if (nextStepContainer) {
                const nextStepContent = nextStepContainer.querySelector('div > div');
                if (nextStepContent) {
                    nextStepContent.innerHTML = `
                        <div>
                            <h3 style="font-size: 1rem; font-weight: 600; color: var(--success); margin-bottom: 0.25rem;">Work Complete</h3>
                            <p style="font-size: 0.875rem; color: var(--gray-600);">Work has been completed. Ready for invoicing.</p>
                        </div>
                        <button class="btn btn-primary" onclick="createInvoice(document.querySelector('h2').textContent.match(/\\d+/)[0])">Create Invoice</button>
                    `;
                }
            }
            
            alert('Checked out successfully!');
            closeCheckoutModal();
        }
        
        function openCheckinModal() {
            const modal = document.getElementById('checkinModal');
            if (modal) {
                modal.classList.add('active');
            }
        }
        
        function closeCheckinModal() {
            const modal = document.getElementById('checkinModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        function submitCheckin() {
            // Get form values
            const checkinDate = document.getElementById('checkinDate').value;
            const notes = document.getElementById('checkinNotes').value;
            
            if (!checkinDate) {
                alert('Please select checked in time');
                return;
            }
            
            // Here you would typically send this data to your backend
            console.log('Checkin submitted:', {
                checkinDate,
                notes
            });
            
            // Update UI to show Check Out button
            const activeButtons = document.querySelectorAll('button[onclick*="checkin"]');
            activeButtons.forEach(button => {
                button.textContent = 'Check Out';
                button.setAttribute('onclick', button.getAttribute('onclick').replace('checkin', 'checkout'));
                button.className = 'btn btn-secondary';
                button.style.cssText = 'padding: 0.2rem 0.4rem; font-size: 0.75rem; width: 75px;';
            });
            
            // Update Next Step section if it exists
            const nextStepContainer = document.querySelector('.table-container[style*="border-left: 4px solid"]');
            if (nextStepContainer) {
                const nextStepContent = nextStepContainer.querySelector('div > div');
                if (nextStepContent) {
                    nextStepContent.innerHTML = `
                        <div>
                            <h3 style="font-size: 1rem; font-weight: 600; color: var(--gray-900); margin-bottom: 0.25rem;">Next Step</h3>
                            <p style="font-size: 0.875rem; color: var(--gray-600);">Complete work and check out when finished</p>
                        </div>
                        <button class="btn btn-primary" onclick="openCheckoutModal()">Check Out</button>
                    `;
                }
            }
            
            alert('Checked in successfully!');
            closeCheckinModal();
        }
        
        function getCustomerFeedbackContent() {
            return `
                <div class="header-bar">
                    <h1 class="header-title">Customer Feedback & Ratings</h1>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="exportFeedback()">
                            📊 Export Report
                        </button>
                        <button class="btn btn-primary" onclick="showResponseTemplates()">
                            📝 Response Templates
                        </button>
                    </div>
                </div>
                
                <!-- Overall Rating Overview -->
                <div class="stats-grid" style="margin-bottom: 2rem;">
                    <div class="stat-card">
                        <div class="stat-value" style="display: flex; align-items: center; gap: 0.5rem;">
                            4.8
                            <span style="color: var(--warning); font-size: 1.5rem;">⭐</span>
                        </div>
                        <div class="stat-label">Overall Rating</div>
                        <div class="stat-change positive">+0.3 from last month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">156</div>
                        <div class="stat-label">Total Reviews</div>
                        <div class="stat-change">23 this month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">94%</div>
                        <div class="stat-label">Response Rate</div>
                        <div class="stat-change positive">Above industry avg</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">2.4h</div>
                        <div class="stat-label">Avg Response Time</div>
                        <div class="stat-change positive">-30min improvement</div>
                    </div>
                </div>
                
                <!-- Rating Distribution -->
                <div class="table-container" style="margin-bottom: 2rem;">
                    <div class="table-header">
                        <h3 class="table-title">Rating Distribution</h3>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="display: grid; gap: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="width: 60px;">5 stars</span>
                                <div style="flex: 1; background: var(--gray-200); height: 24px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: var(--success); height: 100%; width: 72%; display: flex; align-items: center; padding-left: 0.5rem;">
                                        <span style="color: white; font-size: 0.875rem; font-weight: 600;">112 (72%)</span>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="width: 60px;">4 stars</span>
                                <div style="flex: 1; background: var(--gray-200); height: 24px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: var(--primary); height: 100%; width: 18%; display: flex; align-items: center; padding-left: 0.5rem;">
                                        <span style="color: white; font-size: 0.875rem; font-weight: 600;">28 (18%)</span>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="width: 60px;">3 stars</span>
                                <div style="flex: 1; background: var(--gray-200); height: 24px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: var(--warning); height: 100%; width: 6%; display: flex; align-items: center; padding-left: 0.5rem;">
                                        <span style="color: white; font-size: 0.875rem; font-weight: 600;">10</span>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="width: 60px;">2 stars</span>
                                <div style="flex: 1; background: var(--gray-200); height: 24px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: var(--warning); height: 100%; width: 3%; display: flex; align-items: center; padding-left: 0.5rem;">
                                        <span style="color: white; font-size: 0.875rem; font-weight: 600;">4</span>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="width: 60px;">1 star</span>
                                <div style="flex: 1; background: var(--gray-200); height: 24px; border-radius: 4px; overflow: hidden;">
                                    <div style="background: var(--danger); height: 100%; width: 1%; display: flex; align-items: center; padding-left: 0.5rem;">
                                        <span style="color: white; font-size: 0.875rem; font-weight: 600;">2</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Reviews -->
                <div class="table-container">
                    <div class="table-header">
                        <h3 class="table-title">Recent Customer Reviews</h3>
                        <select class="form-select" style="width: 150px;" onchange="sortReviews(this.value)">
                            <option>Most Recent</option>
                            <option>Highest Rated</option>
                            <option>Lowest Rated</option>
                            <option>Needs Response</option>
                        </select>
                    </div>
                    <div style="padding: 1.5rem;">
                        <!-- Review Item 1 -->
                        <div style="border-bottom: 1px solid var(--gray-200); padding-bottom: 1.5rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <strong>McDonald's - Sunset Blvd</strong>
                                        <span style="color: var(--warning);">⭐⭐⭐⭐⭐</span>
                                        <span class="badge badge-success">Responded</span>
                                    </div>
                                    <div style="font-size: 0.875rem; color: var(--gray-600); margin-top: 0.25rem;">
                                        John Smith • WO #2024-1523 • Nov 28, 2024
                                    </div>
                                </div>
                                <button class="btn btn-sm" onclick="viewFeedbackDetails(1)">View Details</button>
                            </div>
                            <p style="color: var(--gray-700); margin: 0.75rem 0;">
                                "Excellent service! The HVAC team arrived on time and fixed our AC unit within 2 hours. Very professional and cleaned up after themselves. Highly recommend!"
                            </p>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <span style="font-size: 0.875rem; color: var(--gray-600);">Service: HVAC Repair</span>
                                <span style="font-size: 0.875rem; color: var(--gray-600);">Response Time: 1.5 hours</span>
                                <span style="font-size: 0.875rem; color: var(--gray-600);">Cost: $450</span>
                            </div>
                            <div style="background: var(--gray-50); padding: 0.75rem; border-radius: 6px; margin-top: 0.75rem;">
                                <div style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">Your Response:</div>
                                <p style="font-size: 0.875rem; color: var(--gray-700); margin: 0;">
                                    "Thank you for your wonderful feedback! We're thrilled to hear that our team provided excellent service. We look forward to serving you again!"
                                </p>
                            </div>
                        </div>
                        
                        <!-- Review Item 2 -->
                        <div style="border-bottom: 1px solid var(--gray-200); padding-bottom: 1.5rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <strong>Burger King - Melrose</strong>
                                        <span style="color: var(--warning);">⭐⭐⭐⭐</span>
                                        <span class="badge badge-warning">Pending Response</span>
                                    </div>
                                    <div style="font-size: 0.875rem; color: var(--gray-600); margin-top: 0.25rem;">
                                        Sarah Johnson • WO #2024-1519 • Nov 27, 2024
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm btn-primary" onclick="respondToFeedback(2)">Respond</button>
                                    <button class="btn btn-sm" onclick="viewFeedbackDetails(2)">View Details</button>
                                </div>
                            </div>
                            <p style="color: var(--gray-700); margin: 0.75rem 0;">
                                "Good service overall. The plumber fixed the issue but arrived 30 minutes late. Work was done well and the area was cleaned up nicely."
                            </p>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <span style="font-size: 0.875rem; color: var(--gray-600);">Service: Plumbing</span>
                                <span style="font-size: 0.875rem; color: var(--gray-600);">Response Time: 2.5 hours</span>
                                <span style="font-size: 0.875rem; color: var(--gray-600);">Cost: $320</span>
                            </div>
                        </div>
                        
                        <!-- Review Item 3 -->
                        <div style="border-bottom: 1px solid var(--gray-200); padding-bottom: 1.5rem; margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                                <div>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <strong>Delilah LA</strong>
                                        <span style="color: var(--warning);">⭐⭐⭐</span>
                                        <span class="badge badge-danger">Needs Attention</span>
                                    </div>
                                    <div style="font-size: 0.875rem; color: var(--gray-600); margin-top: 0.25rem;">
                                        Mike Wilson • WO #2024-1515 • Nov 26, 2024
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button class="btn btn-sm btn-primary" onclick="respondToFeedback(3)">Respond</button>
                                    <button class="btn btn-sm" onclick="escalateFeedback(3)">Escalate</button>
                                </div>
                            </div>
                            <p style="color: var(--gray-700); margin: 0.75rem 0;">
                                "The electrical work was completed but took much longer than quoted. Communication could have been better about the delays."
                            </p>
                            <div style="display: flex; gap: 1rem; align-items: center;">
                                <span style="font-size: 0.875rem; color: var(--gray-600);">Service: Electrical</span>
                                <span style="font-size: 0.875rem; color: var(--gray-600);">Response Time: 4 hours</span>
                                <span style="font-size: 0.875rem; color: var(--gray-600);">Cost: $680</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Insights -->
                <div class="table-container" style="margin-top: 2rem;">
                    <div class="table-header">
                        <h3 class="table-title">Performance Insights</h3>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                            <div>
                                <h4 style="margin-bottom: 0.75rem;">Top Performing Categories</h4>
                                <div style="display: grid; gap: 0.5rem;">
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--gray-50); border-radius: 4px;">
                                        <span>HVAC Services</span>
                                        <strong>4.9 ⭐</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--gray-50); border-radius: 4px;">
                                        <span>Emergency Response</span>
                                        <strong>4.8 ⭐</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--gray-50); border-radius: 4px;">
                                        <span>Preventive Maintenance</span>
                                        <strong>4.7 ⭐</strong>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 0.75rem;">Areas for Improvement</h4>
                                <div style="display: grid; gap: 0.5rem;">
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--warning-light); border-radius: 4px;">
                                        <span>Communication</span>
                                        <strong>3.8 ⭐</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--warning-light); border-radius: 4px;">
                                        <span>Punctuality</span>
                                        <strong>4.1 ⭐</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--warning-light); border-radius: 4px;">
                                        <span>Cost Transparency</span>
                                        <strong>4.2 ⭐</strong>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 0.75rem;">Customer Sentiment</h4>
                                <div style="display: grid; gap: 0.5rem;">
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--gray-50); border-radius: 4px;">
                                        <span>Would Recommend</span>
                                        <strong>92%</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--gray-50); border-radius: 4px;">
                                        <span>Repeat Customers</span>
                                        <strong>78%</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: var(--gray-50); border-radius: 4px;">
                                        <span>NPS Score</span>
                                        <strong>+62</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function respondToFeedback(id) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="this.parentElement.remove()"></div>
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2>Respond to Customer Feedback</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: var(--gray-50); padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <strong>Burger King - Melrose</strong>
                                <span style="color: var(--warning);">⭐⭐⭐⭐</span>
                            </div>
                            <p style="color: var(--gray-700); margin: 0;">
                                "Good service overall. The plumber fixed the issue but arrived 30 minutes late. Work was done well and the area was cleaned up nicely."
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <label>Response Templates</label>
                            <select class="form-select" onchange="loadResponseTemplate(this.value)">
                                <option value="">Select a template...</option>
                                <option value="positive">Thank You - Positive</option>
                                <option value="apology">Apology - Service Issue</option>
                                <option value="explanation">Explanation - Delay</option>
                                <option value="custom">Custom Response</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Your Response</label>
                            <textarea id="responseText" class="form-input" rows="6" placeholder="Type your response to the customer..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" checked>
                                Mark as resolved after sending
                            </label>
                        </div>
                        
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                            <button class="btn btn-primary" onclick="sendFeedbackResponse()">Send Response</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function loadResponseTemplate(template) {
            const responseText = document.getElementById('responseText');
            if (!responseText) return;
            
            switch(template) {
                case 'positive':
                    responseText.value = "Thank you so much for your wonderful feedback! We're delighted to hear that you had a great experience with our service. Your satisfaction is our top priority, and we look forward to serving you again soon!";
                    break;
                case 'apology':
                    responseText.value = "Thank you for taking the time to share your feedback. We sincerely apologize for not meeting your expectations. Your experience is important to us, and we're taking immediate steps to address the issues you've raised. We'd appreciate the opportunity to make this right.";
                    break;
                case 'explanation':
                    responseText.value = "Thank you for your feedback. We apologize for the delay in our arrival. Due to an emergency at another location, our technician was delayed. We understand how valuable your time is and are implementing better communication protocols to keep you informed of any delays in the future. We appreciate your patience and understanding.";
                    break;
                case 'custom':
                    responseText.value = "";
                    break;
            }
        }
        
        function sendFeedbackResponse() {
            showToast('Response sent successfully to customer', 'success');
            document.querySelector('.modal').remove();
        }
        
        function viewFeedbackDetails(id) {
            alert('Opening detailed feedback view...');
        }
        
        function escalateFeedback(id) {
            if (confirm('Escalate this feedback to management for review?')) {
                showToast('Feedback escalated to management', 'info');
            }
        }
        
        function showResponseTemplates() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="this.parentElement.remove()"></div>
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h2>Response Templates</h2>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 1rem;">
                            <button class="btn btn-primary btn-sm" onclick="createNewTemplate()">+ Create New Template</button>
                        </div>
                        
                        <div style="display: grid; gap: 1rem;">
                            <div style="border: 1px solid var(--gray-200); border-radius: 6px; padding: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <strong>Thank You - Positive</strong>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-sm" onclick="editTemplate(1)">Edit</button>
                                        <button class="btn btn-sm" onclick="deleteTemplate(1)">Delete</button>
                                    </div>
                                </div>
                                <p style="color: var(--gray-700); font-size: 0.875rem; margin: 0;">
                                    Thank you so much for your wonderful feedback! We're delighted to hear that you had a great experience...
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function exportFeedback() {
            showToast('Exporting customer feedback report...', 'info');
            setTimeout(() => {
                showToast('Feedback report exported successfully', 'success');
            }, 2000);
        }
    </script>
    
    <!-- Schedule Service Modal -->
    <div id="scheduleModal" class="modal-overlay" onclick="if(event.target === this) closeScheduleModal()">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Schedule Service</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="leadTech">Lead Technician</label>
                    <select id="leadTech">
                        <option value="">Select technician...</option>
                        <option value="tech1">John Smith</option>
                        <option value="tech2">Jane Doe</option>
                        <option value="tech3">Mike Johnson</option>
                        <option value="tech4">Sarah Williams</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="additionalTechs">Additional Technicians</label>
                    <textarea id="additionalTechs" placeholder="Enter additional technician names..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="scheduledDate">
                        <span class="required-field">*</span> Scheduled Arrival Time
                    </label>
                    <input type="datetime-local" id="scheduledDate" required>
                </div>
                
                <div class="form-group">
                    <label for="stockLocations">Stock Locations</label>
                    <textarea id="stockLocations" placeholder="Enter stock locations..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeScheduleModal()">CANCEL</button>
                <button class="btn btn-primary" onclick="submitSchedule()">SCHEDULE</button>
            </div>
        </div>
    </div>
    
    <!-- Remote Check Out Modal -->
    <div id="checkoutModal" class="modal-overlay" onclick="if(event.target === this) closeCheckoutModal()">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Remote Check Out</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="checkoutStatus">
                        <span class="required-field">*</span> Check Out Status
                    </label>
                    <select id="checkoutStatus" required>
                        <option value="">Select status...</option>
                        <option value="work_complete">Work Complete</option>
                        <option value="partial_complete">Partially Complete</option>
                        <option value="requires_followup">Requires Follow-up</option>
                        <option value="unable_to_complete">Unable to Complete</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="numTechs">
                        <span class="required-field">*</span> Number of Techs
                    </label>
                    <input type="number" id="numTechs" value="1" min="1" required>
                </div>
                
                <div class="form-group">
                    <label for="checkoutDate">
                        <span class="required-field">*</span> Checked Out At
                    </label>
                    <input type="datetime-local" id="checkoutDate" required>
                </div>
                
                <div class="form-group">
                    <label for="afterPhotos">Add After Photos</label>
                    <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer;">
                        <div style="font-size: 2rem; color: #999;">+</div>
                        <div style="color: #666;">Upload</div>
                        <input type="file" id="afterPhotos" multiple accept="image/*" style="display: none;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="checkoutNotes">Notes</label>
                    <textarea id="checkoutNotes" placeholder="Enter any notes about the work completed..." rows="4"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCheckoutModal()">CANCEL</button>
                <button class="btn btn-primary" onclick="submitCheckout()">CHECK OUT</button>
            </div>
        </div>
    </div>
    
    <!-- Remote Check In Modal -->
    <div id="checkinModal" class="modal-overlay" onclick="if(event.target === this) closeCheckinModal()">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Remote Check In</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="checkinDate">
                        <span class="required-field">*</span> Checked In At
                    </label>
                    <input type="datetime-local" id="checkinDate" required>
                </div>
                
                <div class="form-group">
                    <label for="beforePhotos">Add Before Photos</label>
                    <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer;">
                        <div style="font-size: 2rem; color: #999;">+</div>
                        <div style="color: #666;">Upload</div>
                        <input type="file" id="beforePhotos" multiple accept="image/*" style="display: none;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="checkinNotes">Notes</label>
                    <textarea id="checkinNotes" placeholder="Enter any notes about arrival..." rows="4"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCheckinModal()">CANCEL</button>
                <button class="btn btn-primary" onclick="submitCheckin()">CHECK IN</button>
            </div>
        </div>
    </div>
    
    <!-- Subcontract Modal -->
    <div id="subcontractModal" class="modal-overlay" onclick="if(event.target === this) closeSubcontractModal()">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Assign to Subcontractor</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="subcontractor">
                        <span class="required-field">*</span> Select Subcontractor
                    </label>
                    <select id="subcontractor" required>
                        <option value="">Choose subcontractor...</option>
                        <option value="sub1">ABC Maintenance Services</option>
                        <option value="sub2">Quick Fix Solutions</option>
                        <option value="sub3">Pro Tech Services</option>
                        <option value="sub4">Elite Repairs LLC</option>
                        <option value="sub5">24/7 Emergency Services</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="agreedPrice">Agreed Price</label>
                    <input type="number" id="agreedPrice" placeholder="Enter agreed price..." step="0.01" min="0">
                </div>
                
                <div class="form-group">
                    <label for="subcontractDueDate">Due Date</label>
                    <input type="datetime-local" id="subcontractDueDate">
                </div>
                
                <div class="form-group">
                    <label for="assignmentNotes">Assignment Notes</label>
                    <textarea id="assignmentNotes" placeholder="Enter any special instructions or notes for the subcontractor..." rows="4"></textarea>
                </div>
                
                <div style="padding: 1rem; background: var(--gray-50); border-radius: 6px; margin-top: 1rem;">
                    <h4 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Work Order Details</h4>
                    <div style="font-size: 0.75rem; color: var(--gray-600);">
                        <div>Priority: Emergency - 4 Hrs</div>
                        <div>Location: Delilah LA</div>
                        <div>Issue: Door knob broken</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSubcontractModal()">CANCEL</button>
                <button class="btn btn-primary" onclick="submitSubcontract()">ASSIGN SUBCONTRACTOR</button>
            </div>
        </div>
    </div>
    
    <!-- Add Parts Modal -->
    <div id="addPartsModal" class="modal-overlay" onclick="if(event.target === this) closeAddPartsModal()">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add Parts</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="partName">
                        <span class="required-field">*</span> Part Name
                    </label>
                    <input type="text" id="partName" placeholder="Enter part name..." required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label for="partQuantity">
                            <span class="required-field">*</span> Quantity
                        </label>
                        <input type="number" id="partQuantity" value="1" min="1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="partCost">Cost per Unit</label>
                        <input type="number" id="partCost" placeholder="0.00" step="0.01" min="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="partSupplier">Supplier</label>
                    <input type="text" id="partSupplier" placeholder="Enter supplier name...">
                </div>
                
                <div class="form-group">
                    <label for="partNotes">Notes</label>
                    <textarea id="partNotes" placeholder="Enter any notes about this part..." rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddPartsModal()">CANCEL</button>
                <button class="btn btn-primary" onclick="addPart()">ADD PART</button>
            </div>
        </div>
    </div>
    
    <!-- Add Equipment Modal -->
    <div id="addEquipmentModal" class="modal-overlay" onclick="if(event.target === this) closeAddEquipmentModal()">
        <div class="modal">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2 class="modal-title">Add equipment</h2>
                <button onclick="closeAddEquipmentModal()" style="background: none; border: none; font-size: 1.5rem; color: var(--gray-400); cursor: pointer;">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="equipmentSelect">Equipment</label>
                    <select id="equipmentSelect" style="width: 100%; padding: 0.625rem 0.875rem; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 0.875rem;">
                        <option value="">Select equipment...</option>
                        <option value="hvac-unit-1">HVAC Unit - Rooftop #1</option>
                        <option value="hvac-unit-2">HVAC Unit - Rooftop #2</option>
                        <option value="walk-in-freezer">Walk-in Freezer - Kitchen</option>
                        <option value="walk-in-cooler">Walk-in Cooler - Kitchen</option>
                        <option value="dishwasher-1">Dishwasher - Main</option>
                        <option value="ice-machine">Ice Machine - Bar</option>
                        <option value="fryer-1">Deep Fryer #1</option>
                        <option value="fryer-2">Deep Fryer #2</option>
                        <option value="grill">Flat Top Grill</option>
                        <option value="oven-1">Convection Oven #1</option>
                        <option value="water-heater">Water Heater - Main</option>
                        <option value="grease-trap">Grease Trap</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="stockLocation">Stock Location</label>
                    <select id="stockLocation" style="width: 100%; padding: 0.625rem 0.875rem; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 0.875rem;">
                        <option value="">Select location...</option>
                        <option value="kitchen">Kitchen</option>
                        <option value="bar">Bar</option>
                        <option value="dining">Dining Room</option>
                        <option value="rooftop">Rooftop</option>
                        <option value="basement">Basement</option>
                        <option value="storage">Storage Room</option>
                        <option value="office">Office</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="serialNumber">Serial Number</label>
                    <input type="text" id="serialNumber" placeholder="Enter serial number..." style="width: 100%; padding: 0.625rem 0.875rem; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 0.875rem;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddEquipmentModal()">CANCEL</button>
                <button class="btn btn-primary" onclick="addEquipment()" style="background: var(--primary); color: white;">ADD</button>
            </div>
        </div>
    </div>
    
    <!-- Inbox Settings Modal -->
    <div id="inboxSettingsModal" class="modal-overlay" onclick="if(event.target === this) closeInboxSettings()">
        <div class="modal">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h2 class="modal-title">Inbox Settings</h2>
                <button onclick="closeInboxSettings()" style="background: none; border: none; font-size: 1.5rem; color: var(--gray-400); cursor: pointer;">×</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- General Notifications -->
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary);">General Notifications</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--gray-200);">
                                <th style="text-align: left; padding: 0.5rem 0; font-size: 0.875rem; font-weight: 600;">Type</th>
                                <th style="text-align: center; padding: 0.5rem; font-size: 0.875rem; font-weight: 600;">Email</th>
                                <th style="text-align: center; padding: 0.5rem; font-size: 0.875rem; font-weight: 600;">Text</th>
                                <th style="text-align: center; padding: 0.5rem; font-size: 0.875rem; font-weight: 600;">App</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">Mention</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">Subscription</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Work Order Notifications -->
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary);">Work Order Notifications</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--gray-200);">
                                <th style="text-align: left; padding: 0.5rem 0; font-size: 0.875rem; font-weight: 600;">Status</th>
                                <th style="text-align: center; padding: 0.5rem; font-size: 0.875rem; font-weight: 600;">Email</th>
                                <th style="text-align: center; padding: 0.5rem; font-size: 0.875rem; font-weight: 600;">Text</th>
                                <th style="text-align: center; padding: 0.5rem; font-size: 0.875rem; font-weight: 600;">App</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">Assigned to Internal Team</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">Pending Contractor Confirmation</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">Confirmed by Service Provider</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">Tech Assigned</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">Tech Scheduled</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">Tech Rescheduled</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">Work Incomplete with reason</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">Work Reviewed and Completed</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">Cancelled With Reason</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">Work Unsatisfactory</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- RFP Notifications -->
                <div style="margin-bottom: 2rem;">
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary);">Request for Proposal Notifications</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--gray-200);">
                                <th style="text-align: left; padding: 0.5rem 0; font-size: 0.875rem; font-weight: 600;">Status</th>
                                <th style="text-align: center; padding: 0.5rem; font-size: 0.875rem; font-weight: 600;">Email</th>
                                <th style="text-align: center; padding: 0.5rem; font-size: 0.875rem; font-weight: 600;">Text</th>
                                <th style="text-align: center; padding: 0.5rem; font-size: 0.875rem; font-weight: 600;">App</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">RFP Created</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">Participating</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">Not Participating</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">Not Awarded</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">Awarded</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                            <tr style="border-bottom: 1px solid var(--gray-100);">
                                <td style="padding: 0.75rem 0; font-size: 0.875rem;">RFP Closed</td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" checked style="width: 18px; height: 18px;">
                                </td>
                                <td style="text-align: center; padding: 0.75rem;">
                                    <input type="checkbox" style="width: 18px; height: 18px;">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeInboxSettings()">CANCEL</button>
                <button class="btn btn-primary" onclick="saveInboxSettings()">SAVE SETTINGS</button>
            </div>
        </div>
    </div>

    <script>
        // ENHANCEMENTS: Table Sorting, Form Validation, PWA
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                initializeEnhancements();
            }, 500);
        });

        function initializeEnhancements() {
            initializeTableSorting();
            initializeFormValidation();
            initializePWA();
            showToast('✨ Enhanced features active', 'success', 4000);
        }

        function initializeTableSorting() {
            document.querySelectorAll('table th').forEach((header, index) => {
                if (header.textContent.trim()) {
                    header.style.cursor = 'pointer';
                    header.style.userSelect = 'none';
                    header.innerHTML += ' <span style="font-size:0.75rem;color:#9ca3af;">↕</span>';
                    
                    header.addEventListener('click', () => {
                        const table = header.closest('table');
                        const tbody = table.querySelector('tbody');
                        if (!tbody) return;
                        
                        const rows = Array.from(tbody.querySelectorAll('tr'));
                        const isAsc = header.dataset.sort !== 'asc';
                        header.dataset.sort = isAsc ? 'asc' : 'desc';
                        
                        // Reset other headers
                        table.querySelectorAll('th').forEach(h => {
                            if (h !== header) h.dataset.sort = '';
                        });
                        
                        rows.sort((a, b) => {
                            const aText = a.cells[index]?.textContent.trim() || '';
                            const bText = b.cells[index]?.textContent.trim() || '';
                            
                            if (isAsc) {
                                return aText.localeCompare(bText, undefined, {numeric: true});
                            } else {
                                return bText.localeCompare(aText, undefined, {numeric: true});
                            }
                        });
                        
                        rows.forEach(row => tbody.appendChild(row));
                        showToast('Table sorted', 'info', 2000);
                    });
                }
            });
        }

        function initializeFormValidation() {
            document.querySelectorAll('input, select, textarea').forEach(field => {
                field.addEventListener('blur', () => {
                    if (field.hasAttribute('required') && !field.value.trim()) {
                        field.style.borderColor = '#ef4444';
                        showToast('Required field cannot be empty', 'error', 3000);
                    } else {
                        field.style.borderColor = '';
                    }
                });
            });
        }

        function initializePWA() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(() => {});
            }
        }

        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container') || (() => {
                const cont = document.createElement('div');
                cont.id = 'toast-container';
                cont.style.cssText = 'position:fixed;bottom:1rem;right:1rem;z-index:10000;';
                document.body.appendChild(cont);
                return cont;
            })();
            
            const toast = document.createElement('div');
            toast.style.cssText = `
                background:white;border-radius:8px;padding:1rem 1.5rem;margin-bottom:0.5rem;
                box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);display:flex;align-items:center;gap:0.75rem;
                border-left:4px solid ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                animation:slideIn 0.3s ease;max-width:300px;
            `;
            
            const icons = {success: '✅', error: '❌', info: 'ℹ️'};
            toast.innerHTML = `${icons[type] || icons.info} ${message}`;
            
            container.appendChild(toast);
            setTimeout(() => toast.remove(), duration);
        }
    </script>
</body>
</html>